"use strict";function wavParserWorker(a){a=a||window.Worker,this.url=this.getWorkerURL(),this.worker=new a(this.url)}function espsParserWorker(a){a=a||window.Worker,this.url=this.getWorkerURL(),this.worker=new a(this.url)}function textGridParserWorker(a){a=a||window.Worker,this.url=this.getWorkerURL(),this.worker=new a(this.url)}function spectroDrawingWorker(a){a=a||window.Worker,this.url=this.getWorkerURL(),this.worker=new a(this.url)}function ssffParserWorker(a){a=a||window.Worker,this.url=this.getWorkerURL(),this.worker=new a(this.url)}ArrayBuffer.prototype.subarray=function(a,b){for(var c=new ArrayBuffer(b),d=new Int8Array(c),e=new Int8Array(this),f=0;b>f;f++)d[f]=e[a+f];return c},angular.module("emuwebApp",["ui","ui.sortable","ngAnimate","angular.filter","btford.markdown"]).config(["$locationProvider",function(a){a.html5Mode(!0)}]),angular.module("emuwebApp").service("ConfigProviderService",["viewState",function(a){var b={};return b.vals={},b.design={},b.curDbConfig={},b.embeddedVals={audioGetUrl:"",labelGetUrl:"",labelType:"",fromUrlParams:!1},b.setDesign=function(a){angular.copy(a,b.design)},b.setVals=function(a){$.isEmptyObject(b.vals)?b.vals=a:angular.forEach(Object.keys(a),function(c){angular.isArray(b.vals[c])?(b.vals[c]=[],angular.forEach(a[c],function(a){b.vals[c].push(a)})):angular.forEach(Object.keys(a[c]),function(d){void 0!==b.vals[c][d]?b.vals[c][d]=a[c][d]:console.error("BAD ENTRY IN CONFIG! Key1: "+c+" key2: "+d)})})},b.getSsffTrackConfig=function(a){var c;return void 0!==b.curDbConfig.ssffTrackDefinitions&&angular.forEach(b.curDbConfig.ssffTrackDefinitions,function(b){b.name===a&&(c=b)}),c},b.getLimsOfTrack=function(c){var d={};return angular.forEach(b.vals.perspectives[a.curPerspectiveIdx].signalCanvases.contourLims,function(a){a.ssffTrackName===c&&(d=a)}),d},b.getContourColorsOfTrack=function(c){var d;return angular.forEach(b.vals.perspectives[a.curPerspectiveIdx].signalCanvases.contourColors,function(a){a.ssffTrackName===c&&(d=a)}),d},b.getAssignment=function(c){var d={};return angular.forEach(b.vals.perspectives[a.curPerspectiveIdx].signalCanvases.assign,function(a){a.signalCanvasName===c&&(d=a)}),d},b.getLevelDefinition=function(a){var c={};return angular.forEach(b.curDbConfig.levelDefinitions,function(b){b.name===a&&(c=b)}),c},b.setPerspectivesOrder=function(a,c){void 0!==b.vals&&void 0!==b.vals.perspectives&&void 0!==b.vals.perspectives[a]&&void 0!==b.vals.perspectives[a].levelCanvases&&(b.vals.perspectives[a].levelCanvases.order=c)},b.getStrRep=function(a){var b;switch(a){case 8:b="BACKSPACE";break;case 9:b="TAB";break;case 13:b="ENTER";break;case 16:b="SHIFT";break;case 18:b="ALT";break;case 32:b="SPACE";break;case 37:b="←";break;case 39:b="→";break;case 38:b="↑";break;case 40:b="↓";break;case 42:b="+";break;case 43:b="+";break;case 45:b="-";break;case 95:b="-";break;default:b=String.fromCharCode(a)}return b},b}]),angular.module("emuwebApp").controller("MainController",["$scope","$rootScope","$log","$compile","$timeout","$q","$window","$document","$location","viewState","HistoryService","Iohandlerservice","Soundhandlerservice","ConfigProviderService","fontScaleService","Ssffdataservice","LevelService","Textgridparserservice","Espsparserservice","Binarydatamaniphelper","Wavparserservice","Ssffparserservice","Drawhelperservice","Validationservice","Appcachehandler","loadedMetaDataService","dbObjLoadSaveService","appStateService","DataService","modalService","browserDetector",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E){a.cps=n,a.hists=k,a.fontImage=o,a.levServ=q,a.dataServ=C,a.vs=j,a.ssffds=p,a.shs=m,a.dhs=w,a.wps=u,a.io=l,a.ach=y,a.lmds=z,a.connectBtnLabel="connect",a.tmp={},a.dbLoaded=!1,a.is2dCancasesHidden=!0,a.windowWidth=g.outerWidth,a.showAboutHint=!1,a.ach.checkForNewVersion(),angular.element(g).bind("resize",function(){q.deleteEditArea(),j.setWindowWidth(g.outerWidth),a.$digest()}),angular.element(g).bind("keyup",function(b){(b.keyCode===n.vals.keyMappings.shift||b.keyCode===n.vals.keyMappings.alt)&&(k.addCurChangeObjToUndoStack(),a.$digest())}),window.onbeforeunload=function(){return""===n.embeddedVals.audioGetUrl&&z.getBundleList().length>0&&!n.vals.main.autoConnect?"Do you really wish to leave/reload the EMU-webApp? All unsaved changes will be lost...":void 0},a.$on("connectionDisrupted",function(){B.resetToInitState()}),a.$on("resetToInitState",function(){a.loadDefaultConfig()});var F=i.search();F.audioGetUrl&&F.labelGetUrl&&F.labelType&&(n.embeddedVals.audioGetUrl=F.audioGetUrl,n.embeddedVals.labelGetUrl=F.labelGetUrl,n.embeddedVals.labelType=F.labelType,n.embeddedVals.fromUrlParams=!0),a.loadFilesForEmbeddedApp=function(){n.embeddedVals.audioGetUrl&&(n.vals.activeButtons.openDemoDB=!1,l.httpGetPath(n.embeddedVals.audioGetUrl,"arraybuffer").then(function(a){j.showDropZone=!1;var b=n.embeddedVals.audioGetUrl;z.setCurBndlName(b.substr(0,b.lastIndexOf(".")).substr(b.lastIndexOf("/")+1,b.length)),j.getsubmenuOpen()&&j.togglesubmenuOpen(n.design.animation.period),j.somethingInProgressTxt="Loading DB config...",l.httpGetPath("configFiles/embedded_emuwebappConfig.json").then(function(b){j.curPerspectiveIdx=0,n.setVals(b.data.EMUwebAppConfig),delete b.data.EMUwebAppConfig;var c=x.validateJSO("emuwebappConfigSchema",n.vals);c===!0?(n.embeddedVals.fromUrlParams&&(n.vals.main.catchMouseForKeyBinding=!1),n.curDbConfig=b.data,c=x.validateJSO("DBconfigFileSchema",n.curDbConfig),c===!0?(j.somethingInProgress=!0,j.somethingInProgressTxt="Parsing WAV file...",u.parseWavArrBuf(a.data).then(function(a){var b=a;j.curViewPort.sS=0,j.curViewPort.eS=b.Data.length,j.resetSelect(),m.wavJSO=b,l.httpGetPath(n.embeddedVals.labelGetUrl,"utf-8").then(function(a){j.somethingInProgressTxt="Parsing "+n.embeddedVals.labelType+" file...",l.parseLabelFile(a.data,n.embeddedVals.labelGetUrl,"embeddedTextGrid",n.embeddedVals.labelType).then(function(a){var b=a;C.setData(b);var c=[],d=[];b.levels.forEach(function(a){c.push(a.name),d.push({name:a.name,type:a.type,attributeDefinitions:{name:a.name,type:"string"}})}),n.curDbConfig.levelDefinitions=d,j.setCurLevelAttrDefs(n.curDbConfig.levelDefinitions),n.vals.perspectives[j.curPerspectiveIdx].levelCanvases.order=c,j.somethingInProgressTxt="Done!",j.somethingInProgress=!1,j.setState("labeling")},function(a){D.open("views/error.html","Error parsing wav file: "+a.status.message)})},function(a){D.open("views/error.html","Could not get label file: "+n.embeddedVals.labelGetUrl+" ERROR "+JSON.stringify(a,null,4))})},function(a){D.open("views/error.html","Error parsing wav file: "+a.status.message)})):D.open("views/error.html","Error validating / checking DBconfig: "+JSON.stringify(c,null,4))):D.open("views/error.html","Error validating ConfigProviderService.vals (emuwebappConfig data) after applying changes of newly loaded config (most likely due to wrong entry...): "+JSON.stringify(c,null,4))},function(a){D.open("views/error.html","Could not get embedded_config.json: "+a)})},function(a){D.open("views/error.html","Could not get audio file:"+n.embeddedVals.audioGetUrl+" ERROR: "+JSON.stringify(a,null,4))}))},a.loadDefaultConfig=function(){j.somethingInProgress=!0,j.somethingInProgressTxt="Loading schema files",x.loadSchemas().then(function(b){x.setSchemas(b),l.httpGetDefaultDesign().success(function(b){n.setDesign(b),l.httpGetDefaultConfig().success(function(b){j.somethingInProgressTxt="Validating emuwebappConfig";var c=x.validateJSO("emuwebappConfigSchema",b);c===!0?(n.setVals(b),a.handleDefaultConfigLoaded(),a.loadFilesForEmbeddedApp(),a.checkIfToShowWelcomeModal(),j.somethingInProgress=!1):D.open("views/error.html","Error validating / checking emuwebappConfigSchema: "+JSON.stringify(c,null,4)).then(function(){B.resetToInitState()})}).error(function(a,b,c,d){D.open("views/error.html","Could not get defaultConfig for EMU-webApp:  status: "+b+" header: "+c+" config "+d).then(function(){B.resetToInitState()})})}).error(function(a,b,c,d){D.open("views/error.html","Could not get defaultConfig for EMU-webApp:  status: "+b+" header: "+c+" config "+d).then(function(){B.resetToInitState()})})},function(a){D.open("views/error.html","Error loading schema file: "+JSON.stringify(a,null,4)).then(function(){B.resetToInitState()})})},a.loadDefaultConfig(),a.checkIfToShowWelcomeModal=function(){var b=localStorage.getItem("haveShownWelcomeModal");E.isBrowser.PhantomJS()||null!==b||(localStorage.setItem("haveShownWelcomeModal","true"),a.showAboutHint=!0),console.log(a.showAboutHint)},a.getCurBndlName=function(){return z.getCurBndlName()},a.handleDefaultConfigLoaded=function(){j.getsubmenuOpen()||j.togglesubmenuOpen(n.design.animation.period),n.vals.main.autoConnect&&l.wsH.initConnect(n.vals.main.serverUrl).then(function(b){"error"===b.type?D.open("views/error.html","Could not connect to websocket server: "+n.vals.main.serverUrl):a.handleConnectedToWSserver()}),j.setspectroSettings(n.vals.spectrogramSettings.windowSizeInSecs,n.vals.spectrogramSettings.rangeFrom,n.vals.spectrogramSettings.rangeTo,n.vals.spectrogramSettings.dynamicRange,n.vals.spectrogramSettings.window,n.vals.spectrogramSettings.drawHeatMapColors,n.vals.spectrogramSettings.preEmphasisFilterFactor,n.vals.spectrogramSettings.heatMapColorAnchors),j.setTransitionTime(n.design.animation.period)},a.handleConnectedToWSserver=function(){j.showDropZone=!1,n.vals.main.comMode="WS",n.vals.activeButtons.openDemoDB=!1,j.somethingInProgress=!0,j.somethingInProgressTxt="Checking protocol...",l.getProtocol().then(function(b){"EMU-webApp-websocket-protocol"===b.protocol&&"0.0.2"===b.version?(j.somethingInProgressTxt="Checking user management...",l.getDoUserManagement().then(function(b){"NO"===b?a.innerHandleConnectedToWSserver():D.open("views/loginModal.html").then(function(b){b?a.innerHandleConnectedToWSserver():B.resetToInitState()})})):D.open("views/error.html","Could not connect to websocket server: "+n.vals.main.serverUrl+'. It does not speak the same protocol as this client. Its protocol answer was: "'+b.protocol+'" with the version: "'+b.version+'"').then(function(){B.resetToInitState()})})},a.innerHandleConnectedToWSserver=function(){j.somethingInProgressTxt="Loading DB config...",l.httpGetDefaultDesign().success(function(a){n.setDesign(a),l.getDBconfigFile().then(function(a){j.curPerspectiveIdx=0,n.setVals(a.EMUwebAppConfig),delete a.EMUwebAppConfig;var b=x.validateJSO("emuwebappConfigSchema",n.vals);b===!0?(n.curDbConfig=a,j.setCurLevelAttrDefs(n.curDbConfig.levelDefinitions),b=x.validateJSO("DBconfigFileSchema",a),b===!0?(j.somethingInProgressTxt="Loading bundle list...",l.getBundleList().then(function(a){b=z.setBundleList(a),n.vals.activeButtons.clear=!0,n.vals.activeButtons.specSettings=!0,b===!0?A.loadBundle(z.getBundleList()[0]):D.open("views/error.html","Error validating bundleList: "+JSON.stringify(b,null,4)).then(function(){B.resetToInitState()})})):D.open("views/error.html","Error validating / checking DBconfig: "+JSON.stringify(b,null,4)).then(function(){B.resetToInitState()})):D.open("views/error.html","Error validating ConfigProviderService.vals (emuwebappConfig data) after applying changes of newly loaded config (most likely due to wrong entry...): "+JSON.stringify(b,null,4)).then(function(){B.resetToInitState()})})})},a.toggleCollapseSession=function(b){a.uniqSessionList[b].collapsed=!a.uniqSessionList[b].collapsed},a.getEnlarge=function(a){var b=n.vals.perspectives[j.curPerspectiveIdx].signalCanvases.order.length,c=50;return-1==j.getenlarge()?"auto":1===b?"auto":2===b?j.getenlarge()==a?"70%":"27%":j.getenlarge()==a?c+"%":(95-c)/(b-1)+"%"},a.cursorInTextField=function(){j.setcursorInTextField(!0)},a.cursorOutOfTextField=function(){j.setcursorInTextField(!1)},a.openSubmenu=function(){j.togglesubmenuOpen(n.design.animation.period)},a.addLevelSegBtnClick=function(){if(j.getPermission("addLevelSegBtnClick")){var a=0;void 0!==C.data.levels&&(a=C.data.levels.length);var b="levelNr"+a,c={items:[{id:C.getNewId(),sampleStart:0,sampleDur:m.wavJSO.Data.length,labels:[{name:b,value:n.vals.labelCanvasConfig.newSegmentName}]}],name:b,type:"SEGMENT"};if(void 0===j.getCurAttrDef(b)){var d={name:b,type:"EVENT",attributeDefinitions:{name:b,type:"string"}};j.setCurLevelAttrDefs(d)}q.insertLevel(c,a,j.curPerspectiveIdx),k.addObjToUndoStack({type:"ANNOT",action:"INSERTLEVEL",level:c,id:a,curPerspectiveIdx:j.curPerspectiveIdx})}},a.addLevelPointBtnClick=function(){if(j.getPermission("addLevelPointBtnClick")){var a=0;void 0!==C.data.levels&&(a=C.data.levels.length);var b="levelNr"+a,c={items:[{id:C.getNewId(),samplePoint:Math.round(m.wavJSO.Data.length/2),labels:[]}],name:b,type:"EVENT"};if(c.items[0].labels.push({name:b,value:n.vals.labelCanvasConfig.newEventName}),void 0===j.getCurAttrDef(b)){var d={name:b,type:"EVENT",attributeDefinitions:{name:b,type:"string"}};j.setCurLevelAttrDefs(d)}q.insertLevel(c,a,j.curPerspectiveIdx),k.addObjToUndoStack({type:"ANNOT",action:"INSERTLEVEL",level:c,id:a,curPerspectiveIdx:j.curPerspectiveIdx})}},a.renameSelLevelBtnClick=function(){j.getPermission("renameSelLevelBtnClick")&&(void 0!==j.getcurClickLevelName()?D.open("views/renameLevel.html",j.getcurClickLevelName()):D.open("views/error.html","Rename Error : Please choose a Level first !"))},a.downloadTextGridBtnClick=function(){j.getPermission("downloadTextGridBtnClick")&&r.asyncToTextGrid().then(function(a){D.open("views/export.html",z.getCurBndl().name+".TextGrid",a)})},a.downloadAnnotationBtnClick=function(){j.getPermission("downloadAnnotationBtnClick")&&D.open("views/export.html",z.getCurBndl().name+"_annot.json",angular.toJson(C.getData(),!0))},a.spectSettingsBtnClick=function(){j.getPermission("spectSettingsChange")&&D.open("views/spectSettings.html")},a.connectBtnClick=function(){j.getPermission("connectBtnClick")&&D.open("views/connectModal.html").then(function(b){b&&(j.somethingInProgressTxt="Connecting to server...",j.somethingInProgress=!0,l.wsH.initConnect(b).then(function(c){"error"===c.type?D.open("views/error.html","Could not connect to websocket server: "+b).then(function(){B.resetToInitState()}):a.handleConnectedToWSserver()}))})},a.openDemoDBbtnClick=function(b){j.getPermission("openDemoBtnDBclick")&&(a.dropdown=!1,n.vals.activeButtons.openDemoDB=!1,z.setDemoDbName(b),j.showDropZone=!1,j.somethingInProgress=!0,j.setState("loadingSaving"),n.vals.main.comMode="DEMO",j.somethingInProgressTxt="Loading DB config...",l.httpGetDefaultDesign().success(function(a){n.setDesign(a),l.getDBconfigFile(b).then(function(a){var c=a.data;j.curPerspectiveIdx=0,n.setVals(c.EMUwebAppConfig),delete c.EMUwebAppConfig;var d=x.validateJSO("emuwebappConfigSchema",n.vals);d===!0?(n.curDbConfig=c,j.setCurLevelAttrDefs(n.curDbConfig.levelDefinitions),d=x.validateJSO("DBconfigFileSchema",n.curDbConfig),d===!0?(j.somethingInProgressTxt="Loading bundle list...",l.getBundleList(b).then(function(a){var b=a.data;z.setBundleList(b),n.vals.activeButtons.clear=!0,n.vals.activeButtons.specSettings=!0,A.loadBundle(z.getBundleList()[0])},function(a){D.open("views/error.html","Error loading bundle list of "+b+": "+a.data+" STATUS: "+a.status).then(function(){B.resetToInitState()})})):D.open("views/error.html","Error validating / checking DBconfig: "+JSON.stringify(d,null,4)).then(function(){B.resetToInitState()})):D.open("views/error.html","Error validating ConfigProviderService.vals (emuwebappConfig data) after applying changes of newly loaded config (most likely due to wrong entry...): "+JSON.stringify(d,null,4)).then(function(){B.resetToInitState()})},function(a){D.open("views/error.html","Error loading DB config of "+b+": "+a.data+" STATUS: "+a.status).then(function(){B.resetToInitState()})})}))},a.aboutBtnClick=function(){D.open("views/help.html")},a.showHierarchyBtnClick=function(){j.hierarchyShown||(j.toggleHierarchy(),D.open("views/showHierarchyModal.html"))},a.showEditDBconfigBtnClick=function(){var b=a.cps.curDbConfig,c=a.cps.vals;D.open("views/tabbed.html").then(function(d){d?console.log(angular.toJson({dbconfig:a.cps.curDbConfig,vals:a.cps.vals})):(a.cps.curDbConfig=b,a.cps.vals=c)})},a.clearBtnClick=function(){var a;a=0!==k.movesAwayFromLastSave&&"DEMO"!==n.vals.main.comMode?"Do you wish to clear all loaded data and if connected disconnect from the server? CAUTION: YOU HAVE UNSAVED CHANGES! These will be lost if you confirm.":"Do you wish to clear all loaded data and if connected disconnect from the server? You have NO unsaved changes so no changes will be lost.",D.open("views/confirmModal.html",a).then(function(a){a&&B.resetToInitState()})},a.cmdZoomAll=function(){j.getPermission("zoom")&&(q.deleteEditArea(),j.setViewPort(0,m.wavJSO.Data.length))},a.cmdZoomIn=function(){j.getPermission("zoom")&&(q.deleteEditArea(),j.zoomViewPort(!0))},a.cmdZoomOut=function(){j.getPermission("zoom")&&(q.deleteEditArea(),j.zoomViewPort(!1))},a.cmdZoomLeft=function(){j.getPermission("zoom")&&(q.deleteEditArea(),j.shiftViewPort(!1))},a.cmdZoomRight=function(){j.getPermission("zoom")&&(q.deleteEditArea(),j.shiftViewPort(!0))},a.cmdZoomSel=function(){j.getPermission("zoom")&&(q.deleteEditArea(),j.setViewPort(j.curViewPort.selectS,j.curViewPort.selectE))},a.cmdPlayView=function(){j.getPermission("playaudio")&&(m.playFromTo(j.curViewPort.sS,j.curViewPort.eS),j.animatePlayHead(j.curViewPort.sS,j.curViewPort.eS))},a.cmdPlaySel=function(){j.getPermission("playaudio")&&(m.playFromTo(j.curViewPort.selectS,j.curViewPort.selectE),j.animatePlayHead(j.curViewPort.selectS,j.curViewPort.selectE))},a.cmdPlayAll=function(){j.getPermission("playaudio")&&(m.playFromTo(0,m.wavJSO.Data.length),j.animatePlayHead(0,m.wavJSO.Data.length))},a.changePerspective=function(a){for(var b,c=0;c<n.vals.perspectives.length;c++)a.name===n.vals.perspectives[c].name&&(b=c);j.curPerspectiveIdx=b,j.setRightsubmenuOpen(!j.getRightsubmenuOpen())},a.getPerspectiveColor=function(a){var b;return b=-1===j.curPerspectiveIdx||a.name===n.vals.perspectives[j.curPerspectiveIdx].name?"emuwebapp-curSelPerspLi":"emuwebapp-perspLi"}}]),angular.module("emuwebApp").directive("level",["$timeout","$animate","viewState","ConfigProviderService","Drawhelperservice","HistoryService","fontScaleService","modalService","LevelService","loadedMetaDataService",function(a,b,c,d,e,f,g,h,i,j){return{templateUrl:"views/level.html",restrict:"E",scope:{level:"=",idx:"="},link:function(k,l,m){var n=l.find("canvas");k.open=m.open,k.vs=c,k.hists=f,k.cps=d,k.modal=h,k.lmds=j;var o=l.find("div");k.levelDef=d.getLevelDefinition(k.level.name),k.backgroundCanvas={background:d.design.color.lightGrey},k.$watch("vs.submenuOpen",function(){a(k.redraw,d.design.animation.duration)}),k.$watch("vs.curViewPort",function(a,b){b.sS!==a.sS||b.eS!==a.eS||b.windowWidth!==a.windowWidth?(k.drawLevelDetails(),k.drawLevelMarkup()):k.drawLevelMarkup()},!0),k.$watch("vs.curMouseX",function(){k.vs.getcurMouseLevelName()===k.level.name&&(k.drawLevelDetails(),k.drawLevelMarkup())},!0),k.$watch("vs.curClickLevelName",function(a){void 0!==a&&k.drawLevelMarkup()},!0),k.$watch("vs.movingBoundarySample",function(){k.drawLevelDetails(),k.drawLevelMarkup()},!0),k.$watch("vs.movingBoundary",function(){k.drawLevelMarkup()},!0),k.$watch("hists.movesAwayFromLastSave",function(){k.drawLevelDetails(),k.drawLevelMarkup()},!0),k.$watch("lmds.getCurBndl()",function(a,b){(a.name!==b.name||a.session!==b.session)&&(k.drawLevelDetails(),k.drawLevelMarkup())},!0),k.redraw=function(){k.drawLevelDetails(),k.drawLevelMarkup()},k.changeCurAttrDef=function(a,c){var d=k.vs.getCurAttrDef(k.level.name);d!==a&&(k.vs.setCurAttrDef(k.level.name,a,c),l.hasClass("emuwebapp-level-animation")||(k.vs.setEditing(!1),i.deleteEditArea(),b.addClass(o,"emuwebapp-level-animation").then(function(){b.removeClass(o,"emuwebapp-level-animation"),k.drawLevelDetails(),k.drawLevelMarkup()})))},k.getAttrDefBtnColor=function(a){var b,c=k.vs.getCurAttrDef(k.level.name);return b=a===c?{background:"-webkit-radial-gradient(50% 50%, closest-corner, rgba(0, 0, 0, 1), rgba(0, 0, 0, 0) 60%)"}:{"background-color":"white"}},k.updateView=function(){$.isEmptyObject(k.cps)||k.drawLevelDetails()},l.bind("mouseleave",function(){k.vs.setcurMouseItem(void 0,void 0,void 0),k.drawLevelMarkup()}),k.drawLevelDetails=function(){var a=1*d.design.font.small.size.slice(0,-2),b=k.vs.getCurAttrDef(k.level.name),c="25px"===l.parent().css("height")?!1:!0;if($.isEmptyObject(k.level))return void console.log("undef levelDetails");if($.isEmptyObject(k.vs))return void console.log("undef viewState");if($.isEmptyObject(k.cps))return void console.log("undef config");c||(a-=1);var e=n[0].getContext("2d");e.clearRect(0,0,n[0].width,n[0].height);var f,h,i,j;f=k.vs.getSampleDist(n[0].width);var m=e.canvas.height/e.canvas.offsetHeight;j=k.level.name===b?c?g.getTextImageTwoLines(e,k.level.name,"("+k.level.type+")",a,d.design.font.small.family,d.design.color.black,!0):g.getTextImage(e,k.level.name,a,d.design.font.small.family,d.design.color.black):g.getTextImageTwoLines(e,k.level.name+":"+b,"("+k.level.type+")",a,d.design.font.small.family,d.design.color.black,!0),e.drawImage(j,0,e.canvas.height/2-a*m);var o=(k.vs.getcurMouseItem(),k.vs.getcurClickItems(),k.vs.getcurClickLevelName(),-1),p=(g.getTextImage(e,"m",a-2,d.design.font.small.family,d.design.color.black),g.getLastImageWidth()),q=(g.getTextImage(e,"0",a-4,d.design.font.small.family,d.design.color.black),g.getLastImageWidth());if("SEGMENT"===k.level.type){e.fillStyle=d.design.color.black;var r=k.level.items;r.forEach(function(f){if(++o,f.sampleStart>=k.vs.curViewPort.sS&&f.sampleStart<=k.vs.curViewPort.eS||f.sampleStart+f.sampleDur>k.vs.curViewPort.sS&&f.sampleStart+f.sampleDur<k.vs.curViewPort.eS||f.sampleStart<k.vs.curViewPort.sS&&f.sampleStart+f.sampleDur>k.vs.curViewPort.eS){var l;if(f.labels.forEach(function(a){a.name===b&&(l=a.value)}),h=k.vs.getPos(n[0].width,f.sampleStart),i=k.vs.getPos(n[0].width,f.sampleStart+f.sampleDur+1),e.fillStyle=d.design.color.black,e.fillRect(h,0,2,n[0].height/2),e.fillStyle=d.design.color.grey,e.fillRect(i,n[0].height/2,2,n[0].height),void 0!==l&&i-h>p*l.length){j=g.getTextImage(e,l,a-2,d.design.font.small.family,d.design.color.black);var m=g.getLastImageWidth(),r=h+(i-h)/2-m/2;c?e.drawImage(j,0,0,j.width,j.height,r,n[0].height/2-(a-2),j.width,j.height):e.drawImage(j,0,0,j.width,j.height,r,n[0].height/2-a,j.width,j.height)}if(k.open&&void 0!==l&&0!==l.length){var s=h+(i-h)/2,t=n[0].height/4;e.strokeStyle=d.design.color.black,e.beginPath(),e.moveTo(h,t),e.lineTo(s,t),e.lineTo(s,t+5),e.stroke(),t=n[0].height/4*3,e.strokeStyle=d.design.color.grey,e.beginPath(),e.moveTo(i,t),e.lineTo(s,t),e.lineTo(s,t-5),e.stroke()}if(i-h>q*f.sampleStart.toString().length&&c){var u=g.getTextImage(e,f.sampleStart,a-2,d.design.font.small.family,d.design.color.grey);e.drawImage(u,0,0,j.width,j.height,h+3,0,j.width,j.height)}if(i-h>q*(6+f.sampleDur.toString().length)&&c){var v=g.getTextImage(e,"dur: "+f.sampleDur+" ",a-2,d.design.font.small.family,d.design.color.grey),w=g.getLastImageWidth();e.drawImage(v,0,0,j.width,j.height,i-w,n[0].height/4*3,j.width,j.height)}}})}else if("EVENT"===k.level.type){e.fillStyle=d.design.color.black;var s;k.level.items.forEach(function(c){if(c.samplePoint>k.vs.curViewPort.sS&&c.samplePoint<k.vs.curViewPort.eS){s=Math.round(k.vs.getPos(n[0].width,c.samplePoint)+f/2);var h;c.labels.forEach(function(a){a.name===b&&(h=a.value)}),e.fillStyle=d.design.color.black,e.fillRect(s,0,1,n[0].height/2-n[0].height/10),e.fillRect(s,n[0].height/2+n[0].height/10,1,n[0].height/2-n[0].height/10),j=g.getTextImage(e,h,a-2,d.design.font.small.family,d.design.color.black),e.drawImage(j,0,0,j.width,j.height,s-5,n[0].height/3,j.width,j.height),j=g.getTextImage(e,c.samplePoint,a-4,d.design.font.small.family,d.design.color.grey),e.drawImage(j,0,0,j.width,j.height,s+5,0,j.width,j.height)}})}},k.drawLevelMarkup=function(){var a=n[1].getContext("2d");a.clearRect(0,0,n[1].width,n[1].height),k.level.name===k.vs.getcurClickLevelName()&&(a.fillStyle=d.design.color.transparent.grey,a.fillRect(0,0,n[0].width,n[0].height)),e.drawMovingBoundaryLine(a),e.drawCurViewPortSelected(a);var b,c,f,g,h;b=k.vs.getPos(n[1].width,k.vs.curViewPort.selectS),c=k.vs.getPos(n[1].width,k.vs.curViewPort.selectE),f=k.vs.getSampleDist(n[1].width);var i=k.vs.getcurMouseItem(),j=k.vs.getcurMouseisFirst(),l=k.vs.getcurMouseisLast(),m=k.vs.getcurClickItems(),o=k.vs.getcurClickLevelName();void 0!==m&&k.level.name===o&&m.length>0&&m.forEach(function(e){void 0!==e&&(void 0!==e.sampleStart?(b=Math.round(k.vs.getPos(n[0].width,e.sampleStart)),c=Math.round(k.vs.getPos(n[0].width,e.sampleStart+e.sampleDur+1))):(b=Math.round(k.vs.getPos(n[0].width,e.samplePoint)+f/2),b-=5,c=b+10),a.fillStyle=d.design.color.transparent.yellow,a.fillRect(b,0,c-b,n[0].height),a.fillStyle=d.design.color.black)}),h=k.vs.getcurMouseItem(),k.level.items.length>0&&void 0!==h&&void 0!==i&&k.level.name===k.vs.getcurMouseLevelName()&&(a.fillStyle=d.design.color.blue,j===!0?"SEGMENT"===k.vs.getcurMouseLevelType()&&(h=k.level.items[0],b=Math.round(k.vs.getPos(n[1].width,h.sampleStart)),a.fillRect(b,0,3,n[1].height)):l===!0?"SEGMENT"===k.vs.getcurMouseLevelType()&&(h=k.level.items[k.level.items.length-1],b=Math.round(k.vs.getPos(n[1].width,h.sampleStart+h.sampleDur+1)),a.fillRect(b,0,3,n[1].height)):"SEGMENT"===k.vs.getcurMouseLevelType()?(b=Math.round(k.vs.getPos(n[1].width,h.sampleStart)),a.fillRect(b,0,3,n[1].height)):(b=Math.round(k.vs.getPos(n[1].width,h.samplePoint)),g=f/2,a.fillRect(b+g,0,3,n[1].height)),a.fillStyle=d.design.color.black)}}}}]),angular.module("emuwebApp").directive("osci",["$timeout","viewState","Soundhandlerservice","ConfigProviderService","Drawhelperservice","loadedMetaDataService",function(a,b,c,d,e,f){return{templateUrl:"views/osci.html",replace:!0,restrict:"E",scope:{},controller:["$scope",function(a){a.changeAttrDef=function(){}}],link:function(g,h,i){var j=h.find("canvas").length,k=h.find("canvas")[0],l=h.find("canvas")[j-1];g.order=i.order,g.trackName=i.trackName,g.cps=d,g.viewState=b,g.lmds=f,g.$watch("viewState.submenuOpen",function(){a(g.redraw,d.design.animation.duration)}),g.$watch("viewState.timelineSize",function(){a(g.redraw,d.design.animation.duration)}),g.$watch("viewState.curPerspectiveIdx",function(){g.drawVpOsciMarkup(g,d,!0)},!0),g.$watch("viewState.playHeadAnimationInfos",function(){$.isEmptyObject(c)||$.isEmptyObject(c.wavJSO)||g.drawPlayHead(g,d)},!0),g.$watch("viewState.movingBoundarySample",function(){$.isEmptyObject(c)||$.isEmptyObject(c.wavJSO)||g.drawVpOsciMarkup(g,d,!0)},!0),g.$watch("viewState.movingBoundary",function(){$.isEmptyObject(c)||$.isEmptyObject(c.wavJSO)||g.drawVpOsciMarkup(g,d,!0)},!0),g.$watch("viewState.curViewPort",function(a,f){if(!$.isEmptyObject(c)&&!$.isEmptyObject(c.wavJSO)){if(f.sS!==a.sS||f.eS!==a.eS){var h=e.calculatePeaks(b,k,c.wavJSO.Data);e.osciPeaks=h,e.freshRedrawDrawOsciOnCanvas(b,k,e.osciPeaks,c.wavJSO.Data,d)}g.drawVpOsciMarkup(g,d,!0)}},!0),g.$watch("lmds.getCurBndl()",function(a,f){if(a.name!==f.name||a.session!==f.session){var g=e.calculatePeaks(b,k,c.wavJSO.Data);e.osciPeaks=g,e.freshRedrawDrawOsciOnCanvas(b,k,e.osciPeaks,c.wavJSO.Data,d)}},!0),g.redraw=function(){g.drawVpOsciMarkup(g,d,!0)},g.drawPlayHead=function(a,c){var e=l.getContext("2d");e.clearRect(0,0,k.width,k.height);var f=b.getPos(l.width,b.playHeadAnimationInfos.sS),g=b.getPos(l.width,b.playHeadAnimationInfos.curS);e.fillStyle=d.design.color.transparent.grey,e.fillRect(f,0,g-f,k.height),a.drawVpOsciMarkup(a,c,!1)},g.drawVpOsciMarkup=function(a,b,c){var d=l.getContext("2d");c&&d.clearRect(0,0,l.width,l.height),e.drawMovingBoundaryLine(d),e.drawViewPortTimes(d,!0),e.drawCurViewPortSelected(d,!0)}}}}]),angular.module("emuwebApp").directive("preview",["viewState","Soundhandlerservice","Drawhelperservice","ConfigProviderService",function(a,b,c,d){return{templateUrl:"views/preview.html",restrict:"E",scope:{currentBundleName:"@"},link:function(e,f){var g=f.find("canvas")[0],h=f.find("canvas")[1],i=!1;e.vs=a,e.shs=b,e.backgroundCanvas={background:"#eee",border:"1px solid gray",width:"100%",height:"100%"},e.$watch("vs.curViewPort",function(a,c){$.isEmptyObject(b.wavJSO)||(c.sS!==a.sS||c.eS!==a.eS)&&e.drawPreview()},!0),e.$watch("currentBundleName",function(){if($.isEmptyObject(b.wavJSO)||(i=!1,e.backgroundCanvas={background:d.design.color.lightGrey,border:"1px solid gray",width:"100%",height:"100%"},e.drawPreview()),""===e.currentBundleName){var a=g.getContext("2d"),c=h.getContext("2d");a.clearRect(0,0,g.width,g.height),c.clearRect(0,0,g.width,g.height)}},!0),e.drawPreview=function(){if(i)e.drawVpOsciMarkup(a,g,d);else{var f=c.calculatePeaks(a,g,b.wavJSO.Data);c.osciPeaks=f,c.freshRedrawDrawOsciOnCanvas(a,g,c.osciPeaks,b.wavJSO.Data,d),i=!0,e.drawVpOsciMarkup(a,g,d)}},e.drawVpOsciMarkup=function(a){var c=h.getContext("2d"),e=h.width/b.wavJSO.Data.length*a.curViewPort.sS,f=h.width/b.wavJSO.Data.length*a.curViewPort.eS;c.clearRect(0,0,h.width,h.height),c.fillStyle=d.design.color.transparent.grey,c.fillRect(e,0,f-e,h.height),c.strokeStyle=d.design.color.transparent.black,c.beginPath(),c.moveTo(e,0),c.lineTo(e,h.height),c.moveTo(f,0),c.lineTo(f,h.height),c.closePath(),c.stroke()}}}}]),angular.module("emuwebApp").directive("bundleListSideBar",function(){return{templateUrl:"views/bundleListSideBar.html",restrict:"E",replace:!0,scope:{},link:function(){}}}),angular.module("emuwebApp").directive("spectro",["$timeout","viewState","ConfigProviderService","Drawhelperservice","fontScaleService","Soundhandlerservice","mathHelperService","loadedMetaDataService",function(a,b,c,d,e,f,g,h){return{templateUrl:"views/spectro.html",restrict:"E",replace:!0,scope:{},link:function(i,j,k){i.shs=f,i.order=k.order,i.vs=b,i.cps=c,i.dhs=d,i.lmds=h,i.trackName=k.trackName,i.canvas0=j.find("canvas")[0],i.canvas1=j.find("canvas")[j.find("canvas").length-1],i.context=i.canvas0.getContext("2d"),i.markupCtx=i.canvas1.getContext("2d"),i.alpha=.16,i.devicePixelRatio=window.devicePixelRatio||1,i.primeWorker=new spectroDrawingWorker,i.$watch("vs.timelineSize",function(){$.isEmptyObject(i.shs)||$.isEmptyObject(i.shs.wavJSO)||a(i.clearAndDrawSpectMarkup,c.design.animation.duration)}),i.$watch("vs.submenuOpen",function(){$.isEmptyObject(i.shs)||$.isEmptyObject(i.shs.wavJSO)||a(i.clearAndDrawSpectMarkup,c.design.animation.duration)}),i.$watch("vs.curViewPort",function(a,b){$.isEmptyObject(i.shs)||$.isEmptyObject(i.shs.wavJSO)||((b.sS!==a.sS||b.eS!==a.eS)&&i.redraw(),i.clearAndDrawSpectMarkup())},!0),i.$watch("vs.movingBoundarySample",function(){$.isEmptyObject(i.shs)||$.isEmptyObject(i.shs.wavJSO)||i.clearAndDrawSpectMarkup()},!0),i.$watch("vs.movingBoundary",function(){$.isEmptyObject(i.shs)||$.isEmptyObject(i.shs.wavJSO)||i.clearAndDrawSpectMarkup()},!0),i.$watch("vs.spectroSettings",function(){$.isEmptyObject(i.shs)||$.isEmptyObject(i.shs.wavJSO)||(i.setupEvent(),i.redraw())},!0),i.$watch("lmds.getCurBndl()",function(a,b){$.isEmptyObject(i.shs)||$.isEmptyObject(i.shs.wavJSO)||(a.name!==b.name||a.session!==b.session)&&i.redraw()},!0),i.redraw=function(){i.markupCtx.clearRect(0,0,i.canvas1.width,i.canvas1.height),i.drawSpectro(i.shs.wavJSO.Data)},i.drawSpectro=function(a){i.killSpectroRenderingThread(),i.startSpectroRenderingThread(a)},i.calcSamplesPerPxl=function(){return(i.vs.curViewPort.eS+1-i.vs.curViewPort.sS)/i.canvas0.width},i.clearAndDrawSpectMarkup=function(){i.markupCtx.clearRect(0,0,i.canvas1.width,i.canvas1.height),i.drawSpectMarkup()},i.drawSpectMarkup=function(){i.dhs.drawMovingBoundaryLine(i.markupCtx),i.dhs.drawCurViewPortSelected(i.markupCtx,!1),i.dhs.drawMinMaxAndName(i.markupCtx,"",i.vs.spectroSettings.rangeFrom,i.vs.spectroSettings.rangeTo,2)},i.killSpectroRenderingThread=function(){i.context.fillStyle=c.design.color.lightGrey,i.context.fillRect(0,0,i.canvas0.width,i.canvas0.height),i.dhs.drawCurViewPortSelected(i.markupCtx,!1);var a=e.getTextImage(i.context,"rendering...",.75*c.design.font.small.size.slice(0,-2),c.design.font.small.family,c.design.color.black,!0);i.context.drawImage(a,10,50),null!==i.primeWorker&&(i.primeWorker.kill(),i.primeWorker=null)
},i.setupEvent=function(){var a=i.context.createImageData(i.canvas0.width,i.canvas0.height);i.primeWorker.says(function(b){if(void 0===b.status){if(i.calcSamplesPerPxl()===b.samplesPerPxl){var c=new Uint8ClampedArray(b.img);a.data.set(c),i.context.putImageData(a,0,0),i.drawSpectMarkup()}}else console.error("Error rendering spectrogram:",b.status.message)})},i.startSpectroRenderingThread=function(a){if(a.length>0){i.primeWorker=new spectroDrawingWorker;var b=[],c=g.calcClosestPowerOf2Gt(i.shs.wavJSO.SampleRate*i.vs.spectroSettings.windowSizeInSecs);512>c&&(c=512),b=i.vs.curViewPort.sS>=c/2?a.subarray(i.vs.curViewPort.sS-c/2,i.vs.curViewPort.eS+c):a.subarray(i.vs.curViewPort.sS,i.vs.curViewPort.eS+c),i.setupEvent(),i.primeWorker.tell({windowSizeInSecs:i.vs.spectroSettings.windowSizeInSecs,fftN:c,alpha:i.alpha,upperFreq:i.vs.spectroSettings.rangeTo,lowerFreq:i.vs.spectroSettings.rangeFrom,samplesPerPxl:i.calcSamplesPerPxl(),window:i.vs.spectroSettings.window,imgWidth:i.canvas0.width,imgHeight:i.canvas0.height,dynRangeInDB:i.vs.spectroSettings.dynamicRange,pixelRatio:i.devicePixelRatio,sampleRate:i.shs.wavJSO.SampleRate,transparency:i.cps.vals.spectrogramSettings.transparency,audioBuffer:b,audioBufferChannels:i.shs.wavJSO.NumChannels,drawHeatMapColors:i.vs.spectroSettings.drawHeatMapColors,preEmphasisFilterFactor:i.vs.spectroSettings.preEmphasisFilterFactor,heatMapColorAnchors:i.vs.spectroSettings.heatMapColorAnchors},[b.buffer])}}}}}]),angular.module("emuwebApp").controller("ExportCtrl",["$scope","modalService","browserDetector","viewState","HistoryService",function(a,b,c,d,e){a.firefox=c.isBrowser.Firefox(),a.getBlob=function(){var c;try{c=new Blob([b.dataExport],{type:"text/plain"})}catch(d){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,c=new BlobBuilder,c.append(a.exportData),c=c.getBlob()}return c},a.updateHistoryService=function(){e.movesAwayFromLastSave=0},a.cursorInTextField=function(){d.setEditing(!0),d.setcursorInTextField(!0)},a.cursorOutOfTextField=function(){d.setEditing(!1),d.setcursorInTextField(!1)},a.export=function(){var c;c="object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.createObjectURL(a.getBlob()):URL.createObjectURL(a.getBlob()),a.SaveToDisk(c,b.dataIn),b.close()},a.SaveToDisk=function(b,c){var d=document.createElement("a");if(a.firefox)d.setAttribute("download",c),d.href=b,d.innerHTML="",d.style.display="none",document.body.appendChild(d),d.click();else{d.href=b,d.target="_blank",d.download=c||"unknown";var e=document.createEvent("Event");e.initEvent("click",!0,!0),d.dispatchEvent(e),(window.URL||window.webkitURL).revokeObjectURL(d.href)}a.updateHistoryService()}}]),angular.module("emuwebApp").factory("viewState",["$rootScope","$timeout","$window","Soundhandlerservice","DataService","StandardFuncsService",function(a,b,c,d,e,f){var g={},h={BARTLETT:1,BARTLETTHANN:2,BLACKMAN:3,COSINE:4,GAUSS:5,HAMMING:6,HANN:7,LANCZOS:8,RECTANGULAR:9,TRIANGULAR:10};return g.curLevelAttrDefs=[],g.initialize=function(){g.curViewPort={sS:0,eS:0,selectS:-1,selectE:-1,dragBarActive:!1,dragBarHeight:-1,windowWidth:void 0},g.spectroSettings={windowSizeInSecs:-1,rangeFrom:-1,rangeTo:-1,dynamicRange:-1,window:-1,drawHeatMapColors:-1,preEmphasisFilterFactor:-1},g.playHeadAnimationInfos={sS:-1,eS:-1,curS:null,endFreezeSample:-1},g.hierarchyState={selectedItemID:void 0,selectedLinkFromID:void 0,selectedLinkToID:void 0,editValue:void 0,inputFocus:!1,collapseInfo:{},contextMenuID:void 0,newLinkFromID:void 0,path:[],rotated:!1,playing:0},g.timelineSize=-1,g.somethingInProgress=!1,g.somethingInProgressTxt="",g.historyActionTxt="",g.editing=!1,g.cursorInTextField=!1,g.saving=!0,g.hierarchyShown=!1,g.submenuOpen=!1,g.rightSubmenuOpen=!1,g.curClickItems=[],g.curMousePosSample=0,g.curMouseLevelName=void 0,g.curMouseLevelType=void 0,g.curClickLevelName=void 0,g.curClickLevelType=void 0,g.lastPcm=void 0,g.curPreselColumnSample=2,g.curCorrectionToolNr=void 0,g.curClickLevelIndex=void 0,g.start=null,g.TransitionTime=void 0,g.showDropZone=!0,g.movingBoundary=!1,g.movingBoundarySample=void 0,g.focusInTextField=!1,g.curTaskPercCompl=0,g.curPerspectiveIdx=-1,g.mouseInEmuWebApp=!1,g.lastKeyCode=void 0,g.states=[],g.states.noDBorFilesloaded={permittedActions:["connectBtnClick","openDemoBtnDBclick"]},g.states.loadingSaving={permittedActions:[]},g.states.labeling={permittedActions:["zoom","playaudio","spectSettingsChange","addLevelSegBtnClick","addLevelPointBtnClick","renameSelLevelBtnClick","downloadTextGridBtnClick","downloadAnnotationBtnClick","spectSettingsChange","clearBtnClick","labelAction","toggleSideBars","saveBndlBtnClick","showHierarchyBtnClick","editDBconfigBtnClick"]},g.states.modalShowing=g.states.loadingSaving,g.prevState=g.states.noDBorFilesloaded,g.curState=g.states.noDBorFilesloaded,g.curLevelAttrDefs=[]},g.initialize(),g.getPermission=function(a){return g.curState.permittedActions.indexOf(a)>-1},g.setWindowWidth=function(a){this.curViewPort.windowWidth=a},g.setState=function(a){g.prevState=g.curState,g.curState="string"==typeof a?g.states[a]:a},g.updatePlayHead=function(b){d.player.isPlaying&&c.requestAnimationFrame(g.updatePlayHead),null===g.start&&(g.start=b);var e=Math.floor(b-g.start)/1e3*d.wavJSO.SampleRate;g.playHeadAnimationInfos.curS=Math.floor(g.playHeadAnimationInfos.sS+e),d.player.isPlaying&&g.playHeadAnimationInfos.curS<=g.playHeadAnimationInfos.eS?(-1!==g.playHeadAnimationInfos.curS&&(g.curMousePosSample=g.playHeadAnimationInfos.curS),a.$apply()):(g.curMousePosSample=g.playHeadAnimationInfos.endFreezeSample,g.playHeadAnimationInfos.sS=-1,g.playHeadAnimationInfos.eS=-1,g.playHeadAnimationInfos.curS=0,g.start=null)},g.animatePlayHead=function(a,b){g.playHeadAnimationInfos.sS=a,g.playHeadAnimationInfos.eS=b,g.playHeadAnimationInfos.endFreezeSample=b,g.playHeadAnimationInfos.curS=a,c.requestAnimationFrame(g.updatePlayHead)},g.select=function(a,b){g.curViewPort.selectS=a,g.curViewPort.selectE=b},g.resetSelect=function(){g.curViewPort.selectS=-1,g.curViewPort.selectE=-1},g.getViewPort=function(){return g.curViewPort},g.setspectroSettings=function(a,b,c,d,e,f,h,i){g.spectroSettings.windowSizeInSecs=a,g.spectroSettings.rangeFrom=parseInt(b,10),g.spectroSettings.rangeTo=parseInt(c,10),g.spectroSettings.dynamicRange=parseInt(d,10),g.setWindowFunction(e),g.spectroSettings.drawHeatMapColors=f,g.spectroSettings.preEmphasisFilterFactor=h,g.spectroSettings.heatMapColorAnchors=i},g.getSelect=function(){return[g.curViewPort.selectS,g.curViewPort.selectE]},g.selectDependent=function(a,b){a<this.curViewPort.selectS&&(this.curViewPort.selectS=a),b>this.curViewPort.selectE&&(this.curViewPort.selectE=b)},g.selectLevel=function(a,b,c){var d,e=g.getcurClickLevelName();if(void 0===e&&!a)return d=c.getLevelDetails(b[0]),void g.setcurClickLevel(d.level.name,d.level.type,0);if(void 0===e&&a)return d=c.getLevelDetails(b[b.length-1]),void g.setcurClickLevel(d.level.name,d.level.type,b.length-1);var f;b.forEach(function(a,b){a===e&&(f=b)}),void 0===f?(d=c.getLevelDetails(b[0]),g.setcurClickLevel(d.level.name,d.level.type,0),g.curClickItems=[],g.selectBoundary()):a?f+1<b.length&&(d=c.getLevelDetails(b[f+1]),g.setcurClickLevel(d.level.name,d.level.type,b.idxOfNow+1),g.curClickItems=[],g.selectBoundary()):f-1>=0&&(d=c.getLevelDetails(b[f-1]),g.setcurClickLevel(d.level.name,d.level.type,b.idxOfNow-1),g.curClickItems=[],g.selectBoundary())},g.setWindowFunction=function(a){switch(a){case"BARTLETT":g.spectroSettings.window=h.BARTLETT;break;case"BARTLETTHANN":g.spectroSettings.window=h.BARTLETTHANN;break;case"BLACKMAN":g.spectroSettings.window=h.BLACKMAN;break;case"COSINE":g.spectroSettings.window=h.COSINE;break;case"GAUSS":g.spectroSettings.window=h.GAUSS;break;case"HAMMING":g.spectroSettings.window=h.HAMMING;break;case"HANN":g.spectroSettings.window=h.HANN;break;case"LANCZOS":g.spectroSettings.window=h.LANCZOS;break;case"RECTANGULAR":g.spectroSettings.window=h.RECTANGULAR;break;case"TRIANGULAR":g.spectroSettings.window=h.TRIANGULAR;break;default:g.spectroSettings.window=h.BARTLETTHANN}},g.getWindowFunctions=function(){return h},g.getdragBarActive=function(){return this.curViewPort.dragBarActive},g.setdragBarActive=function(a){this.curViewPort.dragBarActive=a},g.getdragBarHeight=function(){return this.curViewPort.dragBarHeight},g.setdragBarHeight=function(a){this.curViewPort.dragBarHeight=a},g.getPos=function(a,b){return a*(b-this.curViewPort.sS)/(this.curViewPort.eS-this.curViewPort.sS+1)},g.getSampleDist=function(a){return this.getPos(a,this.curViewPort.sS+1)-this.getPos(a,this.curViewPort.sS)},g.togglesubmenuOpen=function(){this.submenuOpen=!this.submenuOpen},g.getsubmenuOpen=function(){return this.submenuOpen},g.setsubmenuOpen=function(a){this.submenuOpen=a},g.setenlarge=function(a){this.timelineSize=a},g.getenlarge=function(){return this.timelineSize},g.getTransitionTime=function(){return this.TransitionTime},g.setTransitionTime=function(a){this.TransitionTime=a},g.getRightsubmenuOpen=function(){return this.rightSubmenuOpen},g.setRightsubmenuOpen=function(a){this.rightSubmenuOpen=a},g.setcurClickLevel=function(a,b,c){this.setcurClickLevelName(a,c),this.setcurClickLevelType(b)},g.setcurClickLevelType=function(a){this.curClickLevelType=a},g.getcurClickLevelType=function(){return this.curClickLevelType},g.setcurClickLevelName=function(a,b){this.curClickLevelName=a,this.curClickLevelIndex=b},g.getcurClickLevelName=function(){return this.curClickLevelName},g.getcurClickLevelIndex=function(){return this.curClickLevelIndex},g.getcurClickNeighbours=function(){return this.curClickNeighbours},g.setcurMouseLevelName=function(a){this.curMouseLevelName=a},g.getcurMouseLevelName=function(){return this.curMouseLevelName},g.setcurMouseLevelType=function(a){this.curMouseLevelType=a},g.getcurMouseLevelType=function(){return this.curMouseLevelType},g.setcurMouseItem=function(a,b,c,d,e){this.curMouseItem=a,this.curMouseX=c,this.curMouseNeighbours=b,this.curMouseisFirst=d,this.curMouseisLast=e},g.getcurMouseItem=function(){return this.curMouseItem},g.getcurMouseisFirst=function(){return this.curMouseisFirst},g.getcurMouseisLast=function(){return this.curMouseisLast},g.getcurMouseNeighbours=function(){return this.curMouseNeighbours},g.selectItemsInSelection=function(a){g.curClickItems=[];var b=1/0,c=-1/0,d=this.getItemsInSelection(a);angular.forEach(d,function(a){a.sampleStart<b&&(b=a.sampleStart),a.sampleStart+a.sampleDur+1>c&&(c=a.sampleStart+a.sampleDur+1),g.setcurClickItemMultiple(a,g.curClickLevelType)}),g.curViewPort.selectS=b,g.curViewPort.selectE=c},g.getItemsInSelection=function(a){var b=[],c=g.curViewPort.selectS,d=g.curViewPort.selectE;return angular.forEach(a,function(a){a.name===g.getcurClickLevelName()&&angular.forEach(a.items,function(a){a.sampleStart>=c&&a.sampleStart+a.sampleDur<=d&&b.push(a),a.samplePoint>=c&&a.samplePoint<=d&&b.push(a)})}),b},g.setcurClickItem=function(a){null!==a&&void 0!==a?(g.curClickItems=[],g.curClickItems.push(a),g.selectBoundary()):g.curClickItems=[]},g.selectBoundary=function(){if(g.curClickItems.length>0){var a=g.curClickItems[0].sampleStart||g.curClickItems[0].samplePoint,b=g.curClickItems[g.curClickItems.length-1].sampleStart+g.curClickItems[g.curClickItems.length-1].sampleDur||g.curClickItems[0].samplePoint;g.curClickItems.forEach(function(c){c.sampleStart<=a&&(a=c.sampleStart),c.sampleStart+c.sampleDur>=b&&(b=c.sampleStart+c.sampleDur)}),g.select(a,b+1)}},g.setcurClickItemMultiple=function(a,b){var c=!0;if("SEGMENT"===b){var d=a.sampleStart,e=d+a.sampleDur+1;g.curClickItems.forEach(function(b){var f=b.sampleStart===e?!0:!1,h=b.sampleStart+b.sampleDur+1===d?!0:!1;(f||h)&&-1===g.curClickItems.indexOf(a)&&(g.curClickItems.push(a),c=!1)}),c?(g.curClickItems=[],g.curClickItems.push(a)):g.curClickItems.sort(g.sortbystart)}},g.sortbystart=function(a,b){return a.sampleStart>b.sampleStart?1:a.sampleStart<b.sampleStart?-1:0},g.sortbypoint=function(a,b){return a.samplePoint>b.samplePoint?1:a.samplePoint<b.samplePoint?-1:0},g.getselectedRange=function(){return this.curClickItems.length>1?{start:this.curClickItems[0].sampleStart,end:this.curClickItems[this.curClickItems.length-1].sampleStart+this.curClickItems[this.curClickItems.length-1].sampleDur}:1===this.curClickItems.length?void 0!==this.curClickItems[0].sampleStart?{start:this.curClickItems[0].sampleStart,end:this.curClickItems[0].sampleStart+this.curClickItems[0].sampleDur}:{start:this.curClickItems[0].samplePoint,end:this.curClickItems[0].samplePoint}:{start:-1,end:-1}},g.getcurClickItems=function(){return this.curClickItems},g.getselected=function(){return this.curClickItems},g.isEditing=function(){return this.editing},g.setEditing=function(a){this.editing=a},g.getLasPcm=function(){return this.lastPcm},g.setLastPcm=function(a){this.lastPcm=a},g.isHierarchyRotated=function(){return g.hierarchyState.rotated},g.toggleHierarchyRotation=function(){g.hierarchyState.rotated=!g.hierarchyState.rotated},g.toggleHierarchy=function(){g.hierarchyShown=!g.hierarchyShown,g.hierarchyShown===!1&&(console.debug("Hierarchy modal was closed, cleaning up underscore attributes"),f.traverseAndClean(e.getData()))},g.hierarchyState.contextMenuIsOpen=function(){return void 0!==g.hierarchyState.contextMenuID},g.hierarchyState.closeContextMenu=function(){g.hierarchyState.contextMenuID=void 0},g.hierarchyState.getContextMenuID=function(){return g.hierarchyState.contextMenuID},g.hierarchyState.setContextMenuID=function(a){g.hierarchyState.contextMenuID=a},g.hierarchyState.getInputFocus=function(){return g.hierarchyState.inputFocus},g.hierarchyState.setInputFocus=function(a){g.hierarchyState.inputFocus=a},g.hierarchyState.getEditValue=function(){return g.hierarchyState.editValue},g.hierarchyState.setEditValue=function(a){g.hierarchyState.editValue=a},g.getCollapsed=function(a){return"undefined"==typeof g.hierarchyState.collapseInfo[a]?!1:"boolean"==typeof g.hierarchyState.collapseInfo[a].collapsed?g.hierarchyState.collapseInfo[a].collapsed:!1},g.getCollapsePosition=function(a){return"undefined"==typeof g.hierarchyState.collapseInfo[a]?void 0:"object"==typeof g.hierarchyState.collapseInfo[a].collapsePosition?g.hierarchyState.collapseInfo[a].collapsePosition:void 0},g.getNumCollapsedParents=function(a){return"undefined"==typeof g.hierarchyState.collapseInfo[a]?0:"number"==typeof g.hierarchyState.collapseInfo[a].numCollapsedParents?g.hierarchyState.collapseInfo[a].numCollapsedParents:0},g.setCollapsed=function(a,b){"undefined"==typeof g.hierarchyState.collapseInfo[a]&&(g.hierarchyState.collapseInfo[a]={}),g.hierarchyState.collapseInfo[a].collapsed=b},g.setCollapsePosition=function(a,b){"undefined"==typeof g.hierarchyState.collapseInfo[a]&&(g.hierarchyState.collapseInfo[a]={}),g.hierarchyState.collapseInfo[a].collapsePosition=b},g.setNumCollapsedParents=function(a,b){"undefined"==typeof g.hierarchyState.collapseInfo[a]&&(g.hierarchyState.collapseInfo[a]={}),g.hierarchyState.collapseInfo[a].numCollapsedParents=b},g.getcursorInTextField=function(){return this.cursorInTextField},g.setcursorInTextField=function(a){this.cursorInTextField=a},g.isSavingAllowed=function(){return this.saving},g.setSavingAllowed=function(a){this.saving=a},g.countSelected=function(){return this.curClickItems.length},g.getCurrentSample=function(a){return this.curViewPort.sS+(this.curViewPort.eS-this.curViewPort.sS)*a},g.getCurrentPercent=function(a){return a*(100/(this.curViewPort.eS-this.curViewPort.sS)/100)},g.getSamplesPerPixelVal=function(a){var b=parseFloat(this.curViewPort.sS),c=parseFloat(this.curViewPort.eS);return(c-b)/a.originalEvent.target.width},g.getViewPortStartTime=function(){return 1*this.curViewPort.sS/d.wavJSO.SampleRate-.5/d.wavJSO.SampleRate},g.getViewPortEndTime=function(){return 1*this.curViewPort.eS/d.wavJSO.SampleRate+.5/d.wavJSO.SampleRate},g.getSelectedStartTime=function(){return 1*this.curViewPort.selectS/d.wavJSO.SampleRate-.5/d.wavJSO.SampleRate},g.getSelectedEndTime=function(){return 1*this.curViewPort.selectE/d.wavJSO.SampleRate+.5/d.wavJSO.SampleRate},g.setViewPort=function(a,b){var c=this.curViewPort.sS,e=this.curViewPort.eS;void 0!==a&&(this.curViewPort.sS=Math.round(a)),void 0!==b&&(this.curViewPort.eS=Math.round(b)),c>this.curViewPort.sS&&e>this.curViewPort.eS&&this.curViewPort.sS<0&&(this.curViewPort.sS=0,this.curViewPort.eS=e+Math.abs(this.curViewPort.sS)),c<this.curViewPort.sS&&e<this.curViewPort.eS&&this.curViewPort.eS>d.wavJSO.Data.length&&(this.curViewPort.sS=c,this.curViewPort.eS=d.wavJSO.Data.length),this.curViewPort.sS<0&&(this.curViewPort.sS=0),this.curViewPort.eS>d.wavJSO.Data.length&&(this.curViewPort.eS=d.wavJSO.Data.length),this.curViewPort.eS-this.curViewPort.sS<4&&(this.curViewPort.sS=c,this.curViewPort.eS=e)},g.zoomViewPort=function(a,b){var c,d,e,f=this.getcurMouseItem(),h=this.curViewPort.eS-this.curViewPort.sS,i=!1;if(void 0!==f){this.getcurMouseisFirst()?f=b.getItemDetails(g.getcurMouseLevelName(),0):this.getcurMouseisLast()&&(f=b.getLastItem(g.getcurMouseLevelName()),i=!0),e="SEGMENT"===this.getcurMouseLevelType()?i?f.sampleStart+f.sampleDur:f.sampleStart:f.samplePoint;var j=e-this.curViewPort.sS,k=this.curViewPort.eS-e;a?(c=this.curViewPort.sS+.5*j,d=this.curViewPort.eS-.5*k):(c=this.curViewPort.sS-.5*j,d=this.curViewPort.eS+.5*k)}else a?(c=this.curViewPort.sS+~~(h/4),d=this.curViewPort.eS-~~(h/4)):(c=this.curViewPort.sS-~~(h/4),d=this.curViewPort.eS+~~(h/4));this.setViewPort(c,d)},g.shiftViewPort=function(a){var b,c;a?(b=this.curViewPort.sS+~~((this.curViewPort.eS-this.curViewPort.sS)/4),c=this.curViewPort.eS+~~((this.curViewPort.eS-this.curViewPort.sS)/4)):(b=this.curViewPort.sS-~~((this.curViewPort.eS-this.curViewPort.sS)/4),c=this.curViewPort.eS-~~((this.curViewPort.eS-this.curViewPort.sS)/4)),this.setViewPort(b,c)},g.setCurLevelAttrDefs=function(a){angular.forEach(a,function(a){g.curLevelAttrDefs.push({levelName:a.name,curAttrDefName:a.name})})},g.setCurAttrDef=function(a,b,c){angular.forEach(g.curLevelAttrDefs,function(d){d.levelName===a&&(d.curAttrDefName=b,d.curAttrDefIndex=c)})},g.getCurAttrDef=function(a){var b;return angular.forEach(g.curLevelAttrDefs,function(c){c.levelName===a&&(b=c.curAttrDefName)}),b},g.getCurAttrIndex=function(a){var b;return angular.forEach(g.curLevelAttrDefs,function(c){c.levelName===a&&(b=void 0===c.curAttrDefIndex?0:c.curAttrDefIndex)}),b},g.setlastKeyCode=function(a){this.lastKeyCode=a},g.getX=function(a){return(a.offsetX||a.originalEvent.layerX)*(a.originalEvent.target.width/a.originalEvent.target.clientWidth)},g.getY=function(a){return(a.offsetY||a.originalEvent.layerY)*(a.originalEvent.target.height/a.originalEvent.target.clientHeight)},g.resetToInitState=function(){g.initialize()},g.getColorOfAnchor=function(a,b){var c={"background-color":"rgb("+a[b][0]+","+a[b][1]+","+a[b][2]+")",width:"10px",height:"10px"};return c},g}]),angular.module("emuwebApp").directive("trackMouseInLevel",["$document","viewState","LevelService","ConfigProviderService","HistoryService","Soundhandlerservice",function(a,b,c,d,e,f){return{restrict:"A",replace:!0,scope:{levelName:"=",levelType:"="},link:function(g,h){g.lastEventClick=void 0,g.lastEventMove=void 0,g.lastNeighboursMove=void 0,g.lastPCM=void 0,g.curMouseSampleNrInView=void 0,h.bind("click",function(a){a.preventDefault(),g.setLastMove(a,!0),g.setLastClick(a)}),h.bind("contextmenu",function(a){a.preventDefault(),g.setLastMove(a,!0),g.setLastRightClick(a)}),h.bind("dblclick",function(a){g.setLastMove(a,!0),d.vals.restrictions.editItemName?g.setLastDblClick(a):g.setLastClick(a)}),h.bind("mousemove",function(a){if(!b.getdragBarActive()){var h=!0,i=b.getSamplesPerPixelVal(a);g.curMouseSampleNrInView=b.getX(a)*i;var j=g.curMouseSampleNrInView-g.lastPCM;if(1>=i){var k=c.getClosestItem(g.curMouseSampleNrInView+b.curViewPort.sS,g.levelName,f.wavJSO.Data.length);if("SEGMENT"===g.levelType)if(k.isFirst===!0&&k.isLast===!1)j=Math.ceil(g.curMouseSampleNrInView+b.curViewPort.sS-c.getItemDetails(g.levelName,0).sampleStart);else if(k.isFirst===!1&&k.isLast===!0){var l=c.getLastItem(g.levelName);j=Math.ceil(g.curMouseSampleNrInView+b.curViewPort.sS-l.sampleStart-l.sampleDur)}else j=Math.ceil(g.curMouseSampleNrInView+b.curViewPort.sS-c.getItemFromLevelById(g.levelName,k.nearest.id).sampleStart);else j=Math.ceil(g.curMouseSampleNrInView+b.curViewPort.sS-c.getItemFromLevelById(g.levelName,k.nearest.id).samplePoint-.5)}else j=Math.round(g.curMouseSampleNrInView-g.lastPCM)}var m=0;switch(m=void 0===a.buttons?a.which:a.buttons){case 1:break;case 2:break;case 3:break;default:if(!b.getdragBarActive())if(d.vals.restrictions.editItemSize&&a.shiftKey){c.deleteEditArea();var n=b.getcurMouseItem();if(void 0!==n){if(b.movingBoundary=!0,"SEGMENT"===g.levelType){if(b.getcurMouseisFirst()||b.getcurMouseisLast()){var o;b.getcurMouseisFirst()?(o=c.getItemDetails(g.levelName,0),b.movingBoundarySample=o.sampleStart+j):b.getcurMouseisLast()&&(o=c.getLastItem(g.levelName),b.movingBoundarySample=o.sampleStart+o.sampleDur+j)}else b.movingBoundarySample=n.sampleStart+j,o=n;c.moveBoundary(g.levelName,o.id,j,b.getcurMouseisFirst(),b.getcurMouseisLast()),e.updateCurChangeObj({type:"ANNOT",action:"MOVEBOUNDARY",name:g.levelName,id:o.id,movedBy:j,isFirst:b.getcurMouseisFirst(),isLast:b.getcurMouseisLast()})}else o=n,b.movingBoundarySample=n.samplePoint+j,c.moveEvent(g.levelName,o.id,j),e.updateCurChangeObj({type:"ANNOT",action:"MOVEEVENT",name:g.levelName,id:o.id,movedBy:j});g.lastPCM=g.curMouseSampleNrInView,b.setLastPcm(g.lastPCM),b.selectBoundary(),h=!1}}else d.vals.restrictions.editItemSize&&a.altKey?(c.deleteEditArea(),"SEGMENT"==g.levelType&&(o=b.getcurClickItems(),c.moveSegment(g.levelName,o[0].id,o.length,j),e.updateCurChangeObj({type:"ANNOT",action:"MOVESEGMENT",name:g.levelName,id:o[0].id,length:o.length,movedBy:j}),g.lastPCM=g.curMouseSampleNrInView,b.setLastPcm(g.lastPCM),b.selectBoundary())):b.movingBoundary=!1}b.getdragBarActive()||g.setLastMove(a,h)}),h.bind("mousedown",function(a){b.movingBoundary=!0,g.setLastMove(a,!0)}),h.bind("mouseup",function(a){b.movingBoundary=!1,g.setLastMove(a,!0)}),h.bind("mouseout",function(a){b.movingBoundary=!1,g.setLastMove(a,!0)}),g.setLastClick=function(a){g.curMouseSampleNrInView=b.getX(a)*b.getSamplesPerPixelVal(a),c.deleteEditArea(),b.setEditing(!1),g.lastEventClick=c.getClosestItem(g.curMouseSampleNrInView+b.curViewPort.sS,g.levelName,f.wavJSO.Data.length),void 0!==g.lastEventClick.current&&void 0!==g.lastEventClick.nearest&&(c.setlasteditArea("_"+g.lastEventClick.current.id),c.setlasteditAreaElem(h.parent()),b.setcurClickLevel(g.levelName,g.levelType,g.$index),b.setcurClickItem(g.lastEventClick.current)),g.lastPCM=g.curMouseSampleNrInView,b.setLastPcm(g.lastPCM),g.$apply()},g.setLastRightClick=function(a){b.getcurClickLevelName()!==g.levelName&&g.setLastClick(a),g.curMouseSampleNrInView=b.getX(a)*b.getSamplesPerPixelVal(a),c.deleteEditArea(),g.lastEventClick=c.getClosestItem(g.curMouseSampleNrInView+b.curViewPort.sS,g.levelName,f.wavJSO.Data.length),void 0!==g.lastEventClick.current&&void 0!==g.lastEventClick.nearest&&(b.setcurClickLevel(g.levelName,g.levelType,g.$index),b.setcurClickItemMultiple(g.lastEventClick.current,g.levelType),b.selectBoundary()),g.lastPCM=g.curMouseSampleNrInView,b.setLastPcm(g.lastPCM),g.$apply()},g.setLastDblClick=function(d){g.curMouseSampleNrInView=b.getX(d)*b.getSamplesPerPixelVal(d),g.lastEventClick=c.getClosestItem(g.curMouseSampleNrInView+b.curViewPort.sS,g.levelName,f.wavJSO.Data.length);var e="25px"===h.parent().css("height")?!1:!0;e||a.find("#emuwebapp-level-button-resize").click(),void 0!==g.lastEventClick.current&&void 0!==g.lastEventClick.nearest&&b.getPermission("labelAction")&&("SEGMENT"===g.levelType?g.lastEventClick.current.sampleStart>=b.curViewPort.sS?g.lastEventClick.current.sampleStart+g.lastEventClick.current.sampleDur<=b.curViewPort.eS?(b.setcurClickLevel(g.levelName,g.levelType,g.$index),b.setcurClickItem(g.lastEventClick.current),c.setlasteditArea("_"+g.lastEventClick.current.id),c.setlasteditAreaElem(h.parent()),b.setEditing(!0),c.openEditArea(g.lastEventClick.current,h.parent(),g.levelType)):console.log("Editing out of right bound !"):console.log("Editing out of left bound !"):(b.setcurClickLevel(g.levelName,g.levelType,g.$index),b.setcurClickItem(g.lastEventClick.current),c.setlasteditArea("_"+g.lastEventClick.current.id),c.setlasteditAreaElem(h.parent()),b.setEditing(!0),c.openEditArea(g.lastEventClick.current,h.parent(),g.levelType),b.setEditing(!0))),g.lastPCM=g.curMouseSampleNrInView,b.setLastPcm(g.lastPCM),g.$apply()},g.setLastMove=function(a,d){g.curMouseSampleNrInView=b.getX(a)*b.getSamplesPerPixelVal(a),g.lastEventMove=c.getClosestItem(g.curMouseSampleNrInView+b.curViewPort.sS,g.levelName,f.wavJSO.Data.length),d&&void 0!==g.lastEventMove.current&&void 0!==g.lastEventMove.nearest&&(g.lastNeighboursMove=c.getItemNeighboursFromLevel(g.levelName,g.lastEventMove.nearest.id,g.lastEventMove.nearest.id),b.setcurMouseItem(g.lastEventMove.nearest,g.lastNeighboursMove,g.lastPCM,g.lastEventMove.isFirst,g.lastEventMove.isLast)),b.setcurMouseLevelName(g.levelName),b.setcurMouseLevelType(g.levelType),g.lastPCM=g.curMouseSampleNrInView,b.setLastPcm(g.lastPCM),g.$apply()}}}}]),angular.module("emuwebApp").directive("handleglobalkeystrokes",["$timeout","viewState","modalService","HierarchyManipulationService","Soundhandlerservice","ConfigProviderService","HistoryService","LevelService","DataService","LinkService","AnagestService",function(a,b,c,d,e,f,g,h,i,j,k){return{restrict:"A",link:function(a){$(document).bind("keyup",function(c){var d=c.keyCode?c.keyCode:c.which;b.isEditing()&&!b.getcursorInTextField()&&a.applyKeyCodeUp(d,c)}),$(document).bind("keydown",function(b){if(!a.firefox){var c=b.keyCode?b.keyCode:b.which;(8==c||9==c||27==c||37==c||38==c||39==c||40==c||32==c)&&a.applyKeyCode(c,b)}}),$(document).bind("keypress",function(b){var c=b.keyCode?b.keyCode:b.which;a.applyKeyCode(c,b)}),a.applyKeyCodeUp=function(c){a.$apply(function(){if(c!==f.vals.keyMappings.esc&&c!==f.vals.keyMappings.createNewItemAtSelection){var a=$("."+h.getlasteditArea()),d=a.val();b.setSavingAllowed(!0);var e=b.getCurAttrIndex(b.getcurClickLevelName()),g=f.getLevelDefinition(b.getcurClickLevelName()),i={};void 0!==g.attributeDefinitions&&g.attributeDefinitions.length>0&&(i=f.getLevelDefinition(b.getcurClickLevelName()).attributeDefinitions[e]),void 0!==i.legalLabels&&d.length>0&&i.legalLabels.indexOf(d)<0&&b.setSavingAllowed(!1),a.css(b.isSavingAllowed()?{"background-color":"rgba(255,255,0,1)"}:{"background-color":"rgba(255,0,0,1)"})}})},a.applyKeyCode=function(d,l){a.$apply(function(){if(!f.vals.main.catchMouseForKeyBinding||b.mouseInEmuWebApp)if(b.setlastKeyCode(d),b.hierarchyShown)if(b.hierarchyState.getInputFocus()){if(d===f.vals.keyMappings.hierarchyCommitEdit){var m,n=b.hierarchyState.getContextMenuID(),o=h.getItemByID(n),p=h.getLevelNameByElementID(n),q=b.getCurAttrIndex(p),r=f.getLevelDefinition(p).attributeDefinitions[q].legalLabels,s=b.hierarchyState.getEditValue();m=void 0!==o.labels[q]?o.labels[q].value:"",(void 0===r||s.length>0&&r.indexOf(s)>=0)&&(h.renameLabel(p,n,q,s),g.addObjToUndoStack({type:"ANNOT",action:"RENAMELABEL",name:p,id:n,attrIndex:q,oldValue:m,newValue:s}),b.hierarchyState.closeContextMenu())}d===f.vals.keyMappings.hierarchyCancelEdit&&b.hierarchyState.closeContextMenu()}else{if(d===f.vals.keyMappings.hierarchyDeleteLink&&l.preventDefault(),d===f.vals.keyMappings.hierarchyPlayback&&(b.hierarchyState.playing+=1),d===f.vals.keyMappings.hierarchyRotate&&b.toggleHierarchyRotation(),d===f.vals.keyMappings.hierarchyDeleteLink){var t=j.deleteLink(b.hierarchyState.selectedLinkFromID,b.hierarchyState.selectedLinkToID);-1!==t&&g.addObjToUndoStack({type:"HIERARCHY",action:"DELETELINK",fromID:b.hierarchyState.selectedLinkFromID,toID:b.hierarchyState.selectedLinkToID,position:t})}if(d===f.vals.keyMappings.hierarchyDeleteItem){var u=h.deleteItemWithLinks(b.hierarchyState.selectedItemID);void 0!==u.item&&g.addObjToUndoStack({type:"HIERARCHY",action:"DELETEITEM",item:u.item,levelName:u.levelName,position:u.position,deletedLinks:u.deletedLinks})}if(d===f.vals.keyMappings.hierarchyAddItemBefore){var v=h.addItem(b.hierarchyState.selectedItemID,!0);-1!==v&&g.addObjToUndoStack({type:"HIERARCHY",action:"ADDITEM",newID:v,neighborID:b.hierarchyState.selectedItemID,before:!0})}if(d===f.vals.keyMappings.hierarchyAddItemAfter){var v=h.addItem(b.hierarchyState.selectedItemID,!1);-1!==v&&g.addObjToUndoStack({type:"HIERARCHY",action:"ADDITEM",newID:v,neighborID:b.hierarchyState.selectedItemID,before:!1})}d===f.vals.keyMappings.undo&&g.undo(),d===f.vals.keyMappings.redo&&g.redo(),(d===f.vals.keyMappings.esc||d===f.vals.keyMappings.showHierarchy)&&c.close()}else if(b.isEditing()){var w=$("."+h.getlasteditArea());if(!b.isSavingAllowed()&&d===f.vals.keyMappings.createNewItemAtSelection){var x=f.getLevelDefinition(b.getcurClickLevelName()).attributeDefinitions[b.getCurAttrIndex(b.getcurClickLevelName())].legalLabels;l.preventDefault(),l.stopPropagation(),h.deleteEditArea(),b.setEditing(!1),c.open("views/error.html",'Editing Error: Sorry, characters allowed on this Level are "'+JSON.stringify(x)+'"')}if(b.isSavingAllowed()&&d===f.vals.keyMappings.createNewItemAtSelection){var y=h.getItemFromLevelById(b.getcurClickLevelName(),h.getlastID()),q=b.getCurAttrIndex(b.getcurClickLevelName()),m="";void 0!==y.labels[q]&&(m=y.labels[q].value),h.renameLabel(b.getcurClickLevelName(),h.getlastID(),b.getCurAttrIndex(b.getcurClickLevelName()),w.val()),g.addObjToUndoStack({type:"ANNOT",action:"RENAMELABEL",name:b.getcurClickLevelName(),id:h.getlastID(),attrIndex:q,oldValue:m,newValue:w.val()}),h.deleteEditArea(),b.setEditing(!1),b.setcurClickItem(h.getItemFromLevelById(b.getcurClickLevelName(),h.getlastID()))}d===f.vals.keyMappings.esc&&(h.deleteEditArea(),b.setEditing(!1))}else if(b.getcursorInTextField()===!1){if(h.deleteEditArea(),0===b.curState.permittedActions.length&&d===f.vals.keyMappings.esc&&c.force===!1&&c.close(),d===f.vals.keyMappings.showHierarchy&&f.vals.activeButtons.showHierarchy&&b.curState!==b.states.noDBorFilesloaded&&(b.hierarchyShown?c.close():(b.toggleHierarchy(),c.open("views/showHierarchyModal.html"))),d===f.vals.keyMappings.zoomAll&&b.getPermission("zoom")&&b.setViewPort(0,e.wavJSO.Data.length),d===f.vals.keyMappings.zoomIn&&b.getPermission("zoom")&&b.zoomViewPort(!0,h),d===f.vals.keyMappings.zoomOut&&b.getPermission("zoom")&&b.zoomViewPort(!1,h),d===f.vals.keyMappings.zoomSel&&b.getPermission("zoom")&&b.setViewPort(b.curViewPort.selectS,b.curViewPort.selectE),d===f.vals.keyMappings.shiftViewPortLeft&&b.getPermission("zoom")&&b.shiftViewPort(!1),d===f.vals.keyMappings.shiftViewPortRight&&b.getPermission("zoom")&&b.shiftViewPort(!0),d===f.vals.keyMappings.playEntireFile&&b.getPermission("playaudio")&&f.vals.restrictions.playback&&(e.playFromTo(0,e.wavJSO.Data.length),b.animatePlayHead(0,e.wavJSO.Data.length)),d===f.vals.keyMappings.playAllInView&&b.getPermission("playaudio")&&f.vals.restrictions.playback&&(e.playFromTo(b.curViewPort.sS,b.curViewPort.eS),b.animatePlayHead(b.curViewPort.sS,b.curViewPort.eS)),d===f.vals.keyMappings.playSelected&&b.getPermission("playaudio")&&f.vals.restrictions.playback&&(e.playFromTo(b.curViewPort.selectS,b.curViewPort.selectE),b.animatePlayHead(b.curViewPort.selectS,b.curViewPort.selectE)),d===f.vals.keyMappings.selectFirstContourCorrectionTool&&b.getPermission("labelAction")&&f.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=1),d===f.vals.keyMappings.selectSecondContourCorrectionTool&&b.getPermission("labelAction")&&f.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=2),d===f.vals.keyMappings.selectThirdContourCorrectionTool&&b.getPermission("labelAction")&&f.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=3),d===f.vals.keyMappings.selectFourthContourCorrectionTool&&b.getPermission("labelAction")&&f.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=4),d===f.vals.keyMappings.selectNoContourCorrectionTool&&b.getPermission("labelAction")&&f.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=void 0),d===f.vals.keyMappings.levelUp&&b.getPermission("labelAction")&&b.selectLevel(!1,f.vals.perspectives[b.curPerspectiveIdx].levelCanvases.order,h),d===f.vals.keyMappings.levelDown&&b.getPermission("labelAction")&&b.selectLevel(!0,f.vals.perspectives[b.curPerspectiveIdx].levelCanvases.order,h),d===f.vals.keyMappings.snapBoundaryToNearestTopBoundary&&b.getPermission("labelAction")&&f.vals.restrictions.editItemSize){var z=b.getcurMouseItem(),p=b.getcurMouseLevelName(),A=b.getcurMouseLevelType(),B=b.getcurMouseNeighbours(),C=h.snapBoundary(!0,p,z,B,A);
C===!1||("EVENT"===A?g.updateCurChangeObj({type:"ANNOT",action:"MOVEEVENT",name:p,id:z.id,movedBy:C}):"SEGMENT"===A&&g.updateCurChangeObj({type:"ANNOT",action:"MOVEBOUNDARY",name:p,id:z.id,movedBy:C,position:0}),g.addCurChangeObjToUndoStack())}if(d===f.vals.keyMappings.snapBoundaryToNearestBottomBoundary&&b.getPermission("labelAction")&&f.vals.restrictions.editItemSize){var z=b.getcurMouseItem(),p=b.getcurMouseLevelName(),A=b.getcurMouseLevelType(),B=b.getcurMouseNeighbours(),C=h.snapBoundary(!1,p,z,B,A);0==C||("EVENT"===A?g.updateCurChangeObj({type:"ANNOT",action:"MOVEEVENT",name:p,id:z.id,movedBy:C}):"SEGMENT"===A&&g.updateCurChangeObj({type:"ANNOT",action:"MOVEBOUNDARY",name:p,id:z.id,movedBy:C,position:0}),g.addCurChangeObjToUndoStack())}if(d===f.vals.keyMappings.snapBoundaryToNearestZeroCrossing&&b.getPermission("labelAction")&&f.vals.restrictions.editItemSize){var D;if(D=h.calcDistanceToNearestZeroCrossing("SEGMENT"===b.getcurMouseLevelType()?b.getcurMouseItem().sampleStart:b.getcurMouseItem().samplePoint),0!==D){var E=b.getcurMouseItem(),F=(b.getcurMouseNeighbours(),b.getcurMouseLevelName());h.moveBoundary(F,E.id,D,0),g.updateCurChangeObj({type:"ANNOT",action:"MOVEBOUNDARY",name:F,id:E.id,movedBy:D,position:0}),g.addCurChangeObjToUndoStack()}}if(d===f.vals.keyMappings.expandSelSegmentsRight&&b.getPermission("labelAction")&&f.vals.restrictions.editItemSize)if(void 0===b.getcurClickLevelName())c.open("views/error.html","Expand Segments Error: Please select a Level first");else if(0===b.getselected().length)c.open("views/error.html","Expand Segments Error: Please select one or more Segments first");else{var G=parseInt(f.vals.labelCanvasConfig.addTimeValue,10);"relative"===f.vals.labelCanvasConfig.addTimeMode&&(G=f.vals.labelCanvasConfig.addTimeValue*(e.wavJSO.Data.length/100)),h.expandSegment(!0,b.getcurClickItems(),b.getcurClickLevelName(),G),g.addObjToUndoStack({type:"ANNOT",action:"EXPANDSEGMENTS",name:b.getcurClickLevelName(),item:b.getcurClickItems(),rightSide:!0,changeTime:G}),b.selectBoundary()}if(d===f.vals.keyMappings.expandSelSegmentsLeft&&b.getPermission("labelAction")&&f.vals.restrictions.editItemSize)if(void 0===b.getcurClickLevelName())c.open("views/error.html","Expand Segments Error: Please select a Level first");else if(0===b.getselected().length)c.open("views/error.html","Expand Segments Error: Please select one or more Segments first");else{if("absolute"===f.vals.labelCanvasConfig.addTimeMode)var G=parseInt(f.vals.labelCanvasConfig.addTimeValue,10);else if("relative"===f.vals.labelCanvasConfig.addTimeMode)var G=f.vals.labelCanvasConfig.addTimeValue*(e.wavJSO.Data.length/100);else c.open("views/error.html","Expand Segements Error: Error in Configuration (Value labelCanvasConfig.addTimeMode)");h.expandSegment(!1,b.getcurClickItems(),b.getcurClickLevelName(),G),g.addObjToUndoStack({type:"ANNOT",action:"EXPANDSEGMENTS",name:b.getcurClickLevelName(),item:b.getcurClickItems(),rightSide:!1,changeTime:G}),b.selectBoundary()}if(d===f.vals.keyMappings.shrinkSelSegmentsLeft&&b.getPermission("labelAction")&&f.vals.restrictions.editItemSize)if(void 0===b.getcurClickLevelName())c.open("views/error.html","Expand Segments Error: Please select a Level first");else if(0===b.getselected().length)c.open("views/error.html","Expand Segments Error: Please select one or more Segments first");else{if("absolute"===f.vals.labelCanvasConfig.addTimeMode)var G=parseInt(f.vals.labelCanvasConfig.addTimeValue,10);else if("relative"===f.vals.labelCanvasConfig.addTimeMode)var G=f.vals.labelCanvasConfig.addTimeValue*(e.wavJSO.Data.length/100);else c.open("views/error.html","Expand Segements Error: Error in Configuration (Value labelCanvasConfig.addTimeMode)");h.expandSegment(!0,b.getcurClickItems(),b.getcurClickLevelName(),-G),g.addObjToUndoStack({type:"ANNOT",action:"EXPANDSEGMENTS",name:b.getcurClickLevelName(),item:b.getcurClickItems(),rightSide:!0,changeTime:-G}),b.selectBoundary()}if(d===f.vals.keyMappings.shrinkSelSegmentsRight&&b.getPermission("labelAction")&&f.vals.restrictions.editItemSize)if(void 0===b.getcurClickLevelName())c.open("views/error.html","Expand Segments Error: Please select a Level first");else if(0===b.getselected().length)c.open("views/error.html","Expand Segments Error: Please select one or more Segments first");else{if("absolute"===f.vals.labelCanvasConfig.addTimeMode)var G=parseInt(f.vals.labelCanvasConfig.addTimeValue,10);else if("relative"===f.vals.labelCanvasConfig.addTimeMode)var G=f.vals.labelCanvasConfig.addTimeValue*(e.wavJSO.Data.length/100);else c.open("views/error.html","Expand Segements Error: Error in Configuration (Value labelCanvasConfig.addTimeMode)");h.expandSegment(!1,b.getcurClickItems(),b.getcurClickLevelName(),-G),g.addObjToUndoStack({type:"ANNOT",action:"EXPANDSEGMENTS",name:b.getcurClickLevelName(),item:b.getcurClickItems(),rightSide:!1,changeTime:-G}),b.selectBoundary()}if(d===f.vals.keyMappings.toggleSideBarLeft&&b.getPermission("toggleSideBars")&&f.vals.activeButtons.openMenu&&b.togglesubmenuOpen(f.design.animation.period),d===f.vals.keyMappings.toggleSideBarRight&&b.getPermission("toggleSideBars")&&f.vals.activeButtons.openMenu&&b.setRightsubmenuOpen(!b.getRightsubmenuOpen()),d===f.vals.keyMappings.selectItemsInSelection&&b.getPermission("labelAction")&&(void 0===b.getcurClickLevelName()?c.open("views/error.html","Selection Error : Please select a Level first"):b.selectItemsInSelection(i.data.levels)),d===f.vals.keyMappings.selPrevItem&&b.getPermission("labelAction")&&b.getcurClickItems().length>0){var H=b.getcurClickItems()[0].id,I=b.getcurClickItems()[b.getcurClickItems().length-1].id,J=h.getItemNeighboursFromLevel(b.getcurClickLevelName(),H,I);void 0!==J.left&&(void 0!==J.left.sampleStart?J.left.sampleStart>b.curViewPort.sS&&(l.shiftKey?(b.setcurClickItemMultiple(J.left),h.setlasteditArea("_"+J.left.id),b.selectBoundary()):(b.setcurClickItem(J.left),h.setlasteditArea("_"+J.left.id))):J.left.samplePoint>b.curViewPort.sS&&(l.shiftKey?(b.setcurClickItemMultiple(J.left),h.setlasteditArea("_"+J.left.id),b.selectBoundary()):(b.setcurClickItem(J.left),h.setlasteditArea("_"+J.left.id))))}if(d===f.vals.keyMappings.selNextItem&&b.getPermission("labelAction")&&b.getcurClickItems().length>0){var H=b.getcurClickItems()[0].id,I=b.getcurClickItems()[b.getcurClickItems().length-1].id,J=h.getItemNeighboursFromLevel(b.getcurClickLevelName(),H,I);if(void 0!==J.right){var K=0,L=0;void 0!==J.right.sampleStart&&(K=J.right.sampleStart,L=J.right.sampleDur),void 0!==J.right.samplePoint&&(K=J.right.samplePoint,L=0),0!==K&&K+L<b.curViewPort.eS&&(l.shiftKey?(b.setcurClickItemMultiple(J.right),h.setlasteditArea("_"+J.right.id),b.selectBoundary()):(b.setcurClickItem(J.right),h.setlasteditArea("_"+J.right.id)))}}if(d===f.vals.keyMappings.selNextPrevItem&&b.getPermission("labelAction")&&b.getcurClickItems().length>0){var H=b.getcurClickItems()[0].id,I=b.getcurClickItems()[b.getcurClickItems().length-1].id,J=h.getItemNeighboursFromLevel(b.getcurClickLevelName(),H,I);l.shiftKey?void 0!==J.left&&(void 0!==J.left.sampleStart?J.left.sampleStart+J.left.sampleDur>b.curViewPort.sS&&(b.setcurClickItem(J.left),h.setlasteditArea("_"+J.left.id)):J.left.samplePoint>b.curViewPort.sS&&(b.setcurClickItem(J.left,J.left.id),h.setlasteditArea("_"+J.left.id))):void 0!==J.right&&(void 0!==J.right.sampleStart?J.right.sampleStart<b.curViewPort.eS&&(b.setcurClickItem(J.right),h.setlasteditArea("_"+J.right.id)):J.right.samplePoint<b.curViewPort.eS&&(b.setcurClickItem(J.right),h.setlasteditArea("_"+J.right.id)))}if(d===f.vals.keyMappings.createNewItemAtSelection&&b.getPermission("labelAction")&&f.vals.restrictions.addItem)if(b.getselectedRange().start===b.curViewPort.selectS&&b.getselectedRange().end===b.curViewPort.selectE)1===b.getcurClickItems().length?b.getselectedRange().start>=b.curViewPort.sS&&b.getselectedRange().end<=b.curViewPort.eS&&(b.setEditing(!0),h.openEditArea(b.getcurClickItems()[0],h.getlasteditAreaElem(),b.getcurClickLevelType()),a.cursorInTextField()):c.open("views/error.html","Modify Error: Please select a single Segment.");else if(-1==b.curViewPort.selectE&&-1==b.curViewPort.selectS)c.open("views/error.html","Error : Please select a Segment or Point to modify it's name. Or select a level plus a range in the viewport in order to insert a new Segment.");else{var E=h.getClosestItem(b.curViewPort.selectS,b.getcurClickLevelName(),e.wavJSO.Data.length).current;if("SEGMENT"===b.getcurClickLevelType())if(void 0===E){var M=h.insertSegment(b.getcurClickLevelName(),b.curViewPort.selectS,b.curViewPort.selectE,f.vals.labelCanvasConfig.newSegmentName);M.ret?g.addObjToUndoStack({type:"ANNOT",action:"INSERTSEGMENTS",name:b.getcurClickLevelName(),start:b.curViewPort.selectS,end:b.curViewPort.selectE,ids:M.ids,segName:f.vals.labelCanvasConfig.newSegmentName}):c.open("views/error.html","Error : You are not allowed to insert a Segment here.")}else if(E.sampleStart===b.curViewPort.selectS&&E.sampleStart+E.sampleDur+1===b.curViewPort.selectE)b.setcurClickLevel(b.getcurClickLevelName(),b.getcurClickLevelType(),a.$index),b.setcurClickItem(E.current),h.setlasteditArea("_"+E.id),h.openEditArea(E,h.getlasteditAreaElem(),b.getcurClickLevelType()),b.setEditing(!0);else{var M=h.insertSegment(b.getcurClickLevelName(),b.curViewPort.selectS,b.curViewPort.selectE,f.vals.labelCanvasConfig.newSegmentName);M.ret?g.addObjToUndoStack({type:"ANNOT",action:"INSERTSEGMENTS",name:b.getcurClickLevelName(),start:b.curViewPort.selectS,end:b.curViewPort.selectE,ids:M.ids,segName:f.vals.labelCanvasConfig.newSegmentName}):c.open("views/error.html","Error : You are not allowed to insert a Segment here.")}else{var N=f.getLevelDefinition(b.getcurClickLevelName());if("undefined"==typeof N.anagestConfig){var O=h.insertEvent(b.getcurClickLevelName(),b.curViewPort.selectS,f.vals.labelCanvasConfig.newEventName);O.alreadyExists?(b.setcurClickLevel(b.getcurClickLevelName(),b.getcurClickLevelType(),a.$index),b.setcurClickItem(E.current),h.setlasteditArea("_"+E.id),h.openEditArea(E,h.getlasteditAreaElem(),b.getcurClickLevelType()),b.setEditing(!0)):g.addObjToUndoStack({type:"ANNOT",action:"INSERTEVENT",name:b.getcurClickLevelName(),start:b.curViewPort.selectS,id:O.id,pointName:f.vals.labelCanvasConfig.newEventName})}else k.insertAnagestEvents()}}if(d===f.vals.keyMappings.undo&&b.getPermission("labelAction")&&g.undo(),d===f.vals.keyMappings.redo&&b.getPermission("labelAction")&&g.redo(),d===f.vals.keyMappings.deletePreselBoundary&&b.getPermission("labelAction")){l.preventDefault();var E=b.getcurMouseItem(),P=b.getcurClickItems(),Q=b.getcurMouseisFirst(),R=b.getcurMouseisLast(),F=b.getcurMouseLevelName(),S=b.getcurMouseLevelType();if(l.shiftKey){if(f.vals.restrictions.deleteItem&&void 0!==P&&P.length>0)if("SEGMENT"===b.getcurClickLevelType()){var T=h.deleteSegments(F,P[0].id,P.length);g.updateCurChangeObj({type:"ANNOT",action:"DELETESEGMENTS",name:F,id:P[0].id,length:P.length,deletedSegment:T});var U=j.deleteLinkSegment(P);g.updateCurChangeObj({type:"ANNOT",action:"DELETELINKSEGMENT",name:F,segments:P,deletedLinks:U}),g.addCurChangeObjToUndoStack();var V=h.getClosestItem(b.getLasPcm()+b.curViewPort.sS,F,e.wavJSO.Data.length);if(void 0!==V.current&&void 0!==V.nearest){var J=h.getItemNeighboursFromLevel(p,V.nearest.id,V.nearest.id);b.setcurMouseItem(V.nearest,J,b.getLasPcm(),V.isFirst,V.isLast)}b.setcurClickItem(T.clickSeg)}else c.open("views/error.html","Delete Error: You can not delete Segments on Point Levels.")}else if(f.vals.restrictions.deleteItemBoundary&&void 0!==E){var W=h.getItemNeighboursFromLevel(F,E.id,E.id);if("SEGMENT"===S){var T=h.deleteBoundary(F,E.id,Q,R);g.updateCurChangeObj({type:"ANNOT",action:"DELETEBOUNDARY",name:F,id:E.id,isFirst:Q,isLast:R,deletedSegment:T});var U;void 0!==W.left?(U=j.deleteLinkBoundary(E.id,W.left.id),g.updateCurChangeObj({type:"ANNOT",action:"DELETELINKBOUNDARY",name:F,id:E.id,neighbourId:W.left.id,deletedLinks:U})):(U=j.deleteLinkBoundary(E.id,-1),g.updateCurChangeObj({type:"ANNOT",action:"DELETELINKBOUNDARY",name:F,id:E.id,neighbourId:-1,deletedLinks:U})),g.addCurChangeObjToUndoStack();var V=h.getClosestItem(b.getLasPcm()+b.curViewPort.sS,F,e.wavJSO.Data.length);if(void 0!==V.current&&void 0!==V.nearest){var J=h.getItemNeighboursFromLevel(p,V.nearest.id,V.nearest.id);b.setcurMouseItem(V.nearest,J,b.getLasPcm(),V.isFirst,V.isLast)}b.setcurClickItem(T.clickSeg)}else{var X=h.deleteEvent(F,E.id);if(X!==!1){g.updateCurChangeObj({type:"ANNOT",action:"DELETEEVENT",name:F,start:X.samplePoint,id:X.id,pointName:X.labels[0].value}),g.addCurChangeObjToUndoStack();var V=h.getClosestItem(b.getLasPcm()+b.curViewPort.sS,F,e.wavJSO.Data.length);if(void 0!==V.current&&void 0!==V.nearest){var J=h.getItemNeighboursFromLevel(p,V.nearest.id,V.nearest.id);b.setcurMouseItem(V.nearest,J,b.getLasPcm(),V.isFirst,V.isLast)}}else b.setcurMouseItem(void 0,void 0,void 0,void 0,void 0)}}}l.metaKey||l.ctrlKey||(l.preventDefault(),l.stopPropagation())}})},a.safeApply=function(a){var b=this.$root.$$phase;"$apply"==b||"$digest"==b?a&&"function"==typeof a&&a():this.$apply(a)},a.$on("$destroy",function(){$(window).off("keydown")})}}}]),angular.module("emuwebApp").directive("delete",["modalService",function(a){return{restrict:"A",link:function(b,c,d){var e=b.level.name;c.bind("click",function(){b.vs.setcurClickLevelName(e,d.delete),a.open("views/deleteLevel.html",e)})}}}]),angular.module("emuwebApp").directive("resize",["LevelService","viewState",function(a,b){return{restrict:"A",link:function(c,d){var e=d.parent().parent(),f=0,g=e.find(d.parent().children()[0]),h=(e.find(d.parent().children()[1]),e.find(d.parent().children()[2]));d.bind("click",function(){a.deleteEditArea(),b.setEditing(!1),c.open?(c.open=!1,f=e.css("height"),e.css({height:"25px"}),c.cps.vals.activeButtons.deleteSingleLevel&&g.hide(),c.cps.vals.activeButtons.saveSingleLevel&&h.hide()):(c.open=!0,e.css({height:f}),c.cps.vals.activeButtons.deleteSingleLevel&&g.show(),c.cps.vals.activeButtons.saveSingleLevel&&h.show()),c.updateView()})}}}]),angular.module("emuwebApp").directive("enlarge",["$rootScope","viewState","ConfigProviderService",function(a,b,c){return{restrict:"A",link:function(d,e,f){d.$watch("viewState.curPerspectiveIdx",function(){$.isEmptyObject(c.vals.perspectives)||$.isEmptyObject(b.curPerspectiveIdx)||(1===c.vals.perspectives[b.curPerspectiveIdx].signalCanvases.order.length?e.hide():e.show())},!0);var g=!1;e.bind("click",function(){g?(g=!1,b.setenlarge(-1)):(g=!0,b.setenlarge(f.enlarge)),a.$apply()})}}}]),angular.module("emuwebApp").directive("save",["modalService","Espsparserservice",function(a,b){return{restrict:"A",link:function(c,d,e){var f=c.level.name;d.bind("click",function(){c.vs.setcurClickLevelName(f,e.save),b.asyncParseJSO(f).then(function(b){a.open("views/export.html",f+"_esps.txt",b)})})}}}]),angular.module("emuwebApp").directive("slideToggle",function(){return{restrict:"A",scope:{isOpen:"=slideToggle"},link:function(a,b,c){var d=parseInt(c.slideToggleDuration,10)||200;a.isOpen||b.stop().slideToggle(0),a.$watch("isOpen",function(a,c){a!==c&&b.stop().slideToggle(d)})}}}),angular.module("emuwebApp").directive("previewtrack",["viewState","Soundhandlerservice",function(a,b){return{restrict:"A",scope:{},link:function(c,d){var e=-1;d.bind("click",function(d){if(!$.isEmptyObject(b.wavJSO)){var f=a.curViewPort.eS-a.curViewPort.sS;e=a.getX(d)*(b.wavJSO.Data.length/d.originalEvent.target.width),a.isEditing()||c.$apply(function(){a.setViewPort(e-f/2,e+f/2)})}}),d.bind("mousedown",function(c){$.isEmptyObject(b.wavJSO)||(e=a.getX(c)*(b.wavJSO.Data.length/c.originalEvent.target.width))}),d.bind("mousemove",function(d){var f=0;switch(f=void 0===d.buttons?d.which:d.buttons){case 1:if(-1!==e){var g=a.curViewPort.eS-a.curViewPort.sS;e=a.getX(d)*(b.wavJSO.Data.length/d.originalEvent.target.width),a.isEditing()||c.$apply(function(){a.setViewPort(e-g/2,e+g/2)})}}}),d.bind("mouseup",function(){e=-1}),d.bind("mouseout",function(){e=-1})}}}]),angular.module("emuwebApp").service("Iohandlerservice",["$rootScope","$http","$location","$q","HistoryService","viewState","Soundhandlerservice","Ssffparserservice","Wavparserservice","Textgridparserservice","ConfigProviderService","Espsparserservice","Ssffdataservice","Websockethandler","DragnDropDataService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){var p={};return p.wsH=n,p.httpGetDefaultConfig=function(){var a=b.get("configFiles/default_emuwebappConfig.json");return a},p.httpGetDefaultDesign=function(){var a=b.get("configFiles/default_emuwebappDesign.json");return a},p.httpGetPath=function(a,c){var d=b.get(a,{responseType:c});return d},p.getProtocol=function(){var a;return"CORS"===k.vals.main.comMode?alert("CORS version of getProtocol not implemented"):"WS"===k.vals.main.comMode&&(a=n.getProtocol()),a},p.getDoUserManagement=function(){var a;return"CORS"===k.vals.main.comMode?alert("CORS version of getDoUserManagement not implemented"):"WS"===k.vals.main.comMode&&(a=n.getDoUserManagement()),a},p.logOnUser=function(a,b){var c;return"CORS"===k.vals.main.comMode?alert("CORS version of logOnUser not implemented"):"WS"===k.vals.main.comMode&&(c=n.logOnUser(a,b)),c},p.getDBconfigFile=function(a){var c;return"CORS"===k.vals.main.comMode?alert("CORS version of getDBconfigFile not implemented"):"WS"===k.vals.main.comMode?c=n.getDBconfigFile():"DEMO"===k.vals.main.comMode&&(c=b.get("demoDBs/"+a+"/"+a+"_DBconfig.json")),c},p.getBundleList=function(a){var c;return"CORS"===k.vals.main.comMode?alert("CORS version of getBundleList not implemented"):"WS"===k.vals.main.comMode?c=n.getBundleList():"DEMO"===k.vals.main.comMode&&(c=b.get("demoDBs/"+a+"/"+a+"_bundleList.json")),c},p.getBundle=function(a,c,d){var e;return"CORS"===k.vals.main.comMode?alert("CORS version of getBundle not implemented"):"embedded"===k.vals.main.comMode?e=o.getBundle(a,c):"WS"===k.vals.main.comMode?e=n.getBundle(a,c):"DEMO"===k.vals.main.comMode&&(e=b.get("demoDBs/"+d+"/"+a+"_bndl.json")),e},p.saveBundle=function(a){var b;return"CORS"===k.vals.main.comMode?alert("CORS version of saveBundle not implemented"):"WS"===k.vals.main.comMode&&(b=n.saveBundle(a)),b},p.parseLabelFile=function(a,b,c,d){var e;return"ESPS"===d?e=l.asyncParseEsps(a,k.embeddedVals.labelGetUrl,"embeddedESPS"):"TEXTGRID"===d&&(e=j.asyncParseTextGrid(a,k.embeddedVals.labelGetUrl,"embeddedTEXTGRID")),e},p}]),angular.module("emuwebApp").service("Soundhandlerservice",["$document","Binarydatamaniphelper",function(a,b){var c={};return c.wavJSO={},c.player=a[0].createElement("audio"),c.player.isPlaying=!1,c.setPlayerSrc=function(a){var c=b.arrayBufferToBase64(a);this.player.src="data:audio/wav;base64,"+c},c.resetPlayerSrcFromTo=function(a,d){var e=c.wavJSO.BitsPerSample/8,f=c.wavJSO.origArrBuf.subarray(0,44),g=c.wavJSO.origArrBuf.subarray(44,c.wavJSO.Data.length*e),h=new DataView(f);h.setUint32(40,(d-a)*e,!0);var i=g.subarray(a*e,(d-a)*e),j=new Uint8Array(f.byteLength+i.byteLength);j.set(new Uint8Array(f),0),j.set(new Uint8Array(i),f.byteLength);var k=b.arrayBufferToBase64(j.buffer);c.player.src="data:audio/wav;base64,"+k},c.playFromTo=function(a,b){this.resetPlayerSrcFromTo(a,b),this.player.isPlaying?(this.player.isPlaying=!1,this.player.pause()):(this.player.isPlaying=!0,this.player.play())},c.player.addEventListener("ended",function(){this.isPlaying=!1},!1),c}]),angular.module("emuwebApp").directive("drawssff",["$timeout","viewState","ConfigProviderService","Ssffdataservice","HistoryService","fontScaleService","loadedMetaDataService",function(a,b,c,d,e,f,g){return{restrict:"A",scope:{},link:function(h,i,j){h.trackName=j.ssffTrackname,h.assTrackName="",h.lastDraw=Date.now(),h.vs=b,h.hists=e,h.ssffds=d,h.cps=c,h.lmds=g,j.$observe("ssffTrackname",function(a){h.trackName=a}),h.$watch("vs.curViewPort",function(a,b){(b.sS!==a.sS||b.eS!==a.eS)&&h.handleUpdate(),b.windowWidth!==a.windowWidth&&h.handleUpdate(),b.dragBarHeight!==a.dragBarHeight&&h.handleUpdate()},!0),h.$watch("vs.curPerspectiveIdx",function(){h.handleUpdate()},!0),h.$watch("vs.curCorrectionToolNr",function(){h.handleUpdate()},!0),h.$watch("hists.movesAwayFromLastSave",function(){h.handleUpdate()},!0),h.$watch("ssffds.data.length",function(){h.handleUpdate()},!0),h.$watch("vs.spectroSettings",function(){h.handleUpdate()},!0),h.$watch("vs.submenuOpen",function(b,d){b!==d&&a(h.handleUpdate,c.design.animation.duration)}),h.$watch("vs.timelineSize",function(b,d){b!==d&&a(h.handleUpdate,c.design.animation.duration/10)}),h.$watch("lmds.getCurBndl()",function(a,b){(a.name!==b.name||a.session!==b.session)&&h.handleUpdate()},!0),h.handleUpdate=function(){var a=i[0].getContext("2d");if(a.clearRect(0,0,i[0].width,i[0].height),$.isEmptyObject(d.data))a.clearRect(0,0,i[0].width,i[0].height);else if(0!==d.data.length&&(h.assTrackName="",c.vals.perspectives[b.curPerspectiveIdx].signalCanvases.assign.forEach(function(a){if(a.signalCanvasName===h.trackName){h.assTrackName=a.ssffTrackName;var e=c.getSsffTrackConfig(a.ssffTrackName),f=d.getColumnOfTrack(e.name,e.columnName),g=d.getSampleRateAndStartTimeOfTrack(e.name),j=c.getLimsOfTrack(e.name);h.drawValues(b,i[0],c,f,g.sampleRate,g.startTime,j)}}),h.assTrackName="","OSCI"!==h.trackName&&"SPEC"!==h.trackName)){var e=c.getSsffTrackConfig(h.trackName),f=d.getColumnOfTrack(e.name,e.columnName),g=d.getSampleRateAndStartTimeOfTrack(e.name),j=c.getLimsOfTrack(e.name);h.drawValues(b,i[0],c,f,g.sampleRate,g.startTime,j)}},h.drawValues=function(a,b,d,e,g,i,j){var k,l,m=b.getContext("2d");"SPEC"===h.trackName&&"FORMANTS"===h.assTrackName?(k=a.spectroSettings.rangeFrom,l=a.spectroSettings.rangeTo):(k=e._minVal,l=e._maxVal);var n=a.getViewPortStartTime(),o=a.getViewPortEndTime(),p=Math.round(n*g+i),q=Math.round(o*g+i),r=q-p,s=e.values.slice(p,p+r);if(r<b.width&&r>=2){var t,u,v,w;angular.forEach(s[0],function(d,f){if($.isEmptyObject(j)||f>=j.minContourIdx&&f<=j.maxContourIdx){if($.isEmptyObject(j))m.strokeStyle="hsl("+f*(360/s[0].length)+",80%, 50%)",m.fillStyle="hsl("+f*(360/s[0].length)+",80%, 50%)";else{var r=j.maxContourIdx-j.minContourIdx+1;m.strokeStyle="hsl("+f*(360/r)+",80%, 50%)",m.fillStyle="hsl("+f*(360/r)+",80%, 50%)"}var x=c.getContourColorsOfTrack(h.assTrackName);if(void 0!==x&&void 0!==x.colors[f]&&(m.strokeStyle=c.vals.perspectives[a.curPerspectiveIdx].signalCanvases.contourColors[0].colors[f],m.fillStyle=c.vals.perspectives[a.curPerspectiveIdx].signalCanvases.contourColors[0].colors[f]),a.curCorrectionToolNr-1===f&&"SPEC"===h.trackName&&"FORMANTS"===h.assTrackName&&(m.strokeStyle=c.design.color.green,m.fillStyle=c.design.color.green),m.beginPath(),p>=1){var y=e.values[p-1],z=y[f];v=p-1,w=1/g*v+i,t=(w-n)/(o-n)*b.width,u=b.height-(z-k)/(l-k)*b.height,m.moveTo(t,u)}if(angular.forEach(s,function(a,c){v=p+c,w=1/g*v+i,t=(w-n)/(o-n)*b.width,u=b.height-(a[f]-k)/(l-k)*b.height,m.arc(t,u-1,2,0,2*Math.PI,!1),m.lineTo(t,u)}),q<e.values.length-1){var A=e.values[q+1],B=A[f];v=q+1,w=1/g*v+i,t=(w-n)/(o-n)*b.width,u=b.height-(B-k)/(l-k)*b.height,m.lineTo(t,u)}m.stroke()}})}else{m.strokeStyle="red";var x,y;2>=r?(y=f.getTextImageTwoLines(m,"Zoom out to","see contour(s)",c.design.font.small.size.slice(0,-2)/1.05,c.design.font.small.family,c.design.color.transparent.red),m.drawImage(y,0,0,y.width,y.height,b.width/2-y.width/2,25,y.width,y.height)):(x="Zoom in to see contour(s)",y=f.getTextImageTwoLines(m,"Zoom in to","see contour(s)",c.design.font.small.size.slice(0,-2)/1.05,c.design.font.small.family,c.design.color.transparent.red),m.drawImage(y,0,0,y.width,y.height,b.width/2-y.width/2,25,y.width,y.height))}}}}}]),angular.module("emuwebApp").service("Ssffparserservice",["$q",function(a){var b,c={},d=new ssffParserWorker;return d.says(function(a){"SUCCESS"===a.status.type?b.resolve(a):b.reject(a)},!1),c.asyncParseSsffArr=function(c){return b=a.defer(),d.tell({cmd:"parseArr",ssffArr:c}),b.promise},c.asyncJso2ssff=function(c){return b=a.defer(),d.tell({cmd:"jso2ssff",jso:JSON.stringify(c)}),b.promise},c}]),angular.module("emuwebApp").directive("mouseTrackAndCorrectionTool",["viewState","ConfigProviderService","Ssffdataservice","Drawhelperservice","HistoryService","Soundhandlerservice",function(a,b,c,d,e,f){return{restrict:"A",scope:{},link:function(g,h,i){var j,k,l,m,n,o,p,q,r=h[0],s=r.getContext("2d");i.$observe("ssffTrackname",function(a){a&&(p=a)}),i.$observe("bundleName",function(a){a&&(q=a,$.isEmptyObject(c.data)||0!==c.data.length&&(m=b.getSsffTrackConfig("FORMANTS"),void 0!==m&&(n=c.getColumnOfTrack(m.name,m.columnName),o=c.getSampleRateAndStartTimeOfTrack(m.name))))}),h.bind("mousedown",function(b){k=Math.round(a.getX(b)*a.getSamplesPerPixelVal(b)+a.curViewPort.sS),l=k,a.select(k,k),g.switchMarkupContext(b),g.$apply()}),h.bind("mousemove",function(d){var f=0;f=void 0===d.buttons?d.which:d.buttons;var i=a.getX(d);switch(a.curMousePosSample=Math.round(a.curViewPort.sS+i/h[0].width*(a.curViewPort.eS-a.curViewPort.sS)),f){case 0:if(a.getPermission("labelAction")&&(g.switchMarkupContext(d),!($.isEmptyObject(c.data)||0===c.data.length||a.getdragBarActive()||void 0===a.curCorrectionToolNr||a.getdragBarActive()||$.isEmptyObject(b.getAssignment(p))))){void 0===m&&(m=b.getSsffTrackConfig("FORMANTS")),n=c.getColumnOfTrack(m.name,m.columnName),o=c.getSampleRateAndStartTimeOfTrack(m.name);var j=a.getViewPortStartTime(),k=a.getViewPortEndTime(),l=Math.round(j*o.sampleRate+o.startTime),q=Math.round(k*o.sampleRate+o.startTime),t=q-l,u=n.values.slice(l,l+t),v=j+a.getX(d)/d.originalEvent.target.width*(k-j),w=Math.round((v+o.startTime)*o.sampleRate)-1,x=1/o.sampleRate*w+o.startTime;if(0>w-l||w-l>=u.length)return void console.log("early return");a.curPreselColumnSample=w-l;var y=(x-j)/(k-j)*r.width,z=r.height-u[a.curPreselColumnSample][a.curCorrectionToolNr-1]/(a.spectroSettings.rangeTo-a.spectroSettings.rangeFrom)*r.height;if(s.strokeStyle="black",s.fillStyle="black",s.beginPath(),s.arc(y,z-1,2,0,2*Math.PI,!1),s.closePath(),s.stroke(),s.fill(),d.shiftKey){var A=angular.copy(u[a.curPreselColumnSample][a.curCorrectionToolNr-1]),B=a.spectroSettings.rangeTo-a.getY(d)/d.originalEvent.target.height*a.spectroSettings.rangeTo;u[a.curPreselColumnSample][a.curCorrectionToolNr-1]=a.spectroSettings.rangeTo-a.getY(d)/d.originalEvent.target.height*a.spectroSettings.rangeTo;var C=e.updateCurChangeObj({type:"SSFF",trackName:m.name,sampleBlockIdx:l+a.curPreselColumnSample,sampleIdx:a.curCorrectionToolNr-1,oldValue:A,newValue:B});for(var D in C)x=1/o.sampleRate*C[D].sampleBlockIdx+o.startTime,y=(x-j)/(k-j)*r.width,z=r.height-C[D].newValue/(a.spectroSettings.rangeTo-a.spectroSettings.rangeFrom)*r.height,s.strokeStyle="red",s.fillStyle="red",s.beginPath(),s.arc(y,z-1,2,0,2*Math.PI,!1),s.closePath(),s.stroke(),s.fill()}}break;case 1:a.getdragBarActive()||g.setSelectDrag(d)}g.$apply()}),h.bind("mouseup",function(b){a.getdragBarActive()||(g.setSelectDrag(b),g.switchMarkupContext(b))}),h.bind("mouseleave",function(b){$.isEmptyObject(f)||$.isEmptyObject(f.wavJSO)||a.getdragBarActive()||a.getPermission("labelAction")&&g.switchMarkupContext(b,!1)}),g.switchMarkupContext=function(e,f){if(s.clearRect(0,0,r.width,r.height),"OSCI"==i.ssffTrackname)d.drawViewPortTimes(s,!0),d.drawCurViewPortSelected(s,!0);else if("SPEC"==i.ssffTrackname)d.drawCurViewPortSelected(s,!1),d.drawMinMaxAndName(s,"",a.spectroSettings.rangeFrom,a.spectroSettings.rangeTo,2);else{var g=b.getSsffTrackConfig(i.ssffTrackname),h=c.getColumnOfTrack(g.name,g.columnName);d.drawCurViewPortSelected(s,!1),d.drawMinMaxAndName(s,i.ssffTrackname,h._minVal,h._maxVal,2)}f!==!1&&b.vals.restrictions.drawCrossHairs&&d.drawCrossHairs(s,e,a.spectroSettings.rangeFrom,a.spectroSettings.rangeTo,"Hz",i.ssffTrackname),d.drawMovingBoundaryLine(s)},g.setSelectDrag=function(b){j=Math.round(a.getX(b)*a.getSamplesPerPixelVal(b)+a.curViewPort.sS),j>k?(l=j,a.select(k,l)):(k=j,a.select(k,l)),g.$apply()}}}}]),angular.module("emuwebApp").service("Drawhelperservice",["viewState","ConfigProviderService","Soundhandlerservice","fontScaleService","Ssffdataservice","mathHelperService",function(a,b,c,d,e,f){function g(a,b,c){return a.measureText(b).width*c}function h(a,b,c,d){return b.toString().length>c.toString().length?g(a,b,d):g(a,c,d)}function i(a,c,d,e,f,g){var h=g.getContext("2d"),i=1,j=Math.round(d*(g.height/e)),k=c*i,l=Math.round((g.height-j)/2),m=Math.round(f*(g.height/e)),n=(c-1)*i,o=Math.round((g.height-m)/2);h.strokeStyle=b.design.color.black,h.moveTo(n,o),h.lineTo(k,l)}var j={};return j.osciPeaks=[],j.calculatePeaks=function(a,b,c){var d,e=(a.curViewPort.eS+1-a.curViewPort.sS)/b.width,f=1,g=[],h=1/0,i=-1/0;if(1>=e)d=0===a.curViewPort.sS?c.subarray(a.curViewPort.sS,a.curViewPort.eS+2):c.subarray(a.curViewPort.sS-1,a.curViewPort.eS+2),h=Math.min.apply(Math,d),i=Math.max.apply(Math,d),g=Array.prototype.slice.call(d);else{d=c.subarray(a.curViewPort.sS,a.curViewPort.eS);for(var j=0;j<b.width;j++){for(var k=0,l=0;f>l;l++){for(var m=d.subarray(j*e,(j+1)*e),n=0,o=0,p=m.length;p>o;o++)n+=m[o];k+=n/m.length}g[j]=k,k>i&&(i=k)}}return{peaks:g,minPeak:h,maxPeak:i,samplePerPx:e}},j.freshRedrawDrawOsciOnCanvas=function(a,c,d,e,f){var g=c.getContext("2d");if(g.clearRect(0,0,c.width,c.height),d.peaks&&d.samplePerPx>=1)g.beginPath(),d.peaks.forEach(function(b,e){0!==e&&i(a,e,b,d.maxPeak,d.peaks[e-1],c,f)}),g.stroke();else if(d.samplePerPx<1){var h=1/d.samplePerPx/2,j=a.curViewPort.sS;g.strokeStyle=b.design.color.black,g.fillStyle=b.design.color.black;var k;if(0===a.curViewPort.sS){for(g.moveTo(h,(d.peaks[0]-d.minPeak)/(d.maxPeak-d.minPeak)*c.height),k=0;k<d.peaks.length;k++)g.lineTo(k/d.samplePerPx+h,(d.peaks[k]-d.minPeak)/(d.maxPeak-d.minPeak)*c.height);for(g.stroke(),k=0;k<d.peaks.length;k++)g.beginPath(),g.arc(k/d.samplePerPx+h,(d.peaks[k]-d.minPeak)/(d.maxPeak-d.minPeak)*c.height-3,4,0,2*Math.PI,!1),g.stroke(),g.fill(),f.vals.restrictions.drawSampleNrs&&(g.strokeText(j,k/d.samplePerPx+h,(d.peaks[k]-d.minPeak)/(d.maxPeak-d.minPeak)*c.height-10),j+=1)}else{for(g.beginPath(),g.moveTo(-h,c.height-(d.peaks[0]-d.minPeak)/(d.maxPeak-d.minPeak)*c.height),k=1;k<=d.peaks.length;k++)g.lineTo(k/d.samplePerPx-h,c.height-((d.peaks[k]-d.minPeak)/(d.maxPeak-d.minPeak)*c.height+3));for(g.stroke(),k=1;k<=d.peaks.length;k++)g.beginPath(),g.arc(k/d.samplePerPx-h,c.height-(d.peaks[k]-d.minPeak)/(d.maxPeak-d.minPeak)*c.height-3,4,0,2*Math.PI,!1),g.stroke(),g.fill(),f.vals.restrictions.drawSampleNrs&&(g.fillText(j,k/d.samplePerPx-h,c.height-(d.peaks[k]-d.minPeak)/(d.maxPeak-d.minPeak)*c.height-10),j+=1)}}if(f.vals.restrictions.drawZeroLine){if(g.strokeStyle=b.design.color.blue,g.fillStyle=b.design.color.blue,"Google Inc."===navigator.vendor&&g.setLineDash([2]),d.samplePerPx>=1)g.beginPath(),g.moveTo(0,c.height/2),g.lineTo(c.width,c.height/2),g.stroke(),g.fillText("0",5,c.height/2-5,c.width);else{var l=c.height-(0-d.minPeak)/(d.maxPeak-d.minPeak)*c.height;g.beginPath(),g.moveTo(0,l),g.lineTo(c.width,l),g.stroke(),g.fill(),g.fillText("0",5,c.height-(0-d.minPeak)/(d.maxPeak-d.minPeak)*c.height-5,c.width)}"Google Inc."===navigator.vendor&&g.setLineDash([0])}},j.drawMovingBoundaryLine=function(c){var d,e;if(e=a.getSampleDist(c.canvas.width),d="SEGMENT"===a.getcurMouseLevelType()?0:e/2,a.movingBoundary){c.fillStyle=b.design.color.blue;var f=Math.round(a.getPos(c.canvas.width,a.movingBoundarySample));a.getcurMouseisLast()?c.fillRect(f+e,0,1,c.canvas.height):c.fillRect(f+d,0,1,c.canvas.height)}},j.drawCurViewPortSelected=function(e,i){var j,k,l,m,n,o=1*b.design.font.small.size.slice(0,-2);k=a.getSampleDist(e.canvas.width),j="seg"===a.getcurMouseLevelType()?0:k/2;var p=a.getPos(e.canvas.width,a.curViewPort.selectS),q=a.getPos(e.canvas.width,a.curViewPort.selectE);if(p===q)e.fillStyle=b.design.color.transparent.black,e.fillRect(p+j,0,2,e.canvas.height),i&&a.curViewPort.sS!==a.curViewPort.selectS&&-1!==a.curViewPort.selectS&&(n=e.canvas.width/e.canvas.offsetWidth,l=h(e,a.curViewPort.selectS,f.roundToNdigitsAfterDecPoint(a.curViewPort.selectS/c.wavJSO.SampleRate,6),n),m=d.getTextImageTwoLines(e,a.curViewPort.selectS,f.roundToNdigitsAfterDecPoint(a.curViewPort.selectS/c.wavJSO.SampleRate,6),o,b.design.font.small.family,b.design.color.black,!0),e.drawImage(m,0,0,m.width,m.height,q+5,0,m.width,m.height));
else if(e.fillStyle=b.design.color.transparent.grey,e.fillRect(p,0,q-p,e.canvas.height),e.strokeStyle=b.design.color.transparent.black,e.beginPath(),e.moveTo(p,0),e.lineTo(p,e.canvas.height),e.moveTo(q,0),e.lineTo(q,e.canvas.height),e.closePath(),e.stroke(),i&&(n=e.canvas.width/e.canvas.offsetWidth,l=h(e,a.curViewPort.selectS,f.roundToNdigitsAfterDecPoint(a.curViewPort.selectS/c.wavJSO.SampleRate,6),n),m=d.getTextImageTwoLines(e,a.curViewPort.selectS,f.roundToNdigitsAfterDecPoint(a.curViewPort.selectS/c.wavJSO.SampleRate,6),o,b.design.font.small.family,b.design.color.black,!1),e.drawImage(m,0,0,m.width,m.height,p-l-5,0,m.width,m.height),m=d.getTextImageTwoLines(e,a.curViewPort.selectE,f.roundToNdigitsAfterDecPoint(a.curViewPort.selectE/c.wavJSO.SampleRate,6),o,b.design.font.small.family,b.design.color.black,!0),e.drawImage(m,0,0,m.width,m.height,q+5,0,m.width,m.height),l=g(e,f.roundToNdigitsAfterDecPoint((a.curViewPort.selectE-a.curViewPort.selectS)/c.wavJSO.SampleRate,6),n),q-p>l)){var r=a.curViewPort.selectE-a.curViewPort.selectS-1,s=f.roundToNdigitsAfterDecPoint((a.curViewPort.selectE-a.curViewPort.selectS)/c.wavJSO.SampleRate,6);l=h(e,r,s,n),m=d.getTextImageTwoLines(e,r,s,o,b.design.font.small.family,b.design.color.black,!1),e.drawImage(m,0,0,m.width,m.height,p+(q-p)/2-l/2,0,m.width,m.height)}},j.drawCrossHairs=function(c,g,h,i,j,k){if(b.vals.restrictions.drawCrossHairs){var l=1*b.design.font.small.size.slice(0,-2);c.strokeStyle=b.design.color.transparent.red,c.fillStyle=b.design.color.transparent.red,"Google Inc."===navigator.vendor&&c.setLineDash([2]);var m=a.getX(g),n=a.getY(g);"Google Inc."===navigator.vendor&&c.setLineDash([0]),c.font=b.design.font.small.size+" "+b.design.font.small.family;var o=f.roundToNdigitsAfterDecPoint(i-n/c.canvas.height*i,2),p=c.measureText(o+j).width,q=Math.round(a.curViewPort.sS+m/c.canvas.width*(a.curViewPort.eS-a.curViewPort.sS)),r=f.roundToNdigitsAfterDecPoint(a.getViewPortStartTime()+m/c.canvas.width*(a.getViewPortEndTime()-a.getViewPortStartTime()),6),s=d.getTextImage(c,o+j,l,b.design.font.small.family,b.design.color.transparent.red,!0),t=d.getTextImageTwoLines(c,q,r,l,b.design.font.small.family,b.design.color.transparent.red,!0);if(void 0!==i||void 0!==h)if("OSCI"==k)c.beginPath(),c.moveTo(m,0),c.lineTo(m,c.canvas.height),c.stroke();else if("SPEC"==k)c.drawImage(s,0,0,s.width,s.height,5,n,s.width,s.height),c.drawImage(s,0,0,s.width,s.height,c.canvas.width-5-p*(c.canvas.width/c.canvas.offsetWidth),n,s.width,s.height),c.beginPath(),c.moveTo(0,n),c.lineTo(5,n+5),c.moveTo(0,n),c.lineTo(c.canvas.width,n),c.lineTo(c.canvas.width-5,n+5),c.moveTo(m,0),c.lineTo(m,c.canvas.height),c.stroke();else{var u=b.getSsffTrackConfig(k),v=e.getColumnOfTrack(u.name,u.columnName);o=v._maxVal-n/c.canvas.height*(v._maxVal-v._minVal),o=f.roundToNdigitsAfterDecPoint(o,2),s=d.getTextImage(c,o,l,b.design.font.small.family,b.design.color.transparent.red,!0),c.drawImage(s,0,0,s.width,s.height,5,n,s.width,s.height),c.drawImage(s,0,0,s.width,s.height,c.canvas.width-5-p*(c.canvas.width/c.canvas.offsetWidth),n,s.width,s.height),c.beginPath(),c.moveTo(0,n),c.lineTo(5,n+5),c.moveTo(0,n),c.lineTo(c.canvas.width,n),c.lineTo(c.canvas.width-5,n+5),c.moveTo(m,0),c.lineTo(m,c.canvas.height),c.stroke()}c.drawImage(t,0,0,t.width,t.height,m+5,0,t.width,t.height)}},j.drawMinMaxAndName=function(a,c,e,g,h){a.strokeStyle=b.design.color.black,a.fillStyle=b.design.color.black;var i=1*b.design.font.small.size.slice(0,-2),j=a.canvas.height/a.canvas.offsetHeight,k=3*b.design.font.small.size.slice(0,-2)/4,l=k*j;if(a.beginPath(),a.moveTo(0,0),a.lineTo(5,5),a.moveTo(0,a.canvas.height),a.lineTo(5,a.canvas.height-5),a.stroke(),a.closePath(),""!==c){var m=d.getTextImage(a,c,i,b.design.font.small.family,b.design.color.black);a.drawImage(m,0,a.canvas.height/2-i*j/2)}if(void 0!==g){var n=d.getTextImage(a,"max: "+f.roundToNdigitsAfterDecPoint(g,h),k,b.design.font.small.family,b.design.color.grey);a.drawImage(n,5,5,n.width,n.height)}void 0!==e&&(n=d.getTextImage(a,"min: "+f.roundToNdigitsAfterDecPoint(e,h),k,b.design.font.small.family,b.design.color.grey),a.drawImage(n,5,a.canvas.height-l-5,n.width,n.height))},j.drawViewPortTimes=function(e){e.strokeStyle=b.design.color.black,e.fillStyle=b.design.color.black,e.font=b.design.font.small.size+" "+b.design.font.small.family;var g=1*b.design.font.small.size.slice(0,-2);e.beginPath(),e.moveTo(0,0),e.lineTo(5,5),e.moveTo(e.canvas.width,0),e.lineTo(e.canvas.width-5,5),e.closePath(),e.stroke();var i,j,k,l,m=e.canvas.width/e.canvas.offsetWidth;e.canvas.height/e.canvas.offsetHeight,a.curViewPort&&(i=f.roundToNdigitsAfterDecPoint(a.curViewPort.sS/c.wavJSO.SampleRate,6),j=f.roundToNdigitsAfterDecPoint(a.curViewPort.eS/c.wavJSO.SampleRate,6),k=d.getTextImageTwoLines(e,a.curViewPort.sS,i,g,b.design.font.small.family,b.design.color.black,!0),e.drawImage(k,5,5),l=h(e,a.curViewPort.eS,j,m),k=d.getTextImageTwoLines(e,a.curViewPort.eS,j,g,b.design.font.small.family,b.design.color.black,!1),e.drawImage(k,0,0,k.width,k.height,e.canvas.width-l-5,0,k.width,k.height))},j}]),angular.module("emuwebApp").service("HistoryService",["$log","$compile","Ssffdataservice","LevelService","LinkService","ConfigProviderService","viewState","Soundhandlerservice",function(a,b,c,d,e,f,g){function h(a,b){Object.keys(a).forEach(function(g){var h=a[g];if("SSFF"===h.type)if(b){i.setHistoryActionText(!0,"SSFF manipulation");var j=f.getSsffTrackConfig(h.trackName),k=c.getColumnOfTrack(j.name,j.columnName);k.values[h.sampleBlockIdx][h.sampleIdx]=h.oldValue}else{i.setHistoryActionText(!1,"SSFF manipulation");var j=f.getSsffTrackConfig(h.trackName),k=c.getColumnOfTrack(j.name,j.columnName);k.values[h.sampleBlockIdx][h.sampleIdx]=h.newValue}else if("ANNOT"===h.type){var l=!1;switch(h.action){case"MOVEBOUNDARY":b?(l=!0,d.moveBoundary(h.name,h.id,-h.movedBy,h.isFirst,h.isLast)):d.moveBoundary(h.name,h.id,h.movedBy,h.isFirst,h.isLast);break;case"MOVESEGMENT":b?(l=!0,d.moveSegment(h.name,h.id,h.length,-h.movedBy)):d.moveSegment(h.name,h.id,h.length,h.movedBy);break;case"MOVEEVENT":b?(l=!0,d.moveEvent(h.name,h.id,-h.movedBy)):d.moveEvent(h.name,h.id,h.movedBy);break;case"RENAMELABEL":b?(l=!0,d.renameLabel(h.name,h.id,h.attrIndex,h.oldValue)):d.renameLabel(h.name,h.id,h.attrIndex,h.newValue);break;case"RENAMELEVEL":b?(l=!0,d.renameLevel(h.newname,h.name,h.curPerspectiveIdx)):d.renameLevel(h.name,h.newname,h.curPerspectiveIdx);break;case"DELETELEVEL":b?(l=!0,d.insertLevel(h.level,h.id,h.curPerspectiveIdx)):d.deleteLevel(h.id,h.curPerspectiveIdx);break;case"DELETEBOUNDARY":b?(l=!0,d.deleteBoundaryInvers(h.name,h.id,h.isFirst,h.isLast,h.deletedSegment)):d.deleteBoundary(h.name,h.id,h.isFirst,h.isLast);break;case"DELETESEGMENTS":b?(l=!0,d.deleteSegmentsInvers(h.name,h.id,h.length,h.deletedSegment)):d.deleteSegments(h.name,h.id,h.length);break;case"DELETEEVENT":b?(l=!0,d.insertEvent(h.name,h.start,h.pointName,h.id)):d.deleteEvent(h.name,h.id);break;case"DELETELINKSTO":b?(l=!0,e.insertLinksTo(h.deletedLinks)):e.deleteLinksTo(h.id);break;case"DELETELINKBOUNDARY":b?(l=!0,e.deleteLinkBoundaryInvers(h.deletedLinks)):e.deleteLinkBoundary(h.id,h.neighbourId);break;case"DELETELINKSEGMENT":b?(l=!0,e.deleteLinkSegmentInvers(h.deletedLinks)):e.deleteLinkSegment(h.segments);break;case"INSERTLEVEL":b?(l=!0,d.deleteLevel(h.id,h.curPerspectiveIdx)):d.insertLevel(h.level,h.id,h.curPerspectiveIdx);break;case"INSERTSEGMENTS":b?(l=!0,d.insertSegmentInvers(h.name,h.start,h.end,h.segName)):d.insertSegment(h.name,h.start,h.end,h.segName,h.ids);break;case"INSERTEVENT":b?(l=!0,d.deleteEvent(h.name,h.id)):d.insertEvent(h.name,h.start,h.pointName,h.id);break;case"INSERTLINKSTO":b?(l=!0,e.deleteLinksTo(h.parentID,h.childIDs)):e.insertLinksTo(h.parentID,h.childIDs);break;case"EXPANDSEGMENTS":b?(l=!0,d.expandSegment(h.rightSide,h.item,h.name,-h.changeTime)):d.expandSegment(h.rightSide,h.item,h.name,h.changeTime)}i.setHistoryActionText(l,h.action)}else if("HIERARCHY"===h.type){var l=!1;switch(h.action){case"DELETELINK":b?(l=!0,e.insertLinkAt(h.fromID,h.toID,h.position)):e.deleteLink(h.fromID,h.toID);break;case"DELETEITEM":b?(l=!0,d.deleteItemWithLinksInvers(h.item,h.levelName,h.position,h.deletedLinks)):d.deleteItemWithLinks(h.item.id);break;case"ADDITEM":b?(l=!0,d.addItemInvers(h.newID)):d.addItem(h.neighborID,h.before,h.newID);break;case"ADDLINK":b?(l=!0,e.deleteLink(h.link.fromID,h.link.toID)):e.insertLink(h.link.fromID,h.link.toID);break;case"PUSHITEM":b?(l=!0,d.addItemInvers(h.newID)):d.pushNewItem(h.level,h.newID)}i.setHistoryActionText(l,h.action)}})}var i={};i.movesAwayFromLastSave=0;var j=[],k=[],l={};return i.updateCurChangeObj=function(a){var b;if("SSFF"===a.type)b=String(a.type+"#"+a.trackName)+"#"+String(a.sampleBlockIdx)+"#"+String(a.sampleIdx),l[b]?(a.oldValue=l[b].oldValue,l[b]=a):l[b]=a;else if("ANNOT"===a.type)switch(a.action){case"MOVEBOUNDARY":case"MOVEEVENT":case"MOVESEGMENT":case"INSERTEVENT":case"DELETEEVENT":b=String(a.type+"#"+a.action+"#"+a.name+"#"+a.id),l[b]?(a.movedBy+=l[b].movedBy,l[b]=a):l[b]=a;break;case"INSERTLINKSTO":case"DELETELINKSTO":case"DELETELINKBOUNDARY":case"DELETELINKSEGMENT":case"DELETEBOUNDARY":case"DELETESEGMENTS":b=String(a.type+"#"+a.action+"#"+a.name),l[b]?(a.oldValue=l[b].oldValue,l[b]=a):l[b]=a}return l},i.addCurChangeObjToUndoStack=function(){k=[],$.isEmptyObject(l)||(j.push(l),i.movesAwayFromLastSave+=1),a.info(l),l={}},i.addObjToUndoStack=function(a){k=[];var b={},c=String(a.type+"#"+a.action+"#"+a.name+"#"+a.id);b[c]=angular.copy(a),$.isEmptyObject(b)||(j.push(b),i.movesAwayFromLastSave+=1),l={}},i.undo=function(){if(j.length>0){var a=angular.copy(j[j.length-1]);k.push(a),h(a,!0),j.pop(),i.movesAwayFromLastSave-=1}},i.redo=function(){if(k.length>0){var a=angular.copy(k[k.length-1]);j.push(a),h(a,!1),k.pop(),i.movesAwayFromLastSave+=1}},i.getNrOfPossibleUndos=function(){return j.length},i.getCurrentStack=function(){return{undo:j,redo:k}},i.setHistoryActionText=function(a,b){var c="<i>UNDO</i> &#8594; ";a||(c="<i>REDO</i> &#8592; "),g.historyActionTxt=c+b},i.resetToInitState=function(){j=[],k=[],l={},i.movesAwayFromLastSave=0},i}]),angular.module("emuwebApp").service("Wavparserservice",["$q",function(a){var b,c={},d=new wavParserWorker;return d.says(function(a){"SUCCESS"===a.status.type?b.resolve(a.data):b.reject(a)}),c.parseWavArrBuf=function(c){return b=a.defer(),d.tell({cmd:"parseBuf",buffer:c}),b.promise},c}]),angular.module("emuwebApp").service("Textgridparserservice",["$q","DataService","viewState","Soundhandlerservice",function(a,b,c,d){var e,f={},g=new textGridParserWorker;return g.says(function(a){"SUCCESS"===a.status.type?e.resolve(a.data):e.reject(a.data)},!1),f.asyncToTextGrid=function(){return e=a.defer(),g.tell({cmd:"toTextGrid",levels:b.getData().levels,sampleRate:d.wavJSO.SampleRate,buffLength:d.wavJSO.Data.length}),e.promise},f.asyncParseTextGrid=function(b,c,f){return e=a.defer(),g.tell({cmd:"parseTG",textGrid:b,sampleRate:d.wavJSO.SampleRate,annotates:c,name:f}),e.promise},f}]),angular.module("emuwebApp").factory("uuid",function(){function a(a){var b=(Math.random().toString(16)+"000000000").substr(2,8);return a?"-"+b.substr(0,4)+"-"+b.substr(4,4):b}var b={};return b.new=function(){return a()+a(!0)+a(!0)+a()},b.newHash=function(){return a()+a(!0)+a(!0)+a()},b.empty=function(){return"00000000-0000-0000-0000-000000000000"},b}),angular.module("emuwebApp").factory("browserDetector",function(){var a={};return a.isMobile={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)},any:function(){return a.isMobile.Android()||a.isMobile.BlackBerry()||a.isMobile.iOS()||a.isMobile.Opera()||a.isMobile.Windows()}},a.isBrowser={Firefox:function(){return navigator.userAgent.match(/Firefox/i)},Chrome:function(){return navigator.userAgent.match(/Chrome/i)},InternetExplorer:function(){return navigator.userAgent.match(/MSIE/i)},Opera:function(){return navigator.userAgent.match(/Opera/i)},PhantomJS:function(){return navigator.userAgent.match(/PhantomJS/i)},any:function(){return a.isBrowser.Firefox()||a.isBrowser.Chrome()||a.isBrowser.InternetExplorer()||a.isBrowser.Opera()||a.isBrowser.PhantomJS()}},a.isMobileDevice=function(){var b=a.isMobile.any();return null===b?!1:b.length>0?!0:!1},a.isDesktopDevice=function(){var b=a.isBrowser.any();return null===b?!1:b.length>0?!0:!1},a}),angular.module("emuwebApp").service("fontScaleService",function(){var a={};return a.lastTextWidth=null,a.spaceTop=0,a.getTextImage=function(b,c,d,e,f){var g=b.canvas.height/b.canvas.offsetHeight,h=b.canvas.width/b.canvas.offsetWidth;d=Math.floor(d+2-g/2);var i=document.createElement("canvas");i.setAttribute("width",Math.round(200*h)),i.setAttribute("height",Math.round(100*g));var j=i.getContext("2d");return j.save(),j.font=d+"px "+e,j.fillStyle=f,j.scale(h,g),j.fillText(c,0,d+a.spaceTop),a.lastTextWidth=j.measureText(c).width*h,j.restore(),i},a.getLastImageWidth=function(){return a.lastTextWidth},a.getTextImageTwoLines=function(b,c,d,e,f,g,h){var i=b.canvas.height/b.canvas.offsetHeight,j=b.canvas.width/b.canvas.offsetWidth;e=Math.floor(e+2-i/2);var k=document.createElement("canvas");k.setAttribute("width",Math.round(200*j)),k.setAttribute("height",Math.round(100*i));var l=k.getContext("2d");if(l.save(),l.font=e+"px "+f,l.fillStyle=g,l.scale(j,i),a.lastTextWidth=l.measureText(c).width*j,h)l.fillText(c,0,e+a.spaceTop),l.fillText(d,0,2*e+a.spaceTop);else{var m=l.measureText(c).width,n=l.measureText(d).width;m>n?(l.fillText(c,0,e+a.spaceTop),l.fillText(d,m-n,2*e+a.spaceTop)):(l.fillText(c,n-m,e+a.spaceTop),l.fillText(d,0,2*e+a.spaceTop))}return l.restore(),k},a}),angular.module("emuwebApp").service("Espsparserservice",["$q","LevelService","Soundhandlerservice",function(a,b,c){var d,e={},f=new espsParserWorker;return f.says(function(a){"SUCCESS"===a.status.type?d.resolve(a.data):d.reject(a.data)},!1),e.asyncParseEsps=function(b,e,g){return d=a.defer(),f.tell({cmd:"parseESPS",esps:b,sampleRate:c.wavJSO.SampleRate,annotates:e,name:g}),d.promise},e.asyncParseJSO=function(e){return d=a.defer(),f.tell({cmd:"parseJSO",level:b.getLevelDetails(e).level,sampleRate:c.wavJSO.SampleRate}),d.promise},e}]),angular.module("emuwebApp").controller("LoginCtrl",["$scope","$rootScope","$http","ConfigProviderService","Iohandlerservice","viewState","modalService",function(a,b,c,d,e,f,g){a.loginData={username:"",password:"",errorMsg:""},a.tryLogin=function(){e.logOnUser(a.loginData.username,a.loginData.password).then(function(b){"LOGGEDON"===b?g.confirm():a.loginData.errorMsg="ERROR: "+b})},a.cursorInTextField=function(){f.setEditing(!0),f.setcursorInTextField(!0)},a.cursorOutOfTextField=function(){f.setEditing(!1),f.setcursorInTextField(!1)},a.cancel=function(){g.close()}}]),angular.module("emuwebApp").service("Ssffdataservice",["viewState","Soundhandlerservice","ConfigProviderService",function(a,b,c){var d={};return d.data=[],d.getFile=function(a){var b;return void 0!==c.curDbConfig.ssffTrackDefinitions&&c.curDbConfig.ssffTrackDefinitions.forEach(function(c){c.name===a&&d.data.forEach(function(a){a.fileExtension===c.fileExtension&&(b=a)})}),b},d.getColumnOfTrack=function(a,b){var c,e=d.getFile(a);return void 0!==e?(e.Columns.forEach(function(a){a.name===b&&(c=a)}),c):void 0},d.getSampleRateAndStartTimeOfTrack=function(a){var b={},c=d.getFile(a);return void 0!==c?(b.sampleRate=c.sampleRate,b.startTime=c.startTime,b):void 0},d.calculateSamplePosInVP=function(a,c,d){var e=a/c+d,f=Math.round(e*b.wavJSO.SampleRate);return f},d}]),angular.module("emuwebApp").service("DataService",function(){var a={};return a.data={},a.maxItemID=0,a.getData=function(){return a.data},a.setLevelData=function(b){a.data.levels=b},a.getLevelData=function(){return a.data.levels},a.getLevelDataAt=function(b){return a.data.levels[b]},a.insertLevelDataAt=function(b,c){a.data.levels.splice(b,0,c)},a.deleteLevelDataAt=function(b){a.data.levels.splice(b,1)},a.getLinkData=function(){return a.data.links},a.setLinkData=function(b){a.data.links=b},a.insertLinkData=function(b){a.data.links.push(b)},a.deleteLinkDataAt=function(b){a.data.links.splice(b,1)},a.insertLinkDataAt=function(b,c){a.data.links.splice(b,0,c)},a.changeLinkDataAt=function(b,c,d){a.data.links[b].fromID=c,a.data.links[b].toID=d},a.setData=function(b){angular.copy(b,a.data),angular.forEach(a.data.levels,function(b){b.items.forEach(function(b){b.id>a.maxItemID&&(a.maxItemID=b.id)})})},a.getNewId=function(){return a.maxItemID+=1,a.maxItemID},a.raiseId=function(b){a.maxItemID+=b},a.lowerId=function(b){a.maxItemID-=b},a}),angular.module("emuwebApp").service("LevelService",["$q","DataService","LinkService","ConfigProviderService","Soundhandlerservice","viewState","Ssffdataservice","ArrayHelperService",function(a,b,c,d,e,f){function g(a,b){var c;return angular.forEach(b,function(b,d){b.name===a&&(c=d)}),c}var h={};return h.lasteditArea=null,h.lasteditAreaElem=null,h.getLevelDetails=function(a){var c=null,d=null;return angular.forEach(b.getLevelData(),function(b,e){b.name===a&&(c=b,d=e)}),{level:c,id:d}},h.getLevelNameByElementID=function(a){for(var c=null,d=0;d<b.getData().levels.length;++d)for(var e=0;e<b.getData().levels[d].items.length;++e)if(b.getData().levels[d].items[e].id===a){c=b.getData().levels[d].name;break}return c},h.getLevelsByType=function(a){var c=[];return angular.forEach(b.getLevelData(),function(b){var d=b.type;a.indexOf(d)>=0&&c.push(b)}),c},h.getOrderById=function(a,c){var d=void 0;return angular.forEach(b.getLevelData(),function(b){b.name===a&&b.items.forEach(function(a,b){a.id===c&&(d=b)})}),d},h.getIdByOrder=function(a,c){var d=null;return angular.forEach(b.getLevelData(),function(b){b.name===a&&b.items.forEach(function(a,b){b==c&&(d=a.id)})}),d},h.getItemDetails=function(a,c){var d=null;return angular.forEach(b.getLevelData(),function(b){b.name===a&&b.items.forEach(function(a,b){b==c&&(d=a)})}),d},h.getLastItem=function(a){var c=null;return angular.forEach(b.getLevelData(),function(b){b.name===a&&(c=b.items[b.items.length-1])}),c},h.getNextItem=function(a,c){var d=null;return angular.forEach(b.getLevelData(),function(b){b.name===a&&b.items.forEach(function(a,e){a.id==c&&(d=b.items[e+1])})}),d},h.getItemFromLevelById=function(a,c){var d=null;return angular.forEach(b.getLevelData(),function(b){b.name===a&&b.items.forEach(function(a){a.id==c&&(d=a)})}),d},h.getItemsFromLevelByIdAndLength=function(a,b,c){for(var d=[],e=b,f=0;c>f;f++){var g=h.getItemFromLevelById(a,e);e=h.getNextItem(a,g.id),d.push(g)}return d},h.getlasteditAreaElem=function(){return h.lasteditAreaElem},h.setlasteditAreaElem=function(a){h.lasteditAreaElem=a},h.setlasteditArea=function(a){h.lasteditArea=a},h.getlasteditArea=function(){return h.lasteditArea},h.getlastID=function(){return h.lasteditArea.substr(1)},h.deleteEditArea=function(){null!==h.getlasteditArea()&&$("."+h.getlasteditArea()).remove(),f.editing=!1},h.openEditArea=function(a,b,c){var d=f.getcurClickLevelName(),e=f.getCurAttrDef(d),i=g(e,a.labels),j=b.find("canvas").context.getContext("2d"),k=j.canvas.clientWidth,l=j.canvas.offsetLeft,m=j.canvas.offsetTop,n=j.canvas.clientHeight-1,o=10;void 0!==i&&a.labels[i].value.length>0&&(o=7*a.labels[i].value.length);var p="";if(a.labels.length>0&&(p=void 0!==a.labels[i]?a.labels[i].value:""),"SEGMENT"===c){var q=Math.floor(f.getPos(k,a.sampleStart)+l),r=Math.ceil(f.getPos(k,a.sampleStart+a.sampleDur+1)+l),s=r-q;if(2*o>s){var t=f.curViewPort.eS-f.curViewPort.sS;if(!(10>=t))return f.zoomViewPort(!0,this),void h.openEditArea(a,b,c);h.createEditAreaElement(b,q,m,r-q,n,a.labels[i].value,a.id)}h.createEditAreaElement(b,q,m,r-q,n,p,a.id)}else{var q=f.getPos(k,a.samplePoint)+l-o/2,r=f.getPos(k,a.samplePoint)+l+o/2,s=r-q;2*o>s&&(s=2*o),h.createEditAreaElement(b,q,m,s,n,p,a.id)}h.createSelection(b.find("textarea")[0],0,p.length)},h.createSelection=function(a,b,c){if(a.createTextRange){var d=a.createTextRange();d.collapse(!0),d.moveStart("character",b),d.moveEnd("character",c),d.select()}else a.setSelectionRange?a.setSelectionRange(b,c):a.selectionStart&&(a.selectionStart=b,a.selectionEnd=c);a.focus()},h.createEditAreaElement=function(a,b,c,d,e,f,g){var h="_"+g;a.prepend($("<textarea>").attr({id:h,"class":h+" emuwebapp-label-edit","ng-model":"message",autofocus:"true"}).css({left:Math.round(b+2)+"px",top:Math.round(c+1)+"px",width:Math.round(d)-2+"px",height:Math.round(e)-20+"px","padding-top":Math.round(e/3+1)+"px"}).text(f))},h.insertItemDetails=function(a,c,e,g,h,i){var j,k=d.getLevelDefinition(c).attributeDefinitions,l=f.getCurAttrDef(c);void 0===k&&(k=[]),angular.forEach(b.getLevelData(),function(b){if(b.name===c){if("SEGMENT"==b.type)if(j={id:a,sampleStart:h,sampleDur:i,labels:[]},k.length>0)for(var d=0;d<k.length;d++)j.labels.push(k[d].name===l?{name:k[d].name,value:g}:{name:k[d].name,value:g});else j.labels.push({name:c,value:g});else if("EVENT"==b.type)if(j={id:a,samplePoint:h,labels:[]},k.length>0)for(var d=0;d<k.length;d++)j.labels.push(k[d].name===l?{name:k[d].name,value:g}:{name:k[d].name,value:g});else j.labels.push({name:c,value:g});b.items.splice(e,0,j)}})},h.updateSegItemInLevel=function(a,c,d,e,f,g){angular.forEach(b.getLevelData(),function(b){b.name===a&&b.items.forEach(function(a){a.id==c&&(void 0!==f&&(a.sampleStart=f),void 0!==g&&(a.sampleDur=g),void 0!==d&&(a.labels[e].value=d))})})},h.setPointDetails=function(a,c,d,e){angular.forEach(b.getLevelData(),function(b){b.name===a&&b.items.forEach(function(a){a.id==c&&(a.samplePoint=e,a.labels[0].value=d)})})},h.getItemNeighboursFromLevel=function(a,c,d){var e=void 0,f=void 0;return angular.forEach(b.getLevelData(),function(b){b.name===a&&b.items.forEach(function(a,g){a.id==c&&(e=b.items[g-1]),a.id==d&&(f=b.items[g+1])})}),{left:e,right:f}},h.getClosestItem=function(a,b,c){var d=h.getLevelDetails(b).level,e=void 0,f=void 0,g=void 0,i=void 0;if(d.items.length>0)if(e=f=d.items[0],g=!0,i=!1,"SEGMENT"===d.type)angular.forEach(d.items,function(b,c){a>=b.sampleStart-.5&&(a<=b.sampleStart+b.sampleDur+.5&&(a-b.sampleStart>=b.sampleDur/2?void 0!==d.items[c+1]?(e=d.items[c],f=d.items[c+1],i=!1):(i=!0,e=f=d.items[d.items.length-1]):(i=!1,e=f=d.items[c])),g=!1),a>=b.sampleStart-.5&&(a<=b.sampleStart+b.sampleDur+.5?e=b:(i=!0,e=f=d.items[d.items.length-1]))});else{var j=0,k=0;g=!1,i=!1,angular.forEach(d.items,function(b,g){k=g<d.items.length-1?b.samplePoint+(d.items[g+1].samplePoint-d.items[g].samplePoint)/2:c,j=g>0?b.samplePoint-(d.items[g].samplePoint-d.items[g-1].samplePoint)/2:0,k>=a&&a>=j&&(e=f=b)})}return{current:e,nearest:f,isFirst:g,isLast:i}},h.deleteLevel=function(a,c){var e=b.getLevelDataAt(a);return b.deleteLevelDataAt(a),d.vals.perspectives[c].levelCanvases.order.splice(a,1),e},h.insertLevel=function(a,c,e){void 0===b.getLevelData()&&b.setLevelData([]),b.insertLevelDataAt(c,a),d.vals.perspectives[e].levelCanvases.order.splice(c,0,a.name)},h.renameLabel=function(a,b,c,d){h.updateSegItemInLevel(a,b,d,c)},h.renameLevel=function(a,c,e){angular.forEach(b.getLevelData(),function(b){b.name===a&&(b.name=c,angular.forEach(f.curLevelAttrDefs,function(b,c){b.curAttrDefName===a&&b.levelName===a&&f.curLevelAttrDefs.slice(c,1)}),f.curLevelAttrDefs.push({curAttrDefName:c,levelName:c}),angular.forEach(b.items,function(a){a.labels[0].name=c}))}),d.vals.perspectives[e].levelCanvases.order[d.vals.perspectives[e].levelCanvases.order.indexOf(a)]=c},h.deleteSegmentsInvers=function(a,c,d,e){var i,j,k,l=f.getCurAttrDef(a);k=0,angular.forEach(b.getLevelData(),function(b){if(b.name===a){k=e.order;for(j in e.segments)b.items.splice(k++,0,e.segments[j])}});var m=h.getItemNeighboursFromLevel(a,e.segments[0].id,e.segments[e.segments.length-1].id);void 0!==m.left&&void 0===m.right?(i=g(l,m.left.labels),h.updateSegItemInLevel(a,m.left.id,m.left.labels[i].value,i,m.left.sampleStart,m.left.sampleDur-e.timeRight)):void 0===m.left&&void 0!==m.right?(i=g(l,m.right.labels),h.updateSegItemInLevel(a,m.right.id,m.right.labels[i].value,i,m.right.sampleStart+e.timeLeft,m.right.sampleDur-e.timeLeft)):void 0===m.left&&void 0===m.right||(i=g(l,m.left.labels),h.updateSegItemInLevel(a,m.left.id,m.left.labels[i].value,i,m.left.sampleStart,m.left.sampleDur-e.timeLeft),h.updateSegItemInLevel(a,m.right.id,m.right.labels[i].value,i,m.right.sampleStart+e.timeRight,m.right.sampleDur-e.timeRight))},h.deleteSegments=function(a,c,d){for(var e=h.getItemFromLevelById(a,c),i=h.getOrderById(a,c),j=h.getItemDetails(a,i+d-1),k=h.getItemNeighboursFromLevel(a,e.id,j.id),l=0,m=0,n=null,o=null,p=null,q=f.getCurAttrDef(a),r=g(q,e.labels),s=i;i+d>s;s++)l+=h.getItemDetails(a,s).sampleDur+1;return l%2==0?(l/=2,m=l):(l=Math.ceil(l/2),m=l-1),angular.forEach(b.getLevelData(),function(b){b.name===a&&angular.forEach(b.items,function(a,e){a.id==c&&(n=e,o=b.items.splice(n,d))})}),void 0!==k.left&&void 0===k.right?(h.updateSegItemInLevel(a,k.left.id,void 0,r,k.left.sampleStart,k.left.sampleDur+m),p=k.left):void 0===k.left&&void 0!==k.right?(h.updateSegItemInLevel(a,k.right.id,void 0,r,k.right.sampleStart-l,k.right.sampleDur+l),p=k.right):void 0===k.left&&void 0===k.right?f.setcurMouseItem(void 0,void 0,void 0):(h.updateSegItemInLevel(a,k.left.id,void 0,r,k.left.sampleStart,k.left.sampleDur+l),h.updateSegItemInLevel(a,k.right.id,void 0,r,k.right.sampleStart-m,k.right.sampleDur+m),p=k.left),{order:n,segments:o,timeLeft:l,timeRight:m,clickSeg:p}},h.insertSegmentInvers=function(a,c,d){var e,f=!0;return angular.forEach(b.getLevelData(),function(b){if(b.name===a)if(c==d){var g=-1;if(angular.forEach(b.items,function(a,b){c==a.sampleStart&&(g=b,f=!0)}),f){var h=0;void 0!==b.items[g]&&(h=b.items[g].sampleDur+1),void 0!==b.items[g-1]&&(b.items[g-1].sampleDur+=h),b.items.splice(g,1)}}else{var g=-1;angular.forEach(b.items,function(a,b){c==a.sampleStart&&(g=b,f=!0)}),f&&(void 0===b.items[g+1]?b.items.splice(g-1,2):void 0===b.items[g-1]?b.items.splice(g,2):(h=b.items[g].sampleDur+1,e=b.items[g+1].sampleDur+1,b.items[g-1].sampleDur+=h+e,b.items.splice(g,2)))}}),f},h.insertSegment=function(a,c,d,e,f){var g=!0;return angular.forEach(b.getLevelData(),function(i){if(i.name===a)if(c==d){if(0==i.items.length)return{ret:!1,ids:f};void 0===f&&(f=[],f[0]=b.getNewId());var j=-1;if(c<i.items[0].sampleStart){var k=i.items[0].sampleStart-c;h.insertItemDetails(f[0],a,0,e,c,k-1)}else if(c>i.items[i.items.length-1].sampleStart+i.items[i.items.length-1].sampleDur){var l=i.items[i.items.length-1].sampleStart+i.items[i.items.length-1].sampleDur+1;h.insertItemDetails(f[0],a,i.items.length,e,l,c-l)}else if(angular.forEach(i.items,function(a,b){c>=a.sampleStart&&c<=a.sampleStart+a.sampleDur&&(j=b),a.sampleStart==c&&(g=!1),a.sampleStart+a.sampleDur+1==c&&(g=!1)}),g){var k=c-i.items[j].sampleStart-1;h.insertItemDetails(f[0],a,j+1,e,c,i.items[j].sampleDur-k-1),i.items[j].sampleDur=k}}else if(void 0===f&&(f=[],f[0]=b.getNewId(),f[1]=b.getNewId()),0==i.items.length)h.insertItemDetails(f[0],a,0,e,c,d-c-1);else if(d<i.items[0].sampleStart){var k=i.items[0].sampleStart-d-1,m=d-c-1;h.insertItemDetails(f[0],a,0,e,d,k),h.insertItemDetails(f[1],a,0,e,c,m)}else if(c>i.items[i.items.length-1].sampleStart+i.items[i.items.length-1].sampleDur){var k=c-(i.items[i.items.length-1].sampleStart+i.items[i.items.length-1].sampleDur)-1,m=d-c-1,n=i.items.length;h.insertItemDetails(f[0],a,n,e,i.items[i.items.length-1].sampleStart+i.items[i.items.length-1].sampleDur,k),h.insertItemDetails(f[1],a,n+1,e,c,m)}else{var j=-1,o=-1;if(angular.forEach(i.items,function(a,b){c>=a.sampleStart&&c<=a.sampleStart+a.sampleDur&&(j=b),d>=a.sampleStart&&d<=a.sampleStart+a.sampleDur&&(o=b)}),g=j===o,g&&-1!==j){var k=c-i.items[j].sampleStart-1,m=d-c-1;h.insertItemDetails(f[0],a,j+1,e,c,m),h.insertItemDetails(f[1],a,j+2,e,d,i.items[j].sampleDur-k-1-m-1),i.items[j].sampleDur=k}}}),{ret:g,ids:f}},h.insertEvent=function(a,c,d,e){var f=!1,g=void 0,i=void 0;return angular.forEach(b.getLevelData(),function(b){b.name===a&&"EVENT"===b.type&&(i=b.items.length>0?b.items[0].samplePoint:0,angular.forEach(b.items,function(a,b){Math.floor(c)===Math.floor(a.samplePoint)&&(f=!0),c>a.samplePoint&&(g=b+1)}))}),f||(void 0===e&&(e=b.getNewId()),h.insertItemDetails(e,a,g,d,c)),{alreadyExists:f,id:e}},h.deleteEvent=function(a,c){var d=!1;return angular.forEach(b.getLevelData(),function(b){b.name===a&&"EVENT"==b.type&&angular.forEach(b.items,function(a,e){d||c==a.id&&(d=a,b.items.splice(e,1))})}),d},h.deleteBoundary=function(a,c,d,e){var f=h.getItemFromLevelById(a,c),g=null,i=null,j=null,k=null;return angular.forEach(b.getLevelData(),function(b){b.name===a&&(g=b.items[0],angular.forEach(b.items,function(a,c){if("SEGMENT"===b.type&&f.sampleStart==a.sampleStart&&f.sampleDur==a.sampleDur)if(0===c&&d)b.items.splice(c,1),i=c,j=a,k=b.items[0];else if(c===b.items.length-1&&e)b.items.splice(c,1),i=c,j=a,k=b.items[b.items.length-1];else{for(var h=0;h<g.labels.length;h++)g.labels[h].value+=a.labels[h].value;g.sampleDur+=a.sampleDur+1,b.items.splice(c,1),i=c,j=a,k=g}g=a}),null==k&&(k=b.items[0]))}),{order:i,event:j,clickSeg:k}},h.deleteBoundaryInvers=function(a,c,d,e,f){angular.forEach(b.getLevelData(),function(b){if(b.name===a){b.items.splice(f.order,0,f.event);var c=f.event.labels[0].value;d||e||(c=b.items[f.order-1].labels[0].value.slice(0,b.items[f.order-1].labels[0].value.length-f.event.labels[0].value.length),b.items[f.order-1].labels[0].value=c,b.items[f.order-1].sampleDur-=f.event.sampleDur+1)}})},h.snapBoundary=function(a,c,d,e,f){var g,h,i,j,k=1/0,l=void 0;return"SEGMENT"==f?i=d.sampleStart:"EVENT"==f&&(i=d.samplePoint),angular.forEach(b.getLevelData(),function(d,e){if(d.name===c){if(a){if(!(e>=1))return!1;g=b.getLevelData()[e-1]}else{if(!(e<b.getLevelData().length-1))return!1;g=b.getLevelData()[e+1]}g.items.forEach(function(a){"SEGMENT"==g.type?j=a.sampleStart:"EVENT"==g.type&&(j=a.samplePoint),h=Math.abs(i-j),k>h&&(k=h,l=j-i)})}}),void 0!==l?("SEGMENT"==f?this.moveBoundary(c,d.id,l,0):"EVENT"==f&&this.moveEvent(c,d.id,l),l):!1},h.moveBoundary=function(a,b,c,d,i){var j=h.getItemFromLevelById(a,b),k=f.getCurAttrDef(a),l=g(k,j.labels),m=h.getItemNeighboursFromLevel(a,b,b);if(d){var n=m.right;void 0!==n?j.sampleStart+c>=0&&j.sampleStart+c<n.sampleStart&&h.updateSegItemInLevel(a,j.id,void 0,l,j.sampleStart+c,j.sampleDur-c):j.sampleStart+c>=0&&j.sampleDur-c>=0&&j.sampleStart+j.sampleDur+c<=e.wavJSO.Data.length&&h.updateSegItemInLevel(a,j.id,void 0,l,j.sampleStart+c,j.sampleDur-c)}else if(i)j.sampleDur+c>=0&&j.sampleDur+j.sampleStart+c<=e.wavJSO.Data.length&&h.updateSegItemInLevel(a,j.id,void 0,l,j.sampleStart,j.sampleDur+c);else if(void 0===m.left){var n=m.right;void 0!==n?j.sampleStart+c>=0&&j.sampleStart+c<n.sampleStart&&h.updateSegItemInLevel(a,j.id,void 0,l,j.sampleStart+c,j.sampleDur-c):j.sampleStart+c>=0&&j.sampleStart+j.sampleDur+c<=e.wavJSO.Data.length&&h.updateSegItemInLevel(a,j.id,void 0,l,j.sampleStart+c,j.sampleDur-c)}else{var o=m.left;o.sampleDur+c>=0&&j.sampleStart+c>=0&&j.sampleDur-c>=0&&(h.updateSegItemInLevel(a,m.left.id,void 0,l,o.sampleStart,o.sampleDur+c),h.updateSegItemInLevel(a,j.id,void 0,l,j.sampleStart+c,j.sampleDur-c))}},h.moveEvent=function(a,d,f){var g=h.getItemFromLevelById(a,d);if(c.isLinked(d)){var i=h.getItemNeighboursFromLevel(a,d,d);g.samplePoint+f>0&&g.samplePoint+f<=e.wavJSO.Data.length&&(void 0!==i.left&&void 0!==i.right?g.samplePoint+f>i.left.samplePoint&&g.samplePoint+f<i.right.samplePoint&&h.setPointDetails(a,g.id,g.labels[0].value,g.samplePoint+f):void 0===i.left&&void 0===i.right?h.setPointDetails(a,g.id,g.labels[0].value,g.samplePoint+f):void 0===i.left&&void 0!==i.right?g.samplePoint+f>0&&g.samplePoint+f<i.right.samplePoint&&h.setPointDetails(a,g.id,g.labels[0].value,g.samplePoint+f):void 0!==i.left&&void 0===i.right&&g.samplePoint+f>i.left.samplePoint&&g.samplePoint+f<=e.wavJSO.Data.length&&h.setPointDetails(a,g.id,g.labels[0].value,g.samplePoint+f))}else g.samplePoint+f>0&&g.samplePoint+f<=e.wavJSO.Data.length&&h.setPointDetails(a,g.id,g.labels[0].value,g.samplePoint+f),angular.forEach(b.getLevelData(),function(b){b.name===a&&b.items.sort(h.orderPoints)
})},h.orderPoints=function(a,b){return a.samplePoint>b.samplePoint?1:a.samplePoint<b.samplePoint?-1:0},h.moveSegment=function(a,b,c,d){var i=h.getOrderById(a,b),j=h.getItemDetails(a,i),k=h.getItemDetails(a,i+c-1),l=h.getItemNeighboursFromLevel(a,j.id,k.id),m=f.getCurAttrDef(a),n=g(m,j.labels);if(void 0===l.left&&void 0!==l.right){var o=h.getItemFromLevelById(a,l.right.id);if(j.sampleStart+d>0&&l.right.sampleDur-d>=0){h.updateSegItemInLevel(a,o.id,void 0,n,o.sampleStart+d,o.sampleDur-d);for(var p=i;i+c>p;p++){var q=h.getItemDetails(a,p);h.updateSegItemInLevel(a,q.id,void 0,n,q.sampleStart+d,q.sampleDur)}}}else if(void 0===l.right&&void 0!==l.left){var r=h.getItemFromLevelById(a,l.left.id);if(l.left.sampleDur+d>=0&&k.sampleStart+k.sampleDur+d<e.wavJSO.Data.length){h.updateSegItemInLevel(a,r.id,void 0,n,r.sampleStart,r.sampleDur+d);for(var p=i;i+c>p;p++){var q=h.getItemDetails(a,p);h.updateSegItemInLevel(a,q.id,void 0,n,q.sampleStart+d,q.sampleDur)}}}else if(void 0!==l.right&&void 0!==l.left){var s=h.getItemFromLevelById(a,l.left.id),t=h.getItemFromLevelById(a,l.right.id);if(s.sampleDur+d>=0&&t.sampleDur-d>=0){h.updateSegItemInLevel(a,s.id,void 0,n,s.sampleStart,s.sampleDur+d),h.updateSegItemInLevel(a,t.id,void 0,n,t.sampleStart+d,t.sampleDur-d);for(var p=i;i+c>p;p++){var q=h.getItemDetails(a,p);h.updateSegItemInLevel(a,q.id,void 0,n,q.sampleStart+d,q.sampleDur)}}}else if(void 0===l.right&&void 0===l.left){var u=h.getItemDetails(a,i),v=h.getItemDetails(a,i+c-1);if(u.sampleStart+d>0&&v.sampleDur+v.sampleStart+d<e.wavJSO.Data.length)for(var p=i;i+c>p;p++){var q=h.getItemDetails(a,p);h.updateSegItemInLevel(a,q.id,void 0,n,q.sampleStart+d,q.sampleDur)}}},h.expandSegment=function(a,b,c,d){var i,j=0,k=h.getItemNeighboursFromLevel(c,b[0].id,b[b.length-1].id),l=(d*b.length,f.getCurAttrDef(c)),m=g(l,b[0].labels),n=!0;if(a)if(void 0===k.right){var o=b[b.length-1].sampleStart+b[b.length-1].sampleDur+d*b.length;o<=e.wavJSO.Data.length&&angular.forEach(b,function(a){i=h.getItemFromLevelById(c,a.id),h.updateSegItemInLevel(c,i.id,void 0,m,i.sampleStart+j,i.sampleDur+d),j+=d})}else angular.forEach(b,function(a){a.sampleDur+1+d<0&&(n=!1)}),n&&k.right.sampleDur-d*b.length>0&&(angular.forEach(b,function(a){i=h.getItemFromLevelById(c,a.id),h.updateSegItemInLevel(c,i.id,void 0,m,i.sampleStart+j,i.sampleDur+d),j+=d}),h.updateSegItemInLevel(c,k.right.id,void 0,m,k.right.sampleStart+j,k.right.sampleDur-j));else if(void 0===k.left){var p=h.getItemDetails(c,0);p.sampleStart+d*(b.length+1)>0&&angular.forEach(b,function(a){i=h.getItemFromLevelById(c,a.id),h.updateSegItemInLevel(c,i.id,void 0,i.sampleStart-d,m,i.sampleDur+d)})}else angular.forEach(b,function(a){a.sampleDur+1+d<0&&(n=!1)}),n&&k.left.sampleDur-d*b.length>0&&(j=0,angular.forEach(b,function(a,e){i=h.getItemFromLevelById(c,a.id),j=-(b.length-e)*d,h.updateSegItemInLevel(c,i.id,void 0,m,i.sampleStart+j,i.sampleDur+d)}),h.updateSegItemInLevel(c,k.left.id,void 0,m,k.left.sampleStart,k.left.sampleDur-b.length*d))},h.calcDistanceToNearestZeroCrossing=function(a){for(var b=1/0,c=1/0,d=a;d<e.wavJSO.Data.length-1;d++)if(e.wavJSO.Data[d]>=0&&e.wavJSO.Data[d+1]<0||e.wavJSO.Data[d]<0&&e.wavJSO.Data[d+1]>=0){b=d-a;break}for(var d=a;d>1;d--)if(e.wavJSO.Data[d]>=0&&e.wavJSO.Data[d-1]<0||e.wavJSO.Data[d]<0&&e.wavJSO.Data[d-1]>=0){c=d-a;break}var f;return f=Math.abs(c)<Math.abs(b)?c:b+1},h.getAllLabelsOfLevel=function(a){for(var b=f.getCurAttrDef(a.level.name),c=[],d=0;d<a.level.items.length;d++)for(var e=0;e<a.level.items[d].labels.length;e++)a.level.items[d].labels[e].name===b&&c.push(a.level.items[d].labels[e].value);return c},h.getLevelName=function(a){var c=null;return angular.forEach(b.getLevelData(),function(b){angular.forEach(b.items,function(d){d.id===a&&(c=b.name)})}),c},h.getLevelAndItem=function(a){var c,d,e,f,g=!1;for(c=0;c<b.getLevelData().length;++c){for(e=b.getLevelData()[c],d=0;d<e.items.length;++d)if(f=e.items[d],f.id===a){g=!0;break}if(g)break}return g?{level:e,item:f}:null},h.pushNewItem=function(a,c){var e=h.getLevelDetails(a).level;if(console.debug(a,e,c),"ITEM"===e.type){if("number"==typeof c)var f={id:c,labels:[]};else var f={id:b.getNewId(),labels:[]};for(var g=d.getLevelDefinition(e.name).attributeDefinitions,i=0;i<g.length;++i)f.labels.push("STRING"===g[i].type?{name:g[i].name,value:""}:{name:g[i].name,value:null});return e.items.push(f),f.id}return-1},h.addItem=function(a,c,e){if(void 0===a)return-1;if("boolean"!=typeof c)return-1;var f=h.getLevelAndItem(a);if(null===f)return console.debug("Could not find item with id:",a),-1;var g=f.level,i=f.item;if("ITEM"===g.type){var j,k=g.items.indexOf(i);if(j=c===!0?k:k+1,void 0===e)var l={id:b.getNewId(),labels:[]};else var l={id:e,labels:[]};for(var m=d.getLevelDefinition(g.name).attributeDefinitions,n=0;n<m.length;++n)l.labels.push("STRING"===m[n].type?{name:m[n].name,value:""}:{name:m[n].name,value:null});return g.items.splice(j,0,l),l.id}return-1},h.addItemInvers=function(a){for(var c=b.getLevelData(),d=0;d<c.length;++d)for(var e=0;e<c[d].items.length;++e)if(c[d].items[e].id===a)return void c[d].items.splice(e,1)},h.deleteItemWithLinks=function(a){var c={item:void 0,levelName:void 0,position:void 0,deletedLinks:[]},d=h.getLevelAndItem(a);if(null===d)return c;var e=d.level,f=d.item;if("ITEM"!==e.type)return c;console.log("Deleting item:",f,"From level:",e),c.item=f,c.levelName=e.name,c.position=e.items.indexOf(f),e.items.splice(e.items.indexOf(f),1);for(var g=b.getLinkData(),i=g.length-1;i>=0;--i)(g[i].fromID===a||g[i].toID===a)&&(console.log("Deleting link",i),c.deletedLinks.push(g[i]),g.splice(i,1));return c},h.deleteItemWithLinksInvers=function(a,c,d,e){h.getLevelDetails(c).level.items.splice(d,0,a);for(var f=0;f<e.length;++f)b.insertLinkData(e[f])},h.getItemByID=function(a){for(var c=b.getLevelData(),d=0;d<c.length;++d)for(var e=0;e<c[d].items.length;++e)if(c[d].items[e].id===a)return c[d].items[e];return void 0},h}]),angular.module("emuwebApp").service("LinkService",["DataService",function(a){var b={};return b.insertLink=function(b,c){a.insertLinkData({fromID:b,toID:c})},b.insertLinkAt=function(b,c,d){a.insertLinkDataAt(d,{fromID:b,toID:c})},b.deleteLink=function(b,c){var d=-1;return angular.forEach(a.getLinkData(),function(e,f){e.fromID===b&&e.toID===c&&(a.deleteLinkDataAt(f),d=f)}),d},b.linkExists=function(b,c){var d=!1;return angular.forEach(a.getLinkData(),function(a){a.fromID===b&&a.toID===c&&(d=!0)}),d},b.hasParents=function(b){var c=!1;return angular.forEach(a.getLinkData(),function(a){a.toID===b&&(c=!0)}),c},b.hasChildren=function(b){var c=!1;return angular.forEach(a.getLinkData(),function(a){a.fromID===b&&(c=!0)}),c},b.isLinked=function(a){return b.hasChildren(a)||b.hasParents(a)},b.insertLinksTo=function(a,c){angular.forEach(c,function(c){b.insertLink(a,c)})},b.deleteLinksTo=function(a,c){var d=[];return angular.forEach(c,function(c){b.deleteLink(a,c),d.push({fromID:a,toID:c})}),d},b.insertLinksFrom=function(a,c){angular.forEach(a,function(a){b.insertLink(a,c)})},b.deleteLinksFrom=function(a,c){var d=[];return angular.forEach(a,function(a){d.push({fromID:a,toID:c}),b.deleteLink(a,c)}),d},b.getLinksTo=function(b){var c=[];return angular.forEach(a.getLinkData(),function(a,d){a.toID===b&&c.push({link:a,order:d})}),c},b.getLinksFrom=function(b){var c=[];return angular.forEach(a.getLinkData(),function(a,d){a.fromID===b&&c.push({link:a,order:d})}),c},b.changeLinkTo=function(b,c,d){angular.forEach(a.getLinkData(),function(e,f){e.fromID===b&&e.toID===c&&a.changeLinkDataAt(f,b,d)})},b.changeLinkFrom=function(b,c,d){angular.forEach(a.getLinkData(),function(e,f){e.fromID===b&&e.toID===c&&a.changeLinkDataAt(f,d,c)})},b.deleteLinkSegment=function(a){var c=[],d=[];return angular.forEach(a,function(a){angular.forEach(b.getLinksTo(a.id),function(a){c.push({fromID:a.link.fromID,toID:a.link.toID}),b.deleteLink(a.link.fromID,a.link.toID)}),angular.forEach(b.getLinksFrom(a.id),function(a){d.push({fromID:a.link.fromID,toID:a.link.toID}),b.deleteLink(a.link.fromID,a.link.toID)})}),{linksTo:c,linksFrom:d}},b.deleteLinkSegmentInvers=function(a){angular.forEach(a.linksTo,function(a){b.insertLink(a.fromID,a.toID)}),angular.forEach(a.linksFrom,function(a){b.insertLink(a.fromID,a.toID)})},b.deleteLinkBoundary=function(a,c){var d=[],e=[],f=0;return c>0?(angular.forEach(b.getLinksTo(a),function(e){b.linkExists(e.link.fromID,c)?(f=b.deleteLink(e.link.fromID,a),d.push({fromID:e.link.fromID,toID:a,deleted:!0,order:f,neighbourID:0})):(b.changeLinkTo(e.link.fromID,a,c),d.push({fromID:e.link.fromID,toID:a,deleted:!1,order:f,neighbourID:c}))}),angular.forEach(b.getLinksFrom(a),function(d){b.linkExists(c,d.link.toID)?(f=b.deleteLink(a,d.link.toID),e.push({fromID:a,toID:d.link.toID,deleted:!0,order:f,neighbourID:0})):(b.changeLinkFrom(a,d.link.toID,c),e.push({fromID:a,toID:d.link.toID,deleted:!1,order:f,neighbourID:c}))})):(angular.forEach(b.getLinksTo(a),function(c){f=b.deleteLink(c.link.fromID,a),d.push({fromID:c.link.fromID,toID:a,deleted:!0,order:f,neighbourID:0})}),angular.forEach(b.getLinksFrom(a),function(c){f=b.deleteLink(a,c.link.toID),e.push({fromID:a,toID:c.link.toID,deleted:!0,order:f,neighbourID:0})})),{linksTo:d,linksFrom:e}},b.deleteLinkBoundaryInvers=function(a){angular.forEach(a.linksTo,function(a){a.deleted?b.insertLinkAt(a.fromID,a.toID,a.order):b.changeLinkTo(a.fromID,a.neighbourID,a.toID)}),angular.forEach(a.linksFrom,function(a){a.deleted?b.insertLinkAt(a.fromID,a.toID,a.order):b.changeLinkFrom(a.neighbourID,a.toID,a.fromID)})},b}]),angular.module("emuwebApp").service("Websockethandler",["$q","$rootScope","$location","$timeout","HistoryService","Ssffparserservice","ConfigProviderService","viewState","Wavparserservice","Soundhandlerservice","Espsparserservice","uuid","Binarydatamaniphelper","Ssffdataservice","modalService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){function p(a){z=!0,b.$apply(y.resolve(a))}function q(a){u(angular.fromJson(a.data))}function r(a){console.error("WEBSOCKET ERROR!!!!!"),b.$apply(y.resolve(a))}function s(a){!a.wasClean&&z&&o.open("views/error.html","A non clean disconnect to the server occurred! This probably means that the server is down. Please check the server and reconnect!").then(function(){b.$broadcast("connectionDisrupted")}),z=!1,console.log("WEBSOCKET closed!!!!!")}function t(b){var c=a.defer(),e=v();return x[e]={time:new Date,cb:c},b.callbackID=e,w.ws.send(angular.toJson(b)),d(function(){var a={callbackID:e,status:{type:"ERROR:TIMEOUT",message:"Sent request of type: "+b.type+" timed out after "+g.vals.main.serverTimeoutInterval+"ms!  Please check the server..."}};u(a)},g.vals.main.serverTimeoutInterval),c.promise}function u(a){var c=a;if(x.hasOwnProperty(c.callbackID)){switch(c.type){case"getESPSfile":alert("espsfile");break;case"getSSFFfile":alert("ssfffile")}"SUCCESS"===c.status.type?b.$apply(x[c.callbackID].cb.resolve(c.data)):(w.closeConnect(),b.$broadcast("resetToInitState"),b.$apply(o.open("views/error.html","Communication error with server! Error message is: "+c.status.message))),delete x[c.callbackID]}else"ERROR:TIMEOUT"===c.status.type||o.open("views/error.html","What just happened? You should not be here...")}function v(){var a=l.new();return a}var w={},x={};w.ws={};var y={},z=!1;return w.initConnect=function(b){var c=a.defer();return w.ws=new WebSocket(b),w.ws.onopen=p,w.ws.onmessage=q,w.ws.onerror=r,w.ws.onclose=s,y=c,c.promise},w.isConnected=function(){return z},w.closeConnect=function(){w.isConnected()?(w.ws.onclose=function(){},w.ws.close()):console.log("WEBSOCKET ERROR: was not connected!")},w.getProtocol=function(){var a={type:"GETPROTOCOL"},b=t(a);return b},w.getDoUserManagement=function(){var a={type:"GETDOUSERMANAGEMENT"},b=t(a);return b},w.logOnUser=function(a,b){var c={type:"LOGONUSER",userName:a,pwd:b},d=t(c);return d},w.getDBconfigFile=function(){var a={type:"GETGLOBALDBCONFIG"},b=t(a);return b},w.getBundleList=function(){var a={type:"GETBUNDLELIST"},b=t(a);return b},w.getBundle=function(a,b){var c={type:"GETBUNDLE",name:a,session:b},d=t(c);return d},w.saveBundle=function(a){var b={type:"SAVEBUNDLE",data:a},c=t(b);return c},w.disconnectWarning=function(){var a={type:"DISCONNECTWARNING"},b=t(a);return b},w.getDoEditDBConfig=function(){var a={type:"GETDOEDITDBCONFIG"},b=t(a);return b},w.editDBConfig=function(a,b){var c={type:"EDITDBCONFIG",subtype:a,data:b},d=t(c);return d},w}]),angular.module("emuwebApp").service("Binarydatamaniphelper",function(){var a={};return a.base64ToArrayBuffer=function(a){for(var b=window.atob(a),c=b.length,d=new Uint8Array(c),e=0;c>e;e++){var f=b.charCodeAt(e);d[e]=f}return d.buffer},a.arrayBufferToBase64=function(a){for(var b="",c=new Uint8Array(a),d=c.byteLength,e=0;d>e;e++)b+=String.fromCharCode(c[e]);return window.btoa(b)},a}),angular.module("emuwebApp").service("Appcachehandler",["$http","modalService",function(a,b){var c={},d=window.applicationCache;return c.handleUpdatereadyEvent=function(){b.open("views/confirmModal.html","A new version of the EMU-WebApp is available and has already been downloaded and cached in your browser. Would you like to use it? CAUTION: A reload will delete all current changes... TIP: the next time you use the EMU-webApp you will automatically use the updated version)").then(function(a){a&&(d.swapCache(),window.location.reload())})},d.addEventListener("updateready",c.handleUpdatereadyEvent,!1),c.checkForNewVersion=function(){0!==d.status&&3!==d.status&&(console.log("INFO: appCache.status: "+d.status),d.update())},c}]),angular.module("emuwebApp").controller("spectSettingsCtrl",["$scope","modalService","viewState","DataService","mathHelperService","Soundhandlerservice",function(a,b,c,d,e,f){a.vs=c,a.options=Object.keys(a.vs.getWindowFunctions()),a.selWindowInfo={},a.selWindowInfo.name=Object.keys(a.vs.getWindowFunctions())[a.vs.spectroSettings.window-1],a.errorID=[],a.upperBoundary="",a.modalVals={rangeFrom:a.vs.spectroSettings.rangeFrom,rangeTo:a.vs.spectroSettings.rangeTo,dynamicRange:a.vs.spectroSettings.dynamicRange,windowSizeInSecs:a.vs.spectroSettings.windowSizeInSecs,window:a.vs.spectroSettings.window,drawHeatMapColors:a.vs.spectroSettings.drawHeatMapColors,preEmphasisFilterFactor:a.vs.spectroSettings.preEmphasisFilterFactor,heatMapColorAnchors:c.spectroSettings.heatMapColorAnchors,_fftN:512,_windowSizeInSamples:f.wavJSO.SampleRate*a.vs.spectroSettings.windowSizeInSecs},a.cursorInTextField=function(){c.setEditing(!0),c.setcursorInTextField(!0)},a.cursorOutOfTextField=function(){c.setEditing(!1),c.setcursorInTextField(!1)},a.calcWindowSizeInSamples=function(){a.modalVals._windowSizeInSamples=f.wavJSO.SampleRate*a.modalVals.windowSizeInSecs},a.calcFftN=function(){var b=e.calcClosestPowerOf2Gt(a.modalVals._windowSizeInSamples);512>b&&(b=512),a.modalVals._fftN=b},a.calcWindowSizeVals=function(){a.calcWindowSizeInSamples(),a.calcFftN()},a.reset=function(){a.errorID=[],a.modalVals={rangeFrom:a.vs.spectroSettings.rangeFrom,rangeTo:a.vs.spectroSettings.rangeTo,dynamicRange:a.vs.spectroSettings.dynamicRange,windowSizeInSecs:a.vs.spectroSettings.windowSizeInSecs,window:a.vs.spectroSettings.window,drawHeatMapColors:a.vs.spectroSettings.drawHeatMapColors,preEmphasisFilterFactor:a.vs.spectroSettings.preEmphasisFilterFactor,heatMapColorAnchors:c.spectroSettings.heatMapColorAnchors,_fftN:512,_windowSizeInSamples:f.wavJSO.SampleRate*a.vs.spectroSettings.windowSizeInSecs},b.close()},a.cssError=function(b,c){return a.errorID[b]?{background:"#f00"}:void 0!==c&&a.errorID[c]?{background:"#f00"}:void 0},a.htmlError=function(b){return a.errorID[b]},a.saveSpectroSettings=function(){var b=!1;a.errorID.forEach(function(a){a===!0&&(b=!0)}),b||(c.setspectroSettings(a.modalVals.windowSizeInSecs,a.modalVals.rangeFrom,a.modalVals.rangeTo,a.modalVals.dynamicRange,a.selWindowInfo.name,a.modalVals.drawHeatMapColors,a.modalVals.preEmphasisFilterFactor,a.modalVals.heatMapColorAnchors),a.reset())},a.checkSpectroSettings=function(){a.errorID[8]=a.modalVals.heatMapColorAnchors[0][0]%1!==0||a.modalVals.heatMapColorAnchors[0][1]%1!==0||a.modalVals.heatMapColorAnchors[0][2]%1!==0||a.modalVals.heatMapColorAnchors[1][0]%1!==0||a.modalVals.heatMapColorAnchors[1][1]%1!==0||a.modalVals.heatMapColorAnchors[1][2]%1!==0||a.modalVals.heatMapColorAnchors[2][0]%1!==0||a.modalVals.heatMapColorAnchors[2][1]%1!==0||a.modalVals.heatMapColorAnchors[2][2]%1!==0?!0:!1,a.errorID[7]=isNaN(a.modalVals.preEmphasisFilterFactor*f.wavJSO.SampleRate)?!0:!1,a.errorID[6]=isNaN(f.wavJSO.SampleRate*a.modalVals.windowSizeInSecs)?!0:!1,a.errorID[5]=a.modalVals.dynamicRange%1!==0?!0:!1,a.errorID[4]=a.modalVals.rangeFrom%1!==0?!0:!1,a.errorID[3]=a.modalVals.rangeTo%1!==0?!0:!1,a.errorID[2]=a.modalVals.rangeFrom<0?!0:!1,a.upperBoundary=d.data.sampleRate/2,a.errorID[1]=a.modalVals.rangeTo>a.upperBoundary?!0:!1}}]),angular.module("emuwebApp").filter("regex",function(){return function(a,b){for(var c=new RegExp(b.toLowerCase()),d=[],e=0;e<a.length;e++)c.test(a[e].name.toLowerCase())&&d.push(a[e]);return d}}),angular.module("emuwebApp").filter("levelsFilter",["ConfigProviderService","viewState",function(a,b){return function(c){if(c){for(var d,e=new RegExp("SEGMENT|EVENT"),f=[],g=0;g<c.length;g++)e.test(c[g].type)&&void 0!==a.vals.perspectives[b.curPerspectiveIdx].levelCanvases&&(d=a.vals.perspectives[b.curPerspectiveIdx].levelCanvases.order.indexOf(c[g].name),-1!==d&&f.push(c[g]));return f}}}]),angular.module("emuwebApp").controller("ModalCtrl",["$scope","ArrayHelperService","modalService","viewState","LevelService","HistoryService","ConfigProviderService",function(a,b,c,d,e,f,g){a.cps=g,a.data=void 0,a.cursorInTextField=function(){d.setEditing(!0),d.setcursorInTextField(!0)},a.cursorOutOfTextField=function(){d.setEditing(!1),d.setcursorInTextField(!1)},a.saveChanges=function(){c.close()},a.discardChanges=function(){c.close()},a.renameLevel=function(){e.renameLevel(c.dataIn,a.data,d.curPerspectiveIdx),f.addObjToUndoStack({type:"ANNOT",action:"RENAMELEVEL",newname:a.data,name:c.dataIn,curPerspectiveIdx:d.curPerspectiveIdx}),c.close()},a.deleteLevel=function(){var a=e.getLevelDetails(d.getcurClickLevelName());e.deleteLevel(d.getcurClickLevelIndex(),d.curPerspectiveIdx),f.addObjToUndoStack({type:"ANNOT",action:"DELETELEVEL",level:a.level,id:d.getcurClickLevelIndex(),curPerspectiveIdx:d.curPerspectiveIdx}),c.close()}}]),angular.module("emuwebApp").directive("showMenu",["$animate",function(a){return{restrict:"A",link:function(b,c,d){b.$watch(d.showMenu,function(b){b?(a.addClass(c,"emuwebapp-expandWidthTo200px"),a.removeClass(c,"emuwebapp-shrinkWidthTo0px")):(a.removeClass(c,"emuwebapp-expandWidthTo200px"),a.addClass(c,"emuwebapp-shrinkWidthTo0px"))})}}}]),angular.module("emuwebApp").directive("showTwod",["$animate",function(a){return{restrict:"A",link:function(b,c,d){b.$watch(d.showTwod,function(b){b?a.addClass(c,".slideIn2dCanvases"):a.removeClass(c,".slideIn2dCanvases")})}}}]),angular.module("emuwebApp").animation(".slideIn2dCanvases",function(){return{addClass:function(a){a.addClass("slide2dCanvases")},removeClass:function(a){a.removeClass("slide2dCanvases")}}}),angular.module("emuwebApp").directive("bgSplitter",["$rootScope","viewState",function(a,b){return{restrict:"E",replace:!0,transclude:!0,scope:{showTwoDimCans:"@"},template:'<div class="emuwebapp-split-panes vertical" ng-transclude></div>',controller:["$scope",function(a){a.panes=[],a.bottomRightResizePane,this.addPane=function(b){if(a.panes.length>1)throw"splitters can only have two panes";return a.panes.push(b),a.panes.length},this.setBottomRightResizePane=function(b){a.bottomRightResizePane=b}}],link:function(c,d,e){var f=!1,g=!1,h=!1,i=angular.element('<div id="emuwebapp-split-handler" class="emuwebapp-split-handler"><span></span></div>'),j=c.panes[0],k=c.panes[1],l=c.bottomRightResizePane,m=angular.element('<div class="top"></div>'),n=angular.element('<div class="left"></div>'),o=angular.element('<div class="corner"></div>');l.elem.prepend(n),l.elem.prepend(m),l.elem.prepend(o);var p=j.minSize||0,q=k.minSize||0,r=!1,s=!1;j.elem.after(i),e.$observe("showTwoDimCans",function(a){"false"===a?c.bottomRightResizePane.elem.hide():c.bottomRightResizePane.elem.show()}),d.bind("mousemove",function(c){if(s){var e=d[0].getBoundingClientRect(),m=0;if(r){var n=e.bottom-e.top;if(m=c.clientY-e.top,p>m)return;if(q>n-m)return;i.css("top",m+"px"),j.elem.css("height",m+"px"),k.elem.css("top",m+"px"),b.setdragBarHeight(m),a.$digest()}if(f){var n=e.bottom-e.top;if(m=c.clientY-e.top,10>=m||10>=n-m)return;l.elem.css("top",m+"px");var o=n-m;l.elem.css("height",o+"px")}if(g){var t=e.right-e.left;if(m=c.clientX-e.left,10>=m||10>=t-m)return;var o=t-m;l.elem.css("width",o+"px")}if(h){var n=e.bottom-e.top;if(m=c.clientY-e.top,10>=m||10>=n-m)return;l.elem.css("top",m+"px");var o=n-m;l.elem.css("height",o+"px");var t=e.right-e.left;if(m=c.clientX-e.left,10>=m||10>=t-m)return;var o=t-m;l.elem.css("width",o+"px")}}}),i.bind("mousedown",function(c){c.preventDefault(),s=!0,r=!0,b.setdragBarActive(!0),a.$digest()}),m.bind("mousedown",function(c){c.preventDefault(),s=!0,f=!0,b.setdragBarActive(!0),a.$digest()}),n.bind("mousedown",function(c){c.preventDefault(),s=!0,g=!0,b.setdragBarActive(!0),a.$digest()}),o.bind("mousedown",function(c){c.preventDefault(),s=!0,h=!0,b.setdragBarActive(!0),a.$digest()}),angular.element(document).bind("mouseup",function(){s=!1,r=!1,f=!1,g=!1,h=!1,b.setdragBarActive(!1),a.$digest()})}}}]).directive("bgPane",function(){return{restrict:"E",require:"^bgSplitter",replace:!0,transclude:!0,scope:{minSize:"=",type:"@",showTwoDimCans:"@"},template:'<div class="{{typeclass}}" ng-transclude></div>',link:function(a,b,c,d){"emuwebapp-2d-map"!==a.type?(a.elem=b,a.index=d.addPane(a),a.typeclass="split-pane"+a.index):(a.elem=b,a.index=3,a.typeclass="emuwebapp-2d-map",d.setBottomRightResizePane(a))}}}),angular.module("emuwebApp").directive("ssffTrack",["$timeout","viewState","ConfigProviderService","loadedMetaDataService",function(a,b,c,d){return{templateUrl:"views/ssffTrack.html",restrict:"E",link:function(b,e,f){var g,h=e.find("canvas").length,i=(e.find("canvas")[1],e.find("canvas")[h-1]),j=i.getContext("2d");b.lmds=d,f.$observe("trackName",function(a){a&&(g=a)}),b.order=f.order,b.$watch("vs.submenuOpen",function(){a(b.drawSsffTrackMarkup,c.design.animation.duration)}),b.$watch("vs.timelineSize",function(){a(b.drawSsffTrackMarkup,c.design.animation.duration)}),b.$watch("vs.curViewPort",function(){$.isEmptyObject(b.shs)||$.isEmptyObject(b.shs.wavJSO)||b.drawSsffTrackMarkup()},!0),b.$watch("ssffds.data.length",function(){$.isEmptyObject(b.shs)||$.isEmptyObject(b.shs.wavJSO)||b.drawSsffTrackMarkup()},!0),b.$watch("vs.movingBoundary",function(){$.isEmptyObject(b.shs)||$.isEmptyObject(b.shs.wavJSO)||b.drawSsffTrackMarkup()},!0),b.$watch("vs.movingBoundarySample",function(){$.isEmptyObject(b.shs)||$.isEmptyObject(b.shs.wavJSO)||b.drawSsffTrackMarkup()},!0),b.$watch("lmds.getCurBndl()",function(a,c){$.isEmptyObject(b.shs)||$.isEmptyObject(b.shs.wavJSO)||(a.name!==c.name||a.session!==c.session)&&b.drawSsffTrackMarkup()},!0),b.drawSsffTrackMarkup=function(){if(!$.isEmptyObject(b.ssffds.data)&&0!==b.ssffds.data.length){j.clearRect(0,0,j.canvas.width,j.canvas.height),b.dhs.drawMovingBoundaryLine(j),b.dhs.drawCurViewPortSelected(j,!1);var a=b.cps.getSsffTrackConfig(g),c=b.ssffds.getColumnOfTrack(a.name,a.columnName);b.dhs.drawMinMaxAndName(j,g,c._minVal,c._maxVal,2)}}}}}]),angular.module("emuwebApp").directive("progressThing",["$animate",function(a){return{template:'<div class="emuwebapp-progressThing">{{vs.somethingInProgressTxt}}</div>',restrict:"E",replace:!0,link:function(b,c,d){d.$observe("showThing",function(b){"true"===b?(a.removeClass(c,"emuwebapp-shrinkHeightTo0px"),a.removeClass(c,"emuwebapp-animationStopped"),a.addClass(c,"emuwebapp-expandHeightTo20px"),a.addClass(c,"emuwebapp-animationRunning")):(a.removeClass(c,"emuwebapp-expandHeightTo20px"),a.removeClass(c,"emuwebapp-animationRunning"),a.addClass(c,"emuwebapp-shrinkHeightTo0px"),a.addClass(c,"emuwebapp-animationStopped"))})}}}]),angular.module("emuwebApp").directive("historyActionPopup",["$animate","$timeout",function(a,b){return{template:'<div class="emuwebapp-history"><div ng-bind-html="vs.historyActionTxt"></div></div>',restrict:"E",replace:!0,link:function(c,d){c.$watch("vs.historyActionTxt",function(){""!==c.vs.historyActionTxt&&a.addClass(d,"emuwebapp-history-fade").then(function(){c.$apply(),b(function(){a.removeClass(d,"emuwebapp-history-fade").then(function(){b(function(){c.vs.historyActionTxt=""},c.cps.design.animation.period),c.$apply()})},c.cps.design.animation.period)})},!0)}}}]),angular.module("emuwebApp").directive("dragout",["DataService","loadedMetaDataService","browserDetector","ConfigProviderService",function(a,b,c,d){return{restrict:"A",replace:!0,scope:{name:"@"},link:function(e,f,g){e.cps=d;var h=f[0],i=document.createElement("img");i.src="img/saveBtn.svg",e.generateURL=function(){return e.getURL(angular.toJson(a.getData(),!0))},e.isActive=function(){return g.name===b.getCurBndl().name&&"embedded"===e.cps.vals.main.comMode},e.getURL=function(a){var b;return b="object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.createObjectURL(e.getBlob(a)):URL.createObjectURL(e.getBlob(a))},e.getBlob=function(a){var b;try{b=new Blob([a],{type:"text/plain"})}catch(c){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,b=new BlobBuilder,b.append(a),b=b.getBlob()}return b},h.addEventListener("dragstart",function(a){if(e.isActive()){this.classList.add("drag");var b=e.generateURL();(c.isBrowser.Firefox()||c.isBrowser.Chrome())&&(a.dataTransfer.setDragImage(i,-10,-10),a.dataTransfer.effectAllowed="move",a.dataTransfer.setData("DownloadURL","application/json:"+g.name+"_annot.json:"+b))}else console.log("dropping inactive bundles is not allowed");return!1},!1),h.addEventListener("dragend",function(){return e.isActive()&&this.classList.remove("drag"),!1},!1),h.addEventListener("mousedown",function(){e.isActive()?h.setAttribute("draggable",!0):(h.setAttribute("draggable",!1),h.removeAttribute("dragable"))},!1)}}}]),angular.module("emuwebApp").directive("emuhierarchy",["viewState","HistoryService","DataService","LevelService","HierarchyManipulationService","HierarchyLayoutService","Soundhandlerservice","ConfigProviderService",function(a,b,c,d,e,f,g,h){return{template:'<div class="emuwebapp-hierarchy-container" ng-mousemove="checkLink($event)"></div>',restrict:"E",scope:{vertical:"=",playing:"="},replace:!0,link:function(i,j){i.selectedItem,i.selectedLink,i.newLinkSrc,i.offsetX=25,i.offsetY=30,i.vertOffsetX=150,i.vertOffsetY=25,i.scaleExtent=[.5,10],i.transition={duration:750,links:!1,nodes:!0,rotation:!0,contextMenu:!0},i.viewState=a,i.hierarchyState=a.hierarchyState,i.historyService=b,i.cps=h,i.$watch("hierarchyState.path",function(a,b){a!==b&&(console.debug("Rendering due to path change: ",a),i.hierarchyState.newLinkFromID=void 0,i.render())},!1),i.$watch("vertical",function(a,b){a!==b&&(console.debug("Rendering due to rotation: ",a),i.render())},!1),i.$watch("viewState.curLevelAttrDefs",function(a,b){a!==b&&(console.debug("Rendering due to attribute change: ",a),i.render())},!0),i.$watch("playing",function(a,b){a!==b&&(console.debug("Play() triggered",a,i.selectedItem),"undefined"!=typeof i.selectedItem&&0!==a&&i.play(i.selectedItem))},!0),i.$watch("hierarchyState.playing",function(a,b){a!==b&&(console.debug("Play() triggered by viewState",a),"undefined"!=typeof i.selectedItem&&0!==a&&i.play(i.selectedItem))},!1),i.$watch("historyService.movesAwayFromLastSave",function(a,b){a!==b&&(console.debug("history service is active, rendering"),i.render())},!1),i.$watch("hierarchyState.newLinkFromID",function(a,b){a!==b&&(i.newLinkSrc=d.getItemByID(a),i.render())},!1),i.$watch("viewState.hierarchyShown",function(a){a===!0&&(console.debug("Hierarchy modal activated, rendering"),i.render())},!1),i.$watch("hierarchyState.contextMenuID",function(a,b){a!==b&&i.render()},!1),i.selectItem=function(b){i.selectedItem=b,a.hierarchyState.selectedItemID=b.id},i.selectLink=function(b){i.selectedLink=b,a.hierarchyState.selectedLinkFromID=b.fromID,a.hierarchyState.selectedLinkToID=b.toID},i.zoom=function(){i.svg.attr("transform",i.getOrientatedTransform()),i.captionLayer.attr("transform",i.getOrientatedLevelCaptionLayerTransform),i.captionLayer.selectAll("g.emuhierarchy-levelcaption").attr("transform",i.getOrientatedLevelCaptionTransform)},i.getOrientatedTransform=function(){var a="translate("+i.zoomListener.translate()+")";return a+="scale("+i.zoomListener.scale()+")",a+=i.vertical?"scale(-1,1),rotate(90)":"rotate(0)"},i.getOrientatedNodeTransform=function(){return i.vertical?"scale(-1,1)rotate(90)":"scale(1,1)rotate(0)"},i.getNodeText=function(b){for(var c=a.getCurAttrDef(d.getLevelNameByElementID(b.id)),e=0;e<b.labels.length;++e)if(b.labels[e].name===c)return b.labels[e].value;return console.debug("Likely a bug: Did not find the label selected for display","Selected level:",c,"Node: ",b),"NO VALUE"},i.getOrientatedNodeCollapseText=function(b){return i.vertical?a.getCollapsed(b.id)?"↓":"↑":a.getCollapsed(b.id)?"→":"←"},i.getOrientatedTextAnchor=function(){return i.vertical?"middle":"begin"},i.getOrientatedTextX=function(){return i.vertical?0:10},i.getOrientatedTextY=function(){return i.vertical?"1.45em":"0.35em"},i.getOrientatedLevelCaptionLayerTransform=function(){return i.vertical?"translate(0, "+i.zoomListener.translate()[1]+")":"translate("+i.zoomListener.translate()[0]+",0)"},i.getOrientatedLevelCaptionTransform=function(b){var c=angular.copy(a.hierarchyState.path).reverse();return i.vertical?"translate(25, "+i.depthToX(c.indexOf(b))*i.zoomListener.scale()+")":"translate("+i.depthToX(c.indexOf(b))*i.zoomListener.scale()+", 20)"},i.getOrientatedAddItemButtonTransform=function(){return i.vertical?"translate(-12, -5)":"translate(-12, -5)"},i.getOrientatedMousePosition=function(a){return i.vertical?[(a[1]-i.zoomListener.translate()[1])/i.zoomListener.scale(),(a[0]-i.zoomListener.translate()[0])/i.zoomListener.scale()]:[(a[0]-i.zoomListener.translate()[0])/i.zoomListener.scale(),(a[1]-i.zoomListener.translate()[1])/i.zoomListener.scale()]},i.getPath=function(a){return"M"+a._fromX+" "+a._fromY+"Q"+a._fromX+" "+a._toY+" "+a._toX+" "+a._toY},i.getPreviewPath=function(){var a={x:i.newLinkSrc._x,y:i.newLinkSrc._y},b={x:i.selectedItem._x,y:i.selectedItem._y};return"M"+a.x+" "+a.y+"Q"+a.x+" "+b.y+" "+b.x+" "+b.y},i.getPreviewColor=function(){var b=e.checkLinkValidity(a.hierarchyState.path,i.newLinkSrc.id,i.selectedItem.id);return b.valid?"green":3===b.reason&&(b=e.checkLinkValidity(a.hierarchyState.path,i.selectedItem.id,i.newLinkSrc.id),b.valid)?"green":"red"},i.getLabelLegalnessColor=function(b){var c=i.svg.select(".emuhierarchy-contextmenu input")[0][0],e=d.getLevelNameByElementID(b.id),f=a.getCurAttrIndex(e),g=i.cps.getLevelDefinition(e).attributeDefinitions[f].legalLabels;return void 0===g||c.value.length>0&&g.indexOf(c.value)>=0?"lightgreen":"red"},i.svgOnMouseMove=function(){if(void 0!==i.newLinkSrc){var a=i.getOrientatedMousePosition(d3.mouse(this)),b=a[0],c=a[1];i.svg.select("path.emuhierarchy-newlink").attr("d","M"+i.newLinkSrc._x+","+i.newLinkSrc._y+" L"+b+","+c)}},i.svgOnClick=function(){void 0!==a.hierarchyState.contextMenuID&&i.$apply(function(){a.hierarchyState.contextMenuID=void 0})},i.nodeOnClick=function(b){console.debug("Clicked node",b),void 0===a.hierarchyState.contextMenuID&&(d3.event.stopPropagation(),a.hierarchyState.contextMenuID=b.id,i.$apply(function(){i.render()})),a.hierarchyState.contextMenuID===b.id&&d3.event.stopPropagation()},i.nodeOnPlayClick=function(a){i.play(a)},i.nodeOnCollapseClick=function(b){console.debug("collapsing",b),f.toggleCollapse(b,a.hierarchyState.path),i.render()},i.nodeOnMouseOver=function(a){i.selectItem(a),i.renderSelectionOnly()},i.nodeOnInput=function(b){var c=i.svg.select(".emuhierarchy-contextmenu input")[0][0];a.hierarchyState.setEditValue(c.value),c.style.backgroundColor=i.getLabelLegalnessColor(b)
},i.nodeOnFocusIn=function(){a.hierarchyState.inputFocus=!0},i.nodeOnFocusOut=function(){a.hierarchyState.inputFocus=!1},i.linkOnMouseOver=function(a){i.selectLink(a),i.renderSelectionOnly()},i.addButtonOnClick=function(a){var b=d.pushNewItem(a);-1!==b&&i.historyService.addObjToUndoStack({type:"HIERARCHY",action:"PUSHITEM",newID:b,level:a}),i.$apply()},i.play=function(b){var c=a.hierarchyState.path[0];if("undefined"==typeof c)return void console.debug("Likely a bug: There is no path selection. Not executing play():",b);for(var e,h=d.getLevelDetails(c).level.type,i=null,j=null,k=[b];k.length>0;)e=k.pop(),e.labels[0].name===c&&(null===j&&(j=e),i=e),k=k.concat(f.findChildren(e,a.hierarchyState.path));if(console.debug("Node info for playback: ",h,b,i,j),null===i)return void console.debug("No time information found for node, aborting playback",b);var l=0,m=0;"EVENT"===h?(l=i.samplePoint,m=j.samplePoint):"SEGMENT"===h&&(l=i.sampleStart,m=j.sampleStart+j.sampleDur),console.debug("Sample information for playback:",l,m),g.playFromTo(l,m)},i.depthToX=function(b){var c=i.vertical?i.height:i.width,d=i.vertical?i.vertOffsetY:i.offsetX;return d+b/a.hierarchyState.path.length*c},i.posInLevelToY=function(a){var b=i.vertical?i.width:i.height,c=i.vertical?i.vertOffsetX:i.offsetY;return b-=c,c+a*b},i.element=j,i.width=0,i.height=0,i.background="",void 0!==i.cps.design.color&&(i.background=i.cps.design.color.lightGrey),i.zoomListener=d3.behavior.zoom().scaleExtent(i.scaleExtent).on("zoom",i.zoom),i.svg=d3.select(j[0]).append("svg").attr("width","100%").attr("height","100%").style("background-color",i.background).call(i.zoomListener).on("dblclick.zoom",null).on("mousemove",i.svgOnMouseMove).on("click",i.svgOnClick).append("g"),i.shiftMode=!1,i.checkLink=function(c){if(c.shiftKey&&!i.shiftMode&&void 0===a.hierarchyState.newLinkFromID&&(a.hierarchyState.newLinkFromID=a.hierarchyState.selectedItemID,i.shiftMode=!0),!c.shiftKey&&i.shiftMode){i.shiftMode=!1;var d=e.addLink(a.hierarchyState.path,a.hierarchyState.newLinkFromID,a.hierarchyState.selectedItemID);a.hierarchyState.newLinkFromID=void 0,null!==d&&b.addObjToUndoStack({type:"HIERARCHY",action:"ADDLINK",link:d})}},i.captionLayer=i.svg.append("g").style("z-index",5),i.timeArrow=i.svg.append("g").append("text").text("time →"),i.svg=i.svg.append("g").style("z-index",1),i.renderSelectionOnly=function(){i.svg.selectAll("circle.emuhierarchy-nodeCircle").style("fill",function(a){var b=h.design.color.white;return"undefined"!=typeof i.selectedItem&&a.id===i.selectedItem.id&&(b=h.design.color.blue),b}),i.svg.selectAll("path.emuhierarchy-link").style("stroke",function(a){return i.selectedLink===a?h.design.color.yellow:h.design.color.grey}),i.svg.select(".emuhierarchy-newlinkpreview").attr("d",i.getPreviewPath).style("stroke",i.getPreviewColor)},i.render=function(){var b;i.width=parseInt(d3.select(i.element[0]).style("width"),10),i.height=parseInt(d3.select(i.element[0]).style("height"),10),i.transition.rotation?i.svg.transition().duration(i.transition.duration).attr("transform",i.getOrientatedTransform()):i.svg.attr("transform",i.getOrientatedTransform()),i.vertical?i.timeArrow.attr("transform","translate("+i.width/2+","+(i.height-10)+")"):i.timeArrow.attr("transform","translate("+(i.width-20)+","+i.height/2+")rotate(90)"),i.captionLayer.attr("transform",i.getOrientatedLevelCaptionLayerTransform);var e=i.captionLayer.selectAll("g.emuhierarchy-levelcaption").data(a.hierarchyState.path,function(a){return a}),g=e.enter(),h=e.exit();g=g.append("g").attr("class","emuhierarchy-levelcaption"),g.append("text").text(function(a){return a});var j=g.filter(function(a){var b=d.getLevelDetails(a).level.type;return"ITEM"===b}).append("g").attr("class","emuhierarchy-addbutton").attr("transform",i.getOrientatedAddItemButtonTransform).on("click",i.addButtonOnClick);j.append("circle").style("fill",i.cps.design.color.blue).attr("r",8),j.append("path").style("stroke",i.cps.design.color.white).attr("d","M0,-6 V6 M-6,0 H6"),e.attr("transform",i.getOrientatedLevelCaptionTransform),i.transition.rotation?h=h.transition().duration(i.transition.duration).remove():h.remove(),h.select("text").style("fill-opacity",0);var k=[];f.calculateWeightsBottomUp(a.hierarchyState.path);for(var b=0;b<a.hierarchyState.path.length;++b)for(var l=d.getLevelDetails(a.hierarchyState.path[b]).level.items,m=0;m<l.length;++m)l[m]._visible&&k.push(l[m]);for(var n=[],o=c.getData().links,p=0;p<o.length;++p)for(var b=0;b<a.hierarchyState.path.length-1;++b){var q=d.getItemFromLevelById(a.hierarchyState.path[b],o[p].toID),r=d.getItemFromLevelById(a.hierarchyState.path[b+1],o[p].fromID);null!==q&&null!==r&&q._visible&&!a.getCollapsed(r.id)&&r._visible&&n.push(o[p])}k.forEach(function(a){a._x=i.depthToX(a._depth),a._y=i.posInLevelToY(a._posInLevel)}),n.forEach(function(a){a._fromX=i.depthToX(a._fromDepth),a._fromY=i.posInLevelToY(a._fromPosInLevel),a._toX=i.depthToX(a._toDepth),a._toY=i.posInLevelToY(a._toPosInLevel)});var s=i.svg.selectAll("g.emuhierarchy-node").data(k,function(a){return a.id}),t=s.enter(),u=s.exit();t=t.append("g").attr("class","emuhierarchy-node").attr("pointer-events","mouseover").on("click",i.nodeOnClick).on("mouseover",i.nodeOnMouseOver);var v=t.append("circle").attr("class","emuhierarchy-nodeCircle").style("stroke",i.cps.design.color.grey);i.transition.nodes?v.attr("r",0).transition().duration(i.transition.duration).attr("r",4.5):v.attr("r",4.5),t.append("text").attr("class","emuhierarchy-nodeText"),t.attr("transform",function(b){var c=a.getCollapsePosition(b.id);if("undefined"!=typeof c){var d=c[0],e=c[1];return a.setCollapsePosition(b.id,void 0),"translate("+d+","+e+")"+i.getOrientatedNodeTransform()}}),u=i.transition.nodes?u.transition().duration(i.transition.duration).attr("transform",function(b){var c=a.getCollapsePosition(b.id);if("undefined"!=typeof c){var d=c[0],e=c[1];return a.setCollapsePosition(b.id,void 0),"translate("+d+","+e+")"}return"translate(0,0)"}).remove():u.attr("transform",function(b){var c=a.getCollapsePosition(b.id);if("undefined"!=typeof c){var d=c[0],e=c[1];return a.setCollapsePosition(b.id,void 0),"translate("+d+","+e+")"}return"translate(0,0)"}).remove(),u.select("text").style("fill-opacity",0),s.select("text").attr("x",i.getOrientatedTextX).attr("y",i.getOrientatedTextY).attr("text-anchor",i.getOrientatedTextAnchor).attr("transform",i.getOrientatedTextTransform).text(i.getNodeText),s.select("circle.emuhierarchy-nodeCircle").style("fill",function(a){var b=i.cps.design.color.white;return"undefined"!=typeof i.selectedItem&&a.id===i.selectedItem.id&&(b=i.cps.design.color.blue),b}).style("stroke",function(b){return a.getCollapsed(b.id)?i.cps.design.color.red:i.cps.design.color.grey}),i.transition.nodes?s.transition().duration(i.transition.duration).attr("transform",function(a){return"translate("+a._x+","+a._y+")"+i.getOrientatedNodeTransform()}):s.attr("transform",function(a){return"translate("+a._x+","+a._y+")"+i.getOrientatedNodeTransform()}),void 0===a.hierarchyState.contextMenuID&&i.svg.selectAll(".emuhierarchy-contextmenu").remove();var w=i.svg.select(".emuhierarchy-contextmenu");if(null===w[0][0]){w=s.filter(function(b){return b.id===a.hierarchyState.contextMenuID}).append("g").attr("class","emuhierarchy-contextmenu"),w.append("circle").style("fill","darkgrey").attr("r",50).style("cursor","default"),i.transition.contextMenu&&w.style("opacity",0).transition().duration(i.transition.duration).style("opacity",.5),w.append("text").text(i.getOrientatedNodeCollapseText).attr("x",-25).attr("y",-25).attr("text-anchor","middle").on("click",i.nodeOnCollapseClick),i.transition.contextMenu&&w.style("opacity",0).transition().duration(i.transition.duration).style("opacity",1),w.append("text").text("play").attr("x",-25).attr("y",25).attr("text-anchor","middle").on("click",i.nodeOnPlayClick),i.transition.contextMenu&&w.style("opacity",0).transition().duration(i.transition.duration).style("opacity",1);var x=w.append("foreignObject").attr("height",30).attr("x",10).attr("y",-15).attr("width",0);i.transition.contextMenu?x.transition().duration(i.transition.duration).attr("width",100):x.attr("width",100),x.append("xhtml:body").append("input").attr("value",i.getNodeText).style("width","100%").style("height","100%").style("outline","none").style("border","0").style("background-color",i.getLabelLegalnessColor).on("input",i.nodeOnInput).on("focusin",i.nodeOnFocusIn).on("focusout",i.nodeOnFocusOut),0!==x[0].length&&(x.select("input")[0][0].focus(),x.select("input")[0][0].select())}else i.svg.select(".emuhierarchy-contextmenu text").text(i.getOrientatedNodeCollapseText);var y=i.svg.selectAll(".emuhierarchy-linkgroup").data(n,function(a){return"s"+a.fromID+"t"+a.toID}),z=y.enter(),A=y.exit();z=z.insert("g",":first-child").attr("class","emuhierarchy-linkgroup"),z.append("path").attr("class","emuhierarchy-ghostlink").on("mouseover",i.linkOnMouseOver),z.append("path").attr("class","emuhierarchy-link"),i.transition.links&&z.style("opacity",0).transition().duration(i.transition.duration).style("opacity",1),i.transition.links?A.transition().duration(i.transition.duration).style("opacity",0).remove():A.remove(),y.selectAll(".emuhierarchy-link").style("stroke",function(a){return i.selectedLink===a?i.cps.design.color.yellow:i.cps.design.color.grey}),i.transition.rotation?y.selectAll(".emuhierarchy-link").transition().duration(i.transition.duration).attr("d",i.getPath).style("opacity",1):y.selectAll(".emuhierarchy-link").attr("d",i.getPath),y.selectAll(".emuhierarchy-ghostlink").attr("d",i.getPath),i.svg.selectAll(".emuhierarchy-newlink").remove(),i.svg.selectAll(".emuhierarchy-newlinkpreview").remove(),void 0!==i.newLinkSrc&&(i.svg.append("path").attr("class","emuhierarchy-newlink").style("stroke","black"),i.svg.append("path").attr("class","emuhierarchy-newlinkpreview").attr("d",i.getPreviewPath).style("stroke",i.getPreviewColor))},i.resizeHierarchy=function(){console.log("###############"),console.log(i.width)}}}}]),angular.module("emuwebApp").directive("epg",["viewState",function(){return{template:'<div class="emuwebapp-twoDimCanvasContainer"><canvas width="512" height="512"></canvas></div>',restrict:"E",replace:!0,link:function(a,b){var c,d,e,f=b.find("canvas")[0];a.$watch("vs.curViewPort",function(b,c){$.isEmptyObject(a.cps.vals)||$.isEmptyObject(a.ssffds.data)||0!==a.ssffds.data.length&&(c.sS!==b.sS||c.eS!==b.eS)&&a.drawEpgGrid(a)},!0),a.$watch("vs.curMousePosSample",function(){$.isEmptyObject(a.cps.vals)||$.isEmptyObject(a.ssffds.data)||0!==a.ssffds.data.length&&a.drawEpgGrid(a)},!0),a.drawEpgGrid=function(a){var b=f.getContext("2d");c=a.cps.getSsffTrackConfig("EPG"),d=a.ssffds.getColumnOfTrack(c.name,c.columnName),e=a.ssffds.getSampleRateAndStartTimeOfTrack(c.name),b.clearRect(0,0,f.width,f.height),b.fillStyle="green",b.strokeStyle=a.cps.design.color.black,b.font=a.cps.design.font.input.size.slice(0,-2)+"px "+a.cps.design.font.input.family;var g,h=f.width/8,i=f.height/8,j=1/e.sampleRate-e.startTime,k=Math.round(a.vs.curMousePosSample/a.shs.wavJSO.SampleRate/j);angular.forEach(d.values[k],function(a,c){for(g=a.toString(2).split("").reverse();g.length<8;)g.push("0");g.forEach(function(a,d){"1"===a?(b.fillStyle="grey",b.fillRect(d*h+5,i*c+5,h-10,i-10)):(b.fillStyle="white",b.fillRect(d*h+5,i*c+5,h-10,i-10))})});var l=a.fontImage.getTextImageTwoLines(b,"EPG","Frame:"+k,3*a.cps.design.font.input.size.slice(0,-2)/4,a.cps.design.font.input.family,a.cps.design.font.input.family,a.cps.design.color.black,!0);b.drawImage(l,0,0,l.width,l.height,5,0,l.width,l.height)}}}}]),angular.module("emuwebApp").directive("dots",["viewState","ConfigProviderService","Ssffdataservice","fontScaleService","Soundhandlerservice","loadedMetaDataService","mathHelperService",function(a,b,c,d,e,f,g){return{template:'<div class="emuwebapp-twoDimCanvasContainer"><canvas width="512" height="512"></canvas></div>',restrict:"E",replace:!0,scope:{},link:function(h,i){h.cps=b,h.ssffds=c,h.vs=a,h.fontImage=d,h.shs=e,h.lmds=f,h.mhs=g;var j=i.find("canvas")[0],k=1/0,l=-1/0,m=1/0,n=-1/0;h.$watch("ssffds.data.length",function(){$.isEmptyObject(h.cps.vals)||$.isEmptyObject(h.ssffds.data)||0!==h.ssffds.data.length&&h.drawDots()},!0),h.$watch("vs.curViewPort",function(a,b){$.isEmptyObject(h.cps.vals)||$.isEmptyObject(h.ssffds.data)||0!==h.ssffds.data.length&&(b.sS!==a.sS||b.eS!==a.eS)&&h.drawDots()},!0),h.$watch("vs.curMousePosSample",function(){$.isEmptyObject(h.cps.vals)||$.isEmptyObject(h.ssffds.data)||0!==h.ssffds.data.length&&h.drawDots()},!0),h.$watch("vs.curPerspectiveIdx",function(){k=1/0,l=-1/0,m=1/0,n=-1/0},!0),h.$watch("lmds.getCurBndl()",function(){k=1/0,l=-1/0,m=1/0,n=-1/0},!0),h.setGlobalMinMaxVals=function(){for(var a=h.cps.vals.perspectives[h.vs.curPerspectiveIdx].twoDimCanvases.twoDimDrawingDefinitions[0],b=0;b<a.dots.length;b++){var c=h.cps.getSsffTrackConfig(a.dots[b].xSsffTrack),d=h.ssffds.getColumnOfTrack(c.name,c.columnName);d._minVal<k&&(k=d._minVal),d._maxVal>l&&(l=d._maxVal),c=h.cps.getSsffTrackConfig(a.dots[b].ySsffTrack);var e=h.ssffds.getColumnOfTrack(c.name,c.columnName);e._minVal<m&&(m=e._minVal),e._maxVal>n&&(n=e._maxVal)}a.staticDots.forEach(function(a){a.xCoordinates.forEach(function(b,c){k>b&&(k=b),b>l&&(l=b),a.yCoordinates[c]<m&&(m=a.yCoordinates[c]),a.yCoordinates[c]>n&&(n=a.yCoordinates[c])})})},h.drawDots=function(){1/0===k&&h.setGlobalMinMaxVals();var a=j.getContext("2d");a.clearRect(0,0,j.width,j.height);var b=a.canvas.width/a.canvas.offsetWidth,c=a.canvas.height/a.canvas.offsetHeight;a.beginPath(),a.moveTo(0,0),a.lineTo(5,5),a.moveTo(0,j.height),a.lineTo(5,j.height-5),a.moveTo(j.width,j.height),a.lineTo(j.width-5,j.height-5),a.stroke(),a.closePath();var d=3*h.cps.design.font.input.size.slice(0,-2)/4,e=h.fontImage.getTextImage(a,"yMax: "+h.mhs.roundToNdigitsAfterDecPoint(n,2),d,h.cps.design.font.input.family,h.cps.design.color.black);a.drawImage(e,5,5,e.width,e.height),e=h.fontImage.getTextImageTwoLines(a,"yMin: "+h.mhs.roundToNdigitsAfterDecPoint(m,2),"xMin: "+h.mhs.roundToNdigitsAfterDecPoint(k,2),d,h.cps.design.font.input.family,h.cps.design.color.black,!0),a.drawImage(e,5,j.height-d*c*2-5,e.width,e.height);var f=a.measureText("xMax: "+h.mhs.roundToNdigitsAfterDecPoint(l,5)).width*b;e=h.fontImage.getTextImage(a,"xMax: "+h.mhs.roundToNdigitsAfterDecPoint(l,2),d,h.cps.design.font.input.family,h.cps.design.color.black),a.drawImage(e,j.width-f-5,j.height-d*c-5,e.width,e.height);var g,i=h.cps.vals.perspectives[h.vs.curPerspectiveIdx].twoDimCanvases.twoDimDrawingDefinitions[0],o=h.ssffds.getSampleRateAndStartTimeOfTrack(i.dots[0].xSsffTrack),p=h.ssffds.getSampleRateAndStartTimeOfTrack(i.dots[0].ySsffTrack),q=(1/o.sampleRate,h.vs.curMousePosSample/h.shs.wavJSO.SampleRate);g=Math.round(o.startTime===1/o.sampleRate/2?q*o.sampleRate:q*o.sampleRate+(o.startTime-1/o.sampleRate/2)*o.sampleRate);var r=h.cps.getSsffTrackConfig(i.dots[0].xSsffTrack),s=h.ssffds.getColumnOfTrack(r.name,r.columnName);g>s.values.length-1&&(g=s.values.length-1),f=a.measureText("frame: "+g).width*b,e=h.fontImage.getTextImage(a,"frame: "+g,h.cps.design.font.input.size.slice(0,-2)-4,h.cps.design.font.input.family,h.cps.design.color.black);var t=90;a.save(),a.rotate(t*Math.PI/180),a.drawImage(e,j.width/2-f/2,-j.height),a.restore();for(var u=[],v=0;v<i.dots.length;v++){var r=h.cps.getSsffTrackConfig(i.dots[v].xSsffTrack),s=h.ssffds.getColumnOfTrack(r.name,r.columnName);r=h.cps.getSsffTrackConfig(i.dots[v].ySsffTrack);var w=h.ssffds.getColumnOfTrack(r.name,r.columnName);if(s.values.length!==w.values.length)return void alert("columns do not have same length or length of one not 1");var o=h.ssffds.getSampleRateAndStartTimeOfTrack(i.dots[v].xSsffTrack),p=h.ssffds.getSampleRateAndStartTimeOfTrack(i.dots[v].ySsffTrack);if(o.sampleRate!==p.sampleRate||o.startSample!==p.startSample)return void alert("xsRaSt.sampleRate !== ysRaSt.sampleRate || xsRaSt.startSample !== ysRaSt.startSample");var x=(s.values[g][i.dots[v].xContourNr]-k)/(l-k)*j.width,y=j.height-(w.values[g][i.dots[v].yContourNr]-m)/(n-m)*j.height,z=Math.PI/180*0,A=Math.PI/180*360;a.strokeStyle=i.dots[v].color,a.beginPath(),a.arc(x,y,20,z,A,!0),a.stroke(),a.closePath(),a.beginPath(),a.arc(x,y,2,z,A,!0),a.fill(),a.closePath();var e=h.fontImage.getTextImage(a,i.dots[v].name,h.cps.design.font.input.size.slice(0,-2)-4,h.cps.design.font.input.family,h.cps.design.color.black);a.drawImage(e,x,y-5,e.width,e.height),u.push({name:i.dots[v].name,x:x,y:y})}var B,C;i.connectLines.forEach(function(b){u.forEach(function(a){a.name===b.fromDot&&(B=a),a.name===b.toDot&&(C=a)}),a.strokeStyle=b.color,a.beginPath(),a.moveTo(B.x,B.y),a.lineTo(C.x,C.y),a.stroke(),a.closePath()});var z=Math.PI/180*0,A=Math.PI/180*360;i.staticDots.forEach(function(b){a.strokeStyle=b.color,a.fillStyle=b.color;var c=(b.xNameCoordinate-k)/(l-k)*j.width,d=j.height-(b.yNameCoordinate-m)/(n-m)*j.height,e=h.fontImage.getTextImage(a,b.name,h.cps.design.font.input.size.slice(0,-2)-4,h.cps.design.font.input.family,b.color);a.drawImage(e,c,d,e.width,e.height),b.xCoordinates.forEach(function(c,d){var e=(c-k)/(l-k)*j.width,f=j.height-(b.yCoordinates[d]-m)/(n-m)*j.height;if(a.beginPath(),a.arc(e,f,2,z,A,!0),a.fill(),a.closePath(),b.connect&&d>=1){var g=(b.xCoordinates[d-1]-k)/(l-k)*j.width,h=j.height-(b.yCoordinates[d-1]-m)/(n-m)*j.height;a.beginPath(),a.moveTo(g,h),a.lineTo(e,f),a.stroke(),a.closePath()}})})}}}}]),angular.module("emuwebApp").directive("myDropZone",["$animate","$compile","DragnDropService","browserDetector","appStateService","modalService",function(a,b,c,d,e,f){return{templateUrl:"views/myDropZone.html",restrict:"E",replace:!0,scope:{},link:function(a,b){a.dropTextDefault="Drop your files here or click here to open a file",a.dropTextErrorFileType="Error: Could not parse file. The following file types are supported: .WAV .TEXTGRID",a.dropTextErrorAPI="Sorry ! The File APIs are not fully supported in your browser.",a.dropAllowed="Drop file(s) to start loading !",a.dropParsingWaiting=".TextGrid loaded! Please load .WAV file in order to start!",a.dropParsingWaitingAnnot="Annotation file loaded! Please load .WAV file in order to start!",a.dropFirefoxWarning="Sorry ! Firefox does not support dropping folders ! please drop single or multiple files !",a.dropText=a.dropTextDefault,a.dropClass="",a.dropClassDefault="",a.dropClassOver="over",a.dropClassError="error",a.count=0,a.handles=[],a.bundles=[],a.bundleNames=[],a.updateQueueLength=function(b){a.count+=b},a.enqueueFileAddition=function(b){var c=b.name.substring(b.name.lastIndexOf("_")+1,b.name.lastIndexOf(".")).toUpperCase(),e=b.name.substr(b.name.lastIndexOf(".")+1).toUpperCase(),f="";f="ANNOT"===c?b.name.substr(0,b.name.lastIndexOf("_")):b.name.substr(0,b.name.lastIndexOf("."));var g=a.bundleNames.indexOf(f);-1===g&&(a.bundleNames.push(f),g=a.bundleNames.indexOf(f),a.bundles[g]=[],a.bundles[g][0]=f),"WAV"===e?(a.bundles[g][1]=b,a.handles.push(b),a.dropClass=a.dropClassDefault,a.dropText=a.dropTextDefault):"TEXTGRID"===e?(a.bundles[g][2]={},a.bundles[g][2].file=b,a.bundles[g][2].type="textgrid",a.handles.push(b),a.dropClass=a.dropClassDefault,a.dropText=a.dropParsingWaiting):"JSON"===e&&"ANNOT"===c?(a.bundles[g][2]={},a.bundles[g][2].file=b,a.bundles[g][2].type="annotation",a.handles.push(b),a.dropClass=a.dropClassDefault,a.dropText=a.dropParsingWaitingAnnot):(d.isBrowser.Firefox()&&0===b.size?(a.dropClass=a.dropClassError,a.dropText=a.dropFirefoxWarning):(a.dropClass=a.dropClassError,a.dropText=a.dropTextErrorFileType),a.handles=[],a.bundles=[],a.bundleNames=[],a.count=0),d.isBrowser.Firefox()||a.$digest(),void 0!==a.bundles[g]&&void 0!==a.bundles[g][2]&&void 0!==a.bundles[g][1]&&a.startRendering()},a.startRendering=function(){a.count===a.handles.length&&(c.setData(a.bundles)===!1&&f.open("views/error.html","Sorry you dropped too many bundles ("+a.handles.length+"). The maximum currently allowed is: "+c.maxDroppedBundles).then(function(){e.resetToInitState()}),a.handles=[],a.bundles=[],a.bundleNames=[],a.count=0)},a.loadFiles=function(b){a.updateQueueLength(b.length);for(var c=0;c<b.length;c++){var d=b[c];if(".DS_Store"===d.name)a.updateQueueLength(-1);else{var e,f;if(d.isFile||d.isDirectory)e=d;else if(d.getAsEntry)e=d.getAsEntry();else{if(!d.webkitGetAsEntry){if("function"==typeof d.getAsFile){a.enqueueFileAddition(d.getAsFile());continue}if(File&&d instanceof File){a.enqueueFileAddition(d);continue}a.updateQueueLength(-1);continue}e=d.webkitGetAsEntry()}e?e.isFile?e.file(function(b){a.enqueueFileAddition(b)},function(a){console.warn(a)}):e.isDirectory&&(f=e.createReader(),f.readEntries(function(b){a.loadFiles(b),a.updateQueueLength(-1)},function(a){console.warn(a)})):updateQueueLength(-1)}}},a.dropFiles=function(b){b.stopPropagation(),b.preventDefault(),a.$apply(function(){if(window.File&&window.FileReader&&window.FileList&&window.Blob){if(void 0!==b.originalEvent){if(d.isBrowser.Firefox())var c=b.originalEvent.dataTransfer.files;else var c=b.originalEvent.dataTransfer.items;a.loadFiles(c)}}else f.open("views/error.html",a.dropTextErrorAPI).then(function(){a.dropText=a.dropTextDefault,a.dropClass=a.dropClassDefault,e.resetToInitState()})})},a.dragEnterLeave=function(b){b.preventDefault(),a.$apply(function(){a.dropText=a.dropTextDefault,a.dropClass=a.dropClassDefault})},a.handleDragOver=function(b){b.preventDefault(),a.$apply(function(){a.dropText=a.dropAllowed,a.dropClass=a.dropClassOver})},b.bind("drop",function(b){a.dropFiles(b)}),b.bind("dragover",function(b){a.handleDragOver(b)}),b.bind("dragenter",function(b){a.dragEnterLeave(b)}),b.bind("dragleave",function(b){a.dragEnterLeave(b)}),b.bind("click",function(){b.context.children[1].children[0].click()})}}}]),angular.module("emuwebApp").directive("myDropZoneInput",["$animate","browserDetector","appStateService",function(){return{templateUrl:"views/myDropZoneInput.html",restrict:"E",scope:{},link:function(a,b){a.acceptGrid=".TextGrid",a.acceptWav="audio/wav",a.acceptJson="application/json",a.acceptBoth=a.acceptWav+","+a.acceptGrid+","+a.acceptJson,a.acceptFile=a.acceptBoth,a.handleFilesonChange=function(){var c=b.context.children.fileDialog;a.$parent.loadFiles(c.files)},b.bind("change",function(b){a.handleFilesonChange(b)}),b.bind("click",function(){var a=angular.element("input");void 0!==a[1]&&a[1].click()})}}}]),angular.module("emuwebApp").directive("emuwebapp",["viewState","Iohandlerservice","ConfigProviderService",function(a,b,c){return{templateUrl:"views/emuwebapp.html",restrict:"E",scope:{audioGetUrl:"@",labelGetUrl:"@",labelType:"@"},link:function(b,d,e){d.bind("mouseenter",function(){a.mouseInEmuWebApp=!0}),d.bind("mouseleave",function(){a.mouseInEmuWebApp=!1}),e.$observe("audioGetUrl",function(a){void 0!==a&&""!==a&&(c.embeddedVals.audioGetUrl=a)}),e.$observe("labelGetUrl",function(a){void 0!==a&&""!==a&&(c.embeddedVals.labelGetUrl=a)}),e.$observe("labelType",function(a){void 0!==a&&""!==a&&(c.embeddedVals.labelType=a)})}}}]),angular.module("emuwebApp").service("Validationservice",["$http","$q","ConfigProviderService",function(a,b,c){function d(a,b){var c=!0;return b.levelDefinitions.forEach(function(b){for(var c=a.indexOf(b.name);-1!==c;)a.splice(c,1),c=a.indexOf(b.name)}),0!==a.length&&(c="Following levels are not defined: "+a),c}function e(a,b){var c=!0,d=a.indexOf("OSCI");return-1!==d&&a.splice(d,1),d=a.indexOf("SPEC"),-1!==d&&a.splice(d,1),b.ssffTrackDefinitions.forEach(function(b){for(var c=a.indexOf(b.name);-1!==c;)a.splice(c,1),c=a.indexOf(b.name)}),0!==a.length&&(c="Following ssffTracks are not defined: "+a),c}var f={},g=[],h=["annotationFileSchema","emuwebappConfigSchema","DBconfigFileSchema","bundleListSchema","bundleSchema","designSchema"];return f.semCheckLoadedConfigs=function(a,b){var f=!0,g=!0;a.perspectives.forEach(function(a){if(g){var h=e(angular.copy(a.signalCanvases.order),b);h!==!0&&(f="Error in EMUwebAppConfig/perspectives/signalCanvases/order! References to undefined ssffTracks are present. "+h,g=!1);var i=[];a.signalCanvases.assign.forEach(function(c){if(g){i.push(c.ssffTrackName),c.signalCanvasName===c.ssffTrackName&&(f="Error in EMUwebAppConfig/perspectives/signalCanvases/assign! Assignment to self is not possible! signalCanvasesName: "+c.signalCanvasName,g=!1),("OSCI"===c.ssffTrackName||"SPEC"===c.ssffTrackName)&&(f="Error in EMUwebAppConfig/perspectives/signalCanvases/assign! Assignment of OSCI or SPEC is not possible!",g=!1),h=e([c.signalCanvasName,c.ssffTrackName],b),h!==!0&&(f="Error in EMUwebAppConfig/perspectives/signalCanvases/assign! References to undefined ssffTracks are present. "+h,g=!1);var d=a.signalCanvases.order.indexOf(c.signalCanvasName);-1===d&&(f="Error in EMUwebAppConfig/perspectives/signalCanvases/assign! References to ssffTracks that are not displayed (not in order array of that perspective) are: "+c.signalCanvasName,g=!1)}}),a.signalCanvases.contourLims.forEach(function(c){if(g){h=e([c.ssffTrackName],b),h!==!0&&(f="Error in EMUwebAppConfig/perspectives/signalCanvases/contourLims! References to undefined ssffTracks are present. "+h,g=!1);var d=a.signalCanvases.order.concat(i).indexOf(c.ssffTrackName);-1===d&&(f="Error in EMUwebAppConfig/perspectives/signalCanvases/contourLims! References to ssffTracks that are not displayed (not in order array of that perspective) are: "+c.ssffTrackName,g=!1)}});var j=d(angular.copy(a.levelCanvases.order),b);j!==!0&&(f="Error in EMUwebAppConfig/perspectives/levelCanvases/order! References to undefined levels are present. "+j,g=!1),a.levelCanvases.order.forEach(function(a){if(g){var b=c.getLevelDefinition(a);"SEGMENT"!==b.type&&"EVENT"!==b.type&&(f="Error in EMUwebAppConfig/perspectives/levelCanvases/order! Configured to display levels of type ITEM as levels containing time information (ITEM level in order array). LevelName: "+a,g=!1)}}),void 0!==a.twoDimCanvases&&void 0!==a.twoDimCanvases.twoDimDrawingDefinitions&&a.twoDimCanvases.twoDimDrawingDefinitions.forEach(function(a){if(g){var c=[];a.dots.forEach(function(a){g&&(c.push(a.name),h=e([a.xSsffTrack,a.ySsffTrack],b),h!==!0&&(f="Error in EMUwebAppConfig/perspectives/twoDimCanvases/twoDimDrawingDefinitions/dots! References to undefined ssffTracks are present. "+h,g=!1))}),a.connectLines.forEach(function(a){if(g){var b=c.indexOf(a.fromDot);-1===b&&(f="Error in EMUwebAppConfig/perspectives/twoDimCanvases/twoDimDrawingDefinitions/connectLines! References dots in fromDot that are not defined. dots.name: "+a.fromDot,g=!1),b=c.indexOf(a.toDot),-1===b&&(f="Error in EMUwebAppConfig/perspectives/twoDimCanvases/twoDimDrawingDefinitions/connectLines! References dots in toDot that are not defined. dots.name: "+a.toDot,g=!1)}}),a.staticDots.forEach(function(a){g&&a.xCoordinates.length!==a.yCoordinates.length&&(f="Error in EMUwebAppConfig/perspectives/twoDimCanvases/twoDimDrawingDefinitions/staticDots! xCoordinates and yCoordinates are not of the same length!",g=!1)})}})}});var h=[],i=[];b.levelDefinitions.forEach(function(a){void 0!==a.anagestConfig&&(h.push(a.anagestConfig.verticalPosSsffTrackName),h.push(a.anagestConfig.velocitySsffTrackName),i.push(a.anagestConfig.autoLinkLevelName))});var j=d(i,b);j!==!0&&(f="Error in DBconfig/levelDefinitions/anagestConfig/autoLinkLevelName! References to undefined levels are present. "+j);var k=e(h,b);return k!==!0&&(f="Error in DBconfig/levelDefinitions/anagestConfig/verticalPosSsffTrackName || velocitySsffTrackName! References to undefined ssffTracks are present. "+k),f},f.loadSchemas=function(){var c,d=[];return angular.forEach(h,function(b){c="schemaFiles/"+b+".json",d.push(a.get(c))}),b.all(d)},f.setSchemas=function(a){angular.forEach(a,function(a){g.push({name:a.config.url,data:a.data}),"schemaFiles/annotationFileSchema.json"===a.config.url&&tv4.addSchema(a.config.url,a.data)})},f.getSchema=function(a){var b=void 0;return angular.forEach(g,function(c){c.name==="schemaFiles/"+a+".json"&&(b=c)}),b},f.validateJSO=function(a,b){var d,e=f.getSchema(a);if(void 0!==e&&tv4.validate(b,e.data))if("DBconfigFileSchema"===a){var g=f.semCheckLoadedConfigs(c.vals,c.curDbConfig);d=g===!0?!0:g}else d=!0;else d=void 0===e?"Schema: "+a+" is currently undefined! This is probably due to a misnamed schema file on the server...":tv4.error;return d},f}]),angular.module("emuwebApp").controller("ShowhierarchyCtrl",["$scope","viewState","modalService","ConfigProviderService","LevelService","HierarchyLayoutService","StandardFuncsService",function(a,b,c,d,e,f,g){var h=0;a.paths={possible:[],possibleAsStr:[],selected:""},a.vs=b,a.standardFuncServ=g,angular.forEach(d.curDbConfig.levelDefinitions,function(b){"ITEM"!==b.type&&(a.paths.possible=a.paths.possible.concat(f.findPaths(b.name)))}),angular.forEach(a.paths.possible,function(b,c){var d=g.reverseCopy(b);0===c&&(a.paths.selected=d.join(" → ")),a.paths.possibleAsStr.push(d.join(" → "))}),a.$watch("paths.selected",function(){b.hierarchyState.path=a.paths.possible[a.getSelIdx()]},!1),a.getSelIdx=function(){var b=a.paths.possibleAsStr.indexOf(a.paths.selected);return b},a.rotateHierarchy=function(){b.toggleHierarchyRotation()},a.getRotation=function(){return b.isHierarchyRotated()},a.playSelection=function(){++h},a.getPlaying=function(){return h},a.isCurrentAttrDef=function(a,c){return b.getCurAttrDef(a)===c?!0:!1},a.setCurrentAttrDef=function(a,c,d){b.setCurAttrDef(a,c,d)},a.getAllAttrDefs=function(a){var b=d.getLevelDefinition(a);return b.attributeDefinitions},a.cancel=function(){c.close()}}]),angular.module("emuwebApp").service("HierarchyLayoutService",["viewState","ConfigProviderService","LevelService","DataService",function(a,b,c,d){var e={};return e.findPaths=function(a,b){if("undefined"==typeof b)var b=[a];else b=b.concat([a]);var c=this.findParentLevels(a);if(0===c.length)return[b];for(var d=[],f=0;f<c.length;++f)d=d.concat(e.findPaths(c[f],b));return d},e.findParentLevels=function(a){for(var c=[],d=0;d<b.curDbConfig.linkDefinitions.length;++d)b.curDbConfig.linkDefinitions[d].sublevelName===a&&c.push(b.curDbConfig.linkDefinitions[d].superlevelName);return c},e.calculateWeightsBottomUp=function(a){var b,f;for(e.findParents(a),e.findVisibility(a),b=0;b<a.length;++b){var g=c.getLevelDetails(a[b]).level;for(g._weight=0,f=0;f<g.items.length;++f)g.items[f]._weight,g.items[f]._weight=g.items[f]._visible===!1?.35:1,g._weight+=g.items[f]._weight;var h=0;for(f=0;f<g.items.length;++f){g.items[f]._posInLevel=(h+g.items[f]._weight/2)/g._weight,h+=g.items[f]._weight,g.items[f]._depth=a.length-b-1;for(var i=d.getData().links,j=0;j<i.length;++j)i[j].toID===g.items[f].id&&(i[j]._toPosInLevel=g.items[f]._posInLevel,i[j]._toDepth=g.items[f]._depth),i[j].fromID===g.items[f].id&&(i[j]._fromPosInLevel=g.items[f]._posInLevel,i[j]._fromDepth=g.items[f]._depth)}}},e.findChildren=function(a,b){var e=[],f=c.getLevelNameByElementID(a.id);if(null===f)return console.log("Likely a bug: failed to find a node's level",a),[];for(var g=null,h=0;h<b.length-1;++h)if(b[h+1]===f){g=b[h];break}if(null===g)return[];for(var i=0;i<d.getData().links.length;++i)if(d.getData().links[i].fromID===a.id)for(var j=0;j<d.getData().levels.length;++j)if(d.getData().levels[j].name===g)for(var k=0;k<d.getData().levels[j].items.length;++k)d.getData().levels[j].items[k].id===d.getData().links[i].toID&&e.push(d.getData().levels[j].items[k]);return e},e.findParents=function(a){var b,d,f,g;for(b=0;b<a.length;++b)for(g=c.getLevelDetails(a[b]).level,d=0;d<g.items.length;++d)g.items[d]._parents=[];for(b=0;b<a.length;++b)for(g=c.getLevelDetails(a[b]).level,d=0;d<g.items.length;++d){var h=e.findChildren(g.items[d],a);for(f=0;f<h.length;++f)h[f]._parents.push(g.items[d])}},e.findVisibility=function(b){if(void 0!==b&&b.length>0){for(var d,f=[],g=0;g<b.length;++g){d=c.getLevelDetails(b[g]).level;for(var h=0;h<d.items.length;++h)0===d.items[h]._parents.length&&f.push(d.items[h])}var i,j=[];for(j=j.concat(f);j.length>0;)i=j.pop(),j=j.concat(e.findChildren(i,b)),i._visible=!1;for(j=[],j=j.concat(f);j.length>0;)i=j.pop(),a.getCollapsed(i.id)||(j=j.concat(e.findChildren(i,b))),i._visible=!0}},e.toggleCollapse=function(b,c){var d=!a.getCollapsed(b.id);
a.setCollapsed(b.id,d);for(var f,g=e.findChildren(b,c);g.length>0;){f=g.pop(),g=g.concat(e.findChildren(f,c));var h=a.getNumCollapsedParents(f.id);d?a.setNumCollapsedParents(f.id,h+1):a.setNumCollapsedParents(f.id,h-1),a.setCollapsePosition(f.id,[b._x,b._y])}},e}]),angular.module("emuwebApp").service("ArrayHelperService",["$q",function(){var a={};return a.convertToAbsValues=function(a){for(var b=0;b<a.length;b++)a[b]=Math.abs(a[b]);return a},a.multiplyEachElement=function(a,b){for(var c=0;c<a.length;c++)a[c]=a[c]*b;return a},a.interp2points=function(a,b,c,d,e){return b+(d-b)*((e-a)/(c-a))},a.findMinMax=function(a,b){var c,d;if("min"===b){c=1/0;for(var e=0;e<a.length;e++)a[e]<c&&(c=a[e],d=e)}else if("max"===b){c=-1/0;for(var e=0;e<a.length;e++)a[e]>c&&(c=a[e],d=e)}return{val:c,idx:d}},a.flattenArrayOfArray=function(a){var b=[];return b=b.concat.apply(b,a)},a.convertArrayToXYjsoArray=function(a){for(var b=[],c=0;c<a.length;c++)b.push({x:c,y:a[c]});return b},a}]),angular.module("emuwebApp").service("AnagestService",["$q","$log","viewState","LevelService","LinkService","ConfigProviderService","Ssffdataservice","ArrayHelperService","modalService","HistoryService","DataService",function(a,b,c,d,e,f,g,h,i,j,k){var l,m={};return m.insertAnagestEvents=function(){var l=a.defer(),n=c.getItemsInSelection(k.data.levels);if(0!==n.length)return i.open("views/error.html","There are already events in the selected area! This is not permitted...").then(function(){l.reject()}),l;var o=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.verticalPosSsffTrackName,p=f.getSsffTrackConfig(o),q=g.getColumnOfTrack(p.name,p.columnName),r=g.getSampleRateAndStartTimeOfTrack(p.name),s=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.velocitySsffTrackName,t=f.getSsffTrackConfig(s),u=g.getColumnOfTrack(t.name,t.columnName);if(g.getSampleRateAndStartTimeOfTrack(t.name),1!==q.length||1!==u.length)return i.open("views/error.html","UPS... the column length of of one of the tracks is != 1 this means something is badly configured in the DB!!!").then(function(){l.reject()}),l;var v=h.flattenArrayOfArray(q.values),w=h.flattenArrayOfArray(u.values),x=[0/0,0/0],y=[0/0,0/0],z=[0/0,0/0],A=[0/0,0/0];w=h.convertToAbsValues(w);var B=c.getSelectedStartTime(),C=c.getSelectedEndTime(),D=Math.round(B*r.sampleRate+r.startTime),E=Math.round(C*r.sampleRate+r.startTime),F=E-D,G=v.slice(D,D+F),H=w.slice(D,D+F),I=h.findMinMax(G,"max");A[0]=I.idx;var J=h.findMinMax(H.slice(0,A[0]+1),"max");y[0]=J.idx;var K=h.findMinMax(H.slice(0,y[0]+1),"min");return b.info("Looking for gesture onset"),m.interactiveFindThresholds(H.slice(0,y[0]+1),K.val,J.val,f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.threshold,1,"Looking for gesture onset").then(function(a){var k=a;x[0]=k;var n=h.findMinMax(H.slice(y[0],A[0]+1),"min"),o=n.idx+y[0];b.info("Looking for nucleus onset"),m.interactiveFindThresholds(H.slice(y[0],o+1),n.val,J.val,f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.threshold,-1,"Looking for nucleus onset").then(function(a){var k=a;z[0]=k+y[0];var n=h.findMinMax(H.slice(A[0]),"max");y[1]=n.idx+A[0];var p=h.findMinMax(H.slice(A[0],y[1]+1),"min");o=p.idx+A[0],b.info("Looking for nucleus offset"),m.interactiveFindThresholds(H.slice(o,y[1]+1),p.val,n.val,f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.threshold,1,"Looking for nucleus offset").then(function(a){var k=a;z[1]=k+o;var p=h.findMinMax(H.slice(y[1]),"min");o=p.idx+y[1],b.info("Looking for gesture offset"),m.interactiveFindThresholds(H.slice(y[1],o+1),p.val,n.val,f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.threshold,-1,"Looking for gesture offset").then(function(a){var b=a;x[1]=b+y[1];var h;x[0]=g.calculateSamplePosInVP(D+x[0],r.sampleRate,r.startTime),x[1]=g.calculateSamplePosInVP(D+x[1],r.sampleRate,r.startTime),h=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.gestureOnOffsetLabels[0];var k=d.insertEvent(c.getcurClickLevelName(),x[0],h);j.updateCurChangeObj({type:"ANNOT",action:"INSERTEVENT",name:c.getcurClickLevelName(),start:x[0],id:k.id,pointName:h}),h=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.gestureOnOffsetLabels[1];var m=d.insertEvent(c.getcurClickLevelName(),x[1],h);j.updateCurChangeObj({type:"ANNOT",action:"INSERTEVENT",name:c.getcurClickLevelName(),start:x[1],id:m.id,pointName:h}),y[0]=g.calculateSamplePosInVP(D+y[0],r.sampleRate,r.startTime),y[1]=g.calculateSamplePosInVP(D+y[1],r.sampleRate,r.startTime),h=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.maxVelocityOnOffsetLabels[0];var n=d.insertEvent(c.getcurClickLevelName(),y[0],h);j.updateCurChangeObj({type:"ANNOT",action:"INSERTEVENT",name:c.getcurClickLevelName(),start:y[0],id:n.id,pointName:h}),h=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.maxVelocityOnOffsetLabels[1];var o=d.insertEvent(c.getcurClickLevelName(),y[1],h);j.updateCurChangeObj({type:"ANNOT",action:"INSERTEVENT",name:c.getcurClickLevelName(),start:y[1],id:o.id,pointName:h}),z[0]=g.calculateSamplePosInVP(D+z[0],r.sampleRate,r.startTime),z[1]=g.calculateSamplePosInVP(D+z[1],r.sampleRate,r.startTime),h=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.constrictionPlateauBeginEndLabels[0];var p=d.insertEvent(c.getcurClickLevelName(),z[0],h);j.updateCurChangeObj({type:"ANNOT",action:"INSERTEVENT",name:c.getcurClickLevelName(),start:z[0],id:p.id,pointName:h}),h=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.constrictionPlateauBeginEndLabels[1];var q=d.insertEvent(c.getcurClickLevelName(),z[1],h);j.updateCurChangeObj({type:"ANNOT",action:"INSERTEVENT",name:c.getcurClickLevelName(),start:z[1],id:q.id,pointName:h}),A[0]=g.calculateSamplePosInVP(D+A[0],r.sampleRate,r.startTime),h=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.maxConstrictionLabel;var s=d.insertEvent(c.getcurClickLevelName(),A[0],h);j.updateCurChangeObj({type:"ANNOT",action:"INSERTEVENT",name:c.getcurClickLevelName(),start:A[0],id:s.id,pointName:h});var t=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.autoLinkLevelName,u=d.getLevelDetails(t),v=d.getAllLabelsOfLevel(u);i.open("views/SelectLabelModal.html",v,void 0,!0).then(function(a){if(a!==!1){var b=[k.id,m.id,n.id,o.id,p.id,q.id,s.id];e.insertLinksTo(u.level.items[a].id,b),j.updateCurChangeObj({type:"ANNOT",action:"INSERTLINKSTO",name:u.level.name,parentID:u.level.items[a].id,childIDs:b}),j.addCurChangeObjToUndoStack()}}),l.resolve()})})})},function(){}),l.promise},m.interactiveFindThresholds=function(b,c,d,e,f,g){var j=c+(d-c)*e,k=f;j*=k;for(var m=h.multiplyEachElement(b,k),n=m.length,o=m.slice(1,n),p=0,q=n-1,r=[],s=0;s<m.length;s++)o[s]>=j&&m[s]<j&&r.push(s);for(var t=[],s=0;s<r.length;s++)r[s]>=p&&r[s]<=q&&t.push(s);if(t.length>1){l=a.defer();var u={};u.description=g,u.options=[],u.y=m,u.minVal=c,u.maxVal=d,u.threshold=e;for(var s=0;s<r.length;s++)u.options.push({thresholdIdx:r[s],thresholdValue:m[s]});return i.open("views/SelectThresholdModal.html",u,void 0,!0).then(function(a){console.log(a);var b=r[t[a]];b=h.interp2points(m[b],b,m[b+1],b+1,j),l.resolve(b)}),l.promise}if(0===t.length)return l=a.defer(),i.open("views/error.html","Could not find any values that step over the threshold!!").then(function(){l.reject("Could not find any values that step over the threshold!!")}),l.promise;l=a.defer();var v=r[t[0]];return v=h.interp2points(m[v],v,m[v+1],v+1,j),l.resolve(v),l.promise},m}]),angular.module("emuwebApp").service("DragnDropDataService",["$q","ConfigProviderService",function(a){var b={};return b.convertedBundles=[],b.sessionDefault="",b.getBundle=function(c){var d=a.defer();return angular.forEach(b.convertedBundles,function(a){a.name===c&&d.resolve({status:200,data:a})}),d.promise},b.resetToInitState=function(){b.convertedBundles=[],b.sessionDefault=""},b.setDefaultSession=function(a){b.sessionDefault=a},b.getDefaultSession=function(){return b.sessionDefault},b}]),angular.module("emuwebApp").service("DragnDropService",["$q","$rootScope","appStateService","modalService","DataService","Validationservice","ConfigProviderService","DragnDropDataService","Iohandlerservice","viewState","Soundhandlerservice","Binarydatamaniphelper","browserDetector","Wavparserservice","Textgridparserservice","loadedMetaDataService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){var q={};return q.drandropBundles=[],q.bundleList=[],q.sessionName="File(s)",q.maxDroppedBundles=10,q.setData=function(a){var b=0;return angular.forEach(a,function(a,c){q.setDragnDropData(a[0],c,"wav",a[1]),q.setDragnDropData(a[0],c,"annotation",a[2]),b=c}),b<=q.maxDroppedBundles?void q.convertDragnDropData(q.drandropBundles,0).then(function(){return p.setBundleList(q.bundleList),p.setCurBndlName(q.bundleList[h.sessionDefault]),p.setDemoDbName(q.bundleList[h.sessionDefault]),q.handleLocalFiles(),!0}):!1},q.resetToInitState=function(){q.drandropBundles=[],q.bundleList=[]},q.setDragnDropData=function(a,b,c,d){void 0===q.drandropBundles[b]&&(q.drandropBundles[b]={},h.convertedBundles[b]={},h.convertedBundles[b].name=a,q.bundleList.push({name:a,session:q.sessionName}),h.setDefaultSession(b)),"wav"===c?q.drandropBundles[b].wav=d:"annotation"===c&&(q.drandropBundles[b].annotation=d)},q.getDragnDropData=function(a,b){return"wav"===b?q.drandropBundles[a].wav:"annotation"===b?q.drandropBundles[a].annotation:!1},q.generateDrop=function(a){var b;return b="object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.createObjectURL(q.getBlob(a)):URL.createObjectURL(q.getBlob(a))},q.getBlob=function(a){var b;try{b=new Blob([a],{type:"text/plain"})}catch(c){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,b=new BlobBuilder,b.append(a),b=b.getBlob()}return b},q.convertDragnDropData=function(b,c){var d,e=a.defer(),f=q.drandropBundles[c],g=new FileReader,i=new FileReader;return b.length>c?(void 0!==f.wav&&(g.readAsArrayBuffer(f.wav),g.onloadend=function(a){a.target.readyState==FileReader.DONE&&(d=m.isBrowser.Firefox()?a.target.result:a.currentTarget.result,n.parseWavArrBuf(d).then(function(a){h.convertedBundles[c].mediaFile={},k.wavJSO=a,h.convertedBundles[c].mediaFile.data=l.arrayBufferToBase64(a.origArrBuf),h.convertedBundles[c].ssffFiles={};var d=f.wav.name.substr(0,f.wav.name.lastIndexOf("."));void 0===f.annotation?(h.convertedBundles[c].annotation={levels:[],links:[],sampleRate:a.SampleRate,annotates:d,name:d},q.convertDragnDropData(b,c+1).then(function(){e.resolve()})):"textgrid"===f.annotation.type?(i.readAsText(f.annotation.file),i.onloadend=function(a){a.target.readyState==FileReader.DONE&&o.asyncParseTextGrid(a.currentTarget.result,f.wav.name,d).then(function(a){h.convertedBundles[c].annotation=a,q.convertDragnDropData(b,c+1).then(function(){e.resolve()})})}):"annotation"===f.annotation.type&&(i.readAsText(f.annotation.file),i.onloadend=function(a){a.target.readyState==FileReader.DONE&&(h.convertedBundles[c].annotation=angular.fromJson(a.currentTarget.result),q.convertDragnDropData(b,c+1).then(function(){e.resolve()}))})}))}),e.promise):(e.resolve(),e.promise)},q.handleLocalFiles=function(){var a,b=h.convertedBundles[h.sessionDefault].mediaFile.data,m=l.base64ToArrayBuffer(b),o=h.convertedBundles[h.sessionDefault].annotation;j.showDropZone=!1,j.setState("loadingSaving"),j.somethingInProgress=!0,j.somethingInProgressTxt="Loading local File: "+b.name,i.httpGetPath("configFiles/standalone_emuwebappConfig.json").then(function(b){j.curPerspectiveIdx=0,g.setVals(b.data.EMUwebAppConfig),delete b.data.EMUwebAppConfig,a=f.validateJSO("emuwebappConfigSchema",g.vals),a===!0&&(g.curDbConfig=b.data,j.somethingInProgressTxt="Parsing WAV file...",n.parseWavArrBuf(m).then(function(a){var b=a;j.curViewPort.sS=0,j.curViewPort.eS=b.Data.length,j.curViewPort.selectS=-1,j.curViewPort.selectE=-1,j.curClickSegments=[],j.curClickLevelName=void 0,j.curClickLevelType=void 0,p.setCurBndl(h.convertedBundles[h.sessionDefault]),j.resetSelect(),j.curPerspectiveIdx=0,e.setLevelData(o.levels);var i=[],l=[];o.levels.forEach(function(a){i.push(a.name),l.push({name:a.name,type:a.type,attributeDefinitions:{name:a.name,type:"string"}})}),g.curDbConfig.levelDefinitions=l,j.setCurLevelAttrDefs(g.curDbConfig.levelDefinitions),g.setPerspectivesOrder(j.curPerspectiveIdx,i),k.wavJSO=b,j.somethingInProgressTxt="Parsing SSFF files...";var m=f.validateJSO("annotationFileSchema",o);m===!0?(e.setLinkData(o.links),j.setState("labeling"),j.somethingInProgress=!1,j.somethingInProgressTxt="Done!"):d.open("views/error.html","Error validating annotation file: "+JSON.stringify(m,null,4)).then(function(){q.resetToInitState(),c.resetToInitState()})},function(a){d.open("views/error.html","Error parsing wav file: "+a).then(function(){q.resetToInitState(),c.resetToInitState()})}))}),j.somethingInProgress=!1},q}]),angular.module("emuwebApp").directive("lineChart",function(){return{restrict:"E",scope:{data:"=",threshold:"="},link:function(a,b){a.$watch("data",function(){a.render(a.data)},!0);var c={top:20,right:20,bottom:20,left:40},d=400-c.left-c.right,e=200-c.top-c.bottom,f=d3.select(b[0]).append("svg").attr("width",d+c.left+c.right).attr("height",e+c.top+c.bottom).append("g").attr("transform","translate("+c.left+","+c.top+")"),g=d3.scale.linear().range([0,d]),h=d3.scale.linear().range([e,0]),i=d3.svg.axis().scale(g).tickSize(5).tickSubdivide(!0),j=d3.svg.axis().scale(h).orient("left"),k=d3.svg.line().x(function(a){return g(a.x)}).y(function(a){return h(a.y)}).interpolate("linear");a.render=function(b){g.domain([d3.min(b,function(a){return a.x}),d3.max(b,function(a){return a.x})]),h.domain([d3.min(b,function(a){return a.y}),d3.max(b,function(a){return a.y})]),f.selectAll("g.axis").remove(),f.append("g").attr("class","x axis").attr("transform","translate(0,"+e+")").call(i),f.append("g").attr("class","y axis").call(j),f.append("svg:path").attr("d",k(b)).attr("stroke","red").attr("stroke-width",1).attr("fill","none"),f.append("svg:line").attr("x1",5).attr("y1",5).attr("x2",200).attr("y2",200).attr("class","label-line"),f.append("line").attr({x1:g(a.threshold),y1:0,x2:g(a.threshold),y2:e}).attr("stroke","steelblue").attr("class","verticalLine")}}}}),angular.module("emuwebApp").directive("tutorial",["viewState","Iohandlerservice","ConfigProviderService",function(a,b,c){return{templateUrl:"views/tutorial.html",restrict:"E",scope:{},link:function(b){b.counter=0,b.css=[],b.vs=a,b.cps=c,b.cssDone={color:"#222"},b.cssNotDone={color:"#ddd"},b.cssActive={color:"red","font-size":"18px"},b.que=[],b.$watch("vs.lastKeyCode",function(a){void 0!==a&&a===b.que[b.counter]&&++b.counter,console.log(a)}),b.getClass=function(a){return a==b.counter?b.cssActive:a<b.counter?b.cssDone:b.cssNotDone},b.getStrRep=function(a,d){return b.que[a]=d,c.getStrRep(d)}}}}]),angular.module("emuwebApp").directive("hint",function(){return{templateUrl:"views/hint.html",replace:!0,restrict:"E",link:function(a,b,c){a.showAboutHint=c.show,a.hideMe=function(){a.showAboutHint=!a.showAboutHint,a.aboutBtnClick()}}}}),angular.module("emuwebApp").directive("perspectives",function(){return{templateUrl:"views/perspectives.html",replace:!0,restrict:"E",link:function(){}}}),angular.module("emuwebApp").service("loadedMetaDataService",["Validationservice",function(a){function b(a){var b,c=[];return a.forEach(function(a,d){c[a.session]={collapsed:!0},0===d&&(b=a.session)}),c[b].collapsed=!1,c}function c(a){return a.forEach(function(a){void 0===i[a.session]&&(i[a.session]=[]),i[a.session].push(a)}),i}var d={},e=[],f=[],g={},h="",i={};return d.setBundleList=function(d){var g=a.validateJSO("bundleListSchema",d);return g===!0&&(f=d,e=b(f),i=c(f)),g},d.getBundleList=function(){return f},d.getRendOptBndlList=function(){return i},d.getCurBndl=function(){return g},d.setCurBndl=function(a){g=a},d.getCurBndlName=function(){return g.name},d.setCurBndlName=function(a){g.name=a},d.setDemoDbName=function(a){h=a},d.getDemoDbName=function(){return h},d.toggleCollapseSession=function(a){e[a].collapsed=!e[a].collapsed,Object.keys(e).forEach(function(b){b!==a&&(e[b].collapsed=!0)})},d.getSessionCollapseState=function(a){return e[a].collapsed},d.resetToInitState=function(){e=[],f=[],g={},i={}},d}]),angular.module("emuwebApp").controller("bundleListSideBarCtrl",["$scope","viewState","HistoryService","loadedMetaDataService","dbObjLoadSaveService","ConfigProviderService",function(a,b,c,d,e,f){a.vs=b,a.lmds=d,a.dolss=e,a.cps=f,a.filterText="",a.pageSize=500,a.currentPage=0,a.numberOfPages=function(b){return Math.ceil(b/a.pageSize)},a.uttIsDisabled=function(a){return a.name===d.getCurBndl().name?!1:!0},a.getBndlColor=function(a){var b;return b=0!==c.movesAwayFromLastSave?{"background-color":"#f00",color:"white"}:{"background-color":"#999",color:"black"},a.name===d.getCurBndl().name?b:void 0},a.isSessionDefined=function(a){return"undefined"===a?!1:!0}}]),angular.module("emuwebApp").service("dbObjLoadSaveService",["$log","$q","DataService","viewState","HistoryService","loadedMetaDataService","Ssffdataservice","Iohandlerservice","Binarydatamaniphelper","Wavparserservice","Soundhandlerservice","Ssffparserservice","Validationservice","LevelService","modalService","ConfigProviderService","appStateService","StandardFuncsService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){var s={};return s.loadBundle=function(a){if(0!==e.movesAwayFromLastSave&&"DEMO"!==p.vals.main.comMode){var b=f.getCurBndl();a!==b&&o.open("views/saveChanges.html",b.session+":"+b.name).then(function(b){"saveChanges"===b?s.saveBundle().then(function(){s.loadBundle(a)}):"discardChanges"===b&&(e.resetToInitState(),s.loadBundle(a))})}else a!==f.getCurBndl()&&(e.resetToInitState(),n.deleteEditArea(),d.setEditing(!1),d.setState("loadingSaving"),d.somethingInProgress=!0,d.somethingInProgressTxt="Loading bundle: "+a.name,g.data=[],h.getBundle(a.name,a.session,f.getDemoDbName()).then(function(b){200===b.status&&(b=b.data);var e=m.validateJSO("bundleSchema",b);if(e===!0){var h;h=i.base64ToArrayBuffer(b.mediaFile.data),d.somethingInProgressTxt="Parsing WAV file...",j.parseWavArrBuf(h).then(function(e){var h=e;d.curViewPort.sS=0,d.curViewPort.eS=h.Data.length,d.curViewPort.selectS=-1,d.curViewPort.selectE=-1,d.curClickSegments=[],d.curClickLevelName=void 0,d.curClickLevelType=void 0,d.resetSelect(),k.wavJSO=h,d.somethingInProgressTxt="Parsing SSFF files...",l.asyncParseSsffArr(b.ssffFiles).then(function(e){g.data=e.data,c.setData(b.annotation),f.setCurBndl(a),d.setState("labeling"),d.somethingInProgress=!1,d.somethingInProgressTxt="Done!"},function(a){o.open("views/error.html","Error parsing SSFF file: "+a.status.message).then(function(){q.resetToInitState()})})},function(a){o.open("views/error.html","Error parsing wav file: "+a.status.message).then(function(){q.resetToInitState()})})}else o.open("views/error.html","Error validating annotation file: "+JSON.stringify(e,null,4)).then(function(){q.resetToInitState()})},function(a){a.data?o.open("views/error.html","Error loading bundle: "+a.data).then(function(){q.resetToInitState()}):o.open("views/error.html","Error loading bundle: "+a.status.message).then(function(){q.resetToInitState()})}))},s.saveBundle=function(){if(d.getPermission("saveBndlBtnClick")){var c=b.defer();d.somethingInProgress=!0,d.setState("loadingSaving");var e={};d.somethingInProgressTxt="Creating bundle json...",e.ssffFiles=[];var f={},f=g.getFile("FORMANTS");return void 0!==f?l.asyncJso2ssff(f).then(function(a){e.ssffFiles.push({fileExtension:f.fileExtension,encoding:"BASE64",data:i.arrayBufferToBase64(a.data)}),s.getAnnotationAndSaveBndl(e,c)},function(a){o.open("views/error.html","Error converting javascript object to SSFF file: "+a.status.message),c.reject()}):s.getAnnotationAndSaveBndl(e,c),c.promise}a.info("Action: menuBundleSaveBtnClick not allowed!")},s.getAnnotationAndSaveBndl=function(a,b){r.traverseAndClean(c.getData()),a.annotation=c.getData();var g=f.getCurBndl();"undefined"!=typeof g.session&&(a.session=g.session),"undefined"!=typeof g.finishedEditing&&(a.finishedEditing=g.finishedEditing),"undefined"!=typeof g.comment&&(a.comment=g.comment),d.somethingInProgressTxt="Saving bundle...",h.saveBundle(a).then(function(){d.somethingInProgressTxt="Done!",d.somethingInProgress=!1,e.movesAwayFromLastSave=0,b.resolve(),d.setState("labeling")},function(a){o.open("views/error.html","Error saving bundle: "+a.status.message).then(function(){q.resetToInitState()}),b.reject()})},s}]),angular.module("emuwebApp").service("appStateService",["$log","$rootScope","DragnDropDataService","viewState","Iohandlerservice","loadedMetaDataService","Soundhandlerservice","DataService","Ssffdataservice","HistoryService",function(a,b,c,d,e,f,g,h,i,j){var k={};return k.resetToInitState=function(){e.wsH.isConnected()&&e.wsH.disconnectWarning().then(function(){a.info("Closing websocket connection to server"),e.wsH.closeConnect()}),f.resetToInitState(),g.wavJSO={},h.setData({}),c.resetToInitState(),i.data=[],j.resetToInitState(),d.setState("noDBorFilesloaded"),d.somethingInProgress=!1,d.resetToInitState(),j.resetToInitState(),d.showDropZone=!0,b.$broadcast("resetToInitState")},k}]),wavParserWorker.prototype={getWorkerScript:function(){var a="";return a+="("+this.workerInit+")(this);"},workerInit:function(a){ArrayBuffer.prototype.subarray=function(a,b){for(var c=new ArrayBuffer(b),d=new Int8Array(c),e=new Int8Array(this),f=0;b>f;f++)d[f]=e[a+f];return c},a.ab2str=function(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c]);return String.fromCharCode.apply(null,b)},a.wav2jso=function(b){var c,d,e,f={};return c=0,d=b.subarray(c,4),e=new Uint8Array(d),f.ChunkID=a.ab2str(e),"RIFF"!==f.ChunkID?{status:{type:"ERROR",message:"Wav read error: ChunkID not RIFF but "+f.ChunkID}}:(c=4,d=b.subarray(c,4),e=new Uint32Array(d),f.ChunkSize=e[0],c=8,d=b.subarray(c,4),e=new Uint8Array(d),f.Format=a.ab2str(e),"WAVE"!==f.Format?{status:{type:"ERROR",message:"Wav read error: Format not WAVE but "+f.Format}}:(c=12,d=b.subarray(c,4),e=new Uint8Array(d),f.Subchunk1ID=a.ab2str(e),"fmt "!==f.Subchunk1ID?{status:{type:"ERROR",message:"Wav read error: Subchunk1ID not fmt  but "+f.Subchunk1ID}}:(c=16,d=b.subarray(c,4),e=new Uint32Array(d),f.Subchunk1Size=e[0],16!==f.Subchunk1Size?{status:{type:"ERROR",message:"Wav read error: Subchunk1Size not 16 but "+f.Subchunk1Size}}:(c=20,d=b.subarray(c,2),e=new Uint16Array(d),f.AudioFormat=e[0],1!==f.AudioFormat?{status:{type:"ERROR",message:"Wav read error: AudioFormat not 1 but "+f.AudioFormat}}:(c=22,d=b.subarray(c,2),e=new Uint16Array(d),f.NumChannels=e[0],1!==f.NumChannels?{status:{type:"ERROR",message:"Wav read error: NumChannels not 1 but "+f.NumChannels}}:(c=24,d=b.subarray(c,4),e=new Uint32Array(d),f.SampleRate=e[0],c=28,d=b.subarray(c,4),e=new Uint32Array(d),f.ByteRate=e[0],c=32,d=b.subarray(c,2),e=new Uint16Array(d),f.BlockAlign=e[0],c=34,d=b.subarray(c,2),e=new Uint16Array(d),f.BitsPerSample=e[0],16!==f.BitsPerSample?{status:{type:"ERROR",message:"Wav read error: BitsPerSample not 16 but "+f.BitsPerSample}}:(c=36,d=b.subarray(c,4),e=new Uint8Array(d),f.Subchunk2ID=a.ab2str(e),"data"!==f.Subchunk2ID?{status:{type:"ERROR",message:"Wav read error: Subchunk2ID not data but "+f.Subchunk2ID}}:(c=40,d=b.subarray(c,4),e=new Uint32Array(d),f.Subchunk2Size=e[0],c=44,d=b.subarray(c,f.Subchunk2Size),e=new Int16Array(d),f.Data=new Float32Array(e),f.origArrBuf=b,f))))))))},a.onmessage=function(b){if(void 0!==b.data)switch(b.data.cmd){case"parseBuf":var c=a.wav2jso(b.data.buffer);a.postMessage(void 0===c.status?{status:{type:"SUCCESS",message:""},data:c}:c);break;default:a.postMessage({status:{type:"ERROR",message:"Unknown command sent to wavParserWorker"}})}else a.postMessage({status:{type:"ERROR",message:"Undefined message was sent to wavParserWorker"}})}},getWorkerURL:function(){var a,b;try{a=new Blob([this.getWorkerScript()],{type:"application/javascript"})}catch(c){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,a=new BlobBuilder,a.append(textGridParserWorker),a=a.getBlob()}return b="object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.createObjectURL(a):URL.createObjectURL(a)},kill:function(){this.worker&&this.worker.terminate(),this.url&&URL.revokeObjectURL(this.url)},tell:function(a){this.worker&&this.worker.postMessage(a)},says:function(a){this.worker&&this.worker.addEventListener("message",function(b){a(b.data)})}},espsParserWorker.prototype={getWorkerScript:function(){var a="";return a+="("+this.workerInit+")(this);"},workerInit:function(a){a.toJSO=function(a,b,c,d){var e={};e.name=c,e.annotates=b,e.sampleRate=d,e.levels=[],a=a.replace(/([ \t]*\r?\n)+/g,"\n"),a=a.replace(/[ \t]+/g," ");for(var f,g=a.split("\n"),h=0;h<g.length;h++)if("#"===g[h]){f=h;break}e.levels[0]={},e.levels[0].name=c,e.levels[0].items=[];var i,j=1,k=g[f+1].split(/\s+/);if(e.levels[0].type="H#"!==k[k.length-1]?"EVENT":"SEGMENT","EVENT"===e.levels[0].type)for(h=f+1;h<g.length-1;h++)k=g[h].split(/\s+/),e.levels[0].items.push({id:j,labels:[{name:c,value:k[k.length-1]}],samplePoint:Math.floor(k[1]*d)}),j+=1;else for(j+=1,h=f+2;h<g.length-1;h++)k=g[h].split(/\s+/),i=g[h-1].split(/\s+/),e.levels[0].items.push({id:j,labels:[{name:c,value:k[k.length-1]}],sampleStart:Math.floor(i[1]*d),sampleDur:Math.floor(k[1]*d)-Math.floor(i[1]*d)-1}),j+=1;return e},a.toESPS=function(a,b,c){var d="";d+="signal "+b+"\n",d+="nfields 1\n",d+="#\n";for(var e,f=0;f<a.length;f++)e=""===a[f].labels[0].value&&0===f?"H#":a[f].labels[0].value,d+="	"+String((a[f].sampleStart+a[f].sampleDur)/c)+"	125	"+e+"\n";return d},a.onmessage=function(b){if(void 0!==b.data){var c;switch(b.data.cmd){case"parseESPS":c=a.toJSO(b.data.esps,b.data.annotates,b.data.name,b.data.sampleRate),a.postMessage(void 0===c.type?{status:{type:"SUCCESS",message:""},data:c}:c);break;case"parseJSO":c=a.toESPS(b.data.level.items,b.data.level.name,b.data.sampleRate),a.postMessage(void 0===c.type?{status:{type:"SUCCESS",message:""},data:c}:c);break;default:a.postMessage({status:{type:"ERROR",message:"Unknown command sent to espsParserWorker"}})}}else a.postMessage({status:{type:"ERROR",message:"Undefined message was sent to espsParserWorker"}})}},getWorkerURL:function(){var a,b;try{a=new Blob([this.getWorkerScript()],{type:"application/javascript"})}catch(c){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,a=new BlobBuilder,a.append(textGridParserWorker),a=a.getBlob()}return b="object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.createObjectURL(a):URL.createObjectURL(a)},kill:function(){this.worker&&this.worker.terminate(),this.url&&URL.revokeObjectURL(this.url)},tell:function(a){this.worker&&this.worker.postMessage(a)},says:function(a){this.worker&&this.worker.addEventListener("message",function(b){a(b.data)})}},textGridParserWorker.prototype={getWorkerScript:function(){var a="";return a+="("+this.workerInit+")(this);"},workerInit:function(a){a.l1='File type = "ooTextFile"',a.l2='Object class = "TextGrid"',a.localID=0,a.testForGapsInLabelJSO=function(a){for(var b=0,c=0;c<a.levels.length;c++)if("SEGMENT"===a.levels[c].type)for(var d=0;d<a.levels[c].items.length-1;d++)a.levels[c].items[d].sampleStart+a.levels[c].items[d].sampleDur+1!==a.levels[c].items[d+1].sampleStart&&(b+=1)},a.findTimeOfMinSample=function(){return 0},a.findTimeOfMaxSample=function(a,b){return a/b},a.toJSO=function(b,c,d,e){var f="123abcABCCBAcba321";b=b.replace(/([ \t]*\r?\n)+/g,"\n"),b=b.replace(/("[^\n]*")/g,function(a,b){var c=b.replace(/\s+/g,f);return c}),b=b.replace(/[\t ]+/g,"");var g=new RegExp(f,"g");b=b.replace(g," ");var h,i,j,k,l=b.split("\n"),m=!0,n=[],o={name:d,annotates:c,sampleRate:e,levels:[],links:[]};if(l[0].replace(/\s+/g,"")===a.l1.replace(/\s+/g,"")&&l[1].replace(/\s+/g,"")===a.l2.replace(/\s+/g,"")){for(var p=2;p<l.length;p++){var q=l[p];if("item[]:"!==q){if(!m)if(0===q.indexOf("item[")&&(i=l[p+2].split(/=/)[1].replace(/"/g,""),'"IntervalTier"'===l[p+1].split(/=/)[1]?(h="SEGMENT",o.levels.push({name:i,type:h,items:[]})):'"TextTier"'===l[p+1].split(/=/)[1]&&(h="EVENT",o.levels.push({name:i,type:h,items:[]}))),o.levels.length>0&&"SEGMENT"===o.levels[o.levels.length-1].type&&0===q.indexOf("intervals")&&0!==q.indexOf("intervals:")){var r=Math.floor(l[p+1].split(/=/)[1]*e)+1;1===r&&(r=0);var s=Math.floor(l[p+2].split(/=/)[1]*e);k=l[p+3].split(/=/)[1].replace(/"/g,"");var n=[];n.push({name:o.levels[o.levels.length-1].name,value:k}),o.levels[o.levels.length-1].items.push({id:a.localID,sampleStart:r,sampleDur:s-r+1,labels:n}),++a.localID}else o.levels.length>0&&"EVENT"===o.levels[o.levels.length-1].type&&0===q.indexOf("points")&&0!==q.indexOf("points:")&&(j=l[p+1].split(/=/)[1]*e,k=l[p+2].split(/=/)[1].replace(/"/g,""),n=[],n.push({name:o.levels[o.levels.length-1].name,value:k}),o.levels[o.levels.length-1].items.push({id:a.localID,samplePoint:Math.round(j),labels:n}),++a.localID)}else m=!1}return a.testForGapsInLabelJSO(o),o}return{status:{type:"ERROR",message:"bad header in TextGrid file!!! The header has to be: "+a.l1+"\n"+a.l2}}},a.toTextGrid=function(b,c,d){var e="",f="\n",g="	";e=e+a.l1+f+a.l2+f+f,e=e+"xmin = "+a.findTimeOfMinSample()+f,e=e+"xmax = "+a.findTimeOfMaxSample(c,d)+f,e=e+"levels? <exists>"+f,e=e+"size = "+b.length+f,e=e+"item []:"+f;for(var h=0;h<b.length;h++){var i=b[h];e=e+g+"item ["+h+"]:"+f,"SEGMENT"===i.type?e=e+g+g+'class = "IntervalTier"'+f:"EVENT"===i.type&&(e=e+g+g+'class = "TextTier"'+f),e=e+g+g+'name = "'+i.name+'"'+f,e=e+g+g+"xmin = "+a.findTimeOfMinSample()+f,e=e+g+g+"xmax = "+a.findTimeOfMaxSample(c,d)+f,"SEGMENT"===i.type?e=e+g+g+"intervals: size = "+i.items.length+f:"EVENT"===i.type&&(e=e+g+g+"points: size = "+i.items.length+f);for(var j,k=0;k<i.items.length;k++){var l=k+1;"SEGMENT"===i.type?(e=e+g+g+g+"intervals ["+l+"]:"+f,0!==i.items[k].sampleStart?(j=i.items[k].sampleStart/d+1/d/2,e=e+g+g+g+g+"xmin = "+j+f):e=e+g+g+g+g+"xmin = 0"+f,k<i.items.length-1?(j=(i.items[k].sampleStart+i.items[k].sampleDur)/d+1/d/2,e=e+g+g+g+g+"xmax = "+j+f):e=e+g+g+g+g+"xmax = "+a.findTimeOfMaxSample(c,d)+f,e=e+g+g+g+g+'text = "'+i.items[k].labels[0].value+'"'+f):"EVENT"===i.type&&(e=e+g+g+g+"points["+l+"]:"+f,e=e+g+g+g+g+"time = "+i.items[k].sampleStart/d+f,e=e+g+g+g+g+'mark = "'+i.items[k].label+'"'+f)}}return e},a.onmessage=function(b){if(void 0!==b.data){var c;switch(b.data.cmd){case"parseTG":c=a.toJSO(b.data.textGrid,b.data.annotates,b.data.name,b.data.sampleRate),a.postMessage(void 0===c.status?{status:{type:"SUCCESS",message:""},data:c}:c);break;case"toTextGrid":c=a.toTextGrid(b.data.levels,b.data.buffLength,b.data.sampleRate),a.postMessage(void 0===c.status?{status:{type:"SUCCESS",message:""},data:c}:c);break;default:a.postMessage({status:{type:"ERROR",message:"Unknown command sent to textGridParserWorker"}})}}else a.postMessage({status:{type:"ERROR",message:"Undefined message was sent to textGridParserWorker"}})}},getWorkerURL:function(){var a,b;try{a=new Blob([this.getWorkerScript()],{type:"application/javascript"})}catch(c){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,a=new BlobBuilder,a.append(textGridParserWorker),a=a.getBlob()}return b="object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.createObjectURL(a):URL.createObjectURL(a)},kill:function(){this.worker&&this.worker.terminate(),this.url&&URL.revokeObjectURL(this.url)},tell:function(a){this.worker&&this.worker.postMessage(a)},says:function(a){this.worker&&this.worker.addEventListener("message",function(b){a(b.data)})}},spectroDrawingWorker.prototype={getWorkerScript:function(){var a="";return a+="("+this.workerInit+")(this);"},workerInit:function(a){a.executed=!1,a.PI=3.141592653589793,a.TWO_PI=6.283185307179586,a.totalMax=0,a.dynRangeInDB=50,a.myWindow={BARTLETT:1,BARTLETTHANN:2,BLACKMAN:3,COSINE:4,GAUSS:5,HAMMING:6,HANN:7,LANCZOS:8,RECTANGULAR:9,TRIANGULAR:10},a.imgWidth=0,a.imgHeight=0,a.upperFreq=0,a.lowerFreq=0,a.pixelRatio=1,a.heatMapColorAnchors=[[255,0,0],[0,255,0],[0,0,0]],a.samplesPerPxl=0,a.sampleRate=0,a.preEmphasisFilterFactor=.97,a.transparency=0,a.drawHeatMapColors=!1,a.N=0,a.windowSizeInSecs=.01,a.audioBuffer=void 0,a.audioBufferChannels=0,a.wFunction=0,a.myFFT=void 0,a.pixelHeight=1,a.internalalpha=1,a.maxPsd=0,a.HzStep=0,a.paint=[],a.sin=void 0,a.cos=void 0,a.ceilingFreqFftIdx=0,a.floorFreqFftIdx=0,a.resultImgArr=void 0,a.toLinearLevel=function(a){return Math.pow(10,a/10)
},a.log10=function(a){return Math.log(a)/2.302585092994046},a.magnitude=function(a,b){return Math.sqrt(a*a+b*b)},a.FFT=function(){var b,c,d,e=a.N;if(b=parseInt(Math.log(e)/.6931471805599453,10),e!==1<<b&&console.log("ERROR : FFT length must be power of 2"),void 0===a.cos||e!==a.N)for(a.cos=new Float32Array(e/2),d=0;e/2>d;d++)a.cos[d]=Math.cos(-2*a.PI*d/e);if(void 0===a.sin||e!==a.N)for(a.sin=new Float32Array(e/2),d=0;e/2>d;d++)a.sin[d]=Math.sin(-2*a.PI*d/e);this.applyWindowFuncAndPreemph=function(b,d,e,f){switch(this.alpha=d,b){case a.myWindow.BARTLETT:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionBartlett(f,c);break;case a.myWindow.BARTLETTHANN:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionBartlettHann(f,c);break;case a.myWindow.BLACKMAN:for(this.alpha=this.alpha||.16,c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionBlackman(f,c,d);break;case a.myWindow.COSINE:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionCosine(f,c);break;case a.myWindow.GAUSS:for(this.alpha=this.alpha||.25,c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionGauss(f,c,d);break;case a.myWindow.HAMMING:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionHamming(f,c);break;case a.myWindow.HANN:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionHann(f,c);break;case a.myWindow.LANCZOS:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionLanczos(f,c);break;case a.myWindow.RECTANGULAR:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionRectangular(f,c);break;case a.myWindow.TRIANGULAR:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionTriangular(f,c)}return e},this.wFunctionBartlett=function(a,b){return 2/(a-1)*((a-1)/2-Math.abs(b-(a-1)/2))},this.wFunctionBartlettHann=function(b,c){return.62-.48*Math.abs(c/(b-1)-.5)-.38*Math.cos(a.TWO_PI*c/(b-1))},this.wFunctionBlackman=function(b,c,d){var e=(1-d)/2,f=.5,g=d/2;return e-f*Math.cos(a.TWO_PI*c/(b-1))+g*Math.cos(4*a.PI*c/(b-1))},this.wFunctionCosine=function(b,c){return Math.cos(a.PI*c/(b-1)-a.PI/2)},this.wFunctionGauss=function(a,b,c){return Math.pow(Math.E,-.5*Math.pow((b-(a-1)/2)/(c*(a-1)/2),2))},this.wFunctionHamming=function(b,c){return.54-.46*Math.cos(a.TWO_PI*c/(b-1))},this.wFunctionHann=function(b,c){return.5*(1-Math.cos(a.TWO_PI*c/(b-1)))},this.wFunctionLanczos=function(b,c){var d=2*c/(b-1)-1;return Math.sin(a.PI*d)/(a.PI*d)},this.wFunctionRectangular=function(){return 1},this.wFunctionTriangular=function(a,b){return 2/a*(a/2-Math.abs(b-(a-1)/2))},this.applyPreEmph=function(b,c){return b-a.preEmphasisFilterFactor*c},this.fft=function(c,d){var f,g,h,i,j,k,l,m,n,o;for(g=0,j=e/2,f=1;e-1>f;f++){for(i=j;g>=i;)g-=i,i/=2;g+=i,g>f&&(n=c[f],c[f]=c[g],c[g]=n,n=d[f],d[f]=d[g],d[g]=n)}for(i=0,j=1,f=0;b>f;f++)for(i=j,j+=j,k=0,g=0;i>g;g++)for(l=a.cos[k],m=a.sin[k],k+=1<<b-f-1,h=g;e>h;h+=j)n=l*c[h+i]-m*d[h+i],o=m*c[h+i]+l*d[h+i],c[h+i]=c[h]-n,d[h+i]=d[h]-o,c[h]=c[h]+n,d[h]=d[h]+o}},a.convertToHeatmap=function(a,b,c,d){var e=d.length-1,f=(c-a)/(b-a)*e,g=Math.floor(f),h=Math.min.apply(null,[Math.floor(f)+1,e]),i=d[g],j=d[h],k=f-g;return{r:Math.floor(i[0]+k*(j[0]-i[0])),g:Math.floor(i[1]+k*(j[1]-i[1])),b:Math.floor(i[2]+k*(j[2]-i[2]))}},a.drawVerticalLineOfSpectogram=function(b){var c,d,e,f,g=a.pixelHeight,h=2*Math.pow(a.paint[b][1],2)/a.N,i=10*a.log10(h/a.maxPsd),j=(i+a.dynRangeInDB)/a.dynRangeInDB;j>1?j=1:0>j&&(j=0);for(var k=0;k<a.paint[b].length;k++){var l=j;h=2*Math.pow(a.paint[b][k],2)/a.N,i=10*a.log10(h/a.maxPsd),j=(i+a.dynRangeInDB)/a.dynRangeInDB,j>1&&(j=1),0>j&&(j=0);var m=j;if(a.pixelHeight>=1)for(var n=0;n<a.pixelHeight;n++){var o=l+(m-l)/g*n;if(c=255-Math.round(255*o),e=Math.floor(b),f=Math.floor(a.imgHeight-(a.pixelHeight*(k-2)+n)),d=4*(e+f*a.imgWidth),a.drawHeatMapColors)if(isNaN(c))a.resultImgArr[d+0]=c,a.resultImgArr[d+1]=c,a.resultImgArr[d+2]=c,a.resultImgArr[d+3]=a.transparency;else{var p=a.convertToHeatmap(0,255,c,a.heatMapColorAnchors);a.resultImgArr[d+0]=p.r,a.resultImgArr[d+1]=p.g,a.resultImgArr[d+2]=p.b,a.resultImgArr[d+3]=a.transparency}else a.resultImgArr[d+0]=c,a.resultImgArr[d+1]=c,a.resultImgArr[d+2]=c,a.resultImgArr[d+3]=a.transparency}else c=255-Math.round(255*m),e=Math.floor(b),f=Math.floor(a.imgHeight-a.pixelHeight*(k-2)),d=4*(e+f*a.imgWidth),a.resultImgArr[d+0]=c,a.resultImgArr[d+1]=c,a.resultImgArr[d+2]=c,a.resultImgArr[d+3]=a.transparency}},a.calcMagnitudeSpectrum=function(b,c){for(var d=new Float32Array(a.N),e=new Float32Array(a.N),f=new Float32Array(a.ceilingFreqFftIdx-a.floorFreqFftIdx),g=0;c>g;g++)e[g]=a.audioBuffer[b+g];a.myFFT.applyWindowFuncAndPreemph(a.wFunction,a.internalalpha,e,c),a.myFFT.fft(e,d);for(var h=0;h<=a.ceilingFreqFftIdx-a.floorFreqFftIdx;h++)f[h]=a.magnitude(e[h+a.floorFreqFftIdx],d[h+a.floorFreqFftIdx]),a.totalMax<f[h]&&(a.totalMax=f[h]);return f},a.renderSpectrogram=function(){if(!a.executed){a.executed=!0;var b=a.sampleRate*a.windowSizeInSecs;a.myFFT=new a.FFT,a.paint=new Array(a.imgWidth),a.HzStep=a.sampleRate/2/(a.N/2),a.ceilingFreqFftIdx=Math.ceil(a.upperFreq/a.HzStep),a.floorFreqFftIdx=Math.floor(a.lowerFreq/a.HzStep),a.pixelHeight=a.imgHeight/(a.ceilingFreqFftIdx-a.floorFreqFftIdx-2),"undefined"==typeof Uint8ClampedArray&&(Uint8ClampedArray=Uint8Array),a.resultImgArr=new Uint8ClampedArray(Math.ceil(a.imgWidth*a.imgHeight*4));for(var c=0;c<a.imgWidth;c++)a.paint[c]=a.calcMagnitudeSpectrum(Math.round(c*a.samplesPerPxl),b),a.maxPsd=2*Math.pow(a.totalMax,2)/a.N;for(var d=0;d<a.imgWidth;d++)a.drawVerticalLineOfSpectogram(d);a.postMessage({window:a.wFunction,samplesPerPxl:a.samplesPerPxl,pixelHeight:a.pixelHeight,pixelRatio:a.pixelRatio,width:a.imgWidth,height:a.imgHeight,img:a.resultImgArr.buffer},[a.resultImgArr.buffer]),a.myFFT=null,a.executed=!1}},a.onmessage=function(b){if(void 0!==b.data){var c=!0,d="",e=b.data;if(void 0!==e.windowSizeInSecs?a.windowSizeInSecs=e.windowSizeInSecs:(d="windowSizeInSecs",c=!1),void 0!==e.fftN?a.N=e.fftN:(d="fftN",c=!1),void 0!==e.alpha?a.internalalpha=e.alpha:(d="alpha",c=!1),void 0!==e.upperFreq?a.upperFreq=e.upperFreq:(d="upperFreq",c=!1),void 0!==e.lowerFreq?a.lowerFreq=e.lowerFreq:(d="lowerFreq",c=!1),void 0!==e.samplesPerPxl?a.samplesPerPxl=e.samplesPerPxl:(d="samplesPerPxl",c=!1),void 0!==e.window)switch(e.window){case 1:a.wFunction=a.myWindow.BARTLETT;break;case 2:a.wFunction=a.myWindow.BARTLETTHANN;break;case 3:a.wFunction=a.myWindow.BLACKMAN;break;case 4:a.wFunction=a.myWindow.COSINE;break;case 5:a.wFunction=a.myWindow.GAUSS;break;case 6:a.wFunction=a.myWindow.HAMMING;break;case 7:a.wFunction=a.myWindow.HANN;break;case 8:a.wFunction=a.myWindow.LANCZOS;break;case 9:a.wFunction=a.myWindow.RECTANGULAR;break;case 10:a.wFunction=a.myWindow.TRIANGULAR}else d="window",c=!1;void 0!==e.imgWidth?a.imgWidth=e.imgWidth:(d="imgWidth",c=!1),void 0!==e.imgHeight?a.imgHeight=e.imgHeight:(d="imgHeight",c=!1),void 0!==e.dynRangeInDB?a.dynRangeInDB=e.dynRangeInDB:(d="dynRangeInDB",c=!1),void 0!==e.pixelRatio?a.pixelRatio=e.pixelRatio:(d="pixelRatio",c=!1),void 0!==e.sampleRate?a.sampleRate=e.sampleRate:(d="sampleRate",c=!1),void 0!==e.audioBufferChannels?a.audioBufferChannels=e.audioBufferChannels:(d="audioBufferChannels",c=!1),void 0!==e.transparency?a.transparency=e.transparency:(d="transparency",c=!1),void 0!==e.audioBuffer?a.audioBuffer=e.audioBuffer:(d="audioBuffer",c=!1),void 0!==e.drawHeatMapColors?a.drawHeatMapColors=e.drawHeatMapColors:(d="drawHeatMapColors",c=!1),void 0!==e.preEmphasisFilterFactor?a.preEmphasisFilterFactor=e.preEmphasisFilterFactor:(d="preEmphasisFilterFactor",c=!1),void 0!==e.heatMapColorAnchors?a.heatMapColorAnchors=e.heatMapColorAnchors:(d="heatMapColorAnchors",c=!1),c?a.renderSpectrogram():a.postMessage({status:{type:"ERROR",message:d+" is undefined"}})}else a.postMessage({status:{type:"ERROR",message:"Undefined message was sent to spectroDrawingWorker"}})}},getWorkerURL:function(){var a,b;try{a=new Blob([this.getWorkerScript()],{type:"application/javascript"})}catch(c){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,a=new BlobBuilder,a.append(spectroDrawingWorker),a=a.getBlob()}return b="object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.createObjectURL(a):URL.createObjectURL(a)},kill:function(){this.worker&&this.worker.terminate(),this.url&&("object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.revokeObjectURL(this.url):URL.revokeObjectURL(this.url))},tell:function(a){this.worker&&this.worker.postMessage(a)},says:function(a){this.worker&&this.worker.addEventListener("message",function(b){a(b.data)})}},ssffParserWorker.prototype={getWorkerScript:function(){var a="";return a+="("+this.workerInit+")(this);"},workerInit:function(a){var b={},c="SSFF -- (c) SHLRC\n",d="Machine IBM-PC\n",e="-----------------\n";b.fileExtension="",b.sampleRate=-1,b.startTime=-1,b.origFreq=-1,b.Columns=[],function(){function b(a){var b,c,e,f,g,h;for(e=a.length,c=0,b="";e>c;){if(f=255&a.charCodeAt(c++),c===e){b+=d.charAt(f>>2),b+=d.charAt((3&f)<<4),b+="==";break}if(g=a.charCodeAt(c++),c===e){b+=d.charAt(f>>2),b+=d.charAt((3&f)<<4|(240&g)>>4),b+=d.charAt((15&g)<<2),b+="=";break}h=a.charCodeAt(c++),b+=d.charAt(f>>2),b+=d.charAt((3&f)<<4|(240&g)>>4),b+=d.charAt((15&g)<<2|(192&h)>>6),b+=d.charAt(63&h)}return b}function c(a){var b,c,d,f,g,h,i;for(h=a.length,g=0,i="";h>g;){do b=e[255&a.charCodeAt(g++)];while(h>g&&-1===b);if(-1===b)break;do c=e[255&a.charCodeAt(g++)];while(h>g&&-1===c);if(-1===c)break;i+=String.fromCharCode(b<<2|(48&c)>>4);do{if(d=255&a.charCodeAt(g++),61===d)return i;d=e[d]}while(h>g&&-1===d);if(-1===d)break;i+=String.fromCharCode((15&c)<<4|(60&d)>>2);do{if(f=255&a.charCodeAt(g++),61===f)return i;f=e[f]}while(h>g&&-1===f);if(-1===f)break;i+=String.fromCharCode((3&d)<<6|f)}return i}var d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",e=new Array(-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1);a.btoa||(a.btoa=b),a.atob||(a.atob=c)}(),a.base64ToArrayBuffer=function(b){for(var c=a.atob(b),d=c.length,e=new Uint8Array(d),f=0;d>f;f++){var g=c.charCodeAt(f);e[f]=g}return e.buffer},a.round=function(a,b){if(1>b||b>14)return!1;var c=Math.pow(10,b),d=(Math.round(a*c)/c).toString();return-1===d.indexOf(".")&&(d+="."),d+=c.toString().substring(1),d.substring(0,d.indexOf(".")+b+1)},a.stringToUint=function(a){for(var b=a.split(""),c=[],d=0;d<b.length;d++)c.push(b[d].charCodeAt(0));return new Uint8Array(c)},a.Uint8Concat=function(a,b){var c=a.length,d=new Uint8Array(c+b.length);return d.set(a),d.set(b,c),d},a.ssff2jso=function(a,f){b.fileExtension=f,b.Columns=[];for(var g=new Uint8Array(a),h="",i=0;i<g.length;i++)h+=String.fromCharCode(g[i]);var j=h.split(/^/m);if(j[0]!==c)return{status:{type:"ERROR",message:"SSFF parse error: first line != SSFF -- (c) SHLRC in file with fileExtension "+f}};if(j[1]!==d)return{status:{type:"ERROR",message:"SSFF parse error: machineID != Machine IBM-PC in file with fileExtension "+f}};b.sampleRate=void 0,b.startTime=void 0;for(var k=0;j[k]!==e;)"Record_Freq"===j[k].split(/[ ,]+/)[0]&&(b.sampleRate=parseFloat(j[k].split(/[ ,]+/)[1].replace(/(\r\n|\n|\r)/gm,""))),"Start_Time"===j[k].split(/[ ,]+/)[0]&&(b.startTime=parseFloat(j[k].split(/[ ,]+/)[1].replace(/(\r\n|\n|\r)/gm,""))),k+=1;if(void 0===b.sampleRate||void 0===b.startTime)return{status:{type:"ERROR",message:"SSFF parse error: Required fields Record_Freq or Start_Time not set in file with fileExtension "+f}};for(var l=4;l<j.length&&("Original_Freq"===j[l].split(/[ ,]+/)[0]&&(b.origFreq=parseFloat(j[l].split(/[ ,]+/)[2].replace(/(\r\n|\n|\r)/gm,""))),j[l]!==e);l++){var m=j[l].split(/[ ]+/);"Column"===m[0]&&b.Columns.push({name:m[1],ssffdatatype:m[2],length:parseInt(m[3].replace(/(\r\n|\n|\r)/gm,""),10),values:[],_minVal:1/0,_maxVal:-1/0})}for(var n,o,p,q,r,s=j.slice(0,l+1).join("").length;s<=g.length;)for(l=0;l<b.Columns.length;l++)if("DOUBLE"===b.Columns[l].ssffdatatype)p=8*b.Columns[l].length,o=a.subarray(s,p),"undefined"==typeof Float64Array&&(Float64Array=Float32Array),n=new Float64Array(o),b.Columns[l].values.push(Array.prototype.slice.call(n)),s+=p,q=Math.min.apply(null,Array.prototype.slice.call(n)),r=Math.max.apply(null,Array.prototype.slice.call(n)),q<b.Columns[l]._minVal&&(b.Columns[l]._minVal=q),r>b.Columns[l]._maxVal&&(b.Columns[l]._maxVal=r);else if("FLOAT"===b.Columns[l].ssffdatatype)p=4*b.Columns[l].length,o=a.subarray(s,p),n=new Float32Array(o),b.Columns[l].values.push(Array.prototype.slice.call(n)),s+=p,q=Math.min.apply(null,Array.prototype.slice.call(n)),r=Math.max.apply(null,Array.prototype.slice.call(n)),q<b.Columns[l]._minVal&&(b.Columns[l]._minVal=q),r>b.Columns[l]._maxVal&&(b.Columns[l]._maxVal=r);else if("SHORT"===b.Columns[l].ssffdatatype)p=2*b.Columns[l].length,o=a.subarray(s,p),n=new Uint16Array(o),b.Columns[l].values.push(Array.prototype.slice.call(n)),s+=p,q=Math.min.apply(null,Array.prototype.slice.call(n)),r=Math.max.apply(null,Array.prototype.slice.call(n)),q<b.Columns[l]._minVal&&(b.Columns[l]._minVal=q),r>b.Columns[l]._maxVal&&(b.Columns[l]._maxVal=r);else{if("BYTE"!==b.Columns[l].ssffdatatype)return{status:{type:"ERROR",message:"Unsupported column type! Only DOUBLE, FLOAT, SHORT, BYTE column types are currently supported in file with fileExtension "+f}};p=1*b.Columns[l].length,o=a.subarray(s,p),n=new Uint8Array(o),b.Columns[l].values.push(Array.prototype.slice.call(n)),s+=p}return b},a.jso2ssff=function(b){var f=c+d;f+="Record_Freq "+a.round(b.sampleRate,1)+"\n",f+="Start_Time "+b.startTime+"\n",b.Columns.forEach(function(a){f+="Column "+a.name+" "+a.ssffdatatype+" "+a.length+"\n"}),f+="Original_Freq DOUBLE "+a.round(b.origFreq,1)+"\n",f+=e;var g=0,h=!1;if(b.Columns.forEach(function(a){"SHORT"===a.ssffdatatype?g+=2*a.length:h=!0}),h)return{status:{type:"ERROR",message:"Unsupported column type! Only SHORT columns supported for now!"}};var i=g*b.Columns[0].values.length,j=new ArrayBuffer(i),k=new DataView(j),l=new Uint8Array(a.stringToUint(f)),m=0;if(b.Columns[0].values.forEach(function(a,c){b.Columns.forEach(function(a){"SHORT"===a.ssffdatatype?a.values[c].forEach(function(a){k.setInt16(m,a,!0),m+=2}):h=!0})}),h)return{status:{type:"ERROR",message:"Unsupported column type! Only SHORT columns supported for now!"}};var n=new Uint8Array(k.buffer);return l=new a.Uint8Concat(l,n),{status:{type:"SUCCESS",message:""},data:l.buffer}},a.parseArr=function(b){for(var c,d=!0,e=[],f=0;f<b.length;f++){c={};var g;if(g=a.base64ToArrayBuffer(b[f].data),c=a.ssff2jso(g,b[f].fileExtension),void 0!==c.status)return d=!1,c;e.push(JSON.parse(JSON.stringify(c)))}return d?{status:{type:"SUCCESS",message:""},data:e}:{status:{type:"ERROR",message:"Error in parseArr() with: "+JSON.stringify(b)}}},ArrayBuffer.prototype.subarray=function(a,b){for(var c=new ArrayBuffer(b),d=new Int8Array(c),e=new Int8Array(this),f=0;b>f;f++)d[f]=e[a+f];return c},a.onmessage=function(b){if(void 0!==b.data)switch(b.data.cmd){case"parseArr":a.postMessage(a.parseArr(b.data.ssffArr));break;case"jso2ssff":a.postMessage(a.jso2ssff(JSON.parse(b.data.jso)));break;default:a.postMessage({status:{type:"ERROR",message:"Unknown command sent to ssffParserWorker"}})}else a.postMessage({status:{type:"ERROR",message:"Undefined message was sent to ssffParserWorker"}})}},getWorkerURL:function(){var a,b;try{a=new Blob([this.getWorkerScript()],{type:"application/javascript"})}catch(c){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,a=new BlobBuilder,a.append(textGridParserWorker),a=a.getBlob()}return b="object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.createObjectURL(a):URL.createObjectURL(a)},kill:function(){this.worker&&(this.worker.terminate(),this.worker=void 0),this.url&&("object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.revokeObjectURL(this.url):URL.revokeObjectURL(this.url),this.url=void 0)},tell:function(a){this.worker&&this.worker.postMessage(a)},says:function(a){this.worker&&this.worker.addEventListener("message",function(b){a(b.data)})}},angular.module("emuwebApp").service("mathHelperService",function(){var a={};return a.calcClosestPowerOf2Gt=function(a){for(var b=0;Math.pow(2,b)<a;)b+=1;return Math.pow(2,b)},a.roundToNdigitsAfterDecPoint=function(a,b){(1>b||b>14)&&console.error("error in call of round function!!");var c=Math.pow(10,b),d=(Math.round(a*c)/c).toString();return-1===d.indexOf(".")&&(d+="."),d+=c.toString().substring(1),parseFloat(d.substring(0,d.indexOf(".")+b+1))},a}),angular.module("emuwebApp").directive("modal",["$animate","modalService",function(a,b){return{restrict:"E",templateUrl:"views/modal.html",replace:!0,scope:{},link:function(a,c){a.templateUrl="",a.modal=b,a.isOpen=!1,a.force=!1,a.dataIn="",a.$watch("modal.isOpen",function(d){void 0!==d&&(a.templateUrl=b.getTemplateUrl(),a.dataIn=b.dataIn,a.force=b.force,d?c[0].classList.add("emuwebapp-modal-open"):c[0].classList.remove("emuwebapp-modal-open"))}),a.$watch("modal.templateUrl",function(c){void 0!==c&&(a.templateUrl=c,a.dataIn=b.dataIn,a.force=b.force)})}}}]),angular.module("emuwebApp").service("modalService",["$q","ArrayHelperService","viewState",function(a,b,c){var d={};return d.isOpen=!1,d.templateUrl="",d.defer=void 0,d.deferChange=void 0,d.force=!1,d.dataOut=void 0,d.dataIn=void 0,d.dataExport=void 0,d.open=function(e,f,g,h){return void 0!==f&&(d.dataIn=f,void 0!==f.y&&(d.dataIn.chartData=b.convertArrayToXYjsoArray(f.y))),void 0!==g&&(d.dataExport=g),void 0!==h&&(d.force=h),d.defer=a.defer(),d.templateUrl=e,c.setState("modalShowing"),d.isOpen=!0,d.defer.promise},d.changeModal=function(b,c,e,f){return void 0!==c&&(d.dataIn=c),void 0!==e&&(d.dataExport=e),void 0!==f&&(d.force=f),d.deferChange=a.defer(),d.templateUrl=b,d.deferChange.promise},d.error=function(a){d.dataIn=a,d.templateUrl="views/error.html",c.setState("modalShowing")},d.close=function(){c.setEditing(!1),c.setState(c.prevState),d.isOpen=!1,c.hierarchyShown&&c.toggleHierarchy(),d.defer.resolve(!1)},d.closeAndResolve=function(a){c.setEditing(!1),c.setState(c.prevState),d.isOpen=!1,d.defer.resolve(a)},d.confirm=function(){c.setEditing(!1),c.setState(c.prevState),d.isOpen=!1,d.defer.resolve(!0)},d.select=function(a){d.closeAndResolve(a)},d.confirmContent=function(){c.setEditing(!1),c.setState(c.prevState),d.isOpen=!1,d.defer.resolve(d.dataOut)},d.getTemplateUrl=function(){return d.templateUrl},d}]),angular.module("emuwebApp").controller("TabbedCtrl",["$scope","Websockethandler","viewState","ConfigProviderService","Validationservice","uuid","LevelService",function(a,b,c,d,e,f,g){a.cps=d,a.vs=c,a.valid=e,a.lvl=g,a.levelDefinitionProperties={},a.linkDefinitionProperties={},a.spectroDefinitionProperties={},a.signalSelect=[],a.levelSelect=[],a.twoDimSelect=[],a.addSignalSelect="",a.addLevelSelect="",a.addTwoDimSelect="",a.response=[],a.tabs=[{title:"level definitions",url:"views/tabbed/levelDefinition.html"},{title:"link definitions",url:"views/tabbed/linkDefinition.html"},{title:"ssff track definitions",url:"views/tabbed/ssffDefinition.html"},{title:"2D definitions",url:"views/tabbed/twoDimDefinition.html"},{title:"EMU-webApp",url:"views/tabbed/emuDefinition.html"},{title:"global DB",url:"views/tabbed/globalDefinition.html"}],a.cps=d,a.currentTabUrl=a.tabs[0].url,a.onClickTab=function(b){a.currentTabUrl=b.url},a.isActiveTab=function(b){return b===a.currentTabUrl?{"background-color":d.design.color.white,color:d.design.color.black,"font-family":d.design.font.large.family,"font-size":d.design.font.large.size}:{"background-color":d.design.color.blue,color:d.design.color.white,"font-family":d.design.font.large.family,"font-size":d.design.font.large.size}},a.setup=function(){var b=a.valid.getSchema("DBconfigFileSchema"),c=a.valid.getSchema("emuwebappConfigSchema");a.levelDefinitionProperties=b.data.properties.levelDefinitions.items.properties,a.linkDefinitionProperties=b.data.properties.linkDefinitions.items.properties,a.spectroDefinitionProperties=c.data.properties.spectrogramSettings.properties,a.resetSelections()},a.resetSelections=function(){a.signalSelect=["OSCI","SPEC"],a.levelSelect=[],a.twoDimSelect=[],angular.forEach(a.cps.curDbConfig.ssffTrackDefinitions,function(b){a.signalSelect.push(b.name)}),angular.forEach(a.cps.curDbConfig.levelDefinitions,function(b){a.levelSelect.push(b.name)}),a.twoDimSelect.push("under development"),a.addSignalSelect=a.signalSelect[0],a.addLevelSelect=a.levelSelect[0],a.addTwoDimSelect=a.twoDimSelect[0]},a.cursorInTextField=function(){c.setEditing(!0),c.setcursorInTextField(!0)},a.cursorOutOfTextField=function(){c.setEditing(!1),c.setcursorInTextField(!1)},a.highlight=function(b,c){var d={"background-color":a.cps.design.color.lightGrey};switch(b){case"level":if(a.cps.curDbConfig.levelDefinitions[c].added===!0)return d;break;case"ssff":if(a.cps.curDbConfig.ssffTrackDefinitions[c].added===!0)return d;break;case"link":if(a.cps.curDbConfig.linkDefinitions[c].added===!0)return d;break;default:return{}}return{}},a.classBorderDefinition=function(b,c){var d="emuwebapp-tabbed-border";switch(b){case"level":a.cps.curDbConfig.levelDefinitions[c].added===!0&&(d="emuwebapp-tabbed-border highlight");break;case"ssff":a.cps.curDbConfig.ssffTrackDefinitions[c].added===!0&&(d="emuwebapp-tabbed-border highlight");break;case"link":a.cps.curDbConfig.linkDefinitions[c].added===!0&&(d="emuwebapp-tabbed-border highlight")}return d},a.saveDefinition=function(c,d,e,f){var g=angular.toJson(f,!1),h=f;b.getDoEditDBConfig().then(function(f){if("YES"===f){var i=!1;switch(c){case"level":h.added===!0&&(h.name.length>0?null===a.lvl.getLevelDetails(h.name).level?""!==h.type?i=!0:a.showResponse(d,"The level type is not set."):a.showResponse(d,'The level name "'+h.name+'" already exists.'):a.showResponse(d,'The level name "'+h.name+'" is not valid.'));break;case"link":h.added===!0&&(h.superlevelName.length>0?h.sublevelName.length>0?""!==h.type?i=!0:a.showResponse(d,"The level type is not set."):a.showResponse(d,'The sublevelName name "'+h.sublevelName+'" is not valid.'):a.showResponse(d,'The superlevelName name "'+h.superlevelName+'" is not valid.'));break;case"ssff":h.added===!0&&(h.name.length>0?h.columnName.length>0?h.fileExtension.length>0?i=!0:a.showResponse(d,'The fileExtension "'+h.fileExtension+'" already exists.'):a.showResponse(d,'The columnName "'+h.columnName+'" already exists.'):a.showResponse(d,'The name "'+h.name+'" is not valid.'))}i&&b.editDBConfig(e,g).then(function(b){"YES"===b?(h.added=void 0,delete h.added,a.hideResponse(d)):a.showResponse(d,"Error while communicating with server ("+e+").")})}else a.showResponse(d,"Editing of Config is not allowed.")})},a.showResponse=function(b,c){a.response[b]={},a.response[b].show=!0,a.response[b].text=c},a.hideResponse=function(b){void 0!==a.response[b]&&a.response[b].show===!0&&(a.response[b].show=!1)},a.addDefinition=function(b,c,d){switch(b){case"level":a.cps.curDbConfig.levelDefinitions.push({name:"",type:"",attributeDefinitions:[{name:"",type:"STRING"}],added:!0});break;case"levelattribute":a.cps.curDbConfig.levelDefinitions[c].attributeDefinitions.push({name:"",type:"STRING",legalLabels:[]});break;case"link":a.cps.curDbConfig.linkDefinitions.push({type:"",superlevelName:"",sublevelName:"",added:!0});break;case"ssff":a.cps.curDbConfig.ssffTrackDefinitions.push({name:"",columnName:"",fileExtension:"",added:!0});break;case"perspective":a.cps.vals.perspectives.push({name:"",signalCanvases:{order:[],assign:[],contourLims:[],contourColors:[]},levelCanvases:{order:[]},twoDimCanvases:{order:[]}});break;case"perspectiveAssign":a.cps.vals.perspectives[c].signalCanvases.assign.push({signalCanvasName:"",ssffTrackName:""});break;case"perspectiveContourColor":a.cps.vals.perspectives[c].signalCanvases.contourColors.push({colors:["rgba(0,0,0,1)"],ssffTrackName:""});break;case"perspectiveContourColorColor":a.cps.vals.perspectives[c].signalCanvases.contourColors[d].colors.push("rgba(0,0,0,1)");break;case"perspectiveContourLims":a.cps.vals.perspectives[c].signalCanvases.contourLims.push({ssffTrackName:"",minContourIdx:0,maxContourIdx:1});break;case"perspectiveOrderSignal":a.cps.vals.perspectives[c].signalCanvases.order.push(d);break;case"perspectiveOrderLevel":a.cps.vals.perspectives[c].levelCanvases.order.push(d);break;case"perspectiveOrderTwoDim":a.cps.vals.perspectives[c].twoDimCanvases.order.push(d)}},a.deleteDefinition=function(b,c,d,e){switch(b){case"level":a.cps.curDbConfig.levelDefinitions.splice(c,1);break;case"levelattribute":a.cps.curDbConfig.levelDefinitions[c].attributeDefinitions.splice(d,1);break;case"link":a.cps.curDbConfig.linkDefinitions.splice(c,1);break;case"ssff":a.cps.curDbConfig.ssffTrackDefinitions.splice(c,1);break;case"perspective":a.cps.vals.perspectives.splice(c,1);break;case"perspectiveAssign":a.cps.vals.perspectives[c].signalCanvases.assign.splice(d,1);break;case"perspectiveContourColor":a.cps.vals.perspectives[c].signalCanvases.contourColors.splice(d,1);break;case"perspectiveContourColorColor":a.cps.vals.perspectives[c].signalCanvases.contourColors[d].colors.splice(e,1);break;case"perspectiveContourLims":a.cps.vals.perspectives[c].signalCanvases.contourLims.splice(d,1);break;case"perspectiveOrderSignal":a.cps.vals.perspectives[c].signalCanvases.order.splice(d,1);break;case"perspectiveOrderLevel":a.cps.vals.perspectives[c].levelCanvases.order.splice(d,1);break;case"perspectiveOrderTwoDim":a.cps.vals.perspectives[c].twoDimCanvases.order.splice(d,1)}},a.setup()}]),angular.module("emuwebApp").controller("TabbedHelpCtrl",["$scope","ConfigProviderService","Iohandlerservice",function(a,b,c){a.cps=b,a.tree=[],c.httpGetPath("manual/index.json").then(function(b){a.tree=b.data,console.log(a.tree),a.onClickTab(a.tree[0]),a.tree[0].expanded=!0}),a.onClickTab=function(b){b.expanded=!b.expanded,b.url!==!1&&("md"===b.url.substr(b.url.lastIndexOf(".")+1).toLowerCase()?(a.isMDFile=!0,a.currentTabUrl=b.url):(a.isMDFile=!1,a.currentTabUrl=b.url))},a.hasChildren=function(a){return void 0!==a.nodes&&a.nodes.length>0?!0:!1}}]),angular.module("emuwebApp").service("HierarchyManipulationService",["$q","HierarchyLayoutService","DataService","LevelService","ConfigProviderService","ArrayHelperService",function(a,b,c,d,e){var f={};return f.addLink=function(a,b,d){var e=f.checkLinkValidity(a,b,d);if(e.valid){var g={fromID:b,toID:d};return c.insertLinkData(g),g}if(console.debug("Not adding invalid link:",b,"->",d," (Error code:",e.reason,")"),3===e.reason){if(e=f.checkLinkValidity(a,d,b),e.valid){console.debug("Adding reverse link instead");var g={fromID:d,toID:b};return c.insertLinkData(g),g}return null}return null},f.checkLinkValidity=function(a,f,g){var h={valid:!0,reason:0},i=c.getLinkData();if(f===g)return h.valid=!1,h.reason=1,h;for(var j=0;j<i.length;++j)if(i[j].fromID===f&&i[j].toID===g)return h.valid=!1,h.reason=2,h;var k=d.getLevelNameByElementID(f),l=d.getLevelNameByElementID(g),m=a.indexOf(k);if(a[m-1]!==l)return h.valid=!1,h.reason=3,h;for(var n,j=0;j<e.curDbConfig.linkDefinitions.length;++j)e.curDbConfig.linkDefinitions[j].sublevelName===l&&e.curDbConfig.linkDefinitions[j].superlevelName===k&&(n=e.curDbConfig.linkDefinitions[j].type);if(void 0===n)return consle.debug("LIKELY A BUG: link to be added (",f,"->",g,") has been found to be a part of the currently selected path but the link between the respective levels could not be found."),h.valid=!1,h.reason=3,h;if("ONE_TO_MANY"===n||"ONE_TO_ONE"===n){var o=d.getItemByID(g);if(o._parents.length>0)return h.valid=!1,h.reason=4,h}if("ONE_TO_ONE"===n){var p=d.getItemByID(f),q=b.findChildren(p,a);if(q.length>0)return h.valid=!1,h.reason=4,h}for(var r,s=void 0,t=void 0,u=d.getLevelAndItem(f).level,v=d.getLevelAndItem(g).level,w=d.getOrderById(k,f),x=d.getOrderById(l,g),y=0;void 0===s;){if(y-=1,r=u.items[w+y],void 0===r){s=0;break}console.debug("found preceding sibling",r.id,r.labels[0]);for(var q=b.findChildren(r,a),j=0;j<q.length;++j){var z=d.getOrderById(l,q[j].id);(void 0===s||z>s)&&(s=z)}}for(y=0;void 0===t;){if(y+=1,r=u.items[w+y],void 0===r){t=v.items.length-1;break}console.debug("found successive sibling",r.id,r.labels[0]);var q=b.findChildren(r,a);if(0!==q.length)for(var j=0;j<q.length;++j){var z=d.getOrderById(l,q[j].id);(void 0===t||t>z)&&(t=z)}}return console.debug("child must be within",s,t),s>x||x>t?(h.valid=!1,h.reason=5,h):h},f}]),angular.module("emuwebApp").service("StandardFuncsService",function(){var a={};return a.traverseAndClean=function(b){for(var c in b)"_"===c.substr(0,1)&&delete b[c],null!==b[c]&&"object"==typeof b[c]&&a.traverseAndClean(b[c])},a.reverseCopy=function(a){var b=angular.copy(a);return b.reverse(),b},a}),angular.module("emuwebApp").filter("startFrom",function(){return function(a,b){return b=+b,a.slice(b)}}),angular.module("emuwebApp").controller("ManualCtrl",["$scope","ConfigProviderService",function(a,b){a.listOfMarkdownFiles=[{title:"Introduction",url:"manual/Introduction.md"},{title:"EMU-webApp-websocket-protocol",url:"manual/EMU-webApp-websocket-protocol.md"},{title:"Labeling articulatory data",url:"manual/Labeling-articulatory-data.md"}],a.curMdFile=a.listOfMarkdownFiles[0],a.setCurrentMdFile=function(b){a.curMdFile=b},a.isCurrentMdFile=function(c){return console.log(c),console.log(a.curMdFile.url),c===a.curMdFile.url?{"background-color":b.design.color.white,color:b.design.color.black,"font-weight":"500"}:{"background-color":b.design.color.blue,color:b.design.color.white,"font-weight":"400"}}}]);