"use strict";function wavParserWorker(a){a=a||window.Worker,this.url=this.getWorkerURL(),this.worker=new a(this.url)}function espsParserWorker(a){a=a||window.Worker,this.url=this.getWorkerURL(),this.worker=new a(this.url)}function textGridParserWorker(a){a=a||window.Worker,this.url=this.getWorkerURL(),this.worker=new a(this.url)}function spectroDrawingWorker(a){a=a||window.Worker,this.url=this.getWorkerURL(),this.worker=new a(this.url)}function ssffParserWorker(a){a=a||window.Worker,this.url=this.getWorkerURL(),this.worker=new a(this.url)}ArrayBuffer.prototype.subarray=function(a,b){for(var c=new ArrayBuffer(b),d=new Int8Array(c),e=new Int8Array(this),f=0;b>f;f++)d[f]=e[a+f];return c},angular.module("emuwebApp",["ui","ui.sortable","ngAnimate","angular.filter"]).config(["$locationProvider",function(a){a.html5Mode(!0)}]),angular.module("emuwebApp").service("ConfigProviderService",["viewState",function(a){var b={};return b.vals={},b.curDbConfig={},b.embeddedVals={audioGetUrl:"",labelGetUrl:"",labelType:"",fromUrlParams:!1},b.setVals=function(a){$.isEmptyObject(b.vals)?b.vals=a:angular.forEach(Object.keys(a),function(c){angular.isArray(b.vals[c])?(b.vals[c]=[],angular.forEach(a[c],function(a){b.vals[c].push(a)})):angular.forEach(Object.keys(a[c]),function(d){void 0!==b.vals[c][d]?b.vals[c][d]=a[c][d]:console.error("BAD ENTRY IN CONFIG! Key1: "+c+" key2: "+d)})})},b.getSsffTrackConfig=function(a){var c;return void 0!==b.curDbConfig.ssffTrackDefinitions&&angular.forEach(b.curDbConfig.ssffTrackDefinitions,function(b){b.name===a&&(c=b)}),c},b.getLimsOfTrack=function(c){var d={};return angular.forEach(b.vals.perspectives[a.curPerspectiveIdx].signalCanvases.contourLims,function(a){a.ssffTrackName===c&&(d=a)}),d},b.getContourColorsOfTrack=function(c){var d;return angular.forEach(b.vals.perspectives[a.curPerspectiveIdx].signalCanvases.contourColors,function(a){a.ssffTrackName===c&&(d=a)}),d},b.getAssignment=function(c){var d={};return angular.forEach(b.vals.perspectives[a.curPerspectiveIdx].signalCanvases.assign,function(a){a.signalCanvasName===c&&(d=a)}),d},b.getLevelDefinition=function(a){var c={};return angular.forEach(b.curDbConfig.levelDefinitions,function(b){b.name===a&&(c=b)}),c},b.setPerspectivesOrder=function(a,c){void 0!==b.vals&&void 0!==b.vals.perspectives&&void 0!==b.vals.perspectives[a]&&void 0!==b.vals.perspectives[a].levelCanvases&&(b.vals.perspectives[a].levelCanvases.order=c)},b.getStrRep=function(a){var b;switch(a){case 8:b="BACKSPACE";break;case 9:b="TAB";break;case 13:b="ENTER";break;case 16:b="SHIFT";break;case 18:b="ALT";break;case 32:b="SPACE";break;case 37:b="←";break;case 39:b="→";break;case 38:b="↑";break;case 40:b="↓";break;case 42:b="+";break;case 43:b="+";break;case 45:b="-";break;case 95:b="-";break;default:b=String.fromCharCode(a)}return b},b}]),angular.module("emuwebApp").controller("MainController",["$scope","$rootScope","$log","$compile","$timeout","$q","$window","$document","$location","viewState","HistoryService","Iohandlerservice","Soundhandlerservice","ConfigProviderService","fontScaleService","Ssffdataservice","LevelService","Textgridparserservice","Espsparserservice","Binarydatamaniphelper","Wavparserservice","Ssffparserservice","Drawhelperservice","Validationservice","Appcachehandler","loadedMetaDataService","dbObjLoadSaveService","appStateService","DataService","modalService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D){a.cps=n,a.hists=k,a.fontImage=o,a.levServ=q,a.dataServ=C,a.vs=j,a.ssffds=p,a.shs=m,a.dhs=w,a.wps=u,a.io=l,a.ach=y,a.lmds=z,a.connectBtnLabel="connect",a.tmp={},a.dbLoaded=!1,a.is2dCancasesHidden=!0,a.windowWidth=g.outerWidth,a.ach.checkForNewVersion(),angular.element(g).bind("resize",function(){q.deleteEditArea(),j.setWindowWidth(g.outerWidth),a.$digest()}),angular.element(g).bind("keyup",function(b){(b.keyCode===n.vals.keyMappings.shift||b.keyCode===n.vals.keyMappings.alt)&&(k.addCurChangeObjToUndoStack(),a.$digest())}),window.onbeforeunload=function(){return""===n.embeddedVals.audioGetUrl&&z.getBundleList().length>0&&!n.vals.main.autoConnect?"Do you really wish to leave/reload the EMU-webApp? All unsaved changes will be lost...":void 0},a.$on("connectionDisrupted",function(){B.resetToInitState()}),a.$on("resetToInitState",function(){a.loadDefaultConfig()});var E=i.search();E.audioGetUrl&&E.labelGetUrl&&E.labelType&&(n.embeddedVals.audioGetUrl=E.audioGetUrl,n.embeddedVals.labelGetUrl=E.labelGetUrl,n.embeddedVals.labelType=E.labelType,n.embeddedVals.fromUrlParams=!0),a.loadFilesForEmbeddedApp=function(){n.embeddedVals.audioGetUrl&&(n.vals.activeButtons.openDemoDB=!1,l.httpGetPath(n.embeddedVals.audioGetUrl,"arraybuffer").then(function(a){j.showDropZone=!1;var b=n.embeddedVals.audioGetUrl;z.setCurBndlName(b.substr(0,b.lastIndexOf(".")).substr(b.lastIndexOf("/")+1,b.length)),j.getsubmenuOpen()&&j.togglesubmenuOpen(n.vals.colors.transitionTime),j.somethingInProgressTxt="Loading DB config...",l.httpGetPath("configFiles/embedded_emuwebappConfig.json").then(function(b){j.curPerspectiveIdx=0,n.setVals(b.data.EMUwebAppConfig),delete b.data.EMUwebAppConfig;var c=x.validateJSO("emuwebappConfigSchema",n.vals);c===!0?(n.embeddedVals.fromUrlParams&&(n.vals.main.catchMouseForKeyBinding=!1),n.curDbConfig=b.data,c=x.validateJSO("DBconfigFileSchema",n.curDbConfig),c===!0?(j.somethingInProgress=!0,j.somethingInProgressTxt="Parsing WAV file...",u.parseWavArrBuf(a.data).then(function(a){var b=a;j.curViewPort.sS=0,j.curViewPort.eS=b.Data.length,j.resetSelect(),m.wavJSO=b,l.httpGetPath(n.embeddedVals.labelGetUrl,"utf-8").then(function(a){j.somethingInProgressTxt="Parsing "+n.embeddedVals.labelType+" file...",l.parseLabelFile(a.data,n.embeddedVals.labelGetUrl,"embeddedTextGrid",n.embeddedVals.labelType).then(function(a){var b=a;C.setData(b);var c=[],d=[];b.levels.forEach(function(a){c.push(a.name),d.push({name:a.name,type:a.type,attributeDefinitions:{name:a.name,type:"string"}})}),n.curDbConfig.levelDefinitions=d,j.setCurLevelAttrDefs(n.curDbConfig.levelDefinitions),n.vals.perspectives[j.curPerspectiveIdx].levelCanvases.order=c,j.somethingInProgressTxt="Done!",j.somethingInProgress=!1,j.setState("labeling")},function(a){D.open("views/error.html","Error parsing wav file: "+a.status.message)})},function(a){D.open("views/error.html","Could not get label file: "+n.embeddedVals.labelGetUrl+" ERROR "+JSON.stringify(a,null,4))})},function(a){D.open("views/error.html","Error parsing wav file: "+a.status.message)})):D.open("views/error.html","Error validating DBconfig: "+JSON.stringify(c,null,4))):D.open("views/error.html","Error validating ConfigProviderService.vals (emuwebappConfig data) after applying changes of newly loaded config (most likely due to wrong entry...): "+JSON.stringify(c,null,4))},function(a){D.open("views/error.html","Could not get embedded_config.json: "+a)})},function(a){D.open("views/error.html","Could not get audio file:"+n.embeddedVals.audioGetUrl+" ERROR: "+JSON.stringify(a,null,4))}))},a.loadDefaultConfig=function(){j.somethingInProgress=!0,j.somethingInProgressTxt="Loading schema files",x.loadSchemas().then(function(b){x.setSchemas(b),l.httpGetDefaultConfig().success(function(b){j.somethingInProgressTxt="Validating emuwebappConfig";var c=x.validateJSO("emuwebappConfigSchema",b);c===!0?(n.setVals(b),a.handleDefaultConfigLoaded(),a.loadFilesForEmbeddedApp(),j.somethingInProgress=!1):D.open("views/error.html","Error validating emuwebappConfigSchema: "+JSON.stringify(c,null,4)).then(function(){B.resetToInitState()})}).error(function(a,b,c,d){D.open("views/error.html","Could not get defaultConfig for EMU-webApp:  status: "+b+" header: "+c+" config "+d).then(function(){B.resetToInitState()})})},function(a){D.open("views/error.html","Error loading schema file: "+JSON.stringify(a,null,4)).then(function(){B.resetToInitState()})})},a.loadDefaultConfig(),a.getCurBndlName=function(){return z.getCurBndlName()},a.handleDefaultConfigLoaded=function(){j.getsubmenuOpen()||j.togglesubmenuOpen(n.vals.colors.transitionTime),n.vals.main.autoConnect&&l.wsH.initConnect(n.vals.main.serverUrl).then(function(b){"error"===b.type?D.open("views/error.html","Could not connect to websocket server: "+n.vals.main.serverUrl):a.handleConnectedToWSserver()}),j.setspectroSettings(n.vals.spectrogramSettings.windowSizeInSecs,n.vals.spectrogramSettings.rangeFrom,n.vals.spectrogramSettings.rangeTo,n.vals.spectrogramSettings.dynamicRange,n.vals.spectrogramSettings.window,n.vals.spectrogramSettings.drawHeatMapColors,n.vals.spectrogramSettings.preEmphasisFilterFactor,n.vals.spectrogramSettings.heatMapColorAnchors),j.setTransitionTime(n.vals.colors.transitionTime/1e3)},a.handleConnectedToWSserver=function(){j.showDropZone=!1,n.vals.main.comMode="WS",n.vals.activeButtons.openDemoDB=!1,j.somethingInProgress=!0,j.somethingInProgressTxt="Checking protocol...",l.getProtocol().then(function(b){"EMU-webApp-websocket-protocol"===b.protocol&&"0.0.1"===b.version?(j.somethingInProgressTxt="Checking user management...",l.getDoUserManagement().then(function(b){"NO"===b?a.innerHandleConnectedToWSserver():D.open("views/loginModal.html").then(function(b){b?a.innerHandleConnectedToWSserver():B.resetToInitState()})})):D.open("views/error.html","Could not connect to websocket server: "+n.vals.main.serverUrl+'. It does not speak the same protocol as this client. Its protocol answer was: "'+b.protocol+'" with the version: "'+b.version+'"').then(function(){B.resetToInitState()})})},a.innerHandleConnectedToWSserver=function(){j.somethingInProgressTxt="Loading DB config...",l.getDBconfigFile().then(function(a){j.curPerspectiveIdx=0,n.setVals(a.EMUwebAppConfig),delete a.EMUwebAppConfig;var b=x.validateJSO("emuwebappConfigSchema",n.vals);b===!0?(n.curDbConfig=a,j.setCurLevelAttrDefs(n.curDbConfig.levelDefinitions),b=x.validateJSO("DBconfigFileSchema",a),b===!0?(j.somethingInProgressTxt="Loading bundle list...",l.getBundleList().then(function(a){b=z.setBundleList(a),b===!0?A.loadBundle(z.getBundleList()[0]):D.open("views/error.html","Error validating bundleList: "+JSON.stringify(b,null,4)).then(function(){B.resetToInitState()})})):D.open("views/error.html","Error validating DBconfig: "+JSON.stringify(b,null,4)).then(function(){B.resetToInitState()})):D.open("views/error.html","Error validating ConfigProviderService.vals (emuwebappConfig data) after applying changes of newly loaded config (most likely due to wrong entry...): "+JSON.stringify(b,null,4)).then(function(){B.resetToInitState()})})},a.toggleCollapseSession=function(b){a.uniqSessionList[b].collapsed=!a.uniqSessionList[b].collapsed},a.getEnlarge=function(a){var b=n.vals.perspectives[j.curPerspectiveIdx].signalCanvases.order.length,c=50;return-1==j.getenlarge()?"auto":1===b?"auto":2===b?j.getenlarge()==a?"70%":"27%":j.getenlarge()==a?c+"%":(98-c)/(b-1)+"%"},a.cursorInTextField=function(){j.setcursorInTextField(!0)},a.cursorOutOfTextField=function(){j.setcursorInTextField(!1)},a.openSubmenu=function(){j.togglesubmenuOpen(n.vals.colors.transitionTime)},a.addLevelSegBtnClick=function(){if(j.getPermission("addLevelSegBtnClick")){var a=0;void 0!==C.data.levels&&(a=C.data.levels.length);var b="levelNr"+a,c={items:[{id:C.getNewId(),sampleStart:0,sampleDur:m.wavJSO.Data.length,labels:[{name:b,value:n.vals.labelCanvasConfig.newSegmentName}]}],name:b,type:"SEGMENT"};if(void 0===j.getCurAttrDef(b)){var d={name:b,type:"EVENT",attributeDefinitions:{name:b,type:"string"}};j.setCurLevelAttrDefs(d)}q.insertLevel(c,a,j.curPerspectiveIdx),k.addObjToUndoStack({type:"ANNOT",action:"INSERTLEVEL",level:c,id:a,curPerspectiveIdx:j.curPerspectiveIdx})}},a.addLevelPointBtnClick=function(){if(j.getPermission("addLevelPointBtnClick")){var a=0;void 0!==C.data.levels&&(a=C.data.levels.length);var b="levelNr"+a,c={items:[{id:C.getNewId(),samplePoint:Math.round(m.wavJSO.Data.length/2),labels:[]}],name:b,type:"EVENT"};if(c.items[0].labels.push({name:b,value:n.vals.labelCanvasConfig.newEventName}),void 0===j.getCurAttrDef(b)){var d={name:b,type:"EVENT",attributeDefinitions:{name:b,type:"string"}};j.setCurLevelAttrDefs(d)}q.insertLevel(c,a,j.curPerspectiveIdx),k.addObjToUndoStack({type:"ANNOT",action:"INSERTLEVEL",level:c,id:a,curPerspectiveIdx:j.curPerspectiveIdx})}},a.renameSelLevelBtnClick=function(){j.getPermission("renameSelLevelBtnClick")&&(void 0!==j.getcurClickLevelName()?D.open("views/renameLevel.html",j.getcurClickLevelName()):D.open("views/error.html","Rename Error : Please choose a Level first !"))},a.downloadTextGridBtnClick=function(){j.getPermission("downloadTextGridBtnClick")&&r.asyncToTextGrid().then(function(a){D.open("views/export.html",z.getCurBndl().name+".TextGrid",a)})},a.downloadAnnotationBtnClick=function(){j.getPermission("downloadAnnotationBtnClick")&&D.open("views/export.html",z.getCurBndl().name+"_annot.json",angular.toJson(C.getData(),!0))},a.spectSettingsBtnClick=function(){j.getPermission("spectSettingsChange")&&D.open("views/spectSettings.html")},a.connectBtnClick=function(){j.getPermission("connectBtnClick")&&D.open("views/connectModal.html").then(function(b){b&&l.wsH.initConnect(b).then(function(c){"error"===c.type?D.open("views/error.html","Could not connect to websocket server: "+b):a.handleConnectedToWSserver()})})},a.openDemoDBbtnClick=function(a){j.getPermission("openDemoBtnDBclick")&&(n.vals.activeButtons.openDemoDB=!1,z.setDemoDbName(a),j.showDropZone=!1,j.somethingInProgress=!0,j.setState("loadingSaving"),n.vals.main.comMode="DEMO",j.somethingInProgressTxt="Loading DB config...",l.getDBconfigFile(a).then(function(b){var c=b.data;j.curPerspectiveIdx=0,n.setVals(c.EMUwebAppConfig),delete c.EMUwebAppConfig;var d=x.validateJSO("emuwebappConfigSchema",n.vals);d===!0?(n.curDbConfig=c,j.setCurLevelAttrDefs(n.curDbConfig.levelDefinitions),d=x.validateJSO("DBconfigFileSchema",n.curDbConfig),d===!0?(j.somethingInProgressTxt="Loading bundle list...",l.getBundleList(a).then(function(a){var b=a.data;z.setBundleList(b),A.loadBundle(z.getBundleList()[0])},function(b){D.open("views/error.html","Error loading bundle list of "+a+": "+b.data+" STATUS: "+b.status).then(function(){B.resetToInitState()})})):D.open("views/error.html","Error validating DBconfig: "+JSON.stringify(d,null,4)).then(function(){B.resetToInitState()})):D.open("views/error.html","Error validating ConfigProviderService.vals (emuwebappConfig data) after applying changes of newly loaded config (most likely due to wrong entry...): "+JSON.stringify(d,null,4)).then(function(){B.resetToInitState()})},function(b){D.open("views/error.html","Error loading DB config of "+a+": "+b.data+" STATUS: "+b.status).then(function(){B.resetToInitState()})}))},a.aboutBtnClick=function(){D.open("views/about.html")},a.showHierarchyBtnClick=function(){j.hierarchyShown||(j.toggleHierarchy(),D.open("views/showHierarchyModal.html"))},a.showEditDBconfigBtnClick=function(){var b=a.cps.curDbConfig,c=a.cps.vals;D.open("views/editDBconfigModal.html").then(function(d){d?console.log(angular.toJson({dbconfig:a.cps.curDbConfig,vals:a.cps.vals})):(a.cps.curDbConfig=b,a.cps.vals=c)})},a.clearBtnClick=function(){var a;a=0!==k.movesAwayFromLastSave&&"DEMO"!==n.vals.main.comMode?"Do you wish to clear all loaded data and if connected disconnect from the server? CAUTION: YOU HAVE UNSAVED CHANGES! These will be lost if you confirm.":"Do you wish to clear all loaded data and if connected disconnect from the server? You have NO unsaved changes so no changes will be lost.",D.open("views/confirmModal.html",a).then(function(a){a&&B.resetToInitState()})},a.cmdZoomAll=function(){j.getPermission("zoom")&&(q.deleteEditArea(),j.setViewPort(0,m.wavJSO.Data.length))},a.cmdZoomIn=function(){j.getPermission("zoom")&&(q.deleteEditArea(),j.zoomViewPort(!0))},a.cmdZoomOut=function(){j.getPermission("zoom")&&(q.deleteEditArea(),j.zoomViewPort(!1))},a.cmdZoomLeft=function(){j.getPermission("zoom")&&(q.deleteEditArea(),j.shiftViewPort(!1))},a.cmdZoomRight=function(){j.getPermission("zoom")&&(q.deleteEditArea(),j.shiftViewPort(!0))},a.cmdZoomSel=function(){j.getPermission("zoom")&&(q.deleteEditArea(),j.setViewPort(j.curViewPort.selectS,j.curViewPort.selectE))},a.cmdPlayView=function(){j.getPermission("playaudio")&&(m.playFromTo(j.curViewPort.sS,j.curViewPort.eS),j.animatePlayHead(j.curViewPort.sS,j.curViewPort.eS))},a.cmdPlaySel=function(){j.getPermission("playaudio")&&(m.playFromTo(j.curViewPort.selectS,j.curViewPort.selectE),j.animatePlayHead(j.curViewPort.selectS,j.curViewPort.selectE))},a.cmdPlayAll=function(){j.getPermission("playaudio")&&(m.playFromTo(0,m.wavJSO.Data.length),j.animatePlayHead(0,m.wavJSO.Data.length))},a.changePerspective=function(a){for(var b,c=0;c<n.vals.perspectives.length;c++)a.name===n.vals.perspectives[c].name&&(b=c);j.curPerspectiveIdx=b,j.setRightsubmenuOpen(!j.getRightsubmenuOpen())},a.getPerspectiveColor=function(a){var b;return b=-1===j.curPerspectiveIdx||a.name===n.vals.perspectives[j.curPerspectiveIdx].name?"emuwebapp-curSelPerspLi":"emuwebapp-perspLi"}}]),angular.module("emuwebApp").directive("level",["$timeout","$animate","viewState","ConfigProviderService","Drawhelperservice","HistoryService","fontScaleService","modalService","LevelService",function(a,b,c,d,e,f,g,h,i){return{templateUrl:"views/level.html",restrict:"E",scope:{level:"=",idx:"="},link:function(j,k,l){var m=k.find("canvas");j.open=l.open,j.vs=c,j.hists=f,j.cps=d,j.modal=h;var n=k.find("div");j.levelDef=d.getLevelDefinition(j.level.name),j.backgroundCanvas={background:d.vals.colors.levelColor},j.$watch("vs.submenuOpen",function(){a(j.redraw,j.cps.vals.colors.transitionTime)}),j.$watch("vs.curViewPort",function(a,b){b.sS!==a.sS||b.eS!==a.eS||b.windowWidth!==a.windowWidth?(j.drawLevelDetails(),j.drawLevelMarkup()):j.drawLevelMarkup()},!0),j.$watch("vs.curMouseX",function(){j.vs.getcurMouseLevelName()===j.level.name&&(j.drawLevelDetails(),j.drawLevelMarkup())},!0),j.$watch("vs.curClickLevelName",function(a){void 0!==a&&j.drawLevelMarkup()},!0),j.$watch("vs.movingBoundarySample",function(){j.drawLevelDetails(),j.drawLevelMarkup()},!0),j.$watch("vs.movingBoundary",function(){j.drawLevelMarkup()},!0),j.$watch("hists.movesAwayFromLastSave",function(){j.drawLevelDetails(),j.drawLevelMarkup()},!0),j.redraw=function(){j.drawLevelDetails(),j.drawLevelMarkup()},j.changeCurAttrDef=function(a,c){var d=j.vs.getCurAttrDef(j.level.name);d!==a&&(j.vs.setCurAttrDef(j.level.name,a,c),k.hasClass("emuwebapp-levelCanvasContainer-animate")||(j.vs.setEditing(!1),i.deleteEditArea(),b.addClass(n,"emuwebapp-levelCanvasContainer-animate").then(function(){b.removeClass(n,"emuwebapp-levelCanvasContainer-animate"),j.drawLevelDetails(),j.drawLevelMarkup()})))},j.getAttrDefBtnColor=function(a){var b,c=j.vs.getCurAttrDef(j.level.name);return b=a===c?{background:"-webkit-radial-gradient(50% 50%, closest-corner, rgba(0, 0, 0, 1), rgba(0, 0, 0, 0) 60%)"}:{"background-color":"white"}},j.updateView=function(){$.isEmptyObject(j.cps)||j.drawLevelDetails()},k.bind("mouseleave",function(){j.vs.setcurMouseItem(void 0,void 0,void 0),j.drawLevelMarkup()}),j.drawLevelDetails=function(){var a=j.cps.vals.font.fontPxSize,b=j.vs.getCurAttrDef(j.level.name);if($.isEmptyObject(j.level))return void console.log("undef levelDetails");if($.isEmptyObject(j.vs))return void console.log("undef viewState");if($.isEmptyObject(j.cps))return void console.log("undef config");j.open||(a-=1);var c=m[0].getContext("2d");c.clearRect(0,0,m[0].width,m[0].height);var d,e,f,h;d=j.vs.getSampleDist(m[0].width);var i=c.canvas.height/c.canvas.offsetHeight;h=j.level.name===b?g.getTextImageTwoLines(c,j.level.name,"("+j.level.type+")",a,j.cps.vals.font.fontType,j.cps.vals.colors.labelColor,!0):g.getTextImageTwoLines(c,j.level.name+":"+b,"("+j.level.type+")",a,j.cps.vals.font.fontType,j.cps.vals.colors.labelColor,!0),c.drawImage(h,0,c.canvas.height/2-a*i);var k=(j.vs.getcurMouseItem(),j.vs.getcurClickItems(),j.vs.getcurClickLevelName(),-1),l=(g.getTextImage(c,"m",a-2,j.cps.vals.font.fontType,j.cps.vals.colors.labelColor),g.getLastImageWidth()),n=(g.getTextImage(c,"0",a-4,j.cps.vals.font.fontType,j.cps.vals.colors.endBoundaryColor),g.getLastImageWidth());if("SEGMENT"===j.level.type){c.fillStyle=j.cps.vals.colors.startBoundaryColor;var o=j.level.items;o.forEach(function(d){if(++k,d.sampleStart>=j.vs.curViewPort.sS&&d.sampleStart<=j.vs.curViewPort.eS||d.sampleStart+d.sampleDur>j.vs.curViewPort.sS&&d.sampleStart+d.sampleDur<j.vs.curViewPort.eS||d.sampleStart<j.vs.curViewPort.sS&&d.sampleStart+d.sampleDur>j.vs.curViewPort.eS){var i;if(d.labels.forEach(function(a){a.name===b&&(i=a.value)}),e=j.vs.getPos(m[0].width,d.sampleStart),f=j.vs.getPos(m[0].width,d.sampleStart+d.sampleDur+1),c.fillStyle=j.cps.vals.colors.startBoundaryColor,c.fillRect(e,0,2,m[0].height/2),c.fillStyle=j.cps.vals.colors.endBoundaryColor,c.fillRect(f,m[0].height/2,2,m[0].height),void 0!==i&&f-e>l*i.length){h=g.getTextImage(c,i,a-2,j.cps.vals.font.fontType,j.cps.vals.colors.labelColor);var o=g.getLastImageWidth(),p=e+(f-e)/2-o/2;j.open?c.drawImage(h,0,0,h.width,h.height,p,m[0].height/2-(a-2),h.width,h.height):c.drawImage(h,0,0,h.width,h.height,p,0,h.width,h.height)}if(j.open&&void 0!==i&&0!==i.length){var q=e+(f-e)/2,r=m[0].height/4;c.strokeStyle=j.cps.vals.colors.startBoundaryColor,c.beginPath(),c.moveTo(e,r),c.lineTo(q,r),c.lineTo(q,r+5),c.stroke(),r=m[0].height/4*3,c.strokeStyle=j.cps.vals.colors.endBoundaryColor,c.beginPath(),c.moveTo(f,r),c.lineTo(q,r),c.lineTo(q,r-5),c.stroke()}if(f-e>n*d.sampleStart.toString().length){var s=g.getTextImage(c,d.sampleStart,a-4,j.cps.vals.font.fontType,j.cps.vals.colors.endBoundaryColor);c.drawImage(s,0,0,h.width,h.height,e+3,0,h.width,h.height)}if(f-e>n*(5+d.sampleDur.toString().length)){var t=g.getTextImage(c,"dur: "+d.sampleDur,a-4,j.cps.vals.font.fontType,j.cps.vals.colors.endBoundaryColor),u=g.getLastImageWidth();c.drawImage(t,0,0,h.width,h.height,f-u,m[0].height/4*3,h.width,h.height)}}})}else if("EVENT"===j.level.type){c.fillStyle=j.cps.vals.colors.startBoundaryColor;var p;j.level.items.forEach(function(e){if(e.samplePoint>j.vs.curViewPort.sS&&e.samplePoint<j.vs.curViewPort.eS){p=Math.round(j.vs.getPos(m[0].width,e.samplePoint)+d/2);var f;e.labels.forEach(function(a){a.name===b&&(f=a.value)}),c.fillStyle=j.cps.vals.colors.startBoundaryColor,c.fillRect(p,0,1,m[0].height/2-m[0].height/10),c.fillRect(p,m[0].height/2+m[0].height/10,1,m[0].height/2-m[0].height/10),h=g.getTextImage(c,f,a-2,j.cps.vals.font.fontType,j.cps.vals.colors.labelColor),c.drawImage(h,0,0,h.width,h.height,p-5,m[0].height/3,h.width,h.height),h=g.getTextImage(c,e.samplePoint,a-4,j.cps.vals.font.fontType,j.cps.vals.colors.endBoundaryColor),c.drawImage(h,0,0,h.width,h.height,p+5,0,h.width,h.height)}})}},j.drawLevelMarkup=function(){var a=m[1].getContext("2d");a.clearRect(0,0,m[1].width,m[1].height),j.level.name===j.vs.getcurClickLevelName()&&(a.fillStyle=j.cps.vals.colors.selectedLevelColor,a.fillRect(0,0,m[0].width,m[0].height)),e.drawMovingBoundaryLine(a),e.drawCurViewPortSelected(a);var b,c,d,f,g;b=j.vs.getPos(m[1].width,j.vs.curViewPort.selectS),c=j.vs.getPos(m[1].width,j.vs.curViewPort.selectE),d=j.vs.getSampleDist(m[1].width);var h=j.vs.getcurMouseItem(),i=j.vs.getcurMouseisFirst(),k=j.vs.getcurMouseisLast(),l=j.vs.getcurClickItems(),n=j.vs.getcurClickLevelName();void 0!==l&&j.level.name===n&&l.length>0&&l.forEach(function(e){void 0!==e&&(void 0!==e.sampleStart?(b=Math.round(j.vs.getPos(m[0].width,e.sampleStart)),c=Math.round(j.vs.getPos(m[0].width,e.sampleStart+e.sampleDur+1))):(b=Math.round(j.vs.getPos(m[0].width,e.samplePoint)+d/2),b-=5,c=b+10),a.fillStyle=j.cps.vals.colors.selectedSegmentColor,a.fillRect(b,0,c-b,m[0].height),a.fillStyle=j.cps.vals.colors.startBoundaryColor)}),g=j.vs.getcurMouseItem(),j.level.items.length>0&&void 0!==g&&void 0!==h&&j.level.name===j.vs.getcurMouseLevelName()&&(a.fillStyle=j.cps.vals.colors.selectedBoundaryColor,i===!0?"SEGMENT"===j.vs.getcurMouseLevelType()&&(g=j.level.items[0],b=Math.round(j.vs.getPos(m[1].width,g.sampleStart)),a.fillRect(b,0,3,m[1].height)):k===!0?"SEGMENT"===j.vs.getcurMouseLevelType()&&(g=j.level.items[j.level.items.length-1],b=Math.round(j.vs.getPos(m[1].width,g.sampleStart+g.sampleDur+1)),a.fillRect(b,0,3,m[1].height)):"SEGMENT"===j.vs.getcurMouseLevelType()?(b=Math.round(j.vs.getPos(m[1].width,g.sampleStart)),a.fillRect(b,0,3,m[1].height)):(b=Math.round(j.vs.getPos(m[1].width,g.samplePoint)),f=d/2,a.fillRect(b+f,0,3,m[1].height)),a.fillStyle=j.cps.vals.colors.startBoundaryColor)}}}}]),angular.module("emuwebApp").directive("osci",["$timeout","viewState","Soundhandlerservice","ConfigProviderService","Drawhelperservice",function(a,b,c,d,e){return{templateUrl:"views/osci.html",replace:!0,restrict:"E",scope:{},controller:["$scope",function(a){a.changeAttrDef=function(){}}],link:function(f,g,h){var i=g.find("canvas").length,j=g.find("canvas")[0],k=g.find("canvas")[i-1];f.order=h.order,f.trackName=h.trackName,f.cps=d,f.viewState=b,f.$watch("viewState.submenuOpen",function(){a(f.redraw,f.cps.vals.colors.transitionTime)}),f.$watch("viewState.timelineSize",function(){a(f.redraw,f.cps.vals.colors.transitionTime)}),f.$watch("viewState.curPerspectiveIdx",function(){f.drawVpOsciMarkup(f,d,!0)},!0),f.$watch("viewState.playHeadAnimationInfos",function(){$.isEmptyObject(c)||$.isEmptyObject(c.wavJSO)||f.drawPlayHead(f,d)},!0),f.$watch("viewState.movingBoundarySample",function(){$.isEmptyObject(c)||$.isEmptyObject(c.wavJSO)||f.drawVpOsciMarkup(f,d,!0)},!0),f.$watch("viewState.movingBoundary",function(){$.isEmptyObject(c)||$.isEmptyObject(c.wavJSO)||f.drawVpOsciMarkup(f,d,!0)},!0),f.$watch("viewState.curViewPort",function(a,g){if(!$.isEmptyObject(c)&&!$.isEmptyObject(c.wavJSO)){if(g.sS!==a.sS||g.eS!==a.eS){var h=e.calculatePeaks(b,j,c.wavJSO.Data);e.osciPeaks=h,e.freshRedrawDrawOsciOnCanvas(b,j,e.osciPeaks,c.wavJSO.Data,d)}f.drawVpOsciMarkup(f,d,!0)}},!0),f.redraw=function(){f.drawVpOsciMarkup(f,d,!0)},f.drawPlayHead=function(a,c){var e=k.getContext("2d");e.clearRect(0,0,j.width,j.height);var f=b.getPos(k.width,b.playHeadAnimationInfos.sS),g=b.getPos(k.width,b.playHeadAnimationInfos.curS);e.fillStyle=d.vals.colors.selectedAreaColor,e.fillRect(f,0,g-f,j.height),a.drawVpOsciMarkup(a,c,!1)},f.drawVpOsciMarkup=function(a,b,c){var d=k.getContext("2d");c&&d.clearRect(0,0,k.width,k.height),e.drawMovingBoundaryLine(d),e.drawViewPortTimes(d,!0),e.drawCurViewPortSelected(d,!0)}}}}]),angular.module("emuwebApp").directive("preview",["viewState","Soundhandlerservice","Drawhelperservice","ConfigProviderService",function(a,b,c,d){return{templateUrl:"views/preview.html",restrict:"E",scope:{currentBundleName:"@"},link:function(e,f){var g=f.find("canvas")[0],h=f.find("canvas")[1],i=!1;e.vs=a,e.shs=b,e.backgroundCanvas={background:"#eee",border:"1px solid gray",width:"100%",height:"100%"},e.$watch("vs.curViewPort",function(a,c){$.isEmptyObject(b.wavJSO)||(c.sS!==a.sS||c.eS!==a.eS)&&e.drawPreview()},!0),e.$watch("currentBundleName",function(){if($.isEmptyObject(b.wavJSO)||(i=!1,e.backgroundCanvas={background:d.vals.colors.levelColor,border:"1px solid gray",width:"100%",height:"100%"},e.drawPreview()),""===e.currentBundleName){var a=g.getContext("2d"),c=h.getContext("2d");a.clearRect(0,0,g.width,g.height),c.clearRect(0,0,g.width,g.height)}},!0),e.drawPreview=function(){if(i)e.drawVpOsciMarkup(a,g,d);else{var f=c.calculatePeaks(a,g,b.wavJSO.Data);c.osciPeaks=f,c.freshRedrawDrawOsciOnCanvas(a,g,c.osciPeaks,b.wavJSO.Data,d),i=!0,e.drawVpOsciMarkup(a,g,d)}},e.drawVpOsciMarkup=function(a,c,d){var e=h.getContext("2d"),f=h.width/b.wavJSO.Data.length*a.curViewPort.sS,g=h.width/b.wavJSO.Data.length*a.curViewPort.eS;e.clearRect(0,0,h.width,h.height),e.fillStyle=d.vals.colors.selectedAreaColor,e.fillRect(f,0,g-f,h.height),e.strokeStyle=d.vals.colors.selectedBorderColor,e.beginPath(),e.moveTo(f,0),e.lineTo(f,h.height),e.moveTo(g,0),e.lineTo(g,h.height),e.closePath(),e.stroke()}}}}]),angular.module("emuwebApp").directive("bundleListSideBar",["$animate",function(a){return{templateUrl:"views/bundleListSideBar.html",restrict:"E",replace:!0,scope:{isOpen:"@"},link:function(b,c,d){d.$observe("isOpen",function(b){"true"===b?(a.removeClass(c,"emuwebapp-shrinkWidthTo0px"),a.addClass(c,"emuwebapp-expandWidthTo240px")):a.addClass(c,"emuwebapp-shrinkWidthTo0px")})}}}]),angular.module("emuwebApp").directive("spectro",["$timeout","viewState","ConfigProviderService","Drawhelperservice","fontScaleService","Soundhandlerservice","mathHelperService",function(a,b,c,d,e,f,g){return{templateUrl:"views/spectro.html",restrict:"E",replace:!0,scope:{},link:function(h,i,j){h.shs=f,h.order=j.order,h.vs=b,h.cps=c,h.dhs=d,h.trackName=j.trackName,h.canvas0=i.find("canvas")[0],h.canvas1=i.find("canvas")[i.find("canvas").length-1],h.context=h.canvas0.getContext("2d"),h.markupCtx=h.canvas1.getContext("2d"),h.alpha=.16,h.devicePixelRatio=window.devicePixelRatio||1,h.primeWorker=new spectroDrawingWorker,h.$watch("vs.timelineSize",function(){$.isEmptyObject(h.shs)||$.isEmptyObject(h.shs.wavJSO)||a(h.clearAndDrawSpectMarkup,h.cps.vals.colors.transitionTime)}),h.$watch("vs.submenuOpen",function(){$.isEmptyObject(h.shs)||$.isEmptyObject(h.shs.wavJSO)||a(h.clearAndDrawSpectMarkup,h.cps.vals.colors.transitionTime)}),h.$watch("vs.curViewPort",function(a,b){$.isEmptyObject(h.shs)||$.isEmptyObject(h.shs.wavJSO)||((b.sS!==a.sS||b.eS!==a.eS)&&h.redraw(),h.clearAndDrawSpectMarkup())},!0),h.$watch("vs.movingBoundarySample",function(){$.isEmptyObject(h.shs)||$.isEmptyObject(h.shs.wavJSO)||h.clearAndDrawSpectMarkup()},!0),h.$watch("vs.movingBoundary",function(){$.isEmptyObject(h.shs)||$.isEmptyObject(h.shs.wavJSO)||h.clearAndDrawSpectMarkup()},!0),h.$watch("vs.spectroSettings",function(){$.isEmptyObject(h.shs)||$.isEmptyObject(h.shs.wavJSO)||(h.setupEvent(),h.redraw())},!0),h.redraw=function(){h.markupCtx.clearRect(0,0,h.canvas1.width,h.canvas1.height),h.drawSpectro(h.shs.wavJSO.Data)},h.drawSpectro=function(a){h.killSpectroRenderingThread(),h.startSpectroRenderingThread(a)},h.calcSamplesPerPxl=function(){return(h.vs.curViewPort.eS+1-h.vs.curViewPort.sS)/h.canvas0.width},h.clearAndDrawSpectMarkup=function(){h.markupCtx.clearRect(0,0,h.canvas1.width,h.canvas1.height),h.drawSpectMarkup()},h.drawSpectMarkup=function(){h.dhs.drawMovingBoundaryLine(h.markupCtx),h.dhs.drawCurViewPortSelected(h.markupCtx,!1),h.dhs.drawMinMaxAndName(h.markupCtx,"",h.vs.spectroSettings.rangeFrom,h.vs.spectroSettings.rangeTo,2)},h.killSpectroRenderingThread=function(){h.context.fillStyle=h.cps.vals.colors.levelColor,h.context.fillRect(0,0,h.canvas0.width,h.canvas0.height),h.dhs.drawCurViewPortSelected(h.markupCtx,!1);var a=e.getTextImage(h.context,"rendering...",.75*h.cps.vals.font.fontPxSize,h.cps.vals.font.fontType,h.cps.vals.colors.labelColor,!0);h.context.drawImage(a,10,50),null!==h.primeWorker&&(h.primeWorker.kill(),h.primeWorker=null)},h.setupEvent=function(){var a=h.context.createImageData(h.canvas0.width,h.canvas0.height);h.primeWorker.says(function(b){if(void 0===b.status){if(h.calcSamplesPerPxl()===b.samplesPerPxl){var c=new Uint8ClampedArray(b.img);a.data.set(c),h.context.putImageData(a,0,0),h.drawSpectMarkup()}}else console.error("Error rendering spectrogram:",b.status.message)})},h.startSpectroRenderingThread=function(a){if(a.length>0){h.primeWorker=new spectroDrawingWorker;var b,c=g.calcClosestPowerOf2Gt(h.shs.wavJSO.SampleRate*h.vs.spectroSettings.windowSizeInSecs);512>c&&(c=512),b=new Float32Array(h.vs.curViewPort.sS>=c/2?a.subarray(h.vs.curViewPort.sS-c/2,h.vs.curViewPort.eS+c):a.subarray(h.vs.curViewPort.sS,h.vs.curViewPort.eS+c)),h.setupEvent(),h.primeWorker.tell({windowSizeInSecs:h.vs.spectroSettings.windowSizeInSecs,fftN:c,alpha:h.alpha,upperFreq:h.vs.spectroSettings.rangeTo,lowerFreq:h.vs.spectroSettings.rangeFrom,samplesPerPxl:h.calcSamplesPerPxl(),window:h.vs.spectroSettings.window,imgWidth:h.canvas0.width,imgHeight:h.canvas0.height,dynRangeInDB:h.vs.spectroSettings.dynamicRange,pixelRatio:h.devicePixelRatio,sampleRate:h.shs.wavJSO.SampleRate,transparency:h.cps.vals.spectrogramSettings.transparency,audioBuffer:b.buffer,audioBufferChannels:h.shs.wavJSO.NumChannels,drawHeatMapColors:h.vs.spectroSettings.drawHeatMapColors,preEmphasisFilterFactor:h.vs.spectroSettings.preEmphasisFilterFactor,heatMapColorAnchors:h.vs.spectroSettings.heatMapColorAnchors},[b.buffer])
}}}}}]),angular.module("emuwebApp").controller("ExportCtrl",["$scope","modalService","browserDetector","viewState","HistoryService",function(a,b,c,d,e){a.firefox=c.isBrowser.Firefox(),a.getBlob=function(){var c;try{c=new Blob([b.dataExport],{type:"text/plain"})}catch(d){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,c=new BlobBuilder,c.append(a.exportData),c=c.getBlob()}return c},a.updateHistoryService=function(){e.movesAwayFromLastSave=0},a.cursorInTextField=function(){d.setEditing(!0),d.setcursorInTextField(!0)},a.cursorOutOfTextField=function(){d.setEditing(!1),d.setcursorInTextField(!1)},a.export=function(){var c;c="object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.createObjectURL(a.getBlob()):URL.createObjectURL(a.getBlob()),a.SaveToDisk(c,b.dataIn),b.close()},a.SaveToDisk=function(b,c){var d=document.createElement("a");if(a.firefox)d.setAttribute("download",c),d.href=b,d.innerHTML="",d.style.display="none",document.body.appendChild(d),d.click();else{d.href=b,d.target="_blank",d.download=c||"unknown";var e=document.createEvent("Event");e.initEvent("click",!0,!0),d.dispatchEvent(e),(window.URL||window.webkitURL).revokeObjectURL(d.href)}a.updateHistoryService()}}]),angular.module("emuwebApp").factory("viewState",["$rootScope","$timeout","$window","Soundhandlerservice",function(a,b,c,d){var e={},f={BARTLETT:1,BARTLETTHANN:2,BLACKMAN:3,COSINE:4,GAUSS:5,HAMMING:6,HANN:7,LANCZOS:8,RECTANGULAR:9,TRIANGULAR:10};return e.curLevelAttrDefs=[],e.initialize=function(){e.curViewPort={sS:0,eS:0,selectS:-1,selectE:-1,dragBarActive:!1,dragBarHeight:-1,windowWidth:void 0},e.spectroSettings={windowSizeInSecs:-1,rangeFrom:-1,rangeTo:-1,dynamicRange:-1,window:-1,drawHeatMapColors:-1,preEmphasisFilterFactor:-1},e.playHeadAnimationInfos={sS:-1,eS:-1,curS:null,endFreezeSample:-1},e.timelineSize=-1,e.somethingInProgress=!1,e.somethingInProgressTxt="",e.historyActionTxt="",e.editing=!1,e.cursorInTextField=!1,e.saving=!0,e.hierarchyRotated=!1,e.hierarchyShown=!1,e.submenuOpen=!1,e.rightSubmenuOpen=!1,e.curClickItems=[],e.curMousePosSample=0,e.curMouseLevelName=void 0,e.curMouseLevelType=void 0,e.curClickLevelName=void 0,e.curClickLevelType=void 0,e.lastPcm=void 0,e.curPreselColumnSample=2,e.curCorrectionToolNr=void 0,e.curClickLevelIndex=void 0,e.start=null,e.TransitionTime=void 0,e.showDropZone=!0,e.movingBoundary=!1,e.movingBoundarySample=void 0,e.focusInTextField=!1,e.curTaskPercCompl=0,e.curPerspectiveIdx=-1,e.mouseInEmuWebApp=!1,e.lastKeyCode=void 0,e.states=[],e.states.noDBorFilesloaded={permittedActions:["connectBtnClick","openDemoBtnDBclick"]},e.states.loadingSaving={permittedActions:[]},e.states.labeling={permittedActions:["zoom","playaudio","spectSettingsChange","addLevelSegBtnClick","addLevelPointBtnClick","renameSelLevelBtnClick","downloadTextGridBtnClick","downloadAnnotationBtnClick","spectSettingsChange","clearBtnClick","labelAction","toggleSideBars","saveBndlBtnClick","showHierarchyBtnClick","editDBconfigBtnClick"]},e.states.modalShowing=e.states.loadingSaving,e.prevState=e.states.noDBorFilesloaded,e.curState=e.states.noDBorFilesloaded,e.curLevelAttrDefs=[]},e.initialize(),e.getPermission=function(a){return e.curState.permittedActions.indexOf(a)>-1},e.setWindowWidth=function(a){this.curViewPort.windowWidth=a},e.setState=function(a){e.prevState=e.curState,e.curState="string"==typeof a?e.states[a]:a},e.updatePlayHead=function(b){d.player.isPlaying&&c.requestAnimationFrame(e.updatePlayHead),null===e.start&&(e.start=b);var f=Math.floor(b-e.start)/1e3*d.wavJSO.SampleRate;e.playHeadAnimationInfos.curS=Math.floor(e.playHeadAnimationInfos.sS+f),d.player.isPlaying&&e.playHeadAnimationInfos.curS<=e.playHeadAnimationInfos.eS?(-1!==e.playHeadAnimationInfos.curS&&(e.curMousePosSample=e.playHeadAnimationInfos.curS),a.$apply()):(e.curMousePosSample=e.playHeadAnimationInfos.endFreezeSample,e.playHeadAnimationInfos.sS=-1,e.playHeadAnimationInfos.eS=-1,e.playHeadAnimationInfos.curS=0,e.start=null)},e.animatePlayHead=function(a,b){e.playHeadAnimationInfos.sS=a,e.playHeadAnimationInfos.eS=b,e.playHeadAnimationInfos.endFreezeSample=b,e.playHeadAnimationInfos.curS=a,c.requestAnimationFrame(e.updatePlayHead)},e.select=function(a,b){e.curViewPort.selectS=a,e.curViewPort.selectE=b},e.resetSelect=function(){e.curViewPort.selectS=-1,e.curViewPort.selectE=-1},e.getViewPort=function(){return e.curViewPort},e.setspectroSettings=function(a,b,c,d,f,g,h,i){e.spectroSettings.windowSizeInSecs=a,e.spectroSettings.rangeFrom=parseInt(b,10),e.spectroSettings.rangeTo=parseInt(c,10),e.spectroSettings.dynamicRange=parseInt(d,10),e.setWindowFunction(f),e.spectroSettings.drawHeatMapColors=g,e.spectroSettings.preEmphasisFilterFactor=h,e.spectroSettings.heatMapColorAnchors=i},e.getSelect=function(){return[e.curViewPort.selectS,e.curViewPort.selectE]},e.selectDependent=function(a,b){a<this.curViewPort.selectS&&(this.curViewPort.selectS=a),b>this.curViewPort.selectE&&(this.curViewPort.selectE=b)},e.selectLevel=function(a,b,c){var d,f=e.getcurClickLevelName();if(void 0===f&&!a)return d=c.getLevelDetails(b[0]),void e.setcurClickLevel(d.level.name,d.level.type,0);if(void 0===f&&a)return d=c.getLevelDetails(b[b.length-1]),void e.setcurClickLevel(d.level.name,d.level.type,b.length-1);var g;b.forEach(function(a,b){a===f&&(g=b)}),a?g+1<b.length&&(d=c.getLevelDetails(b[g+1]),e.setcurClickLevel(d.level.name,d.level.type,b.idxOfNow+1),e.curClickItems=[],e.selectBoundary()):g-1>=0&&(d=c.getLevelDetails(b[g-1]),e.setcurClickLevel(d.level.name,d.level.type,b.idxOfNow-1),e.curClickItems=[],e.selectBoundary())},e.setWindowFunction=function(a){switch(a){case"BARTLETT":e.spectroSettings.window=f.BARTLETT;break;case"BARTLETTHANN":e.spectroSettings.window=f.BARTLETTHANN;break;case"BLACKMAN":e.spectroSettings.window=f.BLACKMAN;break;case"COSINE":e.spectroSettings.window=f.COSINE;break;case"GAUSS":e.spectroSettings.window=f.GAUSS;break;case"HAMMING":e.spectroSettings.window=f.HAMMING;break;case"HANN":e.spectroSettings.window=f.HANN;break;case"LANCZOS":e.spectroSettings.window=f.LANCZOS;break;case"RECTANGULAR":e.spectroSettings.window=f.RECTANGULAR;break;case"TRIANGULAR":e.spectroSettings.window=f.TRIANGULAR;break;default:e.spectroSettings.window=f.BARTLETTHANN}},e.getWindowFunctions=function(){return f},e.getdragBarActive=function(){return this.curViewPort.dragBarActive},e.setdragBarActive=function(a){this.curViewPort.dragBarActive=a},e.getdragBarHeight=function(){return this.curViewPort.dragBarHeight},e.setdragBarHeight=function(a){this.curViewPort.dragBarHeight=a},e.getPos=function(a,b){return a*(b-this.curViewPort.sS)/(this.curViewPort.eS-this.curViewPort.sS+1)},e.getSampleDist=function(a){return this.getPos(a,this.curViewPort.sS+1)-this.getPos(a,this.curViewPort.sS)},e.togglesubmenuOpen=function(){this.submenuOpen=!this.submenuOpen},e.getsubmenuOpen=function(){return this.submenuOpen},e.setsubmenuOpen=function(a){this.submenuOpen=a},e.setenlarge=function(a){this.timelineSize=a},e.getenlarge=function(){return this.timelineSize},e.getTransitionTime=function(){return this.TransitionTime},e.setTransitionTime=function(a){this.TransitionTime=a},e.getRightsubmenuOpen=function(){return this.rightSubmenuOpen},e.setRightsubmenuOpen=function(a){this.rightSubmenuOpen=a},e.setcurClickLevel=function(a,b,c){this.setcurClickLevelName(a,c),this.setcurClickLevelType(b)},e.setcurClickLevelType=function(a){this.curClickLevelType=a},e.getcurClickLevelType=function(){return this.curClickLevelType},e.setcurClickLevelName=function(a,b){this.curClickLevelName=a,this.curClickLevelIndex=b},e.getcurClickLevelName=function(){return this.curClickLevelName},e.getcurClickLevelIndex=function(){return this.curClickLevelIndex},e.getcurClickNeighbours=function(){return this.curClickNeighbours},e.setcurMouseLevelName=function(a){this.curMouseLevelName=a},e.getcurMouseLevelName=function(){return this.curMouseLevelName},e.setcurMouseLevelType=function(a){this.curMouseLevelType=a},e.getcurMouseLevelType=function(){return this.curMouseLevelType},e.setcurMouseItem=function(a,b,c,d,e){this.curMouseItem=a,this.curMouseX=c,this.curMouseNeighbours=b,this.curMouseisFirst=d,this.curMouseisLast=e},e.getcurMouseItem=function(){return this.curMouseItem},e.getcurMouseisFirst=function(){return this.curMouseisFirst},e.getcurMouseisLast=function(){return this.curMouseisLast},e.getcurMouseNeighbours=function(){return this.curMouseNeighbours},e.selectItemsInSelection=function(a){e.curClickItems=[];var b=1/0,c=-1/0,d=this.getItemsInSelection(a);angular.forEach(d,function(a){a.sampleStart<b&&(b=a.sampleStart),a.sampleStart+a.sampleDur+1>c&&(c=a.sampleStart+a.sampleDur+1),e.setcurClickItemMultiple(a)}),e.curViewPort.selectS=b,e.curViewPort.selectE=c},e.getItemsInSelection=function(a){var b=[],c=e.curViewPort.selectS,d=e.curViewPort.selectE;return angular.forEach(a,function(a){a.name===e.getcurClickLevelName()&&angular.forEach(a.items,function(a){a.sampleStart>=c&&a.sampleStart+a.sampleDur<=d&&b.push(a),a.samplePoint>=c&&a.samplePoint<=d&&b.push(a)})}),b},e.setcurClickItem=function(a){null!==a&&void 0!==a?(e.curClickItems=[],e.curClickItems.push(a),e.selectBoundary()):e.curClickItems=[]},e.selectBoundary=function(){if(e.curClickItems.length>0){var a,b;a=void 0!==e.curClickItems[0].sampleStart?e.curClickItems[0].sampleStart:e.curClickItems[0].samplePoint,b=e.curClickItems[e.curClickItems.length-1].sampleStart+e.curClickItems[e.curClickItems.length-1].sampleDur||e.curClickItems[0].samplePoint,e.curClickItems.forEach(function(c){c.sampleStart<=a&&(a=c.sampleStart),c.sampleStart+c.sampleDur>=b&&(b=c.sampleStart+c.sampleDur)}),e.select(a,b+1)}},e.setcurClickItemMultiple=function(a){var b=!0,c=a.sampleStart,d=c+a.sampleDur+1;e.curClickItems.forEach(function(f){var g=f.sampleStart===d?!0:!1,h=f.sampleStart+f.sampleDur+1===c?!0:!1;(g||h)&&-1===e.curClickItems.indexOf(a)&&(e.curClickItems.push(a),b=!1)}),b?(e.curClickItems=[],e.curClickItems.push(a)):e.curClickItems.sort(e.sortbyid)},e.sortbyid=function(a,b){return a.sampleStart>b.sampleStart?1:a.sampleStart<b.sampleStart?-1:0},e.getselectedRange=function(){return this.curClickItems.length>1?{start:this.curClickItems[0].sampleStart,end:this.curClickItems[this.curClickItems.length-1].sampleStart+this.curClickItems[this.curClickItems.length-1].sampleDur}:1===this.curClickItems.length?void 0!==this.curClickItems[0].sampleStart?{start:this.curClickItems[0].sampleStart,end:this.curClickItems[0].sampleStart+this.curClickItems[0].sampleDur}:{start:this.curClickItems[0].samplePoint,end:this.curClickItems[0].samplePoint}:{start:-1,end:-1}},e.getcurClickItems=function(){return this.curClickItems},e.getselected=function(){return this.curClickItems},e.isEditing=function(){return this.editing},e.setEditing=function(a){this.editing=a},e.getLasPcm=function(){return this.lastPcm},e.setLastPcm=function(a){this.lastPcm=a},e.isHierarchyRotated=function(){return e.hierarchyRotated},e.rotateHierarchy=function(){e.hierarchyRotated=!e.hierarchyRotated},e.toggleHierarchy=function(){e.hierarchyShown=!e.hierarchyShown},e.getcursorInTextField=function(){return this.cursorInTextField},e.setcursorInTextField=function(a){this.cursorInTextField=a},e.isSavingAllowed=function(){return this.saving},e.setSavingAllowed=function(a){this.saving=a},e.countSelected=function(){return this.curClickItems.length},e.getCurrentSample=function(a){return this.curViewPort.sS+(this.curViewPort.eS-this.curViewPort.sS)*a},e.getCurrentPercent=function(a){return a*(100/(this.curViewPort.eS-this.curViewPort.sS)/100)},e.getSamplesPerPixelVal=function(a){var b=parseFloat(this.curViewPort.sS),c=parseFloat(this.curViewPort.eS);return(c-b)/a.originalEvent.target.width},e.round=function(a,b){(1>b||b>14)&&console.error("error in call of round function!!");var c=Math.pow(10,b),d=(Math.round(a*c)/c).toString();return-1===d.indexOf(".")&&(d+="."),d+=c.toString().substring(1),parseFloat(d.substring(0,d.indexOf(".")+b+1))},e.getViewPortStartTime=function(){return 1*this.curViewPort.sS/d.wavJSO.SampleRate-.5/d.wavJSO.SampleRate},e.getViewPortEndTime=function(){return 1*this.curViewPort.eS/d.wavJSO.SampleRate+.5/d.wavJSO.SampleRate},e.getSelectedStartTime=function(){return 1*this.curViewPort.selectS/d.wavJSO.SampleRate-.5/d.wavJSO.SampleRate},e.getSelectedEndTime=function(){return 1*this.curViewPort.selectE/d.wavJSO.SampleRate+.5/d.wavJSO.SampleRate},e.setViewPort=function(a,b){var c=this.curViewPort.sS,e=this.curViewPort.eS;void 0!==a&&(this.curViewPort.sS=Math.round(a)),void 0!==b&&(this.curViewPort.eS=Math.round(b)),c>this.curViewPort.sS&&e>this.curViewPort.eS&&this.curViewPort.sS<0&&(this.curViewPort.sS=0,this.curViewPort.eS=e+Math.abs(this.curViewPort.sS)),c<this.curViewPort.sS&&e<this.curViewPort.eS&&this.curViewPort.eS>d.wavJSO.Data.length&&(this.curViewPort.sS=c,this.curViewPort.eS=d.wavJSO.Data.length),this.curViewPort.sS<0&&(this.curViewPort.sS=0),this.curViewPort.eS>d.wavJSO.Data.length&&(this.curViewPort.eS=d.wavJSO.Data.length),this.curViewPort.eS-this.curViewPort.sS<4&&(this.curViewPort.sS=c,this.curViewPort.eS=e)},e.zoomViewPort=function(a,b){var c,d,f,g=this.getcurMouseItem(),h=this.curViewPort.eS-this.curViewPort.sS,i=!1;if(void 0!==g){this.getcurMouseisFirst()?g=b.getItemDetails(e.getcurMouseLevelName(),0):this.getcurMouseisLast()&&(g=b.getLastItem(e.getcurMouseLevelName()),i=!0),f="SEGMENT"===this.getcurMouseLevelType()?i?g.sampleStart+g.sampleDur:g.sampleStart:g.samplePoint;var j=f-this.curViewPort.sS,k=this.curViewPort.eS-f;a?(c=this.curViewPort.sS+.5*j,d=this.curViewPort.eS-.5*k):(c=this.curViewPort.sS-.5*j,d=this.curViewPort.eS+.5*k)}else a?(c=this.curViewPort.sS+~~(h/4),d=this.curViewPort.eS-~~(h/4)):(c=this.curViewPort.sS-~~(h/4),d=this.curViewPort.eS+~~(h/4));this.setViewPort(c,d)},e.shiftViewPort=function(a){var b,c;a?(b=this.curViewPort.sS+~~((this.curViewPort.eS-this.curViewPort.sS)/4),c=this.curViewPort.eS+~~((this.curViewPort.eS-this.curViewPort.sS)/4)):(b=this.curViewPort.sS-~~((this.curViewPort.eS-this.curViewPort.sS)/4),c=this.curViewPort.eS-~~((this.curViewPort.eS-this.curViewPort.sS)/4)),this.setViewPort(b,c)},e.setCurLevelAttrDefs=function(a){angular.forEach(a,function(a){e.curLevelAttrDefs.push({levelName:a.name,curAttrDefName:a.name})})},e.setCurAttrDef=function(a,b,c){angular.forEach(e.curLevelAttrDefs,function(d){d.levelName===a&&(d.curAttrDefName=b,d.curAttrDefIndex=c)})},e.getCurAttrDef=function(a){var b;return angular.forEach(e.curLevelAttrDefs,function(c){c.levelName===a&&(b=c.curAttrDefName)}),b},e.getCurAttrIndex=function(a){var b;return angular.forEach(e.curLevelAttrDefs,function(c){c.levelName===a&&(b=void 0===c.curAttrDefIndex?0:c.curAttrDefIndex)}),b},e.setlastKeyCode=function(a){this.lastKeyCode=a},e.getX=function(a){return(a.offsetX||a.originalEvent.layerX)*(a.originalEvent.target.width/a.originalEvent.target.clientWidth)},e.getY=function(a){return(a.offsetY||a.originalEvent.layerY)*(a.originalEvent.target.height/a.originalEvent.target.clientHeight)},e.resetToInitState=function(){e.initialize()},e.getColorOfAnchor=function(a,b){var c={"background-color":"rgb("+a[b][0]+","+a[b][1]+","+a[b][2]+")",width:"10px",height:"10px"};return c},e}]),angular.module("emuwebApp").directive("trackMouseInLevel",["viewState","LevelService","ConfigProviderService","HistoryService","Soundhandlerservice",function(a,b,c,d,e){return{restrict:"A",replace:!0,scope:{levelName:"=",levelType:"="},link:function(f,g){f.lastEventClick=void 0,f.lastEventMove=void 0,f.lastNeighboursMove=void 0,f.lastPCM=void 0,f.curMouseSampleNrInView=void 0,g.bind("click",function(a){a.preventDefault(),f.setLastMove(a,!0),f.setLastClick(a)}),g.bind("contextmenu",function(a){a.preventDefault(),f.setLastMove(a,!0),f.setLastRightClick(a)}),g.bind("dblclick",function(a){f.setLastMove(a,!0),c.vals.restrictions.editItemName?f.setLastDblClick(a):f.setLastClick(a)}),g.bind("mousemove",function(g){if(!a.getdragBarActive()){var h=!0,i=a.getSamplesPerPixelVal(g);f.curMouseSampleNrInView=a.getX(g)*i;var j=f.curMouseSampleNrInView-f.lastPCM;if(1>=i){var k=b.getClosestItem(f.curMouseSampleNrInView+a.curViewPort.sS,f.levelName,e.wavJSO.Data.length);if("SEGMENT"===f.levelType)if(k.isFirst===!0&&k.isLast===!1)j=Math.ceil(f.curMouseSampleNrInView+a.curViewPort.sS-b.getItemDetails(f.levelName,0).sampleStart);else if(k.isFirst===!1&&k.isLast===!0){var l=b.getLastItem(f.levelName);j=Math.ceil(f.curMouseSampleNrInView+a.curViewPort.sS-l.sampleStart-l.sampleDur)}else j=Math.ceil(f.curMouseSampleNrInView+a.curViewPort.sS-b.getItemFromLevelById(f.levelName,k.nearest.id).sampleStart);else j=Math.ceil(f.curMouseSampleNrInView+a.curViewPort.sS-b.getItemFromLevelById(f.levelName,k.nearest.id).samplePoint-.5)}else j=Math.round(f.curMouseSampleNrInView-f.lastPCM)}var m=0;switch(m=void 0===g.buttons?g.which:g.buttons){case 1:break;case 2:break;case 3:break;default:if(!a.getdragBarActive())if(c.vals.restrictions.editItemSize&&g.shiftKey){b.deleteEditArea();var n=a.getcurMouseItem();if(void 0!==n){if(a.movingBoundary=!0,"SEGMENT"===f.levelType){if(a.getcurMouseisFirst()||a.getcurMouseisLast()){var o;a.getcurMouseisFirst()?(o=b.getItemDetails(f.levelName,0),a.movingBoundarySample=o.sampleStart+j):a.getcurMouseisLast()&&(o=b.getLastItem(f.levelName),a.movingBoundarySample=o.sampleStart+o.sampleDur+j)}else a.movingBoundarySample=n.sampleStart+j,o=n;b.moveBoundary(f.levelName,o.id,j,a.getcurMouseisFirst(),a.getcurMouseisLast()),d.updateCurChangeObj({type:"ANNOT",action:"MOVEBOUNDARY",name:f.levelName,id:o.id,movedBy:j,isFirst:a.getcurMouseisFirst(),isLast:a.getcurMouseisLast()})}else o=n,a.movingBoundarySample=n.samplePoint+j,b.moveEvent(f.levelName,o.id,j),d.updateCurChangeObj({type:"ANNOT",action:"MOVEEVENT",name:f.levelName,id:o.id,movedBy:j});f.lastPCM=f.curMouseSampleNrInView,a.setLastPcm(f.lastPCM),a.selectBoundary(),h=!1}}else c.vals.restrictions.editItemSize&&g.altKey?(b.deleteEditArea(),"SEGMENT"==f.levelType&&(o=a.getcurClickItems(),b.moveSegment(f.levelName,o[0].id,o.length,j),d.updateCurChangeObj({type:"ANNOT",action:"MOVESEGMENT",name:f.levelName,id:o[0].id,length:o.length,movedBy:j}),f.lastPCM=f.curMouseSampleNrInView,a.setLastPcm(f.lastPCM),a.selectBoundary())):a.movingBoundary=!1}a.getdragBarActive()||f.setLastMove(g,h)}),g.bind("mousedown",function(b){a.movingBoundary=!0,f.setLastMove(b,!0)}),g.bind("mouseup",function(b){a.movingBoundary=!1,f.setLastMove(b,!0)}),g.bind("mouseout",function(b){a.movingBoundary=!1,f.setLastMove(b,!0)}),f.setLastClick=function(c){f.curMouseSampleNrInView=a.getX(c)*a.getSamplesPerPixelVal(c),b.deleteEditArea(),a.setEditing(!1),f.lastEventClick=b.getClosestItem(f.curMouseSampleNrInView+a.curViewPort.sS,f.levelName,e.wavJSO.Data.length),void 0!==f.lastEventClick.current&&void 0!==f.lastEventClick.nearest&&(b.setlasteditArea("_"+f.lastEventClick.current.id),b.setlasteditAreaElem(g.parent()),a.setcurClickLevel(f.levelName,f.levelType,f.$index),a.setcurClickItem(f.lastEventClick.current)),f.lastPCM=f.curMouseSampleNrInView,a.setLastPcm(f.lastPCM),f.$apply()},f.setLastRightClick=function(c){a.getcurClickLevelName()!==f.levelName&&f.setLastClick(c),f.curMouseSampleNrInView=a.getX(c)*a.getSamplesPerPixelVal(c),b.deleteEditArea(),f.lastEventClick=b.getClosestItem(f.curMouseSampleNrInView+a.curViewPort.sS,f.levelName,e.wavJSO.Data.length),void 0!==f.lastEventClick.current&&void 0!==f.lastEventClick.nearest&&(a.setcurClickLevel(f.levelName,f.levelType,f.$index),a.setcurClickItemMultiple(f.lastEventClick.current),a.selectBoundary()),f.lastPCM=f.curMouseSampleNrInView,a.setLastPcm(f.lastPCM),f.$apply()},f.setLastDblClick=function(c){f.curMouseSampleNrInView=a.getX(c)*a.getSamplesPerPixelVal(c),f.lastEventClick=b.getClosestItem(f.curMouseSampleNrInView+a.curViewPort.sS,f.levelName,e.wavJSO.Data.length),void 0!==f.lastEventClick.current&&void 0!==f.lastEventClick.nearest&&("SEGMENT"===f.levelType?f.lastEventClick.current.sampleStart>=a.curViewPort.sS?f.lastEventClick.current.sampleStart+f.lastEventClick.current.sampleDur<=a.curViewPort.eS?(a.setcurClickLevel(f.levelName,f.levelType,f.$index),a.setcurClickItem(f.lastEventClick.current),b.setlasteditArea("_"+f.lastEventClick.current.id),b.setlasteditAreaElem(g.parent()),a.setEditing(!0),b.openEditArea(f.lastEventClick.current,g.parent(),f.levelType)):console.log("Editing out of right bound !"):console.log("Editing out of left bound !"):(a.setcurClickLevel(f.levelName,f.levelType,f.$index),a.setcurClickItem(f.lastEventClick.current),b.setlasteditArea("_"+f.lastEventClick.current.id),b.setlasteditAreaElem(g.parent()),a.setEditing(!0),b.openEditArea(f.lastEventClick.current,g.parent(),f.levelType),a.setEditing(!0))),f.lastPCM=f.curMouseSampleNrInView,a.setLastPcm(f.lastPCM),f.$apply()},f.setLastMove=function(c,d){f.curMouseSampleNrInView=a.getX(c)*a.getSamplesPerPixelVal(c),f.lastEventMove=b.getClosestItem(f.curMouseSampleNrInView+a.curViewPort.sS,f.levelName,e.wavJSO.Data.length),d&&void 0!==f.lastEventMove.current&&void 0!==f.lastEventMove.nearest&&(f.lastNeighboursMove=b.getItemNeighboursFromLevel(f.levelName,f.lastEventMove.nearest.id,f.lastEventMove.nearest.id),a.setcurMouseItem(f.lastEventMove.nearest,f.lastNeighboursMove,f.lastPCM,f.lastEventMove.isFirst,f.lastEventMove.isLast)),a.setcurMouseLevelName(f.levelName),a.setcurMouseLevelType(f.levelType),f.lastPCM=f.curMouseSampleNrInView,a.setLastPcm(f.lastPCM),f.$apply()}}}}]),angular.module("emuwebApp").directive("handleglobalkeystrokes",["$timeout","viewState","modalService","Soundhandlerservice","ConfigProviderService","HistoryService","LevelService","DataService","LinkService","AnagestService",function(a,b,c,d,e,f,g,h,i,j){return{restrict:"A",link:function(a){$(document).bind("keyup",function(c){var d=c.keyCode?c.keyCode:c.which;b.isEditing()&&!b.getcursorInTextField()&&a.applyKeyCodeUp(d,c)}),$(document).bind("keydown",function(b){if(!a.firefox){var c=b.keyCode?b.keyCode:b.which;(8==c||9==c||27==c||37==c||38==c||39==c||40==c||32==c)&&a.applyKeyCode(c,b)}}),$(document).bind("keypress",function(b){var c=b.keyCode?b.keyCode:b.which;a.applyKeyCode(c,b)}),a.applyKeyCodeUp=function(c){a.$apply(function(){if(c!==e.vals.keyMappings.esc&&c!==e.vals.keyMappings.createNewItemAtSelection){var a=$("."+g.getlasteditArea()),d=a.val();b.setSavingAllowed(!0);var f=b.getCurAttrIndex(b.getcurClickLevelName()),h=e.getLevelDefinition(b.getcurClickLevelName()),i={};void 0!==h.attributeDefinitions&&h.attributeDefinitions.length>0&&(i=e.getLevelDefinition(b.getcurClickLevelName()).attributeDefinitions[f]),void 0!==i.legalLabels&&d.length>0&&i.legalLabels.indexOf(d)<0&&b.setSavingAllowed(!1),a.css(b.isSavingAllowed()?{"background-color":"rgba(255,255,0,1)"}:{"background-color":"rgba(255,0,0,1)"})}})},a.applyKeyCode=function(k,l){a.$apply(function(){if(!e.vals.main.catchMouseForKeyBinding||b.mouseInEmuWebApp)if(b.setlastKeyCode(k),b.isEditing()){var m=$("."+g.getlasteditArea());if(!b.isSavingAllowed()&&k===e.vals.keyMappings.createNewItemAtSelection){var n=e.getLevelDefinition(b.getcurClickLevelName()).attributeDefinitions[b.getCurAttrIndex(b.getcurClickLevelName())].legalLabels;l.preventDefault(),l.stopPropagation(),g.deleteEditArea(),b.setEditing(!1),c.open("views/error.html",'Editing Error: Sorry, characters allowed on this Level are "'+JSON.stringify(n)+'"')}if(b.isSavingAllowed()&&k===e.vals.keyMappings.createNewItemAtSelection){var o=g.getItemFromLevelById(b.getcurClickLevelName(),g.getlastID()),p=b.getCurAttrIndex(b.getcurClickLevelName()),q="";void 0!==o.labels[p]&&(q=o.labels[p].value),g.renameLabel(b.getcurClickLevelName(),g.getlastID(),b.getCurAttrIndex(b.getcurClickLevelName()),m.val()),f.addObjToUndoStack({type:"ANNOT",action:"RENAMELABEL",name:b.getcurClickLevelName(),id:g.getlastID(),attrIndex:p,oldValue:q,newValue:m.val()}),g.deleteEditArea(),b.setEditing(!1),b.setcurClickItem(g.getItemFromLevelById(b.getcurClickLevelName(),g.getlastID()))}k===e.vals.keyMappings.esc&&(g.deleteEditArea(),b.setEditing(!1))}else if(b.getcursorInTextField()===!1){if(g.deleteEditArea(),0===b.curState.permittedActions.length&&k===e.vals.keyMappings.esc&&c.force===!1&&b.hierarchyShown&&c.close(),k===e.vals.keyMappings.showHierarhy&&b.curState!==b.states.noDBorFilesloaded&&(b.hierarchyShown?c.close():(b.toggleHierarchy(),c.open("views/showHierarchyModal.html"))),k===e.vals.keyMappings.rotateHierarhy&&b.rotateHierarchy(),k===e.vals.keyMappings.zoomAll&&b.getPermission("zoom")&&b.setViewPort(0,d.wavJSO.Data.length),k===e.vals.keyMappings.zoomIn&&b.getPermission("zoom")&&b.zoomViewPort(!0,g),k===e.vals.keyMappings.zoomOut&&b.getPermission("zoom")&&b.zoomViewPort(!1,g),k===e.vals.keyMappings.zoomSel&&b.getPermission("zoom")&&b.setViewPort(b.curViewPort.selectS,b.curViewPort.selectE),k===e.vals.keyMappings.shiftViewPortLeft&&b.getPermission("zoom")&&b.shiftViewPort(!1),k===e.vals.keyMappings.shiftViewPortRight&&b.getPermission("zoom")&&b.shiftViewPort(!0),k===e.vals.keyMappings.playEntireFile&&b.getPermission("playaudio")&&e.vals.restrictions.playback&&(d.playFromTo(0,d.wavJSO.Data.length),b.animatePlayHead(0,d.wavJSO.Data.length)),k===e.vals.keyMappings.playAllInView&&b.getPermission("playaudio")&&e.vals.restrictions.playback&&(d.playFromTo(b.curViewPort.sS,b.curViewPort.eS),b.animatePlayHead(b.curViewPort.sS,b.curViewPort.eS)),k===e.vals.keyMappings.playSelected&&b.getPermission("playaudio")&&e.vals.restrictions.playback&&(d.playFromTo(b.curViewPort.selectS,b.curViewPort.selectE),b.animatePlayHead(b.curViewPort.selectS,b.curViewPort.selectE)),k===e.vals.keyMappings.selectFirstContourCorrectionTool&&b.getPermission("labelAction")&&e.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=1),k===e.vals.keyMappings.selectSecondContourCorrectionTool&&b.getPermission("labelAction")&&e.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=2),k===e.vals.keyMappings.selectThirdContourCorrectionTool&&b.getPermission("labelAction")&&e.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=3),k===e.vals.keyMappings.selectFourthContourCorrectionTool&&b.getPermission("labelAction")&&e.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=4),k===e.vals.keyMappings.selectNoContourCorrectionTool&&b.getPermission("labelAction")&&e.vals.restrictions.correctionTool&&(b.curCorrectionToolNr=void 0),k===e.vals.keyMappings.levelUp&&b.getPermission("labelAction")&&b.selectLevel(!1,e.vals.perspectives[b.curPerspectiveIdx].levelCanvases.order,g),k===e.vals.keyMappings.levelDown&&b.getPermission("labelAction")&&b.selectLevel(!0,e.vals.perspectives[b.curPerspectiveIdx].levelCanvases.order,g),k===e.vals.keyMappings.snapBoundaryToNearestTopBoundary&&b.getPermission("labelAction")&&e.vals.restrictions.editItemSize){var r=b.getcurMouseItem(),s=b.getcurMouseLevelName(),t=b.getcurMouseLevelType(),u=b.getcurMouseNeighbours(),v=g.snapBoundary(!0,s,r,u,t);v===!1||("EVENT"===t?f.updateCurChangeObj({type:"ANNOT",action:"MOVEEVENT",name:s,id:r.id,movedBy:v}):"SEGMENT"===t&&f.updateCurChangeObj({type:"ANNOT",action:"MOVEBOUNDARY",name:s,id:r.id,movedBy:v,position:0}),f.addCurChangeObjToUndoStack())}if(k===e.vals.keyMappings.snapBoundaryToNearestBottomBoundary&&b.getPermission("labelAction")&&e.vals.restrictions.editItemSize){var r=b.getcurMouseItem(),s=b.getcurMouseLevelName(),t=b.getcurMouseLevelType(),u=b.getcurMouseNeighbours(),v=g.snapBoundary(!1,s,r,u,t);0==v||("EVENT"===t?f.updateCurChangeObj({type:"ANNOT",action:"MOVEEVENT",name:s,id:r.id,movedBy:v}):"SEGMENT"===t&&f.updateCurChangeObj({type:"ANNOT",action:"MOVEBOUNDARY",name:s,id:r.id,movedBy:v,position:0}),f.addCurChangeObjToUndoStack())}if(k===e.vals.keyMappings.snapBoundaryToNearestZeroCrossing&&b.getPermission("labelAction")&&e.vals.restrictions.editItemSize){var w;if(w=g.calcDistanceToNearestZeroCrossing("SEGMENT"===b.getcurMouseLevelType()?b.getcurMouseItem().sampleStart:b.getcurMouseItem().samplePoint),0!==w){var x=b.getcurMouseItem(),y=(b.getcurMouseNeighbours(),b.getcurMouseLevelName());g.moveBoundary(y,x.id,w,0),f.updateCurChangeObj({type:"ANNOT",action:"MOVEBOUNDARY",name:y,id:x.id,movedBy:w,position:0}),f.addCurChangeObjToUndoStack()}}if(k===e.vals.keyMappings.expandSelSegmentsRight&&b.getPermission("labelAction")&&e.vals.restrictions.editItemSize)if(void 0===b.getcurClickLevelName())c.open("views/error.html","Expand Segments Error: Please select a Level first");else if(0===b.getselected().length)c.open("views/error.html","Expand Segments Error: Please select one or more Segments first");else{var z=parseInt(e.vals.labelCanvasConfig.addTimeValue,10);"relative"===e.vals.labelCanvasConfig.addTimeMode&&(z=e.vals.labelCanvasConfig.addTimeValue*(d.wavJSO.Data.length/100)),g.expandSegment(!0,b.getcurClickItems(),b.getcurClickLevelName(),z),f.addObjToUndoStack({type:"ANNOT",action:"EXPANDSEGMENTS",name:b.getcurClickLevelName(),item:b.getcurClickItems(),rightSide:!0,changeTime:z}),b.selectBoundary()}if(k===e.vals.keyMappings.expandSelSegmentsLeft&&b.getPermission("labelAction")&&e.vals.restrictions.editItemSize)if(void 0===b.getcurClickLevelName())c.open("views/error.html","Expand Segments Error: Please select a Level first");else if(0===b.getselected().length)c.open("views/error.html","Expand Segments Error: Please select one or more Segments first");else{if("absolute"===e.vals.labelCanvasConfig.addTimeMode)var z=parseInt(e.vals.labelCanvasConfig.addTimeValue,10);else if("relative"===e.vals.labelCanvasConfig.addTimeMode)var z=e.vals.labelCanvasConfig.addTimeValue*(d.wavJSO.Data.length/100);else c.open("views/error.html","Expand Segements Error: Error in Configuration (Value labelCanvasConfig.addTimeMode)");g.expandSegment(!1,b.getcurClickItems(),b.getcurClickLevelName(),z),f.addObjToUndoStack({type:"ANNOT",action:"EXPANDSEGMENTS",name:b.getcurClickLevelName(),item:b.getcurClickItems(),rightSide:!1,changeTime:z}),b.selectBoundary()}if(k===e.vals.keyMappings.shrinkSelSegmentsLeft&&b.getPermission("labelAction")&&e.vals.restrictions.editItemSize)if(void 0===b.getcurClickLevelName())c.open("views/error.html","Expand Segments Error: Please select a Level first");else if(0===b.getselected().length)c.open("views/error.html","Expand Segments Error: Please select one or more Segments first");else{if("absolute"===e.vals.labelCanvasConfig.addTimeMode)var z=parseInt(e.vals.labelCanvasConfig.addTimeValue,10);else if("relative"===e.vals.labelCanvasConfig.addTimeMode)var z=e.vals.labelCanvasConfig.addTimeValue*(d.wavJSO.Data.length/100);else c.open("views/error.html","Expand Segements Error: Error in Configuration (Value labelCanvasConfig.addTimeMode)");g.expandSegment(!0,b.getcurClickItems(),b.getcurClickLevelName(),-z),f.addObjToUndoStack({type:"ANNOT",action:"EXPANDSEGMENTS",name:b.getcurClickLevelName(),item:b.getcurClickItems(),rightSide:!0,changeTime:-z}),b.selectBoundary()}if(k===e.vals.keyMappings.shrinkSelSegmentsRight&&b.getPermission("labelAction")&&e.vals.restrictions.editItemSize)if(void 0===b.getcurClickLevelName())c.open("views/error.html","Expand Segments Error: Please select a Level first");else if(0===b.getselected().length)c.open("views/error.html","Expand Segments Error: Please select one or more Segments first");else{if("absolute"===e.vals.labelCanvasConfig.addTimeMode)var z=parseInt(e.vals.labelCanvasConfig.addTimeValue,10);else if("relative"===e.vals.labelCanvasConfig.addTimeMode)var z=e.vals.labelCanvasConfig.addTimeValue*(d.wavJSO.Data.length/100);else c.open("views/error.html","Expand Segements Error: Error in Configuration (Value labelCanvasConfig.addTimeMode)");g.expandSegment(!1,b.getcurClickItems(),b.getcurClickLevelName(),-z),f.addObjToUndoStack({type:"ANNOT",action:"EXPANDSEGMENTS",name:b.getcurClickLevelName(),item:b.getcurClickItems(),rightSide:!1,changeTime:-z}),b.selectBoundary()}if(k===e.vals.keyMappings.toggleSideBarLeft&&b.getPermission("toggleSideBars")&&e.vals.activeButtons.openMenu&&b.togglesubmenuOpen(e.vals.colors.transitionTime),k===e.vals.keyMappings.toggleSideBarRight&&b.getPermission("toggleSideBars")&&e.vals.activeButtons.openMenu&&b.setRightsubmenuOpen(!b.getRightsubmenuOpen()),k===e.vals.keyMappings.selectItemsInSelection&&b.getPermission("labelAction")&&(void 0===b.getcurClickLevelName()?c.open("views/error.html","Selection Error : Please select a Level first"):b.selectItemsInSelection(h.data.levels)),k===e.vals.keyMappings.selPrevItem&&b.getPermission("labelAction")&&b.getcurClickItems().length>0){var A=b.getcurClickItems()[0].id,B=b.getcurClickItems()[b.getcurClickItems().length-1].id,C=g.getItemNeighboursFromLevel(b.getcurClickLevelName(),A,B);
void 0!==C.left&&(void 0!==C.left.sampleStart?C.left.sampleStart>b.curViewPort.sS&&(l.shiftKey?(b.setcurClickItemMultiple(C.left),g.setlasteditArea("_"+C.left.id),b.selectBoundary()):(b.setcurClickItem(C.left),g.setlasteditArea("_"+C.left.id))):C.left.samplePoint>b.curViewPort.sS&&(l.shiftKey?(b.setcurClickItemMultiple(C.left),g.setlasteditArea("_"+C.left.id),b.selectBoundary()):(b.setcurClickItem(C.left),g.setlasteditArea("_"+C.left.id))))}if(k===e.vals.keyMappings.selNextItem&&b.getPermission("labelAction")&&b.getcurClickItems().length>0){var A=b.getcurClickItems()[0].id,B=b.getcurClickItems()[b.getcurClickItems().length-1].id,C=g.getItemNeighboursFromLevel(b.getcurClickLevelName(),A,B);void 0!==C.right&&C.right.sampleStart+C.right.sampleDur<b.curViewPort.eS&&(l.shiftKey?(b.setcurClickItemMultiple(C.right),g.setlasteditArea("_"+C.right.id),b.selectBoundary()):(b.setcurClickItem(C.right),g.setlasteditArea("_"+C.right.id)))}if(k===e.vals.keyMappings.selNextPrevItem&&b.getPermission("labelAction")&&b.getcurClickItems().length>0){var A=b.getcurClickItems()[0].id,B=b.getcurClickItems()[b.getcurClickItems().length-1].id,C=g.getItemNeighboursFromLevel(b.getcurClickLevelName(),A,B);l.shiftKey?void 0!==C.left&&(void 0!==C.left.sampleStart?C.left.sampleStart+C.left.sampleDur>b.curViewPort.sS&&(b.setcurClickItem(C.left,C.left.id),g.setlasteditArea("_"+C.left.id)):C.left.samplePoint>b.curViewPort.sS&&(b.setcurClickItem(C.left,C.left.id),g.setlasteditArea("_"+C.left.id))):void 0!==C.right&&(void 0!==C.right.sampleStart?C.right.sampleStart<b.curViewPort.eS&&(b.setcurClickItem(C.right,C.right.id),g.setlasteditArea("_"+C.right.id)):C.right.samplePoint<b.curViewPort.eS&&(b.setcurClickItem(C.right,C.right.id),g.setlasteditArea("_"+C.right.id)))}if(k===e.vals.keyMappings.createNewItemAtSelection&&b.getPermission("labelAction")&&e.vals.restrictions.addItem)if(b.getselectedRange().start===b.curViewPort.selectS&&b.getselectedRange().end===b.curViewPort.selectE)1===b.getcurClickItems().length?b.getselectedRange().start>=b.curViewPort.sS&&b.getselectedRange().end<=b.curViewPort.eS&&(b.setEditing(!0),g.openEditArea(b.getcurClickItems()[0],g.getlasteditAreaElem(),b.getcurClickLevelType()),a.cursorInTextField()):c.open("views/error.html","Modify Error: Please select a single Segment.");else if(-1==b.curViewPort.selectE&&-1==b.curViewPort.selectS)c.open("views/error.html","Error : Please select a Segment or Point to modify it's name. Or select a level plus a range in the viewport in order to insert a new Segment.");else if("SEGMENT"===b.getcurClickLevelType()){var x=g.getClosestItem(b.curViewPort.selectS,b.getcurClickLevelName(),d.wavJSO.Data.length).current;if(void 0===x){var D=g.insertSegment(b.getcurClickLevelName(),b.curViewPort.selectS,b.curViewPort.selectE,e.vals.labelCanvasConfig.newSegmentName);D.ret?f.addObjToUndoStack({type:"ANNOT",action:"INSERTSEGMENTS",name:b.getcurClickLevelName(),start:b.curViewPort.selectS,end:b.curViewPort.selectE,ids:D.ids,segName:e.vals.labelCanvasConfig.newSegmentName}):c.open("views/error.html","Error : You are not allowed to insert a Segment here.")}else if(x.sampleStart===b.curViewPort.selectS&&x.sampleStart+x.sampleDur+1===b.curViewPort.selectE)b.setcurClickLevel(b.getcurClickLevelName(),b.getcurClickLevelType(),a.$index),b.setcurClickItem(x.current),g.setlasteditArea("_"+x.id),b.setEditing(!0),g.openEditArea(x,g.getlasteditAreaElem(),b.getcurClickLevelType()),b.setEditing(!0);else{var D=g.insertSegment(b.getcurClickLevelName(),b.curViewPort.selectS,b.curViewPort.selectE,e.vals.labelCanvasConfig.newSegmentName);D.ret?f.addObjToUndoStack({type:"ANNOT",action:"INSERTSEGMENTS",name:b.getcurClickLevelName(),start:b.curViewPort.selectS,end:b.curViewPort.selectE,ids:D.ids,segName:e.vals.labelCanvasConfig.newSegmentName}):c.open("views/error.html","Error : You are not allowed to insert a Segment here.")}}else{var E=e.getLevelDefinition(b.getcurClickLevelName());if("undefined"==typeof E.anagestConfig){var F=g.insertEvent(b.getcurClickLevelName(),b.curViewPort.selectS,e.vals.labelCanvasConfig.newEventName);F.alreadyExists?c.open("views/error.html","Error: You are not allowed to insert a Point here."):f.addObjToUndoStack({type:"ANNOT",action:"INSERTEVENT",name:b.getcurClickLevelName(),start:b.curViewPort.selectS,id:F.id,pointName:e.vals.labelCanvasConfig.newEventName})}else j.insertAnagestEvents()}if(k===e.vals.keyMappings.undo&&b.getPermission("labelAction")&&f.undo(),k===e.vals.keyMappings.redo&&b.getPermission("labelAction")&&f.redo(),k===e.vals.keyMappings.deletePreselBoundary&&b.getPermission("labelAction")){l.preventDefault();var x=b.getcurMouseItem(),G=b.getcurClickItems(),H=b.getcurMouseisFirst(),I=b.getcurMouseisLast(),y=b.getcurMouseLevelName(),J=b.getcurMouseLevelType();if(l.shiftKey){if(e.vals.restrictions.deleteItem&&void 0!==G&&G.length>0)if("SEGMENT"===b.getcurClickLevelType()){var K=g.deleteSegments(y,G[0].id,G.length);f.updateCurChangeObj({type:"ANNOT",action:"DELETESEGMENTS",name:y,id:G[0].id,length:G.length,deletedSegment:K});var L=i.deleteLinkSegment(G);f.updateCurChangeObj({type:"ANNOT",action:"DELETELINKSEGMENT",name:y,segments:G,deletedLinks:L}),f.addCurChangeObjToUndoStack();var M=g.getClosestItem(b.getLasPcm()+b.curViewPort.sS,y,d.wavJSO.Data.length);if(void 0!==M.current&&void 0!==M.nearest){var C=g.getItemNeighboursFromLevel(s,M.nearest.id,M.nearest.id);b.setcurMouseItem(M.nearest,C,b.getLasPcm(),M.isFirst,M.isLast)}b.setcurClickItem(K.clickSeg)}else c.open("views/error.html","Delete Error: You can not delete Segments on Point Levels.")}else if(e.vals.restrictions.deleteItemBoundary&&void 0!==x){var N=g.getItemNeighboursFromLevel(y,x.id,x.id);if("SEGMENT"===J){var K=g.deleteBoundary(y,x.id,H,I);f.updateCurChangeObj({type:"ANNOT",action:"DELETEBOUNDARY",name:y,id:x.id,isFirst:H,isLast:I,deletedSegment:K});var L;void 0!==N.left?(L=i.deleteLinkBoundary(x.id,N.left.id),f.updateCurChangeObj({type:"ANNOT",action:"DELETELINKBOUNDARY",name:y,id:x.id,neighbourId:N.left.id,deletedLinks:L})):(L=i.deleteLinkBoundary(x.id,-1),f.updateCurChangeObj({type:"ANNOT",action:"DELETELINKBOUNDARY",name:y,id:x.id,neighbourId:-1,deletedLinks:L})),f.addCurChangeObjToUndoStack();var M=g.getClosestItem(b.getLasPcm()+b.curViewPort.sS,y,d.wavJSO.Data.length);if(void 0!==M.current&&void 0!==M.nearest){var C=g.getItemNeighboursFromLevel(s,M.nearest.id,M.nearest.id);b.setcurMouseItem(M.nearest,C,b.getLasPcm(),M.isFirst,M.isLast)}b.setcurClickItem(K.clickSeg)}else{var O=g.deleteEvent(y,x.id);if(O!==!1){f.updateCurChangeObj({type:"ANNOT",action:"DELETEEVENT",name:y,start:O.samplePoint,id:O.id,pointName:O.labels[0].value}),f.addCurChangeObjToUndoStack();var M=g.getClosestItem(b.getLasPcm()+b.curViewPort.sS,y,d.wavJSO.Data.length);if(void 0!==M.current&&void 0!==M.nearest){var C=g.getItemNeighboursFromLevel(s,M.nearest.id,M.nearest.id);b.setcurMouseItem(M.nearest,C,b.getLasPcm(),M.isFirst,M.isLast)}}else b.setcurMouseItem(void 0,void 0,void 0,void 0,void 0)}}}l.metaKey||l.ctrlKey||(l.preventDefault(),l.stopPropagation())}})},a.safeApply=function(a){var b=this.$root.$$phase;"$apply"==b||"$digest"==b?a&&"function"==typeof a&&a():this.$apply(a)},a.$on("$destroy",function(){$(window).off("keydown")})}}}]),angular.module("emuwebApp").directive("delete",["modalService",function(a){return{restrict:"A",link:function(b,c,d){var e=b.level.name;c.bind("click",function(){b.vs.setcurClickLevelName(e,d.delete),a.open("views/deleteLevel.html",e)})}}}]),angular.module("emuwebApp").directive("resize",function(){return{restrict:"A",link:function(a,b){var c=b.parent().parent(),d=0,e=c.find(b.parent().children()[0]),f=(c.find(b.parent().children()[1]),c.find(b.parent().children()[2]));b.bind("click",function(){a.open?(a.open=!1,d=c.css("height"),c.css({height:"30px"}),a.cps.vals.activeButtons.deleteSingleLevel&&e.hide(),a.cps.vals.activeButtons.saveSingleLevel&&f.hide()):(a.open=!0,c.css({height:d}),a.cps.vals.activeButtons.deleteSingleLevel&&e.show(),a.cps.vals.activeButtons.saveSingleLevel&&f.show()),a.updateView()})}}}),angular.module("emuwebApp").directive("enlarge",["$rootScope","viewState","ConfigProviderService",function(a,b,c){return{restrict:"A",link:function(d,e,f){d.$watch("viewState.curPerspectiveIdx",function(){$.isEmptyObject(c.vals.perspectives)||$.isEmptyObject(b.curPerspectiveIdx)||(1===c.vals.perspectives[b.curPerspectiveIdx].signalCanvases.order.length?e.hide():e.show())},!0);var g=!1;e.bind("click",function(){g?(g=!1,b.setenlarge(-1)):(g=!0,b.setenlarge(f.enlarge)),a.$apply()})}}}]),angular.module("emuwebApp").directive("save",["modalService","Espsparserservice",function(a,b){return{restrict:"A",link:function(c,d,e){var f=c.level.name;d.bind("click",function(){c.vs.setcurClickLevelName(f,e.save),b.asyncParseJSO(f).then(function(b){a.open("views/export.html",f+"_esps.txt",b)})})}}}]),angular.module("emuwebApp").directive("slideToggle",function(){return{restrict:"A",scope:{isOpen:"=slideToggle"},link:function(a,b,c){var d=parseInt(c.slideToggleDuration,10)||200;a.isOpen||b.stop().slideToggle(0),a.$watch("isOpen",function(a,c){a!==c&&b.stop().slideToggle(d)})}}}),angular.module("emuwebApp").directive("previewtrack",["viewState","Soundhandlerservice",function(a,b){return{restrict:"A",scope:{},link:function(c,d){var e=-1;d.bind("click",function(d){if(!$.isEmptyObject(b.wavJSO)){var f=a.curViewPort.eS-a.curViewPort.sS;e=a.getX(d)*(b.wavJSO.Data.length/d.originalEvent.target.width),a.isEditing()||c.$apply(function(){a.setViewPort(e-f/2,e+f/2)})}}),d.bind("mousedown",function(c){$.isEmptyObject(b.wavJSO)||(e=a.getX(c)*(b.wavJSO.Data.length/c.originalEvent.target.width))}),d.bind("mousemove",function(d){var f=0;switch(f=void 0===d.buttons?d.which:d.buttons){case 1:if(-1!==e){var g=a.curViewPort.eS-a.curViewPort.sS;e=a.getX(d)*(b.wavJSO.Data.length/d.originalEvent.target.width),a.isEditing()||c.$apply(function(){a.setViewPort(e-g/2,e+g/2)})}}}),d.bind("mouseup",function(){e=-1}),d.bind("mouseout",function(){e=-1})}}}]),angular.module("emuwebApp").service("Iohandlerservice",["$rootScope","$http","$location","$q","HistoryService","viewState","Soundhandlerservice","Ssffparserservice","Wavparserservice","Textgridparserservice","ConfigProviderService","Espsparserservice","Ssffdataservice","Websockethandler","DragnDropDataService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){var p={};return p.wsH=n,p.httpGetDefaultConfig=function(){var a=b.get("configFiles/default_emuwebappConfig.json");return a},p.httpGetPath=function(a,c){var d=b.get(a,{responseType:c});return d},p.getProtocol=function(){var a;return"CORS"===k.vals.main.comMode?alert("CORS version of getProtocol not implemented"):"WS"===k.vals.main.comMode&&(a=n.getProtocol()),a},p.getDoUserManagement=function(){var a;return"CORS"===k.vals.main.comMode?alert("CORS version of getDoUserManagement not implemented"):"WS"===k.vals.main.comMode&&(a=n.getDoUserManagement()),a},p.logOnUser=function(a,b){var c;return"CORS"===k.vals.main.comMode?alert("CORS version of logOnUser not implemented"):"WS"===k.vals.main.comMode&&(c=n.logOnUser(a,b)),c},p.getDBconfigFile=function(a){var c;return"CORS"===k.vals.main.comMode?alert("CORS version of getDBconfigFile not implemented"):"WS"===k.vals.main.comMode?c=n.getDBconfigFile():"DEMO"===k.vals.main.comMode&&(c=b.get("demoDBs/"+a+"/"+a+"_DBconfig.json")),c},p.getBundleList=function(a){var c;return"CORS"===k.vals.main.comMode?alert("CORS version of getBundleList not implemented"):"WS"===k.vals.main.comMode?c=n.getBundleList():"DEMO"===k.vals.main.comMode&&(c=b.get("demoDBs/"+a+"/"+a+"_bundleList.json")),c},p.getBundle=function(a,c,d){var e;return"CORS"===k.vals.main.comMode?alert("CORS version of getBundle not implemented"):"embedded"===k.vals.main.comMode?e=o.getBundle(a,c):"WS"===k.vals.main.comMode?e=n.getBundle(a,c):"DEMO"===k.vals.main.comMode&&(e=b.get("demoDBs/"+d+"/"+a+"_bndl.json")),e},p.saveBundle=function(a){var b;return"CORS"===k.vals.main.comMode?alert("CORS version of saveBundle not implemented"):"WS"===k.vals.main.comMode&&(b=n.saveBundle(a)),b},p.parseLabelFile=function(a,b,c,d){var e;return"ESPS"===d?e=l.asyncParseEsps(a,k.embeddedVals.labelGetUrl,"embeddedESPS"):"TEXTGRID"===d&&(e=j.asyncParseTextGrid(a,k.embeddedVals.labelGetUrl,"embeddedTEXTGRID")),e},p}]),angular.module("emuwebApp").service("Soundhandlerservice",["$document","Binarydatamaniphelper",function(a,b){var c={};return c.wavJSO={},c.player=a[0].createElement("audio"),c.player.isPlaying=!1,c.setPlayerSrc=function(a){var c=b.arrayBufferToBase64(a);this.player.src="data:audio/wav;base64,"+c},c.resetPlayerSrcFromTo=function(a,d){var e=c.wavJSO.BitsPerSample/8,f=c.wavJSO.origArrBuf.subarray(0,44),g=c.wavJSO.origArrBuf.subarray(44,c.wavJSO.Data.length*e),h=new DataView(f);h.setUint32(40,(d-a)*e,!0);var i=g.subarray(a*e,(d-a)*e),j=new Uint8Array(f.byteLength+i.byteLength);j.set(new Uint8Array(f),0),j.set(new Uint8Array(i),f.byteLength);var k=b.arrayBufferToBase64(j.buffer);c.player.src="data:audio/wav;base64,"+k},c.playFromTo=function(a,b){this.resetPlayerSrcFromTo(a,b),this.player.isPlaying?(this.player.isPlaying=!1,this.player.pause()):(this.player.isPlaying=!0,this.player.play())},c.player.addEventListener("ended",function(){this.isPlaying=!1},!1),c}]),angular.module("emuwebApp").directive("drawssff",["viewState","ConfigProviderService","Ssffdataservice","HistoryService","fontScaleService",function(a,b,c,d,e){return{restrict:"A",scope:{},link:function(f,g,h){f.trackName=h.ssffTrackname,f.assTrackName="",f.lastDraw=Date.now(),f.vs=a,f.hists=d,f.ssffds=c,h.$observe("ssffTrackname",function(a){f.trackName=a}),f.$watch("vs.curViewPort",function(a,b){(b.sS!==a.sS||b.eS!==a.eS)&&f.handleUpdate()},!0),f.$watch("vs.curPerspectiveIdx",function(){f.handleUpdate()},!0),f.$watch("vs.curCorrectionToolNr",function(){f.handleUpdate()},!0),f.$watch("hists.movesAwayFromLastSave",function(){f.handleUpdate()},!0),f.$watch("ssffds.data.length",function(){f.handleUpdate()},!0),f.$watch("vs.spectroSettings",function(){f.handleUpdate()},!0),f.handleUpdate=function(){var d=g[0].getContext("2d");if(d.clearRect(0,0,g[0].width,g[0].height),$.isEmptyObject(c.data))d.clearRect(0,0,g[0].width,g[0].height);else if(0!==c.data.length&&(f.assTrackName="",b.vals.perspectives[a.curPerspectiveIdx].signalCanvases.assign.forEach(function(d){if(d.signalCanvasName===f.trackName){f.assTrackName=d.ssffTrackName;var e=b.getSsffTrackConfig(d.ssffTrackName),h=c.getColumnOfTrack(e.name,e.columnName),i=c.getSampleRateAndStartTimeOfTrack(e.name),j=b.getLimsOfTrack(e.name);f.drawValues(a,g[0],b,h,i.sampleRate,i.startTime,j)}}),f.assTrackName="","OSCI"!==f.trackName&&"SPEC"!==f.trackName)){var e=b.getSsffTrackConfig(f.trackName),h=c.getColumnOfTrack(e.name,e.columnName),i=c.getSampleRateAndStartTimeOfTrack(e.name),j=b.getLimsOfTrack(e.name);f.drawValues(a,g[0],b,h,i.sampleRate,i.startTime,j)}},f.drawValues=function(a,c,d,g,h,i,j){var k,l,m=c.getContext("2d");"SPEC"===f.trackName&&"FORMANTS"===f.assTrackName?(k=a.spectroSettings.rangeFrom,l=a.spectroSettings.rangeTo):(k=g._minVal,l=g._maxVal);var n=a.getViewPortStartTime(),o=a.getViewPortEndTime(),p=Math.round(n*h+i),q=Math.round(o*h+i),r=q-p,s=g.values.slice(p,p+r);if(r<c.width&&r>=2){var t,u,v,w;angular.forEach(s[0],function(d,e){if($.isEmptyObject(j)||e>=j.minContourIdx&&e<=j.maxContourIdx){if($.isEmptyObject(j))m.strokeStyle="hsl("+e*(360/s[0].length)+",80%, 50%)",m.fillStyle="hsl("+e*(360/s[0].length)+",80%, 50%)";else{var r=j.maxContourIdx-j.minContourIdx+1;m.strokeStyle="hsl("+e*(360/r)+",80%, 50%)",m.fillStyle="hsl("+e*(360/r)+",80%, 50%)"}var x=b.getContourColorsOfTrack(f.assTrackName);if(void 0!==x&&void 0!==x.colors[e]&&(m.strokeStyle=b.vals.perspectives[a.curPerspectiveIdx].signalCanvases.contourColors[0].colors[e],m.fillStyle=b.vals.perspectives[a.curPerspectiveIdx].signalCanvases.contourColors[0].colors[e]),a.curCorrectionToolNr-1===e&&"SPEC"===f.trackName&&"FORMANTS"===f.assTrackName&&(m.strokeStyle=b.vals.colors.selectedContourColor,m.fillStyle=b.vals.colors.selectedContourColor),m.beginPath(),p>=1){var y=g.values[p-1],z=y[e];v=p-1,w=1/h*v+i,t=(w-n)/(o-n)*c.width,u=c.height-(z-k)/(l-k)*c.height,m.moveTo(t,u)}if(angular.forEach(s,function(a,b){v=p+b,w=1/h*v+i,t=(w-n)/(o-n)*c.width,u=c.height-(a[e]-k)/(l-k)*c.height,m.arc(t,u-1,2,0,2*Math.PI,!1),m.lineTo(t,u)}),q<g.values.length-1){var A=g.values[q+1],B=A[e];v=q+1,w=1/h*v+i,t=(w-n)/(o-n)*c.width,u=c.height-(B-k)/(l-k)*c.height,m.lineTo(t,u)}m.stroke()}})}else{m.strokeStyle="red";var x,y;2>=r?(y=e.getTextImageTwoLines(m,"Zoom out to","see contour(s)",b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.crossHairsColor),m.drawImage(y,0,0,y.width,y.height,c.width/2-y.width/2,25,y.width,y.height)):(x="Zoom in to see contour(s)",y=e.getTextImageTwoLines(m,"Zoom in to","see contour(s)",b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.crossHairsColor),m.drawImage(y,0,0,y.width,y.height,c.width/2-y.width/2,25,y.width,y.height))}}}}}]),angular.module("emuwebApp").service("Ssffparserservice",["$q",function(a){var b,c={},d=new ssffParserWorker;return d.says(function(a){"SUCCESS"===a.status.type?b.resolve(a):b.reject(a)},!1),c.asyncParseSsffArr=function(c){return b=a.defer(),d.tell({cmd:"parseArr",ssffArr:c}),b.promise},c.asyncJso2ssff=function(c){return b=a.defer(),d.tell({cmd:"jso2ssff",jso:JSON.stringify(c)}),b.promise},c}]),angular.module("emuwebApp").directive("mouseTrackAndCorrectionTool",["viewState","ConfigProviderService","Ssffdataservice","Drawhelperservice","HistoryService","Soundhandlerservice",function(a,b,c,d,e,f){return{restrict:"A",scope:{},link:function(g,h,i){var j,k,l,m,n,o,p,q,r=h[0],s=r.getContext("2d");i.$observe("ssffTrackname",function(a){a&&(p=a)}),i.$observe("bundleName",function(a){a&&(q=a,$.isEmptyObject(c.data)||0!==c.data.length&&(m=b.getSsffTrackConfig("FORMANTS"),void 0!==m&&(n=c.getColumnOfTrack(m.name,m.columnName),o=c.getSampleRateAndStartTimeOfTrack(m.name))))}),h.bind("mousedown",function(b){k=Math.round(a.getX(b)*a.getSamplesPerPixelVal(b)+a.curViewPort.sS),l=k,a.select(k,k),g.switchMarkupContext(b),g.$apply()}),h.bind("mousemove",function(d){var f=0;f=void 0===d.buttons?d.which:d.buttons;var i=a.getX(d);switch(a.curMousePosSample=Math.round(a.curViewPort.sS+i/h[0].width*(a.curViewPort.eS-a.curViewPort.sS)),f){case 0:if(a.getPermission("labelAction")&&(g.switchMarkupContext(d),!($.isEmptyObject(c.data)||0===c.data.length||a.getdragBarActive()||void 0===a.curCorrectionToolNr||a.getdragBarActive()||$.isEmptyObject(b.getAssignment(p))))){void 0===m&&(m=b.getSsffTrackConfig("FORMANTS")),n=c.getColumnOfTrack(m.name,m.columnName),o=c.getSampleRateAndStartTimeOfTrack(m.name);var j=a.getViewPortStartTime(),k=a.getViewPortEndTime(),l=Math.round(j*o.sampleRate+o.startTime),q=Math.round(k*o.sampleRate+o.startTime),t=q-l,u=n.values.slice(l,l+t),v=j+a.getX(d)/d.originalEvent.target.width*(k-j),w=Math.round((v+o.startTime)*o.sampleRate)-1,x=1/o.sampleRate*w+o.startTime;if(0>w-l||w-l>=u.length)return void console.log("early return");a.curPreselColumnSample=w-l;var y=(x-j)/(k-j)*r.width,z=r.height-u[a.curPreselColumnSample][a.curCorrectionToolNr-1]/(a.spectroSettings.rangeTo-a.spectroSettings.rangeFrom)*r.height;if(s.strokeStyle="black",s.fillStyle="black",s.beginPath(),s.arc(y,z-1,2,0,2*Math.PI,!1),s.closePath(),s.stroke(),s.fill(),d.shiftKey){var A=angular.copy(u[a.curPreselColumnSample][a.curCorrectionToolNr-1]),B=a.spectroSettings.rangeTo-a.getY(d)/d.originalEvent.target.height*a.spectroSettings.rangeTo;u[a.curPreselColumnSample][a.curCorrectionToolNr-1]=a.spectroSettings.rangeTo-a.getY(d)/d.originalEvent.target.height*a.spectroSettings.rangeTo;var C=e.updateCurChangeObj({type:"SSFF",trackName:m.name,sampleBlockIdx:l+a.curPreselColumnSample,sampleIdx:a.curCorrectionToolNr-1,oldValue:A,newValue:B});for(var D in C)x=1/o.sampleRate*C[D].sampleBlockIdx+o.startTime,y=(x-j)/(k-j)*r.width,z=r.height-C[D].newValue/(a.spectroSettings.rangeTo-a.spectroSettings.rangeFrom)*r.height,s.strokeStyle="red",s.fillStyle="red",s.beginPath(),s.arc(y,z-1,2,0,2*Math.PI,!1),s.closePath(),s.stroke(),s.fill()}}break;case 1:a.getdragBarActive()||g.setSelectDrag(d)}g.$apply()}),h.bind("mouseup",function(b){a.getdragBarActive()||(g.setSelectDrag(b),g.switchMarkupContext(b))}),h.bind("mouseleave",function(b){$.isEmptyObject(f)||$.isEmptyObject(f.wavJSO)||a.getdragBarActive()||a.getPermission("labelAction")&&g.switchMarkupContext(b,!1)}),g.switchMarkupContext=function(e,f){if(s.clearRect(0,0,r.width,r.height),"OSCI"==i.ssffTrackname)d.drawViewPortTimes(s,!0),d.drawCurViewPortSelected(s,!0);else if("SPEC"==i.ssffTrackname)d.drawCurViewPortSelected(s,!1),d.drawMinMaxAndName(s,"",a.spectroSettings.rangeFrom,a.spectroSettings.rangeTo,2);else{var g=b.getSsffTrackConfig(i.ssffTrackname),h=c.getColumnOfTrack(g.name,g.columnName);d.drawCurViewPortSelected(s,!1),d.drawMinMaxAndName(s,i.ssffTrackname,h._minVal,h._maxVal,2)}f!==!1&&b.vals.restrictions.drawCrossHairs&&d.drawCrossHairs(s,e,a.spectroSettings.rangeFrom,a.spectroSettings.rangeTo,"Hz",i.ssffTrackname),d.drawMovingBoundaryLine(s)},g.setSelectDrag=function(b){j=Math.round(a.getX(b)*a.getSamplesPerPixelVal(b)+a.curViewPort.sS),j>k?(l=j,a.select(k,l)):(k=j,a.select(k,l)),g.$apply()}}}}]),angular.module("emuwebApp").service("Drawhelperservice",["viewState","ConfigProviderService","Soundhandlerservice","fontScaleService","Ssffdataservice",function(a,b,c,d,e){function f(a,b,c){return a.measureText(b).width*c}function g(a,b,c,d){return b.toString().length>c.toString().length?f(a,b,d):f(a,c,d)}function h(a,b,c,d,e,f,g){var h=f.getContext("2d"),i=1,j=Math.round(c*(f.height/d)),k=b*i,l=Math.round((f.height-j)/2),m=Math.round(e*(f.height/d)),n=(b-1)*i,o=Math.round((f.height-m)/2);h.fillStyle=g.vals.colors.osciColor,h.strokeStyle=g.vals.colors.osciColor,h.moveTo(n,o),h.lineTo(k,l)}var i={};return i.osciPeaks=[],i.calculatePeaks=function(a,b,c){var d,e=(a.curViewPort.eS+1-a.curViewPort.sS)/b.width,f=1,g=[],h=1/0,i=-1/0;if(1>=e)d=0===a.curViewPort.sS?c.subarray(a.curViewPort.sS,a.curViewPort.eS+2):c.subarray(a.curViewPort.sS-1,a.curViewPort.eS+2),h=Math.min.apply(Math,d),i=Math.max.apply(Math,d),g=Array.prototype.slice.call(d);else{d=c.subarray(a.curViewPort.sS,a.curViewPort.eS);for(var j=0;j<b.width;j++){for(var k=0,l=0;f>l;l++){for(var m=d.subarray(j*e,(j+1)*e),n=0,o=0,p=m.length;p>o;o++)n+=m[o];k+=n/m.length}g[j]=k,k>i&&(i=k)}}return{peaks:g,minPeak:h,maxPeak:i,samplePerPx:e}},i.freshRedrawDrawOsciOnCanvas=function(a,b,c,d,e){var f=b.getContext("2d");if(f.clearRect(0,0,b.width,b.height),c.peaks&&c.samplePerPx>=1)f.beginPath(),c.peaks.forEach(function(d,f){0!==f&&h(a,f,d,c.maxPeak,c.peaks[f-1],b,e)}),f.stroke();else if(c.samplePerPx<1){var g=1/c.samplePerPx/2,i=a.curViewPort.sS;f.strokeStyle=e.vals.colors.osciColor,f.fillStyle=e.vals.colors.osciColor;var j;if(0===a.curViewPort.sS){for(f.moveTo(g,(c.peaks[0]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height),j=0;j<c.peaks.length;j++)f.lineTo(j/c.samplePerPx+g,(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height);for(f.stroke(),j=0;j<c.peaks.length;j++)f.beginPath(),f.arc(j/c.samplePerPx+g,(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-3,4,0,2*Math.PI,!1),f.stroke(),f.fill(),e.vals.restrictions.drawSampleNrs&&(f.strokeText(i,j/c.samplePerPx+g,(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-10),i+=1)}else{for(f.beginPath(),f.moveTo(-g,b.height-(c.peaks[0]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height),j=1;j<=c.peaks.length;j++)f.lineTo(j/c.samplePerPx-g,b.height-((c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height+3));for(f.stroke(),j=1;j<=c.peaks.length;j++)f.beginPath(),f.arc(j/c.samplePerPx-g,b.height-(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-3,4,0,2*Math.PI,!1),f.stroke(),f.fill(),e.vals.restrictions.drawSampleNrs&&(f.fillText(i,j/c.samplePerPx-g,b.height-(c.peaks[j]-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-10),i+=1)}}if(e.vals.restrictions.drawZeroLine){if(f.strokeStyle=e.vals.colors.zeroLineColor,f.fillStyle=e.vals.colors.zeroLineColor,"Google Inc."===navigator.vendor&&f.setLineDash([2]),c.samplePerPx>=1)f.beginPath(),f.moveTo(0,b.height/2),f.lineTo(b.width,b.height/2),f.stroke(),f.fillText("0",5,b.height/2-5,b.width);else{var k=b.height-(0-c.minPeak)/(c.maxPeak-c.minPeak)*b.height;f.beginPath(),f.moveTo(0,k),f.lineTo(b.width,k),f.stroke(),f.fill(),f.fillText("0",5,b.height-(0-c.minPeak)/(c.maxPeak-c.minPeak)*b.height-5,b.width)}"Google Inc."===navigator.vendor&&f.setLineDash([0])}},i.drawMovingBoundaryLine=function(c){var d,e;if(e=a.getSampleDist(c.canvas.width),d="SEGMENT"===a.getcurMouseLevelType()?0:e/2,a.movingBoundary){c.fillStyle=b.vals.colors.selectedBoundaryColor;var f=Math.round(a.getPos(c.canvas.width,a.movingBoundarySample));a.getcurMouseisLast()?c.fillRect(f+e,0,1,c.canvas.height):c.fillRect(f+d,0,1,c.canvas.height)}},i.drawCurViewPortSelected=function(e,h){var i,j,k,l,m;j=a.getSampleDist(e.canvas.width),i="seg"===a.getcurMouseLevelType()?0:j/2;var n=a.getPos(e.canvas.width,a.curViewPort.selectS),o=a.getPos(e.canvas.width,a.curViewPort.selectE);if(n===o)e.fillStyle=b.vals.colors.selectedBorderColor,e.fillRect(n+i,0,2,e.canvas.height),h&&a.curViewPort.sS!==a.curViewPort.selectS&&-1!==a.curViewPort.selectS&&(m=e.canvas.width/e.canvas.offsetWidth,k=g(e,a.curViewPort.selectS,a.round(a.curViewPort.selectS/c.wavJSO.SampleRate,6),m),l=d.getTextImageTwoLines(e,a.curViewPort.selectS,a.round(a.curViewPort.selectS/c.wavJSO.SampleRate,6),b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!0),e.drawImage(l,0,0,l.width,l.height,o+5,0,l.width,l.height));else if(e.fillStyle=b.vals.colors.selectedAreaColor,e.fillRect(n,0,o-n,e.canvas.height),e.strokeStyle=b.vals.colors.selectedBorderColor,e.beginPath(),e.moveTo(n,0),e.lineTo(n,e.canvas.height),e.moveTo(o,0),e.lineTo(o,e.canvas.height),e.closePath(),e.stroke(),h&&(m=e.canvas.width/e.canvas.offsetWidth,k=g(e,a.curViewPort.selectS,a.round(a.curViewPort.selectS/c.wavJSO.SampleRate,6),m),l=d.getTextImageTwoLines(e,a.curViewPort.selectS,a.round(a.curViewPort.selectS/c.wavJSO.SampleRate,6),b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!1),e.drawImage(l,0,0,l.width,l.height,n-k-5,0,l.width,l.height),l=d.getTextImageTwoLines(e,a.curViewPort.selectE,a.round(a.curViewPort.selectE/c.wavJSO.SampleRate,6),b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!0),e.drawImage(l,0,0,l.width,l.height,o+5,0,l.width,l.height),k=f(e,a.round((a.curViewPort.selectE-a.curViewPort.selectS)/c.wavJSO.SampleRate,6),m),o-n>k)){var p=a.curViewPort.selectE-a.curViewPort.selectS-1,q=a.round((a.curViewPort.selectE-a.curViewPort.selectS)/c.wavJSO.SampleRate,6);k=g(e,p,q,m),l=d.getTextImageTwoLines(e,p,q,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!1),e.drawImage(l,0,0,l.width,l.height,n+(o-n)/2-k/2,0,l.width,l.height)}},i.drawCrossHairs=function(c,f,g,h,i,j){if(b.vals.restrictions.drawCrossHairs){c.strokeStyle=b.vals.colors.crossHairsColor,c.fillStyle=b.vals.colors.crossHairsColor,"Google Inc."===navigator.vendor&&c.setLineDash([2]);var k=a.getX(f),l=a.getY(f);"Google Inc."===navigator.vendor&&c.setLineDash([0]),c.font=b.vals.font.fontPxSize+"px "+b.vals.font.fontType;var m=a.round(h-l/c.canvas.height*h,2),n=c.measureText(m+i).width,o=Math.round(a.curViewPort.sS+k/c.canvas.width*(a.curViewPort.eS-a.curViewPort.sS)),p=a.round(a.getViewPortStartTime()+k/c.canvas.width*(a.getViewPortEndTime()-a.getViewPortStartTime()),6),q=d.getTextImage(c,m+i,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.crossHairsColor,!0),r=d.getTextImageTwoLines(c,o,p,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.crossHairsColor,!0);if(void 0!==h||void 0!==g)if("OSCI"==j)c.beginPath(),c.moveTo(k,0),c.lineTo(k,c.canvas.height),c.stroke();else if("SPEC"==j)c.drawImage(q,0,0,q.width,q.height,5,l,q.width,q.height),c.drawImage(q,0,0,q.width,q.height,c.canvas.width-5-n*(c.canvas.width/c.canvas.offsetWidth),l,q.width,q.height),c.beginPath(),c.moveTo(0,l),c.lineTo(5,l+5),c.moveTo(0,l),c.lineTo(c.canvas.width,l),c.lineTo(c.canvas.width-5,l+5),c.moveTo(k,0),c.lineTo(k,c.canvas.height),c.stroke();else{var s=b.getSsffTrackConfig(j),t=e.getColumnOfTrack(s.name,s.columnName);m=a.round(t._maxVal-l/c.canvas.height*t._maxVal,2),q=d.getTextImage(c,m,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.crossHairsColor,!0),c.drawImage(q,0,0,q.width,q.height,5,l,q.width,q.height),c.drawImage(q,0,0,q.width,q.height,c.canvas.width-5-n*(c.canvas.width/c.canvas.offsetWidth),l,q.width,q.height),c.beginPath(),c.moveTo(0,l),c.lineTo(5,l+5),c.moveTo(0,l),c.lineTo(c.canvas.width,l),c.lineTo(c.canvas.width-5,l+5),c.moveTo(k,0),c.lineTo(k,c.canvas.height),c.stroke()}c.drawImage(r,0,0,r.width,r.height,k+5,0,r.width,r.height)}},i.drawMinMaxAndName=function(c,e,f,g,h){c.strokeStyle=b.vals.colors.labelColor,c.fillStyle=b.vals.colors.labelColor;var i=c.canvas.height/c.canvas.offsetHeight,j=3*b.vals.font.fontPxSize/4,k=j*i;if(c.beginPath(),c.moveTo(0,0),c.lineTo(5,5),c.moveTo(0,c.canvas.height),c.lineTo(5,c.canvas.height-5),c.stroke(),c.closePath(),""!==e){c.font=b.vals.font.fontPxSize+"px "+b.vals.font.fontType;var l=d.getTextImage(c,e,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!0);c.drawImage(l,0,c.canvas.height/2-b.vals.font.fontPxSize*i/2)}if(void 0!==g){var m=d.getTextImage(c,"max: "+a.round(g,h),j,b.vals.font.fontType,b.vals.colors.endBoundaryColor);c.drawImage(m,5,5,m.width,m.height)}void 0!==f&&(m=d.getTextImage(c,"min: "+a.round(f,h),j,b.vals.font.fontType,b.vals.colors.endBoundaryColor),c.drawImage(m,5,c.canvas.height-k-5,m.width,m.height))},i.drawViewPortTimes=function(e){e.strokeStyle=b.vals.colors.labelColor,e.fillStyle=b.vals.colors.labelColor,e.font=b.vals.font.fontPxSize+"px "+b.vals.font.fontType,e.beginPath(),e.moveTo(0,0),e.lineTo(5,5),e.moveTo(e.canvas.width,0),e.lineTo(e.canvas.width-5,5),e.closePath(),e.stroke();var f,h,i,j,k=e.canvas.width/e.canvas.offsetWidth;e.canvas.height/e.canvas.offsetHeight,a.curViewPort&&(f=a.round(a.curViewPort.sS/c.wavJSO.SampleRate,6),h=a.round(a.curViewPort.eS/c.wavJSO.SampleRate,6),i=d.getTextImageTwoLines(e,a.curViewPort.sS,f,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!0),e.drawImage(i,5,5),j=g(e,a.curViewPort.eS,h,k),i=d.getTextImageTwoLines(e,a.curViewPort.eS,h,b.vals.font.fontPxSize,b.vals.font.fontType,b.vals.colors.labelColor,!1),e.drawImage(i,0,0,i.width,i.height,e.canvas.width-j-5,0,i.width,i.height))},i}]),angular.module("emuwebApp").service("HistoryService",["$log","Ssffdataservice","LevelService","LinkService","ConfigProviderService","viewState","Soundhandlerservice",function(a,b,c,d,e,f){function g(a,g){Object.keys(a).forEach(function(h){var i=a[h];if("SSFF"===i.type)if(g){f.historyActionTxt="UNDO: SSFF manipulation";var j=e.getSsffTrackConfig(i.trackName),k=b.getColumnOfTrack(j.name,j.columnName);k.values[i.sampleBlockIdx][i.sampleIdx]=i.oldValue}else{f.historyActionTxt="REDO: SSFF manipulation";var j=e.getSsffTrackConfig(i.trackName),k=b.getColumnOfTrack(j.name,j.columnName);k.values[i.sampleBlockIdx][i.sampleIdx]=i.newValue}else if("ANNOT"===i.type)switch(i.action){case"MOVEBOUNDARY":g?(f.historyActionTxt="UNDO: MOVEBOUNDARY",c.moveBoundary(i.name,i.id,-i.movedBy,i.isFirst,i.isLast)):(f.historyActionTxt="REDO: MOVEBOUNDARY",c.moveBoundary(i.name,i.id,i.movedBy,i.isFirst,i.isLast));break;case"MOVESEGMENT":g?(f.historyActionTxt="UNDO: MOVESEGMENT",c.moveSegment(i.name,i.id,i.length,-i.movedBy)):(f.historyActionTxt="REDO: MOVESEGMENT",c.moveSegment(i.name,i.id,i.length,i.movedBy));break;case"MOVEEVENT":g?(f.historyActionTxt="UNDO: MOVEEVENT",c.moveEvent(i.name,i.id,-i.movedBy)):(f.historyActionTxt="REDO: MOVEEVENT",c.moveEvent(i.name,i.id,i.movedBy));break;case"RENAMELABEL":g?(f.historyActionTxt="UNDO: RENAMELABEL",c.renameLabel(i.name,i.id,i.attrIndex,i.oldValue)):(f.historyActionTxt="REDO: RENAMELABEL",c.renameLabel(i.name,i.id,i.attrIndex,i.newValue));break;case"RENAMELEVEL":g?(f.historyActionTxt="UNDO: RENAMELEVEL",c.renameLevel(i.newname,i.name,i.curPerspectiveIdx)):(f.historyActionTxt="REDO: RENAMELEVEL",c.renameLevel(i.name,i.newname,i.curPerspectiveIdx));
break;case"DELETELEVEL":g?(f.historyActionTxt="UNDO: DELETELEVEL",c.insertLevel(i.level,i.id,i.curPerspectiveIdx)):(f.historyActionTxt="REDO: DELETELEVEL",c.deleteLevel(i.id,i.curPerspectiveIdx));break;case"DELETEBOUNDARY":g?(f.historyActionTxt="UNDO: DELETEBOUNDARY",c.deleteBoundaryInvers(i.name,i.id,i.isFirst,i.isLast,i.deletedSegment)):(f.historyActionTxt="REDO: DELETEBOUNDARY",c.deleteBoundary(i.name,i.id,i.isFirst,i.isLast));break;case"DELETESEGMENTS":g?(f.historyActionTxt="UNDO: DELETESEGMENTS",c.deleteSegmentsInvers(i.name,i.id,i.length,i.deletedSegment)):(f.historyActionTxt="REDO: DELETESEGMENTS",c.deleteSegments(i.name,i.id,i.length));break;case"DELETEEVENT":g?(f.historyActionTxt="UNDO: DELETEEVENT",c.insertEvent(i.name,i.start,i.pointName,i.id)):(f.historyActionTxt="REDO: DELETEEVENT",c.deleteEvent(i.name,i.id));break;case"DELETELINKSTO":g?(f.historyActionTxt="UNDO: DELETELINKSTO",d.insertLinksTo(i.deletedLinks)):(f.historyActionTxt="REDO: DELETELINKSTO",d.deleteLinksTo(i.id));break;case"DELETELINKBOUNDARY":g?(f.historyActionTxt="UNDO: DELETELINKBOUNDARY",d.deleteLinkBoundaryInvers(i.deletedLinks)):(f.historyActionTxt="REDO: DELETELINKBOUNDARY",d.deleteLinkBoundary(i.id,i.neighbourId));break;case"DELETELINKSEGMENT":g?(f.historyActionTxt="UNDO: DELETELINKSEGMENT",d.deleteLinkSegmentInvers(i.deletedLinks)):(f.historyActionTxt="REDO: DELETELINKSEGMENT",d.deleteLinkSegment(i.segments));break;case"INSERTLEVEL":g?(f.historyActionTxt="UNDO: INSERTLEVEL",c.deleteLevel(i.id,i.curPerspectiveIdx)):(f.historyActionTxt="REDO: INSERTLEVEL",c.insertLevel(i.level,i.id,i.curPerspectiveIdx));break;case"INSERTSEGMENTS":g?(f.historyActionTxt="UNDO: INSERTSEGMENTS",c.insertSegmentInvers(i.name,i.start,i.end,i.segName)):(f.historyActionTxt="REDO: INSERTSEGMENTS",c.insertSegment(i.name,i.start,i.end,i.segName,i.ids));break;case"INSERTEVENT":g?(f.historyActionTxt="UNDO: INSERTEVENT",c.deleteEvent(i.name,i.id)):(f.historyActionTxt="REDO: INSERTEVENT",c.insertEvent(i.name,i.start,i.pointName,i.id));break;case"INSERTLINKSTO":g?(f.historyActionTxt="UNDO: INSERTLINKSTO",d.deleteLinksTo(i.parentID,i.childIDs)):(f.historyActionTxt="REDO: INSERTLINKSTO",d.insertLinksTo(i.parentID,i.childIDs));break;case"EXPANDSEGMENTS":g?(f.historyActionTxt="UNDO: EXPANDSEGMENTS",c.expandSegment(i.rightSide,i.item,i.name,-i.changeTime)):(f.historyActionTxt="REDO: EXPANDSEGMENTS",c.expandSegment(i.rightSide,i.item,i.name,i.changeTime))}})}var h={};h.movesAwayFromLastSave=0;var i=[],j=[],k={};return h.updateCurChangeObj=function(a){var b;if("SSFF"===a.type)b=String(a.type+"#"+a.trackName)+"#"+String(a.sampleBlockIdx)+"#"+String(a.sampleIdx),k[b]?(a.oldValue=k[b].oldValue,k[b]=a):k[b]=a;else if("ANNOT"===a.type)switch(a.action){case"MOVEBOUNDARY":case"MOVEEVENT":case"MOVESEGMENT":case"INSERTEVENT":case"DELETEEVENT":b=String(a.type+"#"+a.action+"#"+a.name+"#"+a.id),k[b]?(a.movedBy+=k[b].movedBy,k[b]=a):k[b]=a;break;case"INSERTLINKSTO":case"DELETELINKSTO":case"DELETELINKBOUNDARY":case"DELETELINKSEGMENT":case"DELETEBOUNDARY":case"DELETESEGMENTS":b=String(a.type+"#"+a.action+"#"+a.name),k[b]?(a.oldValue=k[b].oldValue,k[b]=a):k[b]=a}return k},h.addCurChangeObjToUndoStack=function(){j=[],$.isEmptyObject(k)||(i.push(k),h.movesAwayFromLastSave+=1),a.info(k),k={}},h.addObjToUndoStack=function(a){j=[];var b={},c=String(a.type+"#"+a.action+"#"+a.name+"#"+a.id);b[c]=angular.copy(a),$.isEmptyObject(b)||(i.push(b),h.movesAwayFromLastSave+=1),k={}},h.undo=function(){if(i.length>0){var a=angular.copy(i[i.length-1]);j.push(a),g(a,!0),i.pop(),h.movesAwayFromLastSave-=1}},h.redo=function(){if(j.length>0){var a=angular.copy(j[j.length-1]);i.push(a),g(a,!1),j.pop(),h.movesAwayFromLastSave+=1}},h.getNrOfPossibleUndos=function(){return i.length},h.getCurrentStack=function(){return{undo:i,redo:j}},h.resetToInitState=function(){i=[],j=[],k={},h.movesAwayFromLastSave=0},h}]),angular.module("emuwebApp").service("Wavparserservice",["$q",function(a){var b,c={},d=new wavParserWorker;return d.says(function(a){"SUCCESS"===a.status.type?b.resolve(a.data):b.reject(a)}),c.parseWavArrBuf=function(c){return b=a.defer(),d.tell({cmd:"parseBuf",buffer:c}),b.promise},c}]),angular.module("emuwebApp").service("Textgridparserservice",["$q","DataService","viewState","Soundhandlerservice",function(a,b,c,d){var e,f={},g=new textGridParserWorker;return g.says(function(a){"SUCCESS"===a.status.type?e.resolve(a.data):e.reject(a.data)},!1),f.asyncToTextGrid=function(){return e=a.defer(),g.tell({cmd:"toTextGrid",levels:b.getData().levels,sampleRate:d.wavJSO.SampleRate,buffLength:d.wavJSO.Data.length}),e.promise},f.asyncParseTextGrid=function(b,c,f){return e=a.defer(),g.tell({cmd:"parseTG",textGrid:b,sampleRate:d.wavJSO.SampleRate,annotates:c,name:f}),e.promise},f}]),angular.module("emuwebApp").factory("uuid",function(){function a(a){var b=(Math.random().toString(16)+"000000000").substr(2,8);return a?"-"+b.substr(0,4)+"-"+b.substr(4,4):b}var b={};return b.new=function(){return a()+a(!0)+a(!0)+a()},b.newHash=function(){return a()+a(!0)+a(!0)+a()},b.empty=function(){return"00000000-0000-0000-0000-000000000000"},b}),angular.module("emuwebApp").factory("browserDetector",function(){var a={};return a.isMobile={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)},any:function(){return a.isMobile.Android()||a.isMobile.BlackBerry()||a.isMobile.iOS()||a.isMobile.Opera()||a.isMobile.Windows()}},a.isBrowser={Firefox:function(){return navigator.userAgent.match(/Firefox/i)},Chrome:function(){return navigator.userAgent.match(/Chrome/i)},InternetExplorer:function(){return navigator.userAgent.match(/MSIE/i)},Opera:function(){return navigator.userAgent.match(/Opera/i)},PhantomJS:function(){return navigator.userAgent.match(/PhantomJS/i)},any:function(){return a.isBrowser.Firefox()||a.isBrowser.Chrome()||a.isBrowser.InternetExplorer()||a.isBrowser.Opera()||a.isBrowser.PhantomJS()}},a.isMobileDevice=function(){var b=a.isMobile.any();return null===b?!1:b.length>0?!0:!1},a.isDesktopDevice=function(){var b=a.isBrowser.any();return null===b?!1:b.length>0?!0:!1},a}),angular.module("emuwebApp").service("fontScaleService",function(){var a={};return a.lastTextWidth=null,a.spaceTop=0,a.getTextImage=function(b,c,d,e,f){var g=b.canvas.height/b.canvas.offsetHeight,h=b.canvas.width/b.canvas.offsetWidth;d=Math.floor(d+2-g/2);var i=document.createElement("canvas");i.setAttribute("width",Math.round(200*h)),i.setAttribute("height",Math.round(100*g));var j=i.getContext("2d");return j.save(),j.font=d+"px "+e,j.fillStyle=f,j.scale(h,g),j.fillText(c,0,d+a.spaceTop),a.lastTextWidth=j.measureText(c).width*h,j.restore(),i},a.getLastImageWidth=function(){return a.lastTextWidth},a.getTextImageTwoLines=function(b,c,d,e,f,g,h){var i=b.canvas.height/b.canvas.offsetHeight,j=b.canvas.width/b.canvas.offsetWidth;e=Math.floor(e+2-i/2);var k=document.createElement("canvas");k.setAttribute("width",Math.round(200*j)),k.setAttribute("height",Math.round(100*i));var l=k.getContext("2d");if(l.save(),l.font=e+"px "+f,l.fillStyle=g,l.scale(j,i),a.lastTextWidth=l.measureText(c).width*j,h)l.fillText(c,0,e+a.spaceTop),l.fillText(d,0,2*e+a.spaceTop);else{var m=l.measureText(c).width,n=l.measureText(d).width;m>n?(l.fillText(c,0,e+a.spaceTop),l.fillText(d,m-n,2*e+a.spaceTop)):(l.fillText(c,n-m,e+a.spaceTop),l.fillText(d,0,2*e+a.spaceTop))}return l.restore(),k},a}),angular.module("emuwebApp").service("Espsparserservice",["$q","LevelService","Soundhandlerservice",function(a,b,c){var d,e={},f=new espsParserWorker;return f.says(function(a){"SUCCESS"===a.status.type?d.resolve(a.data):d.reject(a.data)},!1),e.asyncParseEsps=function(b,e,g){return d=a.defer(),f.tell({cmd:"parseESPS",esps:b,sampleRate:c.wavJSO.SampleRate,annotates:e,name:g}),d.promise},e.asyncParseJSO=function(e){return d=a.defer(),f.tell({cmd:"parseJSO",level:b.getLevelDetails(e).level,sampleRate:c.wavJSO.SampleRate}),d.promise},e}]),angular.module("emuwebApp").controller("LoginCtrl",["$scope","$rootScope","$http","ConfigProviderService","Iohandlerservice","viewState","modalService",function(a,b,c,d,e,f,g){a.loginData={username:"",password:"",errorMsg:""},a.tryLogin=function(){e.logOnUser(a.loginData.username,a.loginData.password).then(function(b){"LOGGEDON"===b?g.confirm():a.loginData.errorMsg="ERROR: "+b})},a.cursorInTextField=function(){f.setEditing(!0),f.setcursorInTextField(!0)},a.cursorOutOfTextField=function(){f.setEditing(!1),f.setcursorInTextField(!1)},a.cancel=function(){g.close()}}]),angular.module("emuwebApp").service("Ssffdataservice",["viewState","Soundhandlerservice",function(a,b){var c={};return c.data=[],c.getColumnOfTrack=function(a,b){var d={};return c.data.forEach(function(c){c.ssffTrackName===a&&c.Columns.forEach(function(a){a.name===b&&(d=a)})}),void 0!==d?d:void 0},c.getSampleRateAndStartTimeOfTrack=function(a){var b={};return c.data.forEach(function(c){c.ssffTrackName===a&&(b.sampleRate=c.sampleRate,b.startTime=c.startTime)}),void 0!==b?b:void 0},c.calculateSamplePosInVP=function(a,c,d){var e=a/c+d,f=Math.round(e*b.wavJSO.SampleRate);return f},c}]),angular.module("emuwebApp").service("DataService",function(){var a={};return a.data={},a.maxItemID=0,a.getData=function(){return a.data},a.setLevelData=function(b){a.data.levels=b},a.getLevelData=function(){return a.data.levels},a.getLevelDataAt=function(b){return a.data.levels[b]},a.insertLevelDataAt=function(b,c){a.data.levels.splice(b,0,c)},a.deleteLevelDataAt=function(b){a.data.levels.splice(b,1)},a.getLinkData=function(){return a.data.links},a.setLinkData=function(b){a.data.links=b},a.insertLinkData=function(b){a.data.links.push(b)},a.deleteLinkDataAt=function(b){a.data.links.splice(b,1)},a.insertLinkDataAt=function(b,c){a.data.links.splice(b,0,c)},a.changeLinkDataAt=function(b,c,d){a.data.links[b].fromID=c,a.data.links[b].toID=d},a.setData=function(b){angular.copy(b,a.data),angular.forEach(a.data.levels,function(b){b.items.forEach(function(b){b.id>a.maxItemID&&(a.maxItemID=b.id)})})},a.getNewId=function(){return a.maxItemID+=1,a.maxItemID},a.raiseId=function(b){a.maxItemID+=b},a.lowerId=function(b){a.maxItemID-=b},a}),angular.module("emuwebApp").service("LevelService",["$q","DataService","LinkService","ConfigProviderService","Soundhandlerservice","viewState","Ssffdataservice","ArrayHelperService",function(a,b,c,d,e,f){function g(a,b){var c;return angular.forEach(b,function(b,d){b.name===a&&(c=d)}),c}var h={};return h.lasteditArea=null,h.lasteditAreaElem=null,h.getLevelDetails=function(a){var c=null,d=null;return angular.forEach(b.getLevelData(),function(b,e){b.name===a&&(c=b,d=e)}),{level:c,id:d}},h.getLevelsByType=function(a){var c=[];return angular.forEach(b.getLevelData(),function(b){var d=b.type;a.indexOf(d)>=0&&c.push(b)}),c},h.getOrderById=function(a,c){var d=void 0;return angular.forEach(b.getLevelData(),function(b){b.name===a&&b.items.forEach(function(a,b){a.id===c&&(d=b)})}),d},h.getIdByOrder=function(a,c){var d=null;return angular.forEach(b.getLevelData(),function(b){b.name===a&&b.items.forEach(function(a,b){b==c&&(d=a.id)})}),d},h.getItemDetails=function(a,c){var d=null;return angular.forEach(b.getLevelData(),function(b){b.name===a&&b.items.forEach(function(a,b){b==c&&(d=a)})}),d},h.getLastItem=function(a){var c=null;return angular.forEach(b.getLevelData(),function(b){b.name===a&&(c=b.items[b.items.length-1])}),c},h.getNextItem=function(a,c){var d=null;return angular.forEach(b.getLevelData(),function(b){b.name===a&&b.items.forEach(function(a,e){a.id==c&&(d=b.items[e+1])})}),d},h.getItemFromLevelById=function(a,c){var d=null;return angular.forEach(b.getLevelData(),function(b){b.name===a&&b.items.forEach(function(a){a.id==c&&(d=a)})}),d},h.getItemsFromLevelByIdAndLength=function(a,b,c){for(var d=[],e=b,f=0;c>f;f++){var g=h.getItemFromLevelById(a,e);e=h.getNextItem(a,g.id),d.push(g)}return d},h.getlasteditAreaElem=function(){return h.lasteditAreaElem},h.setlasteditAreaElem=function(a){h.lasteditAreaElem=a},h.setlasteditArea=function(a){h.lasteditArea=a},h.getlasteditArea=function(){return h.lasteditArea},h.getlastID=function(){return h.lasteditArea.substr(1)},h.deleteEditArea=function(){null!==h.getlasteditArea()&&$("."+h.getlasteditArea()).remove(),f.editing=!1},h.openEditArea=function(a,b,c){var d=f.getcurClickLevelName(),e=f.getCurAttrDef(d),i=g(e,a.labels),j=b.find("canvas").context.getContext("2d"),k=j.canvas.clientWidth,l=j.canvas.offsetLeft,m=j.canvas.offsetTop,n=j.canvas.clientHeight-1,o=10;void 0!==i&&a.labels[i].value.length>0&&(o=7*a.labels[i].value.length);var p="";if(a.labels.length>0&&(p=void 0!==a.labels[i]?a.labels[i].value:""),"SEGMENT"===c){var q=Math.floor(f.getPos(k,a.sampleStart)+l),r=Math.ceil(f.getPos(k,a.sampleStart+a.sampleDur+1)+l),s=r-q;if(2*o>s){var t=f.curViewPort.eS-f.curViewPort.sS;if(!(10>=t))return f.zoomViewPort(!0,this),void h.openEditArea(a,b,c);h.createEditAreaElement(b,q,m,r-q,n,a.labels[i].value,a.id)}h.createEditAreaElement(b,q,m,r-q,n,p,a.id)}else{var q=f.getPos(k,a.samplePoint)+l-o/2,r=f.getPos(k,a.samplePoint)+l+o/2,s=r-q;2*o>s&&(s=2*o),h.createEditAreaElement(b,q,m,s,n,p,a.id)}h.createSelection(b.find("textarea")[0],0,p.length)},h.createSelection=function(a,b,c){if(a.createTextRange){var d=a.createTextRange();d.collapse(!0),d.moveStart("character",b),d.moveEnd("character",c),d.select()}else a.setSelectionRange?a.setSelectionRange(b,c):a.selectionStart&&(a.selectionStart=b,a.selectionEnd=c);a.focus()},h.createEditAreaElement=function(a,b,c,d,e,f,g){var h="_"+g;a.prepend($("<textarea>").attr({id:h,"class":h+" emuwebapp-labelEdit","ng-model":"message",autofocus:"true"}).css({left:Math.round(b+2)+"px",top:Math.round(c)+"px",width:Math.round(d)-4+"px",height:Math.round(e)-1+"px","padding-top":Math.round(e/3+1)+"px","overflow-x":"hidden","overflow-y":"hidden"}).text(f))},h.insertItemDetails=function(a,c,e,g,h,i){var j,k=d.getLevelDefinition(c).attributeDefinitions,l=f.getCurAttrDef(c);void 0===k&&(k=[]),angular.forEach(b.getLevelData(),function(b){if(b.name===c){if("SEGMENT"==b.type)if(j={id:a,sampleStart:h,sampleDur:i,labels:[]},k.length>0)for(var d=0;d<k.length;d++)j.labels.push(k[d].name===l?{name:k[d].name,value:g}:{name:k[d].name,value:g});else j.labels.push({name:c,value:g});else if("EVENT"==b.type)if(j={id:a,samplePoint:h,labels:[]},k.length>0)for(var d=0;d<k.length;d++)j.labels.push(k[d].name===l?{name:k[d].name,value:g}:{name:k[d].name,value:g});else j.labels.push({name:c,value:g});b.items.splice(e,0,j)}})},h.updateSegItemInLevel=function(a,c,d,e,f,g){angular.forEach(b.getLevelData(),function(b){b.name===a&&b.items.forEach(function(a){a.id==c&&(void 0!==f&&(a.sampleStart=f),void 0!==g&&(a.sampleDur=g),void 0!==d&&(a.labels[e].value=d))})})},h.setPointDetails=function(a,c,d,e){angular.forEach(b.getLevelData(),function(b){b.name===a&&b.items.forEach(function(a){a.id==c&&(a.samplePoint=e,a.labels[0].value=d)})})},h.getItemNeighboursFromLevel=function(a,c,d){var e=void 0,f=void 0;return angular.forEach(b.getLevelData(),function(b){b.name===a&&b.items.forEach(function(a,g){a.id==c&&(e=b.items[g-1]),a.id==d&&(f=b.items[g+1])})}),{left:e,right:f}},h.getClosestItem=function(a,b,c){var d=h.getLevelDetails(b).level,e=void 0,f=void 0,g=void 0,i=void 0;if(d.items.length>0)if(e=f=d.items[0],g=!0,i=!1,"SEGMENT"===d.type)angular.forEach(d.items,function(b,c){a>=b.sampleStart-.5&&(a<=b.sampleStart+b.sampleDur+.5&&(a-b.sampleStart>=b.sampleDur/2?void 0!==d.items[c+1]?(e=d.items[c],f=d.items[c+1],i=!1):(i=!0,e=f=d.items[d.items.length-1]):(i=!1,e=f=d.items[c])),g=!1),a>=b.sampleStart-.5&&(a<=b.sampleStart+b.sampleDur+.5?e=b:(i=!0,e=f=d.items[d.items.length-1]))});else{var j=0,k=0;g=!1,i=!1,angular.forEach(d.items,function(b,g){k=g<d.items.length-1?b.samplePoint+(d.items[g+1].samplePoint-d.items[g].samplePoint)/2:c,j=g>0?b.samplePoint-(d.items[g].samplePoint-d.items[g-1].samplePoint)/2:0,k>=a&&a>=j&&(e=f=b)})}return{current:e,nearest:f,isFirst:g,isLast:i}},h.deleteLevel=function(a,c){var e=b.getLevelDataAt(a);return b.deleteLevelDataAt(a),d.vals.perspectives[c].levelCanvases.order.splice(a,1),e},h.insertLevel=function(a,c,e){void 0===b.getLevelData()&&b.setLevelData([]),b.insertLevelDataAt(c,a),d.vals.perspectives[e].levelCanvases.order.splice(c,0,a.name)},h.renameLabel=function(a,b,c,d){h.updateSegItemInLevel(a,b,d,c)},h.renameLevel=function(a,c,e){angular.forEach(b.getLevelData(),function(b){b.name===a&&(b.name=c,angular.forEach(b.items,function(a){a.labels[0].name=c}))}),d.vals.perspectives[e].levelCanvases.order[d.vals.perspectives[e].levelCanvases.order.indexOf(a)]=c},h.deleteSegmentsInvers=function(a,c,d,e){var i,j,k,l=f.getCurAttrDef(a);k=0,angular.forEach(b.getLevelData(),function(b){if(b.name===a){k=e.order;for(j in e.segments)b.items.splice(k++,0,e.segments[j])}});var m=h.getItemNeighboursFromLevel(a,e.segments[0].id,e.segments[e.segments.length-1].id);void 0!==m.left&&void 0===m.right?(i=g(l,m.left.labels),h.updateSegItemInLevel(a,m.left.id,m.left.labels[i].value,i,m.left.sampleStart,m.left.sampleDur-e.timeRight)):void 0===m.left&&void 0!==m.right?(i=g(l,m.right.labels),h.updateSegItemInLevel(a,m.right.id,m.right.labels[i].value,i,m.right.sampleStart+e.timeLeft,m.right.sampleDur-e.timeLeft)):void 0===m.left&&void 0===m.right||(i=g(l,m.left.labels),h.updateSegItemInLevel(a,m.left.id,m.left.labels[i].value,i,m.left.sampleStart,m.left.sampleDur-e.timeLeft),h.updateSegItemInLevel(a,m.right.id,m.right.labels[i].value,i,m.right.sampleStart+e.timeRight,m.right.sampleDur-e.timeRight))},h.deleteSegments=function(a,c,d){for(var e=h.getItemFromLevelById(a,c),i=h.getOrderById(a,c),j=h.getItemDetails(a,i+d-1),k=h.getItemNeighboursFromLevel(a,e.id,j.id),l=0,m=0,n=null,o=null,p=null,q=f.getCurAttrDef(a),r=g(q,e.labels),s=i;i+d>s;s++)l+=h.getItemDetails(a,s).sampleDur+1;return l%2==0?(l/=2,m=l):(l=Math.ceil(l/2),m=l-1),angular.forEach(b.getLevelData(),function(b){b.name===a&&angular.forEach(b.items,function(a,e){a.id==c&&(n=e,o=b.items.splice(n,d))})}),void 0!==k.left&&void 0===k.right?(h.updateSegItemInLevel(a,k.left.id,void 0,r,k.left.sampleStart,k.left.sampleDur+m),p=k.left):void 0===k.left&&void 0!==k.right?(h.updateSegItemInLevel(a,k.right.id,void 0,r,k.right.sampleStart-l,k.right.sampleDur+l),p=k.right):void 0===k.left&&void 0===k.right?f.setcurMouseItem(void 0,void 0,void 0):(h.updateSegItemInLevel(a,k.left.id,void 0,r,k.left.sampleStart,k.left.sampleDur+l),h.updateSegItemInLevel(a,k.right.id,void 0,r,k.right.sampleStart-m,k.right.sampleDur+m),p=k.left),{order:n,segments:o,timeLeft:l,timeRight:m,clickSeg:p}},h.insertSegmentInvers=function(a,c,d){var e,f=!0;return angular.forEach(b.getLevelData(),function(b){if(b.name===a)if(c==d){var g=-1;if(angular.forEach(b.items,function(a,b){c==a.sampleStart&&(g=b,f=!0)}),f){var h=0;void 0!==b.items[g]&&(h=b.items[g].sampleDur+1),void 0!==b.items[g-1]&&(b.items[g-1].sampleDur+=h),b.items.splice(g,1)}}else{var g=-1;angular.forEach(b.items,function(a,b){c==a.sampleStart&&(g=b,f=!0)}),f&&(void 0===b.items[g+1]?b.items.splice(g-1,2):void 0===b.items[g-1]?b.items.splice(g,2):(h=b.items[g].sampleDur+1,e=b.items[g+1].sampleDur+1,b.items[g-1].sampleDur+=h+e,b.items.splice(g,2)))}}),f},h.insertSegment=function(a,c,d,e,f){var g=!0;return angular.forEach(b.getLevelData(),function(i){if(i.name===a)if(c==d){if(0==i.items.length)return{ret:!1,ids:f};void 0===f&&(f=[],f[0]=b.getNewId());var j=-1;if(c<i.items[0].sampleStart){var k=i.items[0].sampleStart-c;h.insertItemDetails(f[0],a,0,e,c,k-1)}else if(c>i.items[i.items.length-1].sampleStart+i.items[i.items.length-1].sampleDur){var l=i.items[i.items.length-1].sampleStart+i.items[i.items.length-1].sampleDur+1;h.insertItemDetails(f[0],a,i.items.length,e,l,c-l)}else if(angular.forEach(i.items,function(a,b){c>=a.sampleStart&&c<=a.sampleStart+a.sampleDur&&(j=b),a.sampleStart==c&&(g=!1),a.sampleStart+a.sampleDur+1==c&&(g=!1)}),g){var k=c-i.items[j].sampleStart-1;h.insertItemDetails(f[0],a,j+1,e,c,i.items[j].sampleDur-k-1),i.items[j].sampleDur=k}}else if(void 0===f&&(f=[],f[0]=b.getNewId(),f[1]=b.getNewId()),0==i.items.length)h.insertItemDetails(f[0],a,0,e,c,d-c-1);else if(d<i.items[0].sampleStart){var k=i.items[0].sampleStart-d-1,m=d-c-1;h.insertItemDetails(f[0],a,0,e,d,k),h.insertItemDetails(f[1],a,0,e,c,m)}else if(c>i.items[i.items.length-1].sampleStart+i.items[i.items.length-1].sampleDur){var k=c-(i.items[i.items.length-1].sampleStart+i.items[i.items.length-1].sampleDur)-1,m=d-c-1,n=i.items.length;h.insertItemDetails(f[0],a,n,e,i.items[i.items.length-1].sampleStart+i.items[i.items.length-1].sampleDur,k),h.insertItemDetails(f[1],a,n+1,e,c,m)}else{var j=-1,o=-1;if(angular.forEach(i.items,function(a,b){c>=a.sampleStart&&c<=a.sampleStart+a.sampleDur&&(j=b),d>=a.sampleStart&&d<=a.sampleStart+a.sampleDur&&(o=b)}),g=j===o,g&&-1!==j){var k=c-i.items[j].sampleStart-1,m=d-c-1;h.insertItemDetails(f[0],a,j+1,e,c,m),h.insertItemDetails(f[1],a,j+2,e,d,i.items[j].sampleDur-k-1-m-1),i.items[j].sampleDur=k}}}),{ret:g,ids:f}},h.insertEvent=function(a,c,d,e){var f=!1,g=void 0,i=void 0;return angular.forEach(b.getLevelData(),function(b){b.name===a&&"EVENT"===b.type&&(i=b.items.length>0?b.items[0].samplePoint:0,angular.forEach(b.items,function(a,b){Math.floor(c)===Math.floor(a.samplePoint)&&(f=!0),c>a.samplePoint&&(g=b+1)}))}),f||(void 0===e&&(e=b.getNewId()),h.insertItemDetails(e,a,g,d,c)),{alreadyExists:f,id:e}},h.deleteEvent=function(a,c){var d=!1;return angular.forEach(b.getLevelData(),function(b){b.name===a&&"EVENT"==b.type&&angular.forEach(b.items,function(a,e){d||c==a.id&&(d=a,b.items.splice(e,1))})}),d},h.deleteBoundary=function(a,c,d,e){var f=h.getItemFromLevelById(a,c),g=null,i=null,j=null,k=null;return angular.forEach(b.getLevelData(),function(b){b.name===a&&(g=b.items[0],angular.forEach(b.items,function(a,c){if("SEGMENT"===b.type&&f.sampleStart==a.sampleStart&&f.sampleDur==a.sampleDur)if(0===c&&d)b.items.splice(c,1),i=c,j=a,k=b.items[0];else if(c===b.items.length-1&&e)b.items.splice(c,1),i=c,j=a,k=b.items[b.items.length-1];else{for(var h=0;h<g.labels.length;h++)g.labels[h].value+=a.labels[h].value;g.sampleDur+=a.sampleDur+1,b.items.splice(c,1),i=c,j=a,k=g}g=a}),null==k&&(k=b.items[0]))}),{order:i,event:j,clickSeg:k}},h.deleteBoundaryInvers=function(a,c,d,e,f){angular.forEach(b.getLevelData(),function(b){if(b.name===a){b.items.splice(f.order,0,f.event);var c=f.event.labels[0].value;d||e||(c=b.items[f.order-1].labels[0].value.slice(0,b.items[f.order-1].labels[0].value.length-f.event.labels[0].value.length),b.items[f.order-1].labels[0].value=c,b.items[f.order-1].sampleDur-=f.event.sampleDur+1)}})},h.snapBoundary=function(a,c,d,e,f){var g,h,i,j,k=1/0,l=void 0;return"SEGMENT"==f?i=d.sampleStart:"EVENT"==f&&(i=d.samplePoint),angular.forEach(b.getLevelData(),function(d,e){if(d.name===c){if(a){if(!(e>=1))return!1;g=b.getLevelData()[e-1]}else{if(!(e<b.getLevelData().length-1))return!1;g=b.getLevelData()[e+1]}g.items.forEach(function(a){"SEGMENT"==g.type?j=a.sampleStart:"EVENT"==g.type&&(j=a.samplePoint),h=Math.abs(i-j),k>h&&(k=h,l=j-i)})}}),void 0!==l?("SEGMENT"==f?this.moveBoundary(c,d.id,l,0):"EVENT"==f&&this.moveEvent(c,d.id,l),l):!1},h.moveBoundary=function(a,b,c,d,i){var j=h.getItemFromLevelById(a,b),k=f.getCurAttrDef(a),l=g(k,j.labels),m=h.getItemNeighboursFromLevel(a,b,b);if(d){var n=m.right;void 0!==n?j.sampleStart+c>=0&&j.sampleStart+c<n.sampleStart&&h.updateSegItemInLevel(a,j.id,void 0,l,j.sampleStart+c,j.sampleDur-c):j.sampleStart+c>=0&&j.sampleDur-c>=0&&j.sampleStart+j.sampleDur+c<=e.wavJSO.Data.length&&h.updateSegItemInLevel(a,j.id,void 0,l,j.sampleStart+c,j.sampleDur-c)}else if(i)j.sampleDur+c>=0&&j.sampleDur+j.sampleStart+c<=e.wavJSO.Data.length&&h.updateSegItemInLevel(a,j.id,void 0,l,j.sampleStart,j.sampleDur+c);else if(void 0===m.left){var n=m.right;void 0!==n?j.sampleStart+c>=0&&j.sampleStart+c<n.sampleStart&&h.updateSegItemInLevel(a,j.id,void 0,l,j.sampleStart+c,j.sampleDur-c):j.sampleStart+c>=0&&j.sampleStart+j.sampleDur+c<=e.wavJSO.Data.length&&h.updateSegItemInLevel(a,j.id,void 0,l,j.sampleStart+c,j.sampleDur-c)}else{var o=m.left;o.sampleDur+c>=0&&j.sampleStart+c>=0&&j.sampleDur-c>=0&&(h.updateSegItemInLevel(a,m.left.id,void 0,l,o.sampleStart,o.sampleDur+c),h.updateSegItemInLevel(a,j.id,void 0,l,j.sampleStart+c,j.sampleDur-c))}},h.moveEvent=function(a,d,f){var g=h.getItemFromLevelById(a,d);if(c.isIntermediate(d)){var i=h.getItemNeighboursFromLevel(a,d,d);g.samplePoint+f>0&&g.samplePoint+f<=e.wavJSO.Data.length&&(void 0!==i.left?g.samplePoint+f>i.left.samplePoint&&g.samplePoint+f<i.right.samplePoint&&h.setPointDetails(a,g.id,g.labels[0].value,g.samplePoint+f):g.samplePoint+f>0&&g.samplePoint+f<i.right.samplePoint&&h.setPointDetails(a,g.id,g.labels[0].value,g.samplePoint+f))}else g.samplePoint+f>0&&g.samplePoint+f<=e.wavJSO.Data.length&&h.setPointDetails(a,g.id,g.labels[0].value,g.samplePoint+f),angular.forEach(b.getLevelData(),function(b){b.name===a&&b.items.sort(h.orderPoints)})},h.orderPoints=function(a,b){return a.samplePoint>b.samplePoint?1:a.samplePoint<b.samplePoint?-1:0},h.moveSegment=function(a,b,c,d){var i=h.getOrderById(a,b),j=h.getItemDetails(a,i),k=h.getItemDetails(a,i+c-1),l=h.getItemNeighboursFromLevel(a,j.id,k.id),m=f.getCurAttrDef(a),n=g(m,j.labels);if(void 0===l.left&&void 0!==l.right){var o=h.getItemFromLevelById(a,l.right.id);if(j.sampleStart+d>0&&l.right.sampleDur-d>=0){h.updateSegItemInLevel(a,o.id,void 0,n,o.sampleStart+d,o.sampleDur-d);for(var p=i;i+c>p;p++){var q=h.getItemDetails(a,p);h.updateSegItemInLevel(a,q.id,void 0,n,q.sampleStart+d,q.sampleDur)}}}else if(void 0===l.right&&void 0!==l.left){var r=h.getItemFromLevelById(a,l.left.id);if(l.left.sampleDur+d>=0&&k.sampleStart+k.sampleDur+d<e.wavJSO.Data.length){h.updateSegItemInLevel(a,r.id,void 0,n,r.sampleStart,r.sampleDur+d);for(var p=i;i+c>p;p++){var q=h.getItemDetails(a,p);h.updateSegItemInLevel(a,q.id,void 0,n,q.sampleStart+d,q.sampleDur)}}}else if(void 0!==l.right&&void 0!==l.left){var s=h.getItemFromLevelById(a,l.left.id),t=h.getItemFromLevelById(a,l.right.id);if(s.sampleDur+d>=0&&t.sampleDur-d>=0){h.updateSegItemInLevel(a,s.id,void 0,n,s.sampleStart,s.sampleDur+d),h.updateSegItemInLevel(a,t.id,void 0,n,t.sampleStart+d,t.sampleDur-d);for(var p=i;i+c>p;p++){var q=h.getItemDetails(a,p);h.updateSegItemInLevel(a,q.id,void 0,n,q.sampleStart+d,q.sampleDur)}}}else if(void 0===l.right&&void 0===l.left){var u=h.getItemDetails(a,i),v=h.getItemDetails(a,i+c-1);if(u.sampleStart+d>0&&v.sampleDur+v.sampleStart+d<e.wavJSO.Data.length)for(var p=i;i+c>p;p++){var q=h.getItemDetails(a,p);h.updateSegItemInLevel(a,q.id,void 0,n,q.sampleStart+d,q.sampleDur)}}},h.expandSegment=function(a,b,c,d){var i,j=0,k=h.getItemNeighboursFromLevel(c,b[0].id,b[b.length-1].id),l=(d*b.length,f.getCurAttrDef(c)),m=g(l,b[0].labels),n=!0;if(a)if(void 0===k.right){var o=b[b.length-1].sampleStart+b[b.length-1].sampleDur+d*b.length;o<=e.wavJSO.Data.length&&angular.forEach(b,function(a){i=h.getItemFromLevelById(c,a.id),h.updateSegItemInLevel(c,i.id,void 0,m,i.sampleStart+j,i.sampleDur+d),j+=d})}else angular.forEach(b,function(a){a.sampleDur+1+d<0&&(n=!1)}),n&&k.right.sampleDur-d*b.length>0&&(angular.forEach(b,function(a){i=h.getItemFromLevelById(c,a.id),h.updateSegItemInLevel(c,i.id,void 0,m,i.sampleStart+j,i.sampleDur+d),j+=d}),h.updateSegItemInLevel(c,k.right.id,void 0,m,k.right.sampleStart+j,k.right.sampleDur-j));else if(void 0===k.left){var p=h.getItemDetails(c,0);p.sampleStart+d*(b.length+1)>0&&angular.forEach(b,function(a){i=h.getItemFromLevelById(c,a.id),h.updateSegItemInLevel(c,i.id,void 0,i.sampleStart-d,m,i.sampleDur+d)})}else angular.forEach(b,function(a){a.sampleDur+1+d<0&&(n=!1)}),n&&k.left.sampleDur-d*b.length>0&&(j=0,angular.forEach(b,function(a,e){i=h.getItemFromLevelById(c,a.id),j=-(b.length-e)*d,h.updateSegItemInLevel(c,i.id,void 0,m,i.sampleStart+j,i.sampleDur+d)}),h.updateSegItemInLevel(c,k.left.id,void 0,m,k.left.sampleStart,k.left.sampleDur-b.length*d))},h.calcDistanceToNearestZeroCrossing=function(a){for(var b=1/0,c=1/0,d=a;d<e.wavJSO.Data.length-1;d++)if(e.wavJSO.Data[d]>=0&&e.wavJSO.Data[d+1]<0||e.wavJSO.Data[d]<0&&e.wavJSO.Data[d+1]>=0){b=d-a;break}for(var d=a;d>1;d--)if(e.wavJSO.Data[d]>=0&&e.wavJSO.Data[d-1]<0||e.wavJSO.Data[d]<0&&e.wavJSO.Data[d-1]>=0){c=d-a;break}var f;return f=Math.abs(c)<Math.abs(b)?c:b+1},h.getAllLabelsOfLevel=function(a){for(var b=f.getCurAttrDef(a.level.name),c=[],d=0;d<a.level.items.length;d++)for(var e=0;e<a.level.items[d].labels.length;e++)a.level.items[d].labels[e].name===b&&c.push(a.level.items[d].labels[e].value);return c},h.getLevelName=function(a){var c=null;return angular.forEach(b.getLevelData(),function(b){angular.forEach(b.items,function(d){d.id===a&&(c=b.name)})}),c},h}]),angular.module("emuwebApp").service("LinkService",["DataService",function(a){var b={};return b.insertLink=function(b,c){a.insertLinkData({fromID:b,toID:c})},b.insertLinkAt=function(b,c,d){a.insertLinkDataAt(d,{fromID:b,toID:c})},b.deleteLink=function(b,c){var d=-1;return angular.forEach(a.getLinkData(),function(e,f){e.fromID===b&&e.toID===c&&(a.deleteLinkDataAt(f),d=f)}),d},b.linkExists=function(b,c){var d=!1;return angular.forEach(a.getLinkData(),function(a){a.fromID===b&&a.toID===c&&(d=!0)}),d},b.hasParents=function(b){var c=!1;return angular.forEach(a.getLinkData(),function(a){a.toID===b&&(c=!0)}),c},b.hasChildren=function(b){var c=!1;return angular.forEach(a.getLinkData(),function(a){a.fromID===b&&(c=!0)}),c},b.isIntermediate=function(a){return b.hasChildren(a)||b.hasParents(a)},b.insertLinksTo=function(a,c){angular.forEach(c,function(c){b.insertLink(a,c)})},b.deleteLinksTo=function(a,c){var d=[];return angular.forEach(c,function(c){b.deleteLink(a,c),d.push({fromID:a,toID:c})}),d},b.insertLinksFrom=function(a,c){angular.forEach(a,function(a){b.insertLink(a,c)})},b.deleteLinksFrom=function(a,c){var d=[];return angular.forEach(a,function(a){d.push({fromID:a,toID:c}),b.deleteLink(a,c)}),d},b.getLinksTo=function(b){var c=[];return angular.forEach(a.getLinkData(),function(a,d){a.toID===b&&c.push({link:a,order:d})}),c},b.getLinksFrom=function(b){var c=[];return angular.forEach(a.getLinkData(),function(a,d){a.fromID===b&&c.push({link:a,order:d})}),c},b.changeLinkTo=function(b,c,d){angular.forEach(a.getLinkData(),function(e,f){e.fromID===b&&e.toID===c&&a.changeLinkDataAt(f,b,d)})},b.changeLinkFrom=function(b,c,d){angular.forEach(a.getLinkData(),function(e,f){e.fromID===b&&e.toID===c&&a.changeLinkDataAt(f,d,c)})},b.deleteLinkSegment=function(a){var c=[],d=[];return angular.forEach(a,function(a){angular.forEach(b.getLinksTo(a.id),function(a){c.push({fromID:a.link.fromID,toID:a.link.toID}),b.deleteLink(a.link.fromID,a.link.toID)}),angular.forEach(b.getLinksFrom(a.id),function(a){d.push({fromID:a.link.fromID,toID:a.link.toID}),b.deleteLink(a.link.fromID,a.link.toID)})}),{linksTo:c,linksFrom:d}},b.deleteLinkSegmentInvers=function(a){angular.forEach(a.linksTo,function(a){b.insertLink(a.fromID,a.toID)}),angular.forEach(a.linksFrom,function(a){b.insertLink(a.fromID,a.toID)})},b.deleteLinkBoundary=function(a,c){var d=[],e=[],f=0;return c>0?(angular.forEach(b.getLinksTo(a),function(e){b.linkExists(e.link.fromID,c)?(f=b.deleteLink(e.link.fromID,a),d.push({fromID:e.link.fromID,toID:a,deleted:!0,order:f,neighbourID:0})):(b.changeLinkTo(e.link.fromID,a,c),d.push({fromID:e.link.fromID,toID:a,deleted:!1,order:f,neighbourID:c}))}),angular.forEach(b.getLinksFrom(a),function(d){b.linkExists(c,d.link.toID)?(f=b.deleteLink(a,d.link.toID),e.push({fromID:a,toID:d.link.toID,deleted:!0,order:f,neighbourID:0})):(b.changeLinkFrom(a,d.link.toID,c),e.push({fromID:a,toID:d.link.toID,deleted:!1,order:f,neighbourID:c}))})):(angular.forEach(b.getLinksTo(a),function(c){f=b.deleteLink(c.link.fromID,a),d.push({fromID:c.link.fromID,toID:a,deleted:!0,order:f,neighbourID:0})}),angular.forEach(b.getLinksFrom(a),function(c){f=b.deleteLink(a,c.link.toID),e.push({fromID:a,toID:c.link.toID,deleted:!0,order:f,neighbourID:0})
})),{linksTo:d,linksFrom:e}},b.deleteLinkBoundaryInvers=function(a){angular.forEach(a.linksTo,function(a){a.deleted?b.insertLinkAt(a.fromID,a.toID,a.order):b.changeLinkTo(a.fromID,a.neighbourID,a.toID)}),angular.forEach(a.linksFrom,function(a){a.deleted?b.insertLinkAt(a.fromID,a.toID,a.order):b.changeLinkFrom(a.neighbourID,a.toID,a.fromID)})},b}]),angular.module("emuwebApp").service("Websockethandler",["$q","$rootScope","$location","$timeout","HistoryService","Ssffparserservice","ConfigProviderService","viewState","Wavparserservice","Soundhandlerservice","Espsparserservice","uuid","Binarydatamaniphelper","Ssffdataservice","modalService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){function p(a){z=!0,b.$apply(y.resolve(a))}function q(a){u(angular.fromJson(a.data))}function r(a){console.error("WEBSOCKET ERROR!!!!!"),b.$apply(y.resolve(a))}function s(a){!a.wasClean&&z&&o.open("views/error.html","A non clean disconnect to the server occurred! This probably means that the server is down. Please check the server and reconnect!").then(function(){b.$broadcast("connectionDisrupted")}),z=!1,console.log("WEBSOCKET closed!!!!!")}function t(b){var c=a.defer(),e=v();return x[e]={time:new Date,cb:c},b.callbackID=e,w.ws.send(angular.toJson(b)),d(function(){var a={callbackID:e,status:{type:"ERROR:TIMEOUT",message:"Sent request of type: "+b.type+" timed out after "+g.vals.main.serverTimeoutInterval+"ms!  Please check the server..."}};u(a)},g.vals.main.serverTimeoutInterval),c.promise}function u(a){var c=a;if(x.hasOwnProperty(c.callbackID)){switch(c.type){case"getESPSfile":alert("espsfile");break;case"getSSFFfile":alert("ssfffile")}"SUCCESS"===c.status.type?b.$apply(x[c.callbackID].cb.resolve(c.data)):(w.closeConnect(),b.$broadcast("resetToInitState"),b.$apply(o.open("views/error.html","Communication error with server! Error message is: "+c.status.message))),delete x[c.callbackID]}else"ERROR:TIMEOUT"===c.status.type||o.open("views/error.html","What just happened? You should not be here...")}function v(){var a=l.new();return a}var w={},x={};w.ws={};var y={},z=!1;return w.initConnect=function(b){var c=a.defer();return w.ws=new WebSocket(b),w.ws.onopen=p,w.ws.onmessage=q,w.ws.onerror=r,w.ws.onclose=s,y=c,c.promise},w.isConnected=function(){return z},w.closeConnect=function(){w.isConnected()?(w.ws.onclose=function(){},w.ws.close()):console.log("WEBSOCKET ERROR: was not connected!")},w.getProtocol=function(){var a={type:"GETPROTOCOL"},b=t(a);return b},w.getDoUserManagement=function(){var a={type:"GETDOUSERMANAGEMENT"},b=t(a);return b},w.logOnUser=function(a,b){var c={type:"LOGONUSER",userName:a,pwd:b},d=t(c);return d},w.getDBconfigFile=function(){var a={type:"GETGLOBALDBCONFIG"},b=t(a);return b},w.getBundleList=function(){var a={type:"GETBUNDLELIST"},b=t(a);return b},w.getBundle=function(a,b){var c={type:"GETBUNDLE",name:a,session:b},d=t(c);return d},w.saveBundle=function(a){var b={type:"SAVEBUNDLE",data:a},c=t(b);return c},w.disconnectWarning=function(){var a={type:"DISCONNECTWARNING"},b=t(a);return b},w}]),angular.module("emuwebApp").service("Binarydatamaniphelper",function(){var a={};return a.base64ToArrayBuffer=function(a){for(var b=window.atob(a),c=b.length,d=new Uint8Array(c),e=0;c>e;e++){var f=b.charCodeAt(e);d[e]=f}return d.buffer},a.arrayBufferToBase64=function(a){for(var b="",c=new Uint8Array(a),d=c.byteLength,e=0;d>e;e++)b+=String.fromCharCode(c[e]);return window.btoa(b)},a}),angular.module("emuwebApp").service("Appcachehandler",["$http","modalService",function(a,b){var c={},d=window.applicationCache;return c.handleUpdatereadyEvent=function(){b.open("views/confirmModal.html","A new version of the EMU-WebApp is available and has already been downloaded and cached in your browser. Would you like to use it? CAUTION: A reload will delete all current changes... TIP: the next time you use the EMU-webApp you will automatically use the updated version)").then(function(a){a&&(d.swapCache(),window.location.reload())})},d.addEventListener("updateready",c.handleUpdatereadyEvent,!1),c.checkForNewVersion=function(){0!==d.status&&3!==d.status&&(console.log("INFO: appCache.status: "+d.status),d.update())},c}]),angular.module("emuwebApp").controller("spectSettingsCtrl",["$scope","modalService","viewState","DataService","mathHelperService","Soundhandlerservice",function(a,b,c,d,e,f){a.vs=c,a.options=Object.keys(a.vs.getWindowFunctions()),a.selWindowInfo={},a.selWindowInfo.name=Object.keys(a.vs.getWindowFunctions())[a.vs.spectroSettings.window-1],a.errorID=[],a.upperBoundary="",a.modalVals={rangeFrom:a.vs.spectroSettings.rangeFrom,rangeTo:a.vs.spectroSettings.rangeTo,dynamicRange:a.vs.spectroSettings.dynamicRange,windowSizeInSecs:a.vs.spectroSettings.windowSizeInSecs,window:a.vs.spectroSettings.window,drawHeatMapColors:a.vs.spectroSettings.drawHeatMapColors,preEmphasisFilterFactor:a.vs.spectroSettings.preEmphasisFilterFactor,heatMapColorAnchors:c.spectroSettings.heatMapColorAnchors,_fftN:512,_windowSizeInSamples:f.wavJSO.SampleRate*a.vs.spectroSettings.windowSizeInSecs},a.cursorInTextField=function(){c.setEditing(!0),c.setcursorInTextField(!0)},a.cursorOutOfTextField=function(){c.setEditing(!1),c.setcursorInTextField(!1)},a.calcWindowSizeInSamples=function(){a.modalVals._windowSizeInSamples=f.wavJSO.SampleRate*a.modalVals.windowSizeInSecs},a.calcFftN=function(){var b=e.calcClosestPowerOf2Gt(a.modalVals._windowSizeInSamples);512>b&&(b=512),a.modalVals._fftN=b},a.calcWindowSizeVals=function(){a.calcWindowSizeInSamples(),a.calcFftN()},a.reset=function(){a.errorID=[],a.modalVals={rangeFrom:a.vs.spectroSettings.rangeFrom,rangeTo:a.vs.spectroSettings.rangeTo,dynamicRange:a.vs.spectroSettings.dynamicRange,windowSizeInSecs:a.vs.spectroSettings.windowSizeInSecs,window:a.vs.spectroSettings.window,drawHeatMapColors:a.vs.spectroSettings.drawHeatMapColors,preEmphasisFilterFactor:a.vs.spectroSettings.preEmphasisFilterFactor,heatMapColorAnchors:c.spectroSettings.heatMapColorAnchors,_fftN:512,_windowSizeInSamples:f.wavJSO.SampleRate*a.vs.spectroSettings.windowSizeInSecs},b.close()},a.cssError=function(b,c){return a.errorID[b]?{background:"#f00"}:void 0!==c&&a.errorID[c]?{background:"#f00"}:void 0},a.htmlError=function(b){return a.errorID[b]},a.saveSpectroSettings=function(){var b=!1;a.errorID.forEach(function(a){a===!0&&(b=!0)}),b||(c.setspectroSettings(a.modalVals.windowSizeInSecs,a.modalVals.rangeFrom,a.modalVals.rangeTo,a.modalVals.dynamicRange,a.selWindowInfo.name,a.modalVals.drawHeatMapColors,a.modalVals.preEmphasisFilterFactor,a.modalVals.heatMapColorAnchors),a.reset())},a.checkSpectroSettings=function(){a.errorID[8]=a.modalVals.heatMapColorAnchors[0][0]%1!==0||a.modalVals.heatMapColorAnchors[0][1]%1!==0||a.modalVals.heatMapColorAnchors[0][2]%1!==0||a.modalVals.heatMapColorAnchors[1][0]%1!==0||a.modalVals.heatMapColorAnchors[1][1]%1!==0||a.modalVals.heatMapColorAnchors[1][2]%1!==0||a.modalVals.heatMapColorAnchors[2][0]%1!==0||a.modalVals.heatMapColorAnchors[2][1]%1!==0||a.modalVals.heatMapColorAnchors[2][2]%1!==0?!0:!1,a.errorID[7]=isNaN(a.modalVals.preEmphasisFilterFactor*f.wavJSO.SampleRate)?!0:!1,a.errorID[6]=isNaN(f.wavJSO.SampleRate*a.modalVals.windowSizeInSecs)?!0:!1,a.errorID[5]=a.modalVals.dynamicRange%1!==0?!0:!1,a.errorID[4]=a.modalVals.rangeFrom%1!==0?!0:!1,a.errorID[3]=a.modalVals.rangeTo%1!==0?!0:!1,a.errorID[2]=a.modalVals.rangeFrom<0?!0:!1,a.upperBoundary=d.data.sampleRate/2,a.errorID[1]=a.modalVals.rangeTo>a.upperBoundary?!0:!1}}]),angular.module("emuwebApp").filter("regex",function(){return function(a,b){for(var c=new RegExp(b.toLowerCase()),d=[],e=0;e<a.length;e++)c.test(a[e].name.toLowerCase())&&d.push(a[e]);return d}}),angular.module("emuwebApp").filter("levelsFilter",["ConfigProviderService","viewState",function(a,b){return function(c){if(c){for(var d,e=new RegExp("SEGMENT"),f=new RegExp("EVENT"),g=[],h=0;h<c.length;h++)(e.test(c[h].type)||f.test(c[h].type))&&void 0!==a.vals.perspectives[b.curPerspectiveIdx].levelCanvases&&(d=a.vals.perspectives[b.curPerspectiveIdx].levelCanvases.order.indexOf(c[h].name),-1!==d&&(g[d]=c[h]));return g}}}]),angular.module("emuwebApp").controller("ModalCtrl",["$scope","ArrayHelperService","modalService","viewState","LevelService","HistoryService","ConfigProviderService",function(a,b,c,d,e,f,g){a.cps=g,a.data=void 0,a.cursorInTextField=function(){d.setEditing(!0),d.setcursorInTextField(!0)},a.cursorOutOfTextField=function(){d.setEditing(!1),d.setcursorInTextField(!1)},a.saveChanges=function(){c.close()},a.discardChanges=function(){c.close()},a.renameLevel=function(){e.renameLevel(c.dataIn,a.data,d.curPerspectiveIdx),f.addObjToUndoStack({type:"ANNOT",action:"RENAMELEVEL",newname:a.data,name:c.dataIn,curPerspectiveIdx:d.curPerspectiveIdx}),c.close()},a.deleteLevel=function(){var a=e.getLevelDetails(d.getcurClickLevelName());e.deleteLevel(d.getcurClickLevelIndex(),d.curPerspectiveIdx),f.addObjToUndoStack({type:"ANNOT",action:"DELETELEVEL",level:a.level,id:d.getcurClickLevelIndex(),curPerspectiveIdx:d.curPerspectiveIdx}),c.close()}}]),angular.module("emuwebApp").directive("showMenu",["$animate",function(a){return{restrict:"A",link:function(b,c,d){b.$watch(d.showMenu,function(b){b?a.addClass(c,"emuwebapp-expandWidthTo200px"):(a.removeClass(c,"emuwebapp-expandWidthTo200px"),a.addClass(c,"emuwebapp-shrinkWidthTo0px"))})}}}]),angular.module("emuwebApp").directive("showTwod",["$animate",function(a){return{restrict:"A",link:function(b,c,d){b.$watch(d.showTwod,function(b){b?a.addClass(c,".slideIn2dCanvases"):a.removeClass(c,".slideIn2dCanvases")})}}}]),angular.module("emuwebApp").animation(".slideIn2dCanvases",function(){return{addClass:function(a){a.addClass("slide2dCanvases")},removeClass:function(a){a.removeClass("slide2dCanvases")}}}),angular.module("emuwebApp").directive("bgSplitter",["$rootScope","viewState",function(a,b){return{restrict:"E",replace:!0,transclude:!0,scope:{showTwoDimCans:"@"},template:'<div class="emuwebapp-split-panes vertical" ng-transclude></div>',controller:["$scope",function(a){a.panes=[],a.bottomRightResizePane,this.addPane=function(b){if(a.panes.length>1)throw"splitters can only have two panes";return a.panes.push(b),a.panes.length},this.setBottomRightResizePane=function(b){a.bottomRightResizePane=b}}],link:function(c,d,e){var f=!1,g=!1,h=!1,i=angular.element('<div id="emuwebapp-split-handler" class="emuwebapp-split-handler"><span></span></div>'),j=c.panes[0],k=c.panes[1],l=c.bottomRightResizePane,m=angular.element('<div class="emuwebapp-bottomRightResizePaneTopResizer"></div>'),n=angular.element('<div class="emuwebapp-bottomRightResizePaneLeftResizer"></div>'),o=angular.element('<div class="emuwebapp-bottomRightResizePaneCornerResizer"></div>');l.elem.prepend(n),l.elem.prepend(m),l.elem.prepend(o);var p=j.minSize||0,q=k.minSize||0,r=!1,s=!1;j.elem.after(i),e.$observe("showTwoDimCans",function(a){"false"===a?c.bottomRightResizePane.elem.hide():c.bottomRightResizePane.elem.show()}),d.bind("mousemove",function(a){if(s){var c=d[0].getBoundingClientRect(),e=0;if(r){var m=c.bottom-c.top;if(e=a.clientY-c.top,p>e)return;if(q>m-e)return;i.css("top",e+"px"),j.elem.css("height",e+"px"),k.elem.css("top",e+"px"),b.setdragBarHeight(e)}if(f){var m=c.bottom-c.top;if(e=a.clientY-c.top,10>=e||10>=m-e)return;l.elem.css("top",e+"px");var n=m-e;l.elem.css("height",n+"px")}if(g){var o=c.right-c.left;if(e=a.clientX-c.left,10>=e||10>=o-e)return;l.elem.css("left",e+"px");var n=o-e;l.elem.css("width",n+"px")}if(h){var m=c.bottom-c.top;if(e=a.clientY-c.top,10>=e||10>=m-e)return;l.elem.css("top",e+"px");var n=m-e;l.elem.css("height",n+"px");var o=c.right-c.left;if(e=a.clientX-c.left,10>=e||10>=o-e)return;l.elem.css("left",e+"px");var n=o-e;l.elem.css("width",n+"px")}}}),i.bind("mousedown",function(c){c.preventDefault(),s=!0,r=!0,b.setdragBarActive(!0),a.$digest()}),m.bind("mousedown",function(c){c.preventDefault(),s=!0,f=!0,b.setdragBarActive(!0),a.$digest()}),n.bind("mousedown",function(c){c.preventDefault(),s=!0,g=!0,b.setdragBarActive(!0),a.$digest()}),o.bind("mousedown",function(c){c.preventDefault(),s=!0,h=!0,b.setdragBarActive(!0),a.$digest()}),angular.element(document).bind("mouseup",function(){s=!1,r=!1,f=!1,g=!1,h=!1,b.setdragBarActive(!1),a.$digest()})}}}]).directive("bgPane",function(){return{restrict:"E",require:"^bgSplitter",replace:!0,transclude:!0,scope:{minSize:"=",type:"@",showTwoDimCans:"@"},template:'<div class="{{typeclass}}" ng-transclude></div>',link:function(a,b,c,d){"emuwebapp-bottomRightResizePane"!==a.type?(a.elem=b,a.index=d.addPane(a),a.typeclass="split-pane"+a.index):(a.elem=b,a.index=3,a.typeclass="emuwebapp-bottomRightResizePane",d.setBottomRightResizePane(a))}}}),angular.module("emuwebApp").directive("ssffTrack",["$timeout","viewState","ConfigProviderService",function(a){return{templateUrl:"views/ssffTrack.html",restrict:"E",link:function(b,c,d){var e,f=c.find("canvas").length,g=(c.find("canvas")[1],c.find("canvas")[f-1]),h=g.getContext("2d");d.$observe("trackName",function(a){a&&(e=a)}),b.order=d.order,b.$watch("vs.submenuOpen",function(){a(b.drawSsffTrackMarkup,b.cps.vals.colors.transitionTime)}),b.$watch("vs.timelineSize",function(){a(b.drawSsffTrackMarkup,b.cps.vals.colors.transitionTime)}),b.$watch("vs.curViewPort",function(){$.isEmptyObject(b.shs)||$.isEmptyObject(b.shs.wavJSO)||b.drawSsffTrackMarkup()},!0),b.$watch("ssffds.data.length",function(){$.isEmptyObject(b.shs)||$.isEmptyObject(b.shs.wavJSO)||b.drawSsffTrackMarkup()},!0),b.$watch("vs.movingBoundary",function(){$.isEmptyObject(b.shs)||$.isEmptyObject(b.shs.wavJSO)||b.drawSsffTrackMarkup()},!0),b.$watch("vs.movingBoundarySample",function(){$.isEmptyObject(b.shs)||$.isEmptyObject(b.shs.wavJSO)||b.drawSsffTrackMarkup()},!0),b.drawSsffTrackMarkup=function(){if(!$.isEmptyObject(b.ssffds.data)&&0!==b.ssffds.data.length){h.clearRect(0,0,h.canvas.width,h.canvas.height),b.dhs.drawMovingBoundaryLine(h),b.dhs.drawCurViewPortSelected(h,!1);var a=b.cps.getSsffTrackConfig(e),c=b.ssffds.getColumnOfTrack(a.name,a.columnName);b.dhs.drawMinMaxAndName(h,e,c._minVal,c._maxVal,2)}}}}}]),angular.module("emuwebApp").directive("progressThing",["$animate",function(a){return{template:'<div class="emuwebapp-progressThing">{{vs.somethingInProgressTxt}}</div>',restrict:"E",replace:!0,link:function(b,c,d){d.$observe("showThing",function(b){"true"===b?(a.removeClass(c,"emuwebapp-shrinkHeightTo0px"),a.removeClass(c,"emuwebapp-animationStopped"),a.addClass(c,"emuwebapp-expandHeightTo20px"),a.addClass(c,"emuwebapp-animationRunning")):(a.removeClass(c,"emuwebapp-expandHeightTo20px"),a.removeClass(c,"emuwebapp-animationRunning"),a.addClass(c,"emuwebapp-shrinkHeightTo0px"),a.addClass(c,"emuwebapp-animationStopped"))})}}}]),angular.module("emuwebApp").directive("historyActionPopup",["$animate",function(a){return{template:'<div class="emuwebapp-historyActionPopup"> <div class="emuwebapp-historyActionModal">{{vs.historyActionTxt}}</div></div>',restrict:"E",replace:!0,link:function(b,c){b.$watch("vs.historyActionTxt",function(){""!==b.vs.historyActionTxt&&a.addClass(c,"emuwebapp-historyActionPopupThere").then(function(){b.vs.historyActionTxt="",a.removeClass(c,"emuwebapp-historyActionPopupThere"),b.$apply()})},!0)}}}]),angular.module("emuwebApp").directive("dragout",["DataService","loadedMetaDataService","browserDetector","ConfigProviderService",function(a,b,c,d){return{restrict:"A",replace:!0,scope:{name:"@"},link:function(e,f,g){e.cps=d;var h=f[0],i=document.createElement("img");i.src="img/exportBtn.png",e.generateURL=function(){return e.getURL(angular.toJson(a.getData(),!0))},e.isActive=function(){return g.name===b.getCurBndl().name&&"embedded"===e.cps.vals.main.comMode},e.getURL=function(a){var b;return b="object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.createObjectURL(e.getBlob(a)):URL.createObjectURL(e.getBlob(a))},e.getBlob=function(a){var b;try{b=new Blob([a],{type:"text/plain"})}catch(c){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,b=new BlobBuilder,b.append(a),b=b.getBlob()}return b},h.addEventListener("dragstart",function(a){if(e.isActive()){this.classList.add("drag");var b=e.generateURL();(c.isBrowser.Firefox()||c.isBrowser.Chrome())&&(a.dataTransfer.setDragImage(i,-10,-10),a.dataTransfer.effectAllowed="move",a.dataTransfer.setData("DownloadURL","application/json:"+g.name+"_annot.json:"+b))}else console.log("dropping inactive bundles is not allowed");return!1},!1),h.addEventListener("dragend",function(){return e.isActive()&&this.classList.remove("drag"),!1},!1),h.addEventListener("mousedown",function(){e.isActive()?h.setAttribute("draggable",!0):(h.setAttribute("draggable",!1),h.removeAttribute("dragable"))},!1)}}}]),angular.module("emuwebApp").directive("emuhierarchy",["viewState","DataService","LevelService","HierarchyLayoutService","Soundhandlerservice",function(a,b,c,d,e){return{template:'<div class="emuwebapp-hierarchy-container"></div>',restrict:"E",scope:{path:"=",vertical:"=",playing:"="},replace:!0,link:function(f,g){f.selectedItem,f.$watch("path",function(a){void 0!==a&&(console.debug("Rendering due to path change: ",a),f.selectVisibleNodes(),f.render())},!1),f.$watch("vertical",function(a){void 0!==a&&(console.debug("Rendering due to rotation: ",a),f.selectVisibleNodes(),f.render())},!1),f.$watch("viewState.curLevelAttrDefs",function(a){void 0!==a&&(console.debug("Rendering due to attribute change: ",a),f.render())},!0),f.$watch("playing",function(a){void 0!==a&&(console.debug("Play() triggered",a,f.selectedItem),"undefined"!=typeof f.selectedItem&&0!==a&&f.play(f.selectedItem))},!0),f.centerNode=function(a){var b=-a._x+f.width/2,c=-a._y+f.height/2;i.transition().duration(f.duration).attr("transform",f.getOrientatedTransform()+"translate("+b+","+c+")"),h.translate([b,c])},f.zoom=function(){i.attr("transform",f.getOrientatedTransform())},f.getOrientatedTransform=function(){var a="scale("+h.scale()+")";return a+="translate("+h.translate()+")",a+=f.vertical?"scale(-1,1),rotate(90)":"rotate(0)"},f.getOrientatedNodeTransform=function(){return f.vertical?"scale(-1,1)rotate(90)":"scale(1,1)rotate(0)"},f.getNodeText=function(b){for(var d=a.getCurAttrDef(c.getLevelName(b.id)),e=0;e<b.labels.length;++e)if(b.labels[e].name===d)return b.labels[e].value;return console.debug("Likely a bug: Did not find the label selected for display","Selected level:",d,"Node: ",b),"NO VALUE"},f.getOrientatedTextAnchor=function(){return f.vertical?"middle":"begin"},f.getOrientatedTextX=function(){return f.vertical?0:10},f.getOrientatedTextY=function(){return f.vertical?"1.45em":"0.35em"},f.getPath=function(a){return"M"+a._fromX+" "+a._fromY+"Q"+a._fromX+" "+a._toY+" "+a._toX+" "+a._toY},f.nodeOnClick=function(a){console.debug("Clicked node",a);var b;"undefined"==typeof a._collapsed||a._collapsed===!1?b=!0:a._collapsed===!0?b=!1:console.debug("Likely a bug: the following node appears to be neither collapsed nor uncollapsed:",a),a._collapsed=b;for(var c,e=d.findChildren(a,f.path);e.length>0;)c=e.pop(),e=e.concat(d.findChildren(c,f.path)),b?"undefined"==typeof c._collapsedParents?c._collapsedParents=1:c._collapsedParents+=1:c._collapsedParents-=1,c._collapsePosition=[a._x,a._y];f.selectVisibleNodes(),f.render()},f.nodeOnRightClick=function(a){f.play(a)},f.nodeOnMouseOver=function(a){f.selectedItem=a,f.render()},f.play=function(a){var b=f.path[0];if("undefined"==typeof b)return void console.debug("Likely a bug: There is no path selection. Not executing play():",a);for(var g,h=c.getLevelDetails(b).level.type,i=null,j=null,k=[a];k.length>0;)g=k.pop(),g.labels[0].name===b&&(null===j&&(j=g),i=g),k=k.concat(d.findChildren(g,f.path));if(console.debug("Node info for playback: ",h,a,i,j),null===i)return void console.debug("No time information found for node, aborting playback",a);var l=0,m=0;"EVENT"===h?(l=i.samplePoint,m=j.samplePoint):"SEGMENT"===h&&(l=i.sampleStart,m=j.sampleStart+j.sampleDur),console.debug("Sample information for playback:",l,m),e.playFromTo(l,m)},f.selectVisibleNodes=function(){if(void 0!==f.path&&f.path.length>0){var a=c.getLevelDetails(f.path[f.path.length-1]).level.items,b=[];b=b.concat(a);for(var e;b.length>0;)e=b.pop(),b=b.concat(d.findChildren(e,f.path)),e._visible=!1;for(b=[],b=b.concat(a);b.length>0;)e=b.pop(),e._collapsed||(b=b.concat(d.findChildren(e,f.path))),e._visible=!0}},f.element=g,f.width=0,f.height=0,f.duration=750;var h=d3.behavior.zoom().scaleExtent([.5,10]).on("zoom",f.zoom),i=d3.select(g[0]).append("svg").attr("width","100%").attr("height","100%").call(h).on("dblclick.zoom",null).append("g").append("g");f.element=g,f.render=function(){f.width=parseInt(d3.select(f.element[0]).style("width"),10),f.height=parseInt(d3.select(f.element[0]).style("height"),10),i.transition().duration(f.duration).attr("transform",f.getOrientatedTransform());var a=[];d.calculateWeightsBottomUp(f.path);for(var e=0;e<f.path.length;++e)for(var g=c.getLevelDetails(f.path[e]).level.items,h=0;h<g.length;++h)g[h]._visible&&a.push(g[h]);for(var j=[],k=b.getData().links,l=0;l<k.length;++l)for(var e=0;e<f.path.length-1;++e){var m=c.getItemFromLevelById(f.path[e],k[l].toID),n=c.getItemFromLevelById(f.path[e+1],k[l].fromID);null!==m&&null!==n&&m._visible&&!n._collapsed&&n._visible&&j.push(k[l])}var o=25,p=function(a){var b=f.vertical?f.height:f.width;return o+a/f.path.length*b},q=function(a){var b=f.vertical?f.width:f.height;return a*b};a.forEach(function(a){a._x=p(a._depth),a._y=q(a._posInLevel)}),j.forEach(function(a){a._fromX=p(a._fromDepth),a._fromY=q(a._fromPosInLevel),a._toX=p(a._toDepth),a._toY=q(a._toPosInLevel)});var r=i.selectAll("g.emuhierarchy-node").data(a,function(a){return a.id}),s=r.enter(),t=r.exit();s=s.append("g").attr("class","emuhierarchy-node").attr("pointer-events","mouseover").on("click",f.nodeOnClick).on("mouseover",f.nodeOnMouseOver).on("contextmenu",f.play),s.append("circle").attr("class","emuhierarchy-nodeCircle").attr("r",0).transition().duration(f.duration).attr("r",4.5),s.append("text").attr("class","emuhierarchy-nodeText"),s.attr("transform",function(a){if("undefined"!=typeof a._collapsePosition){var b=a._collapsePosition[0],c=a._collapsePosition[1];return delete a._collapsePosition,"translate("+b+","+c+")"+f.getOrientatedNodeTransform()}}),t=t.transition().duration(f.duration).attr("transform",function(a){if(a._collapsePosition){var b=a._collapsePosition[0],c=a._collapsePosition[1];return delete a._collapsePosition,"translate("+b+","+c+")"}return"translate(0,0)"}).remove(),t.select("text").style("fill-opacity",0),r.select("text").attr("x",f.getOrientatedTextX).attr("y",f.getOrientatedTextY).attr("text-anchor",f.getOrientatedTextAnchor).attr("transform",f.getOrientatedTextTransform).text(f.getNodeText),r.select("circle.emuhierarchy-nodeCircle").classed("collapsed",function(a){return a._collapsed}).classed("selected",function(a){return"undefined"==typeof f.selectedItem?!1:a.id===f.selectedItem.id}),r.transition().duration(f.duration).attr("transform",function(a){return"translate("+a._x+","+a._y+")"+f.getOrientatedNodeTransform()});var u=i.selectAll("path.emuhierarchy-link").data(j,function(a){return"s"+a.fromID+"t"+a.toID}),v=u.enter(),w=u.exit();v.insert("path","g").attr("class","emuhierarchy-link").style("opacity",0).transition().duration(f.duration).style("opacity",1),w.transition().duration(f.duration).style("opacity",0).remove(),u.transition().duration(f.duration).attr("d",f.getPath).style("opacity",1)},f.resizeHierarchy=function(){console.log("###############"),console.log(f.width)}}}}]),angular.module("emuwebApp").directive("epg",["viewState",function(){return{template:'<div class="emuwebapp-twoDimCanvasContainer"><canvas width="512" height="512"></canvas></div>',restrict:"E",replace:!0,link:function(a,b){var c,d,e,f=b.find("canvas")[0];a.$watch("vs.curViewPort",function(b,c){$.isEmptyObject(a.cps.vals)||$.isEmptyObject(a.ssffds.data)||0!==a.ssffds.data.length&&(c.sS!==b.sS||c.eS!==b.eS)&&a.drawEpgGrid(a)},!0),a.$watch("vs.curMousePosSample",function(){$.isEmptyObject(a.cps.vals)||$.isEmptyObject(a.ssffds.data)||0!==a.ssffds.data.length&&a.drawEpgGrid(a)},!0),a.drawEpgGrid=function(a){var b=f.getContext("2d");c=a.cps.getSsffTrackConfig("EPG"),d=a.ssffds.getColumnOfTrack(c.name,c.columnName),e=a.ssffds.getSampleRateAndStartTimeOfTrack(c.name),b.clearRect(0,0,f.width,f.height),b.fillStyle="green",b.strokeStyle=a.cps.vals.colors.osciColor,b.font=a.cps.vals.font.fontPxSize+"px "+a.cps.vals.font.fontType;var g,h=f.width/8,i=f.height/8,j=1/e.sampleRate-e.startTime,k=Math.round(a.vs.curMousePosSample/a.shs.wavJSO.SampleRate/j);angular.forEach(d.values[k],function(a,c){for(g=a.toString(2).split("").reverse();g.length<8;)g.push("0");g.forEach(function(a,d){"1"===a?(b.fillStyle="grey",b.fillRect(d*h+5,i*c+5,h-10,i-10)):(b.fillStyle="white",b.fillRect(d*h+5,i*c+5,h-10,i-10))})});var l=a.fontImage.getTextImageTwoLines(b,"EPG","Frame:"+k,a.cps.vals.font.fontPxSize,a.cps.vals.font.fontType,a.cps.vals.colors.labelColor,!0);b.drawImage(l,0,0,l.width,l.height,5,0,l.width,l.height)}}}}]),angular.module("emuwebApp").directive("dots",["viewState","ConfigProviderService","Ssffdataservice","fontScaleService","Soundhandlerservice",function(a,b,c,d,e){return{template:'<div class="emuwebapp-twoDimCanvasContainer"><canvas width="512" height="512"></canvas></div>',restrict:"E",replace:!0,scope:{},link:function(f,g){f.cps=b,f.ssffds=c,f.vs=a,f.fontImage=d,f.shs=e;var h=g.find("canvas")[0],i=1/0,j=-1/0,k=1/0,l=-1/0;f.$watch("ssffds.data.length",function(){$.isEmptyObject(f.cps.vals)||$.isEmptyObject(f.ssffds.data)||0!==f.ssffds.data.length&&f.drawDots()},!0),f.$watch("vs.curViewPort",function(a,b){$.isEmptyObject(f.cps.vals)||$.isEmptyObject(f.ssffds.data)||0!==f.ssffds.data.length&&(b.sS!==a.sS||b.eS!==a.eS)&&f.drawDots()},!0),f.$watch("vs.curMousePosSample",function(){$.isEmptyObject(f.cps.vals)||$.isEmptyObject(f.ssffds.data)||0!==f.ssffds.data.length&&f.drawDots()},!0),f.$watch("vs.curPerspectiveIdx",function(){i=1/0,j=-1/0,k=1/0,l=-1/0},!0),f.setGlobalMinMaxVals=function(){for(var a=f.cps.vals.perspectives[f.vs.curPerspectiveIdx].twoDimCanvases.twoDimDrawingDefinitions[0],b=0;b<a.dots.length;b++){var c=f.cps.getSsffTrackConfig(a.dots[b].xSsffTrack),d=f.ssffds.getColumnOfTrack(c.name,c.columnName);d._minVal<i&&(i=d._minVal),d._maxVal>j&&(j=d._maxVal),c=f.cps.getSsffTrackConfig(a.dots[b].ySsffTrack);var e=f.ssffds.getColumnOfTrack(c.name,c.columnName);e._minVal<k&&(k=e._minVal),e._maxVal>l&&(l=e._maxVal)}},f.drawDots=function(){1/0===i&&f.setGlobalMinMaxVals();var a=h.getContext("2d");a.clearRect(0,0,h.width,h.height);var b=a.canvas.width/a.canvas.offsetWidth,c=a.canvas.height/a.canvas.offsetHeight;a.beginPath(),a.moveTo(0,0),a.lineTo(5,5),a.moveTo(0,h.height),a.lineTo(5,h.height-5),a.moveTo(h.width,h.height),a.lineTo(h.width-5,h.height-5),a.stroke(),a.closePath();var d=3*f.cps.vals.font.fontPxSize/4,e=f.fontImage.getTextImage(a,"yMax: "+f.vs.round(l,2),d,f.cps.vals.font.fontType,f.cps.vals.colors.endBoundaryColor);a.drawImage(e,5,5,e.width,e.height),e=f.fontImage.getTextImageTwoLines(a,"yMin: "+f.vs.round(k,2),"xMin: "+f.vs.round(i,2),d,f.cps.vals.font.fontType,f.cps.vals.colors.endBoundaryColor,!0),a.drawImage(e,5,h.height-d*c*2-5,e.width,e.height);var g=a.measureText("xMax: "+f.vs.round(j,5)).width*b;e=f.fontImage.getTextImage(a,"xMax: "+f.vs.round(j,2),d,f.cps.vals.font.fontType,f.cps.vals.colors.endBoundaryColor),a.drawImage(e,h.width-g-5,h.height-d*c-5,e.width,e.height);var m,n=f.cps.vals.perspectives[f.vs.curPerspectiveIdx].twoDimCanvases.twoDimDrawingDefinitions[0],o=f.ssffds.getSampleRateAndStartTimeOfTrack(n.dots[0].xSsffTrack),p=f.ssffds.getSampleRateAndStartTimeOfTrack(n.dots[0].ySsffTrack),q=(1/o.sampleRate,f.vs.curMousePosSample/f.shs.wavJSO.SampleRate);m=Math.round(o.startTime===1/o.sampleRate/2?q*o.sampleRate:q*o.sampleRate+(o.startTime-1/o.sampleRate/2)*o.sampleRate);var r=f.cps.getSsffTrackConfig(n.dots[0].xSsffTrack),s=f.ssffds.getColumnOfTrack(r.name,r.columnName);m>s.values.length-1&&(m=s.values.length-1),g=a.measureText("frame: "+m).width*b,e=f.fontImage.getTextImage(a,"frame: "+m,f.cps.vals.font.fontPxSize-4,f.cps.vals.font.fontType,f.cps.vals.colors.endBoundaryColor);var t=90;a.save(),a.rotate(t*Math.PI/180),a.drawImage(e,h.width/2-g/2,-h.height),a.restore();for(var u=[],v=0;v<n.dots.length;v++){var r=f.cps.getSsffTrackConfig(n.dots[v].xSsffTrack),s=f.ssffds.getColumnOfTrack(r.name,r.columnName);r=f.cps.getSsffTrackConfig(n.dots[v].ySsffTrack);var w=f.ssffds.getColumnOfTrack(r.name,r.columnName);if(s.values.length!==w.values.length)return void alert("columns do not have same length or length of one not 1");var o=f.ssffds.getSampleRateAndStartTimeOfTrack(n.dots[v].xSsffTrack),p=f.ssffds.getSampleRateAndStartTimeOfTrack(n.dots[v].ySsffTrack);if(o.sampleRate!==p.sampleRate||o.startSample!==p.startSample)return void alert("xsRaSt.sampleRate !== ysRaSt.sampleRate || xsRaSt.startSample !== ysRaSt.startSample");var x=(s.values[m][n.dots[v].xContourNr]-i)/(j-i)*h.width,y=h.height-(w.values[m][n.dots[v].yContourNr]-k)/(l-k)*h.height,z=Math.PI/180*0,A=Math.PI/180*360;a.strokeStyle=n.dots[v].color,a.beginPath(),a.arc(x,y,20,z,A,!0),a.stroke(),a.closePath(),a.beginPath(),a.arc(x,y,2,z,A,!0),a.fill(),a.closePath();var e=f.fontImage.getTextImage(a,n.dots[v].name,f.cps.vals.font.fontPxSize-4,f.cps.vals.font.fontType,f.cps.vals.colors.labelColor);a.drawImage(e,x,y-5,e.width,e.height),u.push({name:n.dots[v].name,x:x,y:y})}var B,C;n.connectLines.forEach(function(b){u.forEach(function(a){a.name===b.fromDot&&(B=a),a.name===b.toDot&&(C=a)}),a.strokeStyle=b.color,a.beginPath(),a.moveTo(B.x,B.y),a.lineTo(C.x,C.y),a.stroke(),a.closePath()})}}}}]),angular.module("emuwebApp").directive("myDropZone",["$animate","$compile","DragnDropService","browserDetector","appStateService","modalService",function(a,b,c,d,e,f){return{templateUrl:"views/myDropZone.html",restrict:"E",replace:!0,scope:{},link:function(a,b){a.dropTextDefault="Drop your files here or click here to open a file",a.dropTextErrorFileType="Error: Could not parse file. The following file types are supported: .WAV .TEXTGRID",a.dropTextErrorAPI="Sorry ! The File APIs are not fully supported in your browser.",a.dropAllowed="Drop file(s) to start loading !",a.dropParsingWaiting=".TextGrid loaded! Please load .WAV file in order to start!",a.dropParsingWaitingAnnot="Annotation file loaded! Please load .WAV file in order to start!",a.dropFirefoxWarning="Sorry ! Firefox does not support dropping folders ! please drop single or multiple files !",a.dropText=a.dropTextDefault,a.dropClass="",a.dropClassDefault="",a.dropClassOver="over",a.dropClassError="error",a.count=0,a.handles=[],a.bundles=[],a.bundleNames=[],a.updateQueueLength=function(b){a.count+=b},a.enqueueFileAddition=function(b){var c=b.name.substring(b.name.lastIndexOf("_")+1,b.name.lastIndexOf(".")).toUpperCase(),e=b.name.substr(b.name.lastIndexOf(".")+1).toUpperCase(),f="";f="ANNOT"===c?b.name.substr(0,b.name.lastIndexOf("_")):b.name.substr(0,b.name.lastIndexOf("."));var g=a.bundleNames.indexOf(f);-1===g&&(a.bundleNames.push(f),g=a.bundleNames.indexOf(f),a.bundles[g]=[],a.bundles[g][0]=f),"WAV"===e?(a.bundles[g][1]=b,a.handles.push(b),a.dropClass=a.dropClassDefault,a.dropText=a.dropTextDefault,a.startRendering()):"TEXTGRID"===e?(a.bundles[g][2]={},a.bundles[g][2].file=b,a.bundles[g][2].type="textgrid",a.handles.push(b),a.dropClass=a.dropClassDefault,a.dropText=a.dropParsingWaiting):"JSON"===e&&"ANNOT"===c?(a.bundles[g][2]={},a.bundles[g][2].file=b,a.bundles[g][2].type="annotation",a.handles.push(b),a.dropClass=a.dropClassDefault,a.dropText=a.dropParsingWaitingAnnot):(d.isBrowser.Firefox()&&0===b.size?(a.dropClass=a.dropClassError,a.dropText=a.dropFirefoxWarning):(a.dropClass=a.dropClassError,a.dropText=a.dropTextErrorFileType),a.handles=[],a.bundles=[],a.bundleNames=[],a.count=0),d.isBrowser.Firefox()||a.$digest()},a.startRendering=function(){a.count===a.handles.length&&(c.setData(a.bundles)===!1&&f.open("views/error.html","Sorry you dropped too many bundles ("+a.handles.length+"). The maximum currently allowed is: "+c.maxDroppedBundles).then(function(){e.resetToInitState()
}),a.handles=[],a.bundles=[],a.bundleNames=[],a.count=0)},a.loadFiles=function(b){a.updateQueueLength(b.length);for(var c=0;c<b.length;c++){var d=b[c];if(".DS_Store"===d.name)a.updateQueueLength(-1);else{var e,f;if(d.isFile||d.isDirectory)e=d;else if(d.getAsEntry)e=d.getAsEntry();else{if(!d.webkitGetAsEntry){if("function"==typeof d.getAsFile){a.enqueueFileAddition(d.getAsFile());continue}if(File&&d instanceof File){a.enqueueFileAddition(d);continue}a.updateQueueLength(-1);continue}e=d.webkitGetAsEntry()}e?e.isFile?e.file(function(b){a.enqueueFileAddition(b)},function(a){console.warn(a)}):e.isDirectory&&(f=e.createReader(),f.readEntries(function(b){a.loadFiles(b),a.updateQueueLength(-1)},function(a){console.warn(a)})):updateQueueLength(-1)}}},a.dropFiles=function(b){b.stopPropagation(),b.preventDefault(),a.$apply(function(){if(window.File&&window.FileReader&&window.FileList&&window.Blob){if(void 0!==b.originalEvent){if(d.isBrowser.Firefox())var c=b.originalEvent.dataTransfer.files;else var c=b.originalEvent.dataTransfer.items;a.loadFiles(c)}}else f.open("views/error.html",a.dropTextErrorAPI).then(function(){a.dropText=a.dropTextDefault,a.dropClass=a.dropClassDefault,e.resetToInitState()})})},a.dragEnterLeave=function(b){b.preventDefault(),a.$apply(function(){a.dropText=a.dropTextDefault,a.dropClass=a.dropClassDefault})},a.handleDragOver=function(b){b.preventDefault(),a.$apply(function(){a.dropText=a.dropAllowed,a.dropClass=a.dropClassOver})},b.bind("drop",function(b){a.dropFiles(b)}),b.bind("dragover",function(b){a.handleDragOver(b)}),b.bind("dragenter",function(b){a.dragEnterLeave(b)}),b.bind("dragleave",function(b){a.dragEnterLeave(b)}),b.bind("click",function(){b.context.children[1].children[0].click()})}}}]),angular.module("emuwebApp").directive("myDropZoneInput",["$animate","browserDetector","appStateService",function(){return{templateUrl:"views/myDropZoneInput.html",restrict:"E",scope:{},link:function(a,b){a.acceptGrid=".TextGrid",a.acceptWav="audio/wav",a.acceptBoth=a.acceptWav+","+a.acceptGrid,a.acceptFile=a.acceptBoth,a.handleFilesonChange=function(){var c=b.context.children.fileDialog;a.$parent.loadFiles(c.files)},b.bind("change",function(b){a.handleFilesonChange(b)}),b.bind("click",function(){var a=angular.element("input");void 0!==a[1]&&a[1].click()})}}}]),angular.module("emuwebApp").directive("emuwebapp",["viewState","Iohandlerservice","ConfigProviderService",function(a,b,c){return{templateUrl:"views/emuwebapp.html",restrict:"E",scope:{audioGetUrl:"@",labelGetUrl:"@",labelType:"@"},link:function(b,d,e){d.bind("mouseenter",function(){a.mouseInEmuWebApp=!0}),d.bind("mouseleave",function(){a.mouseInEmuWebApp=!1}),e.$observe("audioGetUrl",function(a){void 0!==a&&""!==a&&(c.embeddedVals.audioGetUrl=a)}),e.$observe("labelGetUrl",function(a){void 0!==a&&""!==a&&(c.embeddedVals.labelGetUrl=a)}),e.$observe("labelType",function(a){void 0!==a&&""!==a&&(c.embeddedVals.labelType=a)})}}}]),angular.module("emuwebApp").service("Validationservice",["$http","$q",function(a,b){var c={},d=[],e=["annotationFileSchema","emuwebappConfigSchema","DBconfigFileSchema","bundleListSchema"];return c.loadSchemas=function(){var c=[];return angular.forEach(e,function(b){c.push(a.get("schemaFiles/"+b+".json"))}),b.all(c)},c.setSchemas=function(a){angular.forEach(a,function(a){d.push({name:a.config.url,data:a.data})})},c.getSchema=function(a){var b=void 0;return angular.forEach(d,function(c){c.name==="schemaFiles/"+a+".json"&&(b=c)}),b},c.validateJSO=function(a,b){var d=c.getSchema(a);return void 0!==d&&tv4.validate(b,d.data)?!0:void 0===d?"Schema: "+a+" is currently undefined! This is probably due to a misnamed schema file on the server...":tv4.error},c}]),angular.module("emuwebApp").controller("ShowhierarchyCtrl",["$scope","DataService","viewState","modalService","ConfigProviderService","LevelService","HierarchyLayoutService",function(a,b,c,d,e,f,g){var h=0;a.paths={possible:[],possibleAsStr:[],selected:""},angular.forEach(e.curDbConfig.levelDefinitions,function(b){"ITEM"!==b.type&&(a.paths.possible=a.paths.possible.concat(g.findPaths(b.name)))}),angular.forEach(a.paths.possible,function(b,c){0===c&&(a.paths.selected=b.join(" ← ")),a.paths.possibleAsStr.push(b.join(" ← "))}),a.getSelIdx=function(){var b=a.paths.possibleAsStr.indexOf(a.paths.selected);return b},a.rotateHierarchy=function(){c.rotateHierarchy()},a.getRotation=function(){return c.isHierarchyRotated()},a.playSelection=function(){++h},a.getPlaying=function(){return h},a.isCurrentAttrDef=function(a,b){return c.getCurAttrDef(a)===b?!0:!1},a.setCurrentAttrDef=function(a,b){c.setCurAttrDef(a,b)},a.getAllAttrDefs=function(a){var b=e.getLevelDefinition(a);return b.attributeDefinitions},a.cancel=function(){var a=function(b){for(var c in b)"_"===c.substr(0,1)&&delete b[c],null!==b[c]&&"object"==typeof b[c]&&a(b[c])};a(b.getData()),d.close()}}]),angular.module("emuwebApp").service("HierarchyLayoutService",["ConfigProviderService","LevelService","DataService",function(a,b,c){var d,e={};return e.findParentLevels=function(b){for(var c=[],d=0;d<a.curDbConfig.linkDefinitions.length;++d)a.curDbConfig.linkDefinitions[d].sublevelName===b&&c.push(a.curDbConfig.linkDefinitions[d].superlevelName);return c},e.findParents=function(a){var c,f,g;if(!d)for(d=!0,c=a.length-1;c>=0;--c){var h=b.getLevelDetails(a[c]).level;for(f=0;f<h.items.length;++f){var i=e.findChildren(h.items[f],a);for(g=0;g<i.length;++g)"undefined"==typeof i[g]._parents&&(i[g]._parents=[]),i[g]._parents.push(h.items[f])}}},e.calculateWeightsBottomUp=function(a){var d,f;for(e.findParents(a),d=0;d<a.length;++d){var g=b.getLevelDetails(a[d]).level;for(g._weight=0,f=0;f<g.items.length;++f){var h=g.items[f]._weight;"undefined"==typeof h&&(h=1,g.items[f]._weight=1),"undefined"!=typeof g.items[f]._parents,g._weight+=h}var i=0;for(f=0;f<g.items.length;++f){g.items[f]._posInLevel=(i+g.items[f]._weight/2)/g._weight,i+=g.items[f]._weight,g.items[f]._depth=a.length-d-1;for(var j=c.getData().links,k=0;k<j.length;++k)j[k].toID===g.items[f].id&&(j[k]._toPosInLevel=g.items[f]._posInLevel,j[k]._toDepth=g.items[f]._depth),j[k].fromID===g.items[f].id&&(j[k]._fromPosInLevel=g.items[f]._posInLevel,j[k]._fromDepth=g.items[f]._depth)}}},e.findPaths=function(a,b){if("undefined"==typeof b)var b=[a];else b=b.concat([a]);var c=this.findParentLevels(a);if(0===c.length)return[b];for(var d=[],f=0;f<c.length;++f)d=d.concat(e.findPaths(c[f],b));return d},e.findChildren=function(a,d){var e=[],f=b.getLevelName(a.id);if(null===f)return console.log("Likely a bug: failed to find a node's level",a),[];for(var g=null,h=0;h<d.length-1;++h)if(d[h+1]===f){g=d[h];break}if(null===g)return[];for(var i=0;i<c.getData().links.length;++i)if(c.getData().links[i].fromID===a.id)for(var j=0;j<c.getData().levels.length;++j)if(c.getData().levels[j].name===g)for(var k=0;k<c.getData().levels[j].items.length;++k)c.getData().levels[j].items[k].id===c.getData().links[i].toID&&e.push(c.getData().levels[j].items[k]);return e},e}]),angular.module("emuwebApp").service("ArrayHelperService",["$q",function(){var a={};return a.convertToAbsValues=function(a){for(var b=0;b<a.length;b++)a[b]=Math.abs(a[b]);return a},a.multiplyEachElement=function(a,b){for(var c=0;c<a.length;c++)a[c]=a[c]*b;return a},a.interp2points=function(a,b,c,d,e){return b+(d-b)*((e-a)/(c-a))},a.findMinMax=function(a,b){var c,d;if("min"===b){c=1/0;for(var e=0;e<a.length;e++)a[e]<c&&(c=a[e],d=e)}else if("max"===b){c=-1/0;for(var e=0;e<a.length;e++)a[e]>c&&(c=a[e],d=e)}return{val:c,idx:d}},a.flattenArrayOfArray=function(a){var b=[];return b=b.concat.apply(b,a)},a.convertArrayToXYjsoArray=function(a){for(var b=[],c=0;c<a.length;c++)b.push({x:c,y:a[c]});return b},a}]),angular.module("emuwebApp").service("AnagestService",["$q","$log","viewState","LevelService","LinkService","ConfigProviderService","Ssffdataservice","ArrayHelperService","modalService","HistoryService","DataService",function(a,b,c,d,e,f,g,h,i,j,k){var l,m={};return m.insertAnagestEvents=function(){var l=a.defer(),n=c.getItemsInSelection(k.data.levels);if(0!==n.length)return i.open("views/error.html","There are already events in the selected area! This is not permitted...").then(function(){l.reject()}),l;var o=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.verticalPosSsffTrackName,p=f.getSsffTrackConfig(o),q=g.getColumnOfTrack(p.name,p.columnName),r=g.getSampleRateAndStartTimeOfTrack(p.name),s=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.velocitySsffTrackName,t=f.getSsffTrackConfig(s),u=g.getColumnOfTrack(t.name,t.columnName);if(g.getSampleRateAndStartTimeOfTrack(t.name),1!==q.length||1!==u.length)return i.open("views/error.html","UPS... the column length of of one of the tracks is != 1 this means something is badly configured in the DB!!!").then(function(){l.reject()}),l;var v=h.flattenArrayOfArray(q.values),w=h.flattenArrayOfArray(u.values),x=[0/0,0/0],y=[0/0,0/0],z=[0/0,0/0],A=[0/0,0/0];w=h.convertToAbsValues(w);var B=c.getSelectedStartTime(),C=c.getSelectedEndTime(),D=Math.round(B*r.sampleRate+r.startTime),E=Math.round(C*r.sampleRate+r.startTime),F=E-D,G=v.slice(D,D+F),H=w.slice(D,D+F),I=h.findMinMax(G,"max");A[0]=I.idx;var J=h.findMinMax(H.slice(0,A[0]+1),"max");y[0]=J.idx;var K=h.findMinMax(H.slice(0,y[0]+1),"min");return b.info("Looking for gesture onset"),m.interactiveFindThresholds(H.slice(0,y[0]+1),K.val,J.val,f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.threshold,1,"Looking for gesture onset").then(function(a){var k=a;x[0]=k;var n=h.findMinMax(H.slice(y[0],A[0]+1),"min"),o=n.idx+y[0];b.info("Looking for nucleus onset"),m.interactiveFindThresholds(H.slice(y[0],o+1),n.val,J.val,f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.threshold,-1,"Looking for nucleus onset").then(function(a){var k=a;z[0]=k+y[0];var n=h.findMinMax(H.slice(A[0]),"max");y[1]=n.idx+A[0];var p=h.findMinMax(H.slice(A[0],y[1]+1),"min");o=p.idx+A[0],b.info("Looking for nucleus offset"),m.interactiveFindThresholds(H.slice(o,y[1]+1),p.val,n.val,f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.threshold,1,"Looking for nucleus offset").then(function(a){var k=a;z[1]=k+o;var p=h.findMinMax(H.slice(y[1]),"min");o=p.idx+y[1],b.info("Looking for gesture offset"),m.interactiveFindThresholds(H.slice(y[1],o+1),p.val,n.val,f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.threshold,-1,"Looking for gesture offset").then(function(a){var b=a;x[1]=b+y[1];var h;x[0]=g.calculateSamplePosInVP(D+x[0],r.sampleRate,r.startTime),x[1]=g.calculateSamplePosInVP(D+x[1],r.sampleRate,r.startTime),h=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.gestureOnOffsetLabels[0];var k=d.insertEvent(c.getcurClickLevelName(),x[0],h);j.updateCurChangeObj({type:"ANNOT",action:"INSERTEVENT",name:c.getcurClickLevelName(),start:x[0],id:k.id,pointName:h}),h=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.gestureOnOffsetLabels[1];var m=d.insertEvent(c.getcurClickLevelName(),x[1],h);j.updateCurChangeObj({type:"ANNOT",action:"INSERTEVENT",name:c.getcurClickLevelName(),start:x[1],id:m.id,pointName:h}),y[0]=g.calculateSamplePosInVP(D+y[0],r.sampleRate,r.startTime),y[1]=g.calculateSamplePosInVP(D+y[1],r.sampleRate,r.startTime),h=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.maxVelocityOnOffsetLabels[0];var n=d.insertEvent(c.getcurClickLevelName(),y[0],h);j.updateCurChangeObj({type:"ANNOT",action:"INSERTEVENT",name:c.getcurClickLevelName(),start:y[0],id:n.id,pointName:h}),h=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.maxVelocityOnOffsetLabels[1];var o=d.insertEvent(c.getcurClickLevelName(),y[1],h);j.updateCurChangeObj({type:"ANNOT",action:"INSERTEVENT",name:c.getcurClickLevelName(),start:y[1],id:o.id,pointName:h}),z[0]=g.calculateSamplePosInVP(D+z[0],r.sampleRate,r.startTime),z[1]=g.calculateSamplePosInVP(D+z[1],r.sampleRate,r.startTime),h=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.constrictionPlateauBeginEndLabels[0];var p=d.insertEvent(c.getcurClickLevelName(),z[0],h);j.updateCurChangeObj({type:"ANNOT",action:"INSERTEVENT",name:c.getcurClickLevelName(),start:z[0],id:p.id,pointName:h}),h=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.constrictionPlateauBeginEndLabels[1];var q=d.insertEvent(c.getcurClickLevelName(),z[1],h);j.updateCurChangeObj({type:"ANNOT",action:"INSERTEVENT",name:c.getcurClickLevelName(),start:z[1],id:q.id,pointName:h}),A[0]=g.calculateSamplePosInVP(D+A[0],r.sampleRate,r.startTime),h=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.maxConstrictionLabel;var s=d.insertEvent(c.getcurClickLevelName(),A[0],h);j.updateCurChangeObj({type:"ANNOT",action:"INSERTEVENT",name:c.getcurClickLevelName(),start:A[0],id:s.id,pointName:h});var t=f.getLevelDefinition(c.getcurClickLevelName()).anagestConfig.autoLinkLevelName,u=d.getLevelDetails(t),v=d.getAllLabelsOfLevel(u);i.changeModal("views/SelectLabelModal.html",v,void 0,!0).then(function(a){if(a!==!1){var b=[k.id,m.id,n.id,o.id,p.id,q.id,s.id];e.insertLinksTo(u.level.items[a].id,b),j.updateCurChangeObj({type:"ANNOT",action:"INSERTLINKSTO",name:u.level.name,parentID:u.level.items[a].id,childIDs:b}),j.addCurChangeObjToUndoStack()}}),l.resolve()})})})},function(){}),l.promise},m.interactiveFindThresholds=function(b,c,d,e,f,g){var j=c+(d-c)*e,k=f;j*=k;for(var m=h.multiplyEachElement(b,k),n=m.length,o=m.slice(1,n),p=0,q=n-1,r=[],s=0;s<m.length;s++)o[s]>=j&&m[s]<j&&r.push(s);for(var t=[],s=0;s<r.length;s++)r[s]>=p&&r[s]<=q&&t.push(s);if(t.length>1){l=a.defer();var u={};u.description=g,u.options=[],u.y=m,u.minVal=c,u.maxVal=d,u.threshold=e;for(var s=0;s<r.length;s++)u.options.push({thresholdIdx:r[s],thresholdValue:m[s]});return i.open("views/SelectThresholdModal.html",u,void 0,!0).then(function(a){console.log(a);var b=r[t[a]];b=h.interp2points(m[b],b,m[b+1],b+1,j),l.resolve(b)}),l.promise}if(0===t.length)return l=a.defer(),i.open("views/error.html","Could not find any values that step over the threshold!!").then(function(){l.reject("Could not find any values that step over the threshold!!")}),l.promise;l=a.defer();var v=r[t[0]];return v=h.interp2points(m[v],v,m[v+1],v+1,j),l.resolve(v),l.promise},m}]),angular.module("emuwebApp").service("DragnDropDataService",["$q","ConfigProviderService",function(a){var b={};return b.convertedBundles=[],b.sessionDefault="",b.getBundle=function(c){var d=a.defer();return angular.forEach(b.convertedBundles,function(a){a.name===c&&d.resolve({status:200,data:a})}),d.promise},b.resetToInitState=function(){b.convertedBundles=[],b.sessionDefault=""},b.setDefaultSession=function(a){b.sessionDefault=a},b.getDefaultSession=function(){return b.sessionDefault},b}]),angular.module("emuwebApp").service("DragnDropService",["$q","$rootScope","appStateService","modalService","DataService","Validationservice","ConfigProviderService","DragnDropDataService","Iohandlerservice","viewState","Soundhandlerservice","Binarydatamaniphelper","browserDetector","Wavparserservice","Textgridparserservice","loadedMetaDataService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){var q={};return q.drandropBundles=[],q.bundleList=[],q.sessionName="File(s)",q.maxDroppedBundles=10,q.setData=function(a){var b=0;return angular.forEach(a,function(a,c){q.setDragnDropData(a[0],c,"wav",a[1]),q.setDragnDropData(a[0],c,"annotation",a[2]),b=c}),b<=q.maxDroppedBundles?void q.convertDragnDropData(q.drandropBundles,0).then(function(){return p.setBundleList(q.bundleList),p.setCurBndlName(q.bundleList[h.sessionDefault]),p.setDemoDbName(q.bundleList[h.sessionDefault]),q.handleLocalFiles(),!0}):!1},q.resetToInitState=function(){q.drandropBundles=[],q.bundleList=[]},q.setDragnDropData=function(a,b,c,d){void 0===q.drandropBundles[b]&&(q.drandropBundles[b]={},h.convertedBundles[b]={},h.convertedBundles[b].name=a,q.bundleList.push({name:a,session:q.sessionName}),h.setDefaultSession(b)),"wav"===c?q.drandropBundles[b].wav=d:"annotation"===c&&(q.drandropBundles[b].annotation=d)},q.getDragnDropData=function(a,b){return"wav"===b?q.drandropBundles[a].wav:"annotation"===b?q.drandropBundles[a].annotation:!1},q.generateDrop=function(a){var b;return b="object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.createObjectURL(q.getBlob(a)):URL.createObjectURL(q.getBlob(a))},q.getBlob=function(a){var b;try{b=new Blob([a],{type:"text/plain"})}catch(c){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,b=new BlobBuilder,b.append(a),b=b.getBlob()}return b},q.convertDragnDropData=function(b,c){var d,e=a.defer(),f=q.drandropBundles[c],g=new FileReader,i=new FileReader;return b.length>c?(void 0!==f.wav&&(g.readAsArrayBuffer(f.wav),g.onloadend=function(a){a.target.readyState==FileReader.DONE&&(d=m.isBrowser.Firefox()?a.target.result:a.currentTarget.result,n.parseWavArrBuf(d).then(function(a){h.convertedBundles[c].mediaFile={},k.wavJSO=a,h.convertedBundles[c].mediaFile.data=l.arrayBufferToBase64(a.origArrBuf),h.convertedBundles[c].ssffFiles={};var d=f.wav.name.substr(0,f.wav.name.lastIndexOf("."));void 0===f.annotation?(h.convertedBundles[c].annotation={levels:[],links:[],sampleRate:a.SampleRate,annotates:d,name:d},q.convertDragnDropData(b,c+1).then(function(){e.resolve()})):"textgrid"===f.annotation.type?(i.readAsText(f.annotation.file),i.onloadend=function(a){a.target.readyState==FileReader.DONE&&o.asyncParseTextGrid(a.currentTarget.result,f.wav.name,d).then(function(a){h.convertedBundles[c].annotation=a,q.convertDragnDropData(b,c+1).then(function(){e.resolve()})})}):"annotation"===f.annotation.type&&(i.readAsText(f.annotation.file),i.onloadend=function(a){a.target.readyState==FileReader.DONE&&(console.log(a.currentTarget.result),h.convertedBundles[c].annotation=a.currentTarget.result,q.convertDragnDropData(b,c+1).then(function(){e.resolve()}))})}))}),e.promise):(e.resolve(),e.promise)},q.handleLocalFiles=function(){var a,b=h.convertedBundles[h.sessionDefault].mediaFile.data,m=l.base64ToArrayBuffer(b),o=h.convertedBundles[h.sessionDefault].annotation;j.showDropZone=!1,j.setState("loadingSaving"),j.somethingInProgress=!0,j.somethingInProgressTxt="Loading local File: "+b.name,i.httpGetPath("configFiles/standalone_emuwebappConfig.json").then(function(b){j.curPerspectiveIdx=0,g.setVals(b.data.EMUwebAppConfig),delete b.data.EMUwebAppConfig,a=f.validateJSO("emuwebappConfigSchema",g.vals),a===!0&&(g.curDbConfig=b.data,j.somethingInProgressTxt="Parsing WAV file...",n.parseWavArrBuf(m).then(function(a){var b=a;j.curViewPort.sS=0,j.curViewPort.eS=b.Data.length,j.curViewPort.selectS=-1,j.curViewPort.selectE=-1,j.curClickSegments=[],j.curClickLevelName=void 0,j.curClickLevelType=void 0,p.setCurBndl(h.convertedBundles[h.sessionDefault]),j.resetSelect(),j.curPerspectiveIdx=0,e.setData(o);var i=[],l=[];o.levels.forEach(function(a){i.push(a.name),l.push({name:a.name,type:a.type,attributeDefinitions:{name:a.name,type:"string"}})}),g.curDbConfig.levelDefinitions=l,j.setCurLevelAttrDefs(g.curDbConfig.levelDefinitions),g.setPerspectivesOrder(j.curPerspectiveIdx,i),k.wavJSO=b,j.somethingInProgressTxt="Parsing SSFF files...";var m=f.validateJSO("annotationFileSchema",o);m===!0?(e.setData(o),j.setState("labeling"),j.somethingInProgress=!1,j.somethingInProgressTxt="Done!"):d.open("views/error.html","Error validating annotation file: "+JSON.stringify(m,null,4)).then(function(){q.resetToInitState(),c.resetToInitState()})},function(a){d.open("views/error.html","Error parsing wav file: "+a).then(function(){q.resetToInitState(),c.resetToInitState()})}))}),j.somethingInProgress=!1},q}]),angular.module("emuwebApp").directive("lineChart",function(){return{restrict:"E",scope:{data:"=",threshold:"="},link:function(a,b){a.$watch("data",function(){a.render(a.data)},!0);var c={top:20,right:20,bottom:20,left:40},d=400-c.left-c.right,e=200-c.top-c.bottom,f=d3.select(b[0]).append("svg").attr("width",d+c.left+c.right).attr("height",e+c.top+c.bottom).append("g").attr("transform","translate("+c.left+","+c.top+")"),g=d3.scale.linear().range([0,d]),h=d3.scale.linear().range([e,0]),i=d3.svg.axis().scale(g).tickSize(5).tickSubdivide(!0),j=d3.svg.axis().scale(h).orient("left"),k=d3.svg.line().x(function(a){return g(a.x)}).y(function(a){return h(a.y)}).interpolate("linear");a.render=function(b){g.domain([d3.min(b,function(a){return a.x}),d3.max(b,function(a){return a.x})]),h.domain([d3.min(b,function(a){return a.y}),d3.max(b,function(a){return a.y})]),f.selectAll("g.axis").remove(),f.append("g").attr("class","x axis").attr("transform","translate(0,"+e+")").call(i),f.append("g").attr("class","y axis").call(j),f.append("svg:path").attr("d",k(b)).attr("stroke","red").attr("stroke-width",1).attr("fill","none"),f.append("svg:line").attr("x1",5).attr("y1",5).attr("x2",200).attr("y2",200).attr("class","label-line"),f.append("line").attr({x1:g(a.threshold),y1:0,x2:g(a.threshold),y2:e}).attr("stroke","steelblue").attr("class","verticalLine")}}}}),angular.module("emuwebApp").directive("tutorial",["viewState","Iohandlerservice","ConfigProviderService",function(a,b,c){return{templateUrl:"views/tutorial.html",restrict:"E",scope:{},link:function(b){b.counter=0,b.css=[],b.vs=a,b.cps=c,b.cssDone={color:"#222"},b.cssNotDone={color:"#ddd"},b.cssActive={color:"red","font-size":"18px"},b.que=[],b.$watch("vs.lastKeyCode",function(a){void 0!==a&&a===b.que[b.counter]&&++b.counter,console.log(a)}),b.getClass=function(a){return a==b.counter?b.cssActive:a<b.counter?b.cssDone:b.cssNotDone},b.getStrRep=function(a,d){return b.que[a]=d,c.getStrRep(d)}}}}]),angular.module("emuwebApp").service("loadedMetaDataService",["Validationservice",function(a){function b(a){var b,c=[];return a.forEach(function(a,d){c[a.session]={collapsed:!0},0===d&&(b=a.session)}),c[b].collapsed=!1,c}var c={},d=[],e=[],f={},g="";return c.setBundleList=function(c){var f=a.validateJSO("bundleListSchema",c);return f===!0&&(e=c,d=b(e)),f},c.getBundleList=function(){return e},c.setCurBndl=function(a){f=a},c.setCurBndlName=function(a){f.name=a},c.getCurBndlName=function(){return f.name},c.getCurBndl=function(){return f},c.setDemoDbName=function(a){g=a},c.getDemoDbName=function(){return g},c.toggleCollapseSession=function(a){d[a].collapsed=!d[a].collapsed},c.updateCollapseSessionState=function(a){angular.forEach(c.getBundleList(),function(b){d[b.session].collapsed=b.name.indexOf(a)?!1:!0})},c.getSessionCollapseState=function(a){return d[a].collapsed},c.resetToInitState=function(){d=[],e=[],f={}},c}]),angular.module("emuwebApp").controller("bundleListSideBarCtrl",["$scope","viewState","HistoryService","loadedMetaDataService","dbObjLoadSaveService","ConfigProviderService",function(a,b,c,d,e,f){a.vs=b,a.lmds=d,a.dolss=e,a.cps=f,a.filterText="",a.uttIsDisabled=function(a){return a.name===d.getCurBndl().name?!1:!0},a.getBndlColor=function(a){var b;return b=0!==c.movesAwayFromLastSave?{"background-color":"#f00",color:"white"}:{"background-color":"#999",color:"black"},a.name===d.getCurBndl().name?b:void 0},a.isSessionDefined=function(a){return"undefined"===a?!1:!0}}]),angular.module("emuwebApp").service("dbObjLoadSaveService",["$log","$q","DataService","viewState","HistoryService","loadedMetaDataService","Ssffdataservice","Iohandlerservice","Binarydatamaniphelper","Wavparserservice","Soundhandlerservice","Ssffparserservice","Validationservice","LevelService","modalService","ConfigProviderService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){var q={};return q.loadBundle=function(a){0!==e.movesAwayFromLastSave&&"DEMO"!==p.vals.main.comMode?a!==f.getCurBndl()&&o.open("views/saveChanges.html",a.name).then(function(b){"saveChanges"===b?q.saveBundle().then(function(){q.loadBundle(a)}):"discardChanges"===b&&(e.resetToInitState(),q.loadBundle(a))}):a!==f.getCurBndl()&&(e.resetToInitState(),d.setState("loadingSaving"),d.somethingInProgress=!0,d.somethingInProgressTxt="Loading bundle: "+a.name,g.data=[],h.getBundle(a.name,a.session,f.getDemoDbName()).then(function(b){200===b.status&&(b=b.data);var e;e=i.base64ToArrayBuffer(b.mediaFile.data),d.somethingInProgressTxt="Parsing WAV file...",j.parseWavArrBuf(e).then(function(e){var h=e;d.curViewPort.sS=0,d.curViewPort.eS=h.Data.length,d.curViewPort.selectS=-1,d.curViewPort.selectE=-1,d.curClickSegments=[],d.curClickLevelName=void 0,d.curClickLevelType=void 0,d.resetSelect(),k.wavJSO=h,d.somethingInProgressTxt="Parsing SSFF files...",l.asyncParseSsffArr(b.ssffFiles).then(function(e){g.data=e.data;var h=m.validateJSO("annotationFileSchema",b.annotation);h===!0?(c.setData(b.annotation),f.setCurBndl(a),d.setState("labeling"),d.somethingInProgress=!1,d.somethingInProgressTxt="Done!"):o.open("views/error.html","Error validating annotation file: "+JSON.stringify(h,null,4)).then(function(){$scope.resetToInitState()})},function(a){o.open("views/error.html","Error parsing SSFF file: "+a.status.message).then(function(){$scope.resetToInitState()})})},function(a){o.open("views/error.html","Error parsing wav file: "+a.status.message).then(function(){$scope.resetToInitState()})})},function(a){a.data?o.open("views/error.html","Error loading bundle: "+a.data).then(function(){$scope.resetToInitState()}):o.open("views/error.html","Error loading bundle: "+a.status.message).then(function(){$scope.resetToInitState()})}))},q.saveBundle=function(){if(d.getPermission("saveBndlBtnClick")){var c=b.defer();d.somethingInProgress=!0,d.setState("loadingSaving");var e={};d.somethingInProgressTxt="Creating bundle json...",e.ssffFiles=[];var f={};return g.data.forEach(function(a){"FORMANTS"===a.ssffTrackName&&(f=a)}),$.isEmptyObject(f)?q.getAnnotationAndSaveBndl(e,c):l.asyncJso2ssff(f).then(function(a){e.ssffFiles.push({ssffTrackName:f.ssffTrackName,encoding:"BASE64",data:i.arrayBufferToBase64(a.data)}),q.getAnnotationAndSaveBndl(e,c)},function(a){o.open("views/error.html","Error converting javascript object to SSFF file: "+a.status.message),c.reject()}),c.promise}a.info("Action: menuBundleSaveBtnClick not allowed!")},q.getAnnotationAndSaveBndl=function(a,b){a.annotation=c.getData();var g=f.getCurBndl();"undefined"!=typeof g.session&&(a.session=g.session),"undefined"!=typeof g.finishedEditing&&(a.finishedEditing=g.finishedEditing),"undefined"!=typeof g.comment&&(a.comment=g.comment),d.somethingInProgressTxt="Saving bundle...",h.saveBundle(a).then(function(){d.somethingInProgressTxt="Done!",d.somethingInProgress=!1,e.movesAwayFromLastSave=0,b.resolve(),d.setState("labeling")},function(a){o.open("views/error.html","Error saving bundle: "+a.status.message).then(function(){$scope.resetToInitState()}),b.reject()})},q}]),angular.module("emuwebApp").service("appStateService",["$log","$rootScope","DragnDropDataService","viewState","Iohandlerservice","loadedMetaDataService","Soundhandlerservice","DataService","Ssffdataservice","HistoryService",function(a,b,c,d,e,f,g,h,i,j){var k={};return k.resetToInitState=function(){e.wsH.isConnected()&&e.wsH.disconnectWarning().then(function(){a.info("Closing websocket connection to server"),e.wsH.closeConnect()}),f.resetToInitState(),g.wavJSO={},h.setData({}),c.resetToInitState(),i.data=[],j.resetToInitState(),d.setState("noDBorFilesloaded"),d.somethingInProgress=!1,d.resetToInitState(),j.resetToInitState(),d.showDropZone=!0,b.$broadcast("resetToInitState")},k}]),wavParserWorker.prototype={getWorkerScript:function(){var a="";return a+="("+this.workerInit+")(this);"},workerInit:function(a){ArrayBuffer.prototype.subarray=function(a,b){for(var c=new ArrayBuffer(b),d=new Int8Array(c),e=new Int8Array(this),f=0;b>f;f++)d[f]=e[a+f];return c},a.ab2str=function(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c]);return String.fromCharCode.apply(null,b)},a.wav2jso=function(b){var c,d,e,f={};return c=0,d=b.subarray(c,4),e=new Uint8Array(d),f.ChunkID=a.ab2str(e),"RIFF"!==f.ChunkID?{status:{type:"ERROR",message:"Wav read error: ChunkID not RIFF but "+f.ChunkID}}:(c=4,d=b.subarray(c,4),e=new Uint32Array(d),f.ChunkSize=e[0],c=8,d=b.subarray(c,4),e=new Uint8Array(d),f.Format=a.ab2str(e),"WAVE"!==f.Format?{status:{type:"ERROR",message:"Wav read error: Format not WAVE but "+f.Format}}:(c=12,d=b.subarray(c,4),e=new Uint8Array(d),f.Subchunk1ID=a.ab2str(e),"fmt "!==f.Subchunk1ID?{status:{type:"ERROR",message:"Wav read error: Subchunk1ID not fmt  but "+f.Subchunk1ID}}:(c=16,d=b.subarray(c,4),e=new Uint32Array(d),f.Subchunk1Size=e[0],16!==f.Subchunk1Size?{status:{type:"ERROR",message:"Wav read error: Subchunk1Size not 16 but "+f.Subchunk1Size}}:(c=20,d=b.subarray(c,2),e=new Uint16Array(d),f.AudioFormat=e[0],1!==f.AudioFormat?{status:{type:"ERROR",message:"Wav read error: AudioFormat not 1 but "+f.AudioFormat}}:(c=22,d=b.subarray(c,2),e=new Uint16Array(d),f.NumChannels=e[0],1!==f.NumChannels?{status:{type:"ERROR",message:"Wav read error: NumChannels not 1 but "+f.NumChannels}}:(c=24,d=b.subarray(c,4),e=new Uint32Array(d),f.SampleRate=e[0],c=28,d=b.subarray(c,4),e=new Uint32Array(d),f.ByteRate=e[0],c=32,d=b.subarray(c,2),e=new Uint16Array(d),f.BlockAlign=e[0],c=34,d=b.subarray(c,2),e=new Uint16Array(d),f.BitsPerSample=e[0],16!==f.BitsPerSample?{status:{type:"ERROR",message:"Wav read error: BitsPerSample not 16 but "+f.BitsPerSample}}:(c=36,d=b.subarray(c,4),e=new Uint8Array(d),f.Subchunk2ID=a.ab2str(e),"data"!==f.Subchunk2ID?{status:{type:"ERROR",message:"Wav read error: Subchunk2ID not data but "+f.Subchunk2ID}}:(c=40,d=b.subarray(c,4),e=new Uint32Array(d),f.Subchunk2Size=e[0],c=44,d=b.subarray(c,f.Subchunk2Size),e=new Int16Array(d),f.Data=e,f.origArrBuf=b,f))))))))},a.onmessage=function(b){if(void 0!==b.data)switch(b.data.cmd){case"parseBuf":var c=a.wav2jso(b.data.buffer);a.postMessage(void 0===c.status?{status:{type:"SUCCESS",message:""},data:c}:c);break;default:a.postMessage({status:{type:"ERROR",message:"Unknown command sent to wavParserWorker"}})}else a.postMessage({status:{type:"ERROR",message:"Undefined message was sent to wavParserWorker"}})}},getWorkerURL:function(){var a,b;try{a=new Blob([this.getWorkerScript()],{type:"application/javascript"})}catch(c){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,a=new BlobBuilder,a.append(textGridParserWorker),a=a.getBlob()}return b="object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.createObjectURL(a):URL.createObjectURL(a)},kill:function(){this.worker&&this.worker.terminate(),this.url&&URL.revokeObjectURL(this.url)},tell:function(a){this.worker&&this.worker.postMessage(a)},says:function(a){this.worker&&this.worker.addEventListener("message",function(b){a(b.data)})}},espsParserWorker.prototype={getWorkerScript:function(){var a="";return a+="("+this.workerInit+")(this);"},workerInit:function(a){a.toJSO=function(a,b,c,d){var e={};e.name=c,e.annotates=b,e.sampleRate=d,e.levels=[],a=a.replace(/([ \t]*\r?\n)+/g,"\n"),a=a.replace(/[ \t]+/g," ");for(var f,g=a.split("\n"),h=0;h<g.length;h++)if("#"===g[h]){f=h;break}e.levels[0]={},e.levels[0].name=c,e.levels[0].items=[];var i,j=1,k=g[f+1].split(/\s+/);if(e.levels[0].type="H#"!==k[k.length-1]?"EVENT":"SEGMENT","EVENT"===e.levels[0].type)for(h=f+1;h<g.length-1;h++)k=g[h].split(/\s+/),e.levels[0].items.push({id:j,labels:[{name:c,value:k[k.length-1]}],samplePoint:Math.floor(k[1]*d)}),j+=1;else for(j+=1,h=f+2;h<g.length-1;h++)k=g[h].split(/\s+/),i=g[h-1].split(/\s+/),e.levels[0].items.push({id:j,labels:[{name:c,value:k[k.length-1]}],sampleStart:Math.floor(i[1]*d),sampleDur:Math.floor(k[1]*d)-Math.floor(i[1]*d)-1}),j+=1;return e},a.toESPS=function(a,b,c){var d="";d+="signal "+b+"\n",d+="nfields 1\n",d+="#\n";for(var e,f=0;f<a.length;f++)e=""===a[f].labels[0].value&&0===f?"H#":a[f].labels[0].value,d+="	"+String((a[f].sampleStart+a[f].sampleDur)/c)+"	125	"+e+"\n";return d},a.onmessage=function(b){if(void 0!==b.data){var c;switch(b.data.cmd){case"parseESPS":c=a.toJSO(b.data.esps,b.data.annotates,b.data.name,b.data.sampleRate),a.postMessage(void 0===c.type?{status:{type:"SUCCESS",message:""},data:c}:c);break;case"parseJSO":c=a.toESPS(b.data.level.items,b.data.level.name,b.data.sampleRate),a.postMessage(void 0===c.type?{status:{type:"SUCCESS",message:""},data:c}:c);break;default:a.postMessage({status:{type:"ERROR",message:"Unknown command sent to espsParserWorker"}})
}}else a.postMessage({status:{type:"ERROR",message:"Undefined message was sent to espsParserWorker"}})}},getWorkerURL:function(){var a,b;try{a=new Blob([this.getWorkerScript()],{type:"application/javascript"})}catch(c){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,a=new BlobBuilder,a.append(textGridParserWorker),a=a.getBlob()}return b="object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.createObjectURL(a):URL.createObjectURL(a)},kill:function(){this.worker&&this.worker.terminate(),this.url&&URL.revokeObjectURL(this.url)},tell:function(a){this.worker&&this.worker.postMessage(a)},says:function(a){this.worker&&this.worker.addEventListener("message",function(b){a(b.data)})}},textGridParserWorker.prototype={getWorkerScript:function(){var a="";return a+="("+this.workerInit+")(this);"},workerInit:function(a){a.l1='File type = "ooTextFile"',a.l2='Object class = "TextGrid"',a.localID=0,a.testForGapsInLabelJSO=function(a){for(var b=0,c=0;c<a.levels.length;c++)if("SEGMENT"===a.levels[c].type)for(var d=0;d<a.levels[c].items.length-1;d++)a.levels[c].items[d].sampleStart+a.levels[c].items[d].sampleDur+1!==a.levels[c].items[d+1].sampleStart&&(b+=1)},a.findTimeOfMinSample=function(){return 0},a.findTimeOfMaxSample=function(a,b){return a/b},a.toJSO=function(b,c,d,e){var f="123abcABCCBAcba321";b=b.replace(/([ \t]*\r?\n)+/g,"\n"),b=b.replace(/("[^\n]*")/g,function(a,b){var c=b.replace(/\s+/g,f);return c}),b=b.replace(/[\t ]+/g,"");var g=new RegExp(f,"g");b=b.replace(g," ");var h,i,j,k,l=b.split("\n"),m=!0,n=[],o={name:d,annotates:c,sampleRate:e,levels:[],links:[]};if(l[0].replace(/\s+/g,"")===a.l1.replace(/\s+/g,"")&&l[1].replace(/\s+/g,"")===a.l2.replace(/\s+/g,"")){for(var p=2;p<l.length;p++){var q=l[p];if("item[]:"!==q){if(!m)if(0===q.indexOf("item[")&&(i=l[p+2].split(/=/)[1].replace(/"/g,""),'"IntervalTier"'===l[p+1].split(/=/)[1]?(h="SEGMENT",o.levels.push({name:i,type:h,items:[]})):'"TextTier"'===l[p+1].split(/=/)[1]&&(h="EVENT",o.levels.push({name:i,type:h,items:[]}))),o.levels.length>0&&"SEGMENT"===o.levels[o.levels.length-1].type&&0===q.indexOf("intervals")&&0!==q.indexOf("intervals:")){var r=Math.floor(l[p+1].split(/=/)[1]*e)+1;1===r&&(r=0);var s=Math.floor(l[p+2].split(/=/)[1]*e);k=l[p+3].split(/=/)[1].replace(/"/g,"");var n=[];n.push({name:o.levels[o.levels.length-1].name,value:k}),o.levels[o.levels.length-1].items.push({id:a.localID,sampleStart:r,sampleDur:s-r+1,labels:n}),++a.localID}else o.levels.length>0&&"EVENT"===o.levels[o.levels.length-1].type&&0===q.indexOf("points")&&0!==q.indexOf("points:")&&(j=l[p+1].split(/=/)[1]*e,k=l[p+2].split(/=/)[1].replace(/"/g,""),n=[],n.push({name:o.levels[o.levels.length-1].name,value:k}),o.levels[o.levels.length-1].items.push({id:a.localID,samplePoint:Math.round(j),labels:n}),++a.localID)}else m=!1}return a.testForGapsInLabelJSO(o),o}return{status:{type:"ERROR",message:"bad header in TextGrid file!!! The header has to be: "+a.l1+"\n"+a.l2}}},a.toTextGrid=function(b,c,d){var e="",f="\n",g="	";e=e+a.l1+f+a.l2+f+f,e=e+"xmin = "+a.findTimeOfMinSample()+f,e=e+"xmax = "+a.findTimeOfMaxSample(c,d)+f,e=e+"levels? <exists>"+f,e=e+"size = "+b.length+f,e=e+"item []:"+f;for(var h=0;h<b.length;h++){var i=b[h];e=e+g+"item ["+h+"]:"+f,"SEGMENT"===i.type?e=e+g+g+'class = "IntervalTier"'+f:"EVENT"===i.type&&(e=e+g+g+'class = "TextTier"'+f),e=e+g+g+'name = "'+i.name+'"'+f,e=e+g+g+"xmin = "+a.findTimeOfMinSample()+f,e=e+g+g+"xmax = "+a.findTimeOfMaxSample(c,d)+f,"SEGMENT"===i.type?e=e+g+g+"intervals: size = "+i.items.length+f:"EVENT"===i.type&&(e=e+g+g+"points: size = "+i.items.length+f);for(var j,k=0;k<i.items.length;k++){var l=k+1;"SEGMENT"===i.type?(e=e+g+g+g+"intervals ["+l+"]:"+f,0!==i.items[k].sampleStart?(j=i.items[k].sampleStart/d+1/d/2,e=e+g+g+g+g+"xmin = "+j+f):e=e+g+g+g+g+"xmin = 0"+f,k<i.items.length-1?(j=(i.items[k].sampleStart+i.items[k].sampleDur)/d+1/d/2,e=e+g+g+g+g+"xmax = "+j+f):e=e+g+g+g+g+"xmax = "+a.findTimeOfMaxSample(c,d)+f,e=e+g+g+g+g+'text = "'+i.items[k].labels[0].value+'"'+f):"EVENT"===i.type&&(e=e+g+g+g+"points["+l+"]:"+f,e=e+g+g+g+g+"time = "+i.items[k].sampleStart/d+f,e=e+g+g+g+g+'mark = "'+i.items[k].label+'"'+f)}}return e},a.onmessage=function(b){if(void 0!==b.data){var c;switch(b.data.cmd){case"parseTG":c=a.toJSO(b.data.textGrid,b.data.annotates,b.data.name,b.data.sampleRate),a.postMessage(void 0===c.status?{status:{type:"SUCCESS",message:""},data:c}:c);break;case"toTextGrid":c=a.toTextGrid(b.data.levels,b.data.buffLength,b.data.sampleRate),a.postMessage(void 0===c.status?{status:{type:"SUCCESS",message:""},data:c}:c);break;default:a.postMessage({status:{type:"ERROR",message:"Unknown command sent to textGridParserWorker"}})}}else a.postMessage({status:{type:"ERROR",message:"Undefined message was sent to textGridParserWorker"}})}},getWorkerURL:function(){var a,b;try{a=new Blob([this.getWorkerScript()],{type:"application/javascript"})}catch(c){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,a=new BlobBuilder,a.append(textGridParserWorker),a=a.getBlob()}return b="object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.createObjectURL(a):URL.createObjectURL(a)},kill:function(){this.worker&&this.worker.terminate(),this.url&&URL.revokeObjectURL(this.url)},tell:function(a){this.worker&&this.worker.postMessage(a)},says:function(a){this.worker&&this.worker.addEventListener("message",function(b){a(b.data)})}},spectroDrawingWorker.prototype={getWorkerScript:function(){var a="";return a+="("+this.workerInit+")(this);"},workerInit:function(a){a.executed=!1,a.PI=3.141592653589793,a.TWO_PI=6.283185307179586,a.totalMax=0,a.dynRangeInDB=50,a.myWindow={BARTLETT:1,BARTLETTHANN:2,BLACKMAN:3,COSINE:4,GAUSS:5,HAMMING:6,HANN:7,LANCZOS:8,RECTANGULAR:9,TRIANGULAR:10},a.imgWidth=0,a.imgHeight=0,a.upperFreq=0,a.lowerFreq=0,a.pixelRatio=1,a.heatMapColorAnchors=[[255,0,0],[0,255,0],[0,0,0]],a.samplesPerPxl=0,a.sampleRate=0,a.preEmphasisFilterFactor=.97,a.transparency=0,a.drawHeatMapColors=!1,a.N=0,a.windowSizeInSecs=.01,a.audioBuffer=void 0,a.audioBufferChannels=0,a.wFunction=0,a.myFFT=void 0,a.pixelHeight=1,a.internalalpha=1,a.maxPsd=0,a.HzStep=0,a.paint=[],a.sin=void 0,a.cos=void 0,a.ceilingFreqFftIdx=0,a.floorFreqFftIdx=0,a.resultImgArr=void 0,a.toLinearLevel=function(a){return Math.pow(10,a/10)},a.log10=function(a){return Math.log(a)/2.302585092994046},a.magnitude=function(a,b){return Math.sqrt(a*a+b*b)},a.FFT=function(){var b,c,d,e=a.N;if(b=parseInt(Math.log(e)/.6931471805599453,10),e!==1<<b&&console.log("ERROR : FFT length must be power of 2"),void 0===a.cos||e!==a.N)for(a.cos=new Float32Array(e/2),d=0;e/2>d;d++)a.cos[d]=Math.cos(-2*a.PI*d/e);if(void 0===a.sin||e!==a.N)for(a.sin=new Float32Array(e/2),d=0;e/2>d;d++)a.sin[d]=Math.sin(-2*a.PI*d/e);this.applyWindowFuncAndPreemph=function(b,d,e,f){switch(this.alpha=d,b){case a.myWindow.BARTLETT:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionBartlett(f,c);break;case a.myWindow.BARTLETTHANN:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionBartlettHann(f,c);break;case a.myWindow.BLACKMAN:for(this.alpha=this.alpha||.16,c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionBlackman(f,c,d);break;case a.myWindow.COSINE:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionCosine(f,c);break;case a.myWindow.GAUSS:for(this.alpha=this.alpha||.25,c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionGauss(f,c,d);break;case a.myWindow.HAMMING:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionHamming(f,c);break;case a.myWindow.HANN:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionHann(f,c);break;case a.myWindow.LANCZOS:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionLanczos(f,c);break;case a.myWindow.RECTANGULAR:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionRectangular(f,c);break;case a.myWindow.TRIANGULAR:for(c=0;f>c;c++)c>0&&(e[c]=this.applyPreEmph(e[c],e[c-1])),e[c]*=this.wFunctionTriangular(f,c)}return e},this.wFunctionBartlett=function(a,b){return 2/(a-1)*((a-1)/2-Math.abs(b-(a-1)/2))},this.wFunctionBartlettHann=function(b,c){return.62-.48*Math.abs(c/(b-1)-.5)-.38*Math.cos(a.TWO_PI*c/(b-1))},this.wFunctionBlackman=function(b,c,d){var e=(1-d)/2,f=.5,g=d/2;return e-f*Math.cos(a.TWO_PI*c/(b-1))+g*Math.cos(4*a.PI*c/(b-1))},this.wFunctionCosine=function(b,c){return Math.cos(a.PI*c/(b-1)-a.PI/2)},this.wFunctionGauss=function(a,b,c){return Math.pow(Math.E,-.5*Math.pow((b-(a-1)/2)/(c*(a-1)/2),2))},this.wFunctionHamming=function(b,c){return.54-.46*Math.cos(a.TWO_PI*c/(b-1))},this.wFunctionHann=function(b,c){return.5*(1-Math.cos(a.TWO_PI*c/(b-1)))},this.wFunctionLanczos=function(b,c){var d=2*c/(b-1)-1;return Math.sin(a.PI*d)/(a.PI*d)},this.wFunctionRectangular=function(){return 1},this.wFunctionTriangular=function(a,b){return 2/a*(a/2-Math.abs(b-(a-1)/2))},this.applyPreEmph=function(b,c){return b-a.preEmphasisFilterFactor*c},this.fft=function(c,d){var f,g,h,i,j,k,l,m,n,o;for(g=0,j=e/2,f=1;e-1>f;f++){for(i=j;g>=i;)g-=i,i/=2;g+=i,g>f&&(n=c[f],c[f]=c[g],c[g]=n,n=d[f],d[f]=d[g],d[g]=n)}for(i=0,j=1,f=0;b>f;f++)for(i=j,j+=j,k=0,g=0;i>g;g++)for(l=a.cos[k],m=a.sin[k],k+=1<<b-f-1,h=g;e>h;h+=j)n=l*c[h+i]-m*d[h+i],o=m*c[h+i]+l*d[h+i],c[h+i]=c[h]-n,d[h+i]=d[h]-o,c[h]=c[h]+n,d[h]=d[h]+o}},a.convertToHeatmap=function(a,b,c,d){var e=d.length-1,f=(c-a)/(b-a)*e,g=Math.floor(f),h=Math.min.apply(null,[Math.floor(f)+1,e]),i=d[g],j=d[h],k=f-g;return{r:Math.floor(i[0]+k*(j[0]-i[0])),g:Math.floor(i[1]+k*(j[1]-i[1])),b:Math.floor(i[2]+k*(j[2]-i[2]))}},a.drawVerticalLineOfSpectogram=function(b){var c,d,e,f,g=a.pixelHeight,h=2*Math.pow(a.paint[b][1],2)/a.N,i=10*a.log10(h/a.maxPsd),j=(i+a.dynRangeInDB)/a.dynRangeInDB;j>1?j=1:0>j&&(j=0);for(var k=0;k<a.paint[b].length;k++){var l=j;h=2*Math.pow(a.paint[b][k],2)/a.N,i=10*a.log10(h/a.maxPsd),j=(i+a.dynRangeInDB)/a.dynRangeInDB,j>1&&(j=1),0>j&&(j=0);var m=j;if(a.pixelHeight>=1)for(var n=0;n<a.pixelHeight;n++){var o=l+(m-l)/g*n;if(c=255-Math.round(255*o),e=Math.floor(b),f=Math.floor(a.imgHeight-(a.pixelHeight*(k-2)+n)),d=4*(e+f*a.imgWidth),a.drawHeatMapColors)if(isNaN(c))a.resultImgArr[d+0]=c,a.resultImgArr[d+1]=c,a.resultImgArr[d+2]=c,a.resultImgArr[d+3]=a.transparency;else{var p=a.convertToHeatmap(0,255,c,a.heatMapColorAnchors);a.resultImgArr[d+0]=p.r,a.resultImgArr[d+1]=p.g,a.resultImgArr[d+2]=p.b,a.resultImgArr[d+3]=a.transparency}else a.resultImgArr[d+0]=c,a.resultImgArr[d+1]=c,a.resultImgArr[d+2]=c,a.resultImgArr[d+3]=a.transparency}else c=255-Math.round(255*m),e=Math.floor(b),f=Math.floor(a.imgHeight-a.pixelHeight*(k-2)),d=4*(e+f*a.imgWidth),a.resultImgArr[d+0]=c,a.resultImgArr[d+1]=c,a.resultImgArr[d+2]=c,a.resultImgArr[d+3]=a.transparency}},a.calcMagnitudeSpectrum=function(b,c){for(var d=new Float32Array(a.N),e=new Float32Array(a.N),f=new Float32Array(a.ceilingFreqFftIdx-a.floorFreqFftIdx),g=0;c>g;g++)e[g]=a.audioBuffer[b+g];a.myFFT.applyWindowFuncAndPreemph(a.wFunction,a.internalalpha,e,c),a.myFFT.fft(e,d);for(var h=0;h<=a.ceilingFreqFftIdx-a.floorFreqFftIdx;h++)f[h]=a.magnitude(e[h+a.floorFreqFftIdx],d[h+a.floorFreqFftIdx]),a.totalMax<f[h]&&(a.totalMax=f[h]);return f},a.renderSpectrogram=function(){if(!a.executed){a.executed=!0;var b=a.sampleRate*a.windowSizeInSecs;a.myFFT=new a.FFT,a.paint=new Array(a.imgWidth),a.HzStep=a.sampleRate/2/(a.N/2),a.ceilingFreqFftIdx=Math.ceil(a.upperFreq/a.HzStep),a.floorFreqFftIdx=Math.floor(a.lowerFreq/a.HzStep),a.pixelHeight=a.imgHeight/(a.ceilingFreqFftIdx-a.floorFreqFftIdx-2),"undefined"==typeof Uint8ClampedArray&&(Uint8ClampedArray=Uint8Array),a.resultImgArr=new Uint8ClampedArray(Math.ceil(a.imgWidth*a.imgHeight*4));for(var c=0;c<a.imgWidth;c++)a.paint[c]=a.calcMagnitudeSpectrum(Math.round(c*a.samplesPerPxl),b),a.maxPsd=2*Math.pow(a.totalMax,2)/a.N;for(var d=0;d<a.imgWidth;d++)a.drawVerticalLineOfSpectogram(d);a.postMessage({window:a.wFunction,samplesPerPxl:a.samplesPerPxl,pixelHeight:a.pixelHeight,pixelRatio:a.pixelRatio,width:a.imgWidth,height:a.imgHeight,img:a.resultImgArr.buffer},[a.resultImgArr.buffer]),a.myFFT=null,a.executed=!1}},a.onmessage=function(b){if(void 0!==b.data){var c=!0,d="",e=b.data;if(void 0!==e.windowSizeInSecs?a.windowSizeInSecs=e.windowSizeInSecs:(d="windowSizeInSecs",c=!1),void 0!==e.fftN?a.N=e.fftN:(d="fftN",c=!1),void 0!==e.alpha?a.internalalpha=e.alpha:(d="alpha",c=!1),void 0!==e.upperFreq?a.upperFreq=e.upperFreq:(d="upperFreq",c=!1),void 0!==e.lowerFreq?a.lowerFreq=e.lowerFreq:(d="lowerFreq",c=!1),void 0!==e.samplesPerPxl?a.samplesPerPxl=e.samplesPerPxl:(d="samplesPerPxl",c=!1),void 0!==e.window)switch(e.window){case 1:a.wFunction=a.myWindow.BARTLETT;break;case 2:a.wFunction=a.myWindow.BARTLETTHANN;break;case 3:a.wFunction=a.myWindow.BLACKMAN;break;case 4:a.wFunction=a.myWindow.COSINE;break;case 5:a.wFunction=a.myWindow.GAUSS;break;case 6:a.wFunction=a.myWindow.HAMMING;break;case 7:a.wFunction=a.myWindow.HANN;break;case 8:a.wFunction=a.myWindow.LANCZOS;break;case 9:a.wFunction=a.myWindow.RECTANGULAR;break;case 10:a.wFunction=a.myWindow.TRIANGULAR}else d="window",c=!1;void 0!==e.imgWidth?a.imgWidth=e.imgWidth:(d="imgWidth",c=!1),void 0!==e.imgHeight?a.imgHeight=e.imgHeight:(d="imgHeight",c=!1),void 0!==e.dynRangeInDB?a.dynRangeInDB=e.dynRangeInDB:(d="dynRangeInDB",c=!1),void 0!==e.pixelRatio?a.pixelRatio=e.pixelRatio:(d="pixelRatio",c=!1),void 0!==e.sampleRate?a.sampleRate=e.sampleRate:(d="sampleRate",c=!1),void 0!==e.audioBufferChannels?a.audioBufferChannels=e.audioBufferChannels:(d="audioBufferChannels",c=!1),void 0!==e.transparency?a.transparency=e.transparency:(d="transparency",c=!1),void 0!==e.audioBuffer?a.audioBuffer=new Float32Array(e.audioBuffer):(d="audioBuffer",c=!1),void 0!==e.drawHeatMapColors?a.drawHeatMapColors=e.drawHeatMapColors:(d="drawHeatMapColors",c=!1),void 0!==e.preEmphasisFilterFactor?a.preEmphasisFilterFactor=e.preEmphasisFilterFactor:(d="preEmphasisFilterFactor",c=!1),void 0!==e.heatMapColorAnchors?a.heatMapColorAnchors=e.heatMapColorAnchors:(d="heatMapColorAnchors",c=!1),c?a.renderSpectrogram():a.postMessage({status:{type:"ERROR",message:d+" is undefined"}})}else a.postMessage({status:{type:"ERROR",message:"Undefined message was sent to spectroDrawingWorker"}})}},getWorkerURL:function(){var a,b;try{a=new Blob([this.getWorkerScript()],{type:"application/javascript"})}catch(c){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,a=new BlobBuilder,a.append(spectroDrawingWorker),a=a.getBlob()}return b="object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.createObjectURL(a):URL.createObjectURL(a)},kill:function(){this.worker&&this.worker.terminate(),this.url&&("object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.revokeObjectURL(this.url):URL.revokeObjectURL(this.url))},tell:function(a){this.worker&&this.worker.postMessage(a)},says:function(a){this.worker&&this.worker.addEventListener("message",function(b){a(b.data)})}},ssffParserWorker.prototype={getWorkerScript:function(){var a="";return a+="("+this.workerInit+")(this);"},workerInit:function(a){var b={},c="SSFF -- (c) SHLRC\n",d="Machine IBM-PC\n",e="-----------------\n";b.ssffTrackName="",b.sampleRate=-1,b.startTime=-1,b.origFreq=-1,b.Columns=[],function(){function b(a){var b,c,e,f,g,h;for(e=a.length,c=0,b="";e>c;){if(f=255&a.charCodeAt(c++),c===e){b+=d.charAt(f>>2),b+=d.charAt((3&f)<<4),b+="==";break}if(g=a.charCodeAt(c++),c===e){b+=d.charAt(f>>2),b+=d.charAt((3&f)<<4|(240&g)>>4),b+=d.charAt((15&g)<<2),b+="=";break}h=a.charCodeAt(c++),b+=d.charAt(f>>2),b+=d.charAt((3&f)<<4|(240&g)>>4),b+=d.charAt((15&g)<<2|(192&h)>>6),b+=d.charAt(63&h)}return b}function c(a){var b,c,d,f,g,h,i;for(h=a.length,g=0,i="";h>g;){do b=e[255&a.charCodeAt(g++)];while(h>g&&-1===b);if(-1===b)break;do c=e[255&a.charCodeAt(g++)];while(h>g&&-1===c);if(-1===c)break;i+=String.fromCharCode(b<<2|(48&c)>>4);do{if(d=255&a.charCodeAt(g++),61===d)return i;d=e[d]}while(h>g&&-1===d);if(-1===d)break;i+=String.fromCharCode((15&c)<<4|(60&d)>>2);do{if(f=255&a.charCodeAt(g++),61===f)return i;f=e[f]}while(h>g&&-1===f);if(-1===f)break;i+=String.fromCharCode((3&d)<<6|f)}return i}var d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",e=new Array(-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1);a.btoa||(a.btoa=b),a.atob||(a.atob=c)}(),a.base64ToArrayBuffer=function(b){for(var c=a.atob(b),d=c.length,e=new Uint8Array(d),f=0;d>f;f++){var g=c.charCodeAt(f);e[f]=g}return e.buffer},a.round=function(a,b){if(1>b||b>14)return!1;var c=Math.pow(10,b),d=(Math.round(a*c)/c).toString();return-1===d.indexOf(".")&&(d+="."),d+=c.toString().substring(1),d.substring(0,d.indexOf(".")+b+1)},a.stringToUint=function(a){for(var b=a.split(""),c=[],d=0;d<b.length;d++)c.push(b[d].charCodeAt(0));return new Uint8Array(c)},a.Uint8Concat=function(a,b){var c=a.length,d=new Uint8Array(c+b.length);return d.set(a),d.set(b,c),d},a.ssff2jso=function(a,f){b.ssffTrackName=f,b.Columns=[];for(var g=new Uint8Array(a),h="",i=0;i<g.length;i++)h+=String.fromCharCode(g[i]);var j=h.split(/^/m);if(j[0]!==c)return{status:{type:"ERROR",message:"SSFF parse error: first line != SSFF -- (c) SHLRC in ssffTrackName "+f}};if(j[1]!==d)return{status:{type:"ERROR",message:"SSFF parse error: machineID != Machine IBM-PC in ssffTrackName "+f}};b.sampleRate=void 0,b.startTime=void 0;for(var k=0;j[k]!==e;)"Record_Freq"===j[k].split(/[ ,]+/)[0]&&(b.sampleRate=parseFloat(j[k].split(/[ ,]+/)[1].replace(/(\r\n|\n|\r)/gm,""))),"Start_Time"===j[k].split(/[ ,]+/)[0]&&(b.startTime=parseFloat(j[k].split(/[ ,]+/)[1].replace(/(\r\n|\n|\r)/gm,""))),k+=1;if(void 0===b.sampleRate||void 0===b.startTime)return{status:{type:"ERROR",message:"SSFF parse error: Required fields Record_Freq or Start_Time not set in ssffTrackName "+f}};for(var l=4;l<j.length&&("Original_Freq"===j[l].split(/[ ,]+/)[0]&&(b.origFreq=parseFloat(j[l].split(/[ ,]+/)[2].replace(/(\r\n|\n|\r)/gm,""))),j[l]!==e);l++){var m=j[l].split(/[ ]+/);"Column"===m[0]&&b.Columns.push({name:m[1],ssffdatatype:m[2],length:parseInt(m[3].replace(/(\r\n|\n|\r)/gm,""),10),values:[],_minVal:1/0,_maxVal:-1/0})}for(var n,o,p,q,r,s=j.slice(0,l+1).join("").length;s<=g.length;)for(l=0;l<b.Columns.length;l++)if("DOUBLE"===b.Columns[l].ssffdatatype)p=8*b.Columns[l].length,o=a.subarray(s,p),"undefined"==typeof Float64Array&&(Float64Array=Float32Array),n=new Float64Array(o),b.Columns[l].values.push(Array.prototype.slice.call(n)),s+=p,q=Math.min.apply(null,Array.prototype.slice.call(n)),r=Math.max.apply(null,Array.prototype.slice.call(n)),q<b.Columns[l]._minVal&&(b.Columns[l]._minVal=q),r>b.Columns[l]._maxVal&&(b.Columns[l]._maxVal=r);else if("FLOAT"===b.Columns[l].ssffdatatype)p=4*b.Columns[l].length,o=a.subarray(s,p),n=new Float32Array(o),b.Columns[l].values.push(Array.prototype.slice.call(n)),s+=p,q=Math.min.apply(null,Array.prototype.slice.call(n)),r=Math.max.apply(null,Array.prototype.slice.call(n)),q<b.Columns[l]._minVal&&(b.Columns[l]._minVal=q),r>b.Columns[l]._maxVal&&(b.Columns[l]._maxVal=r);else if("SHORT"===b.Columns[l].ssffdatatype)p=2*b.Columns[l].length,o=a.subarray(s,p),n=new Uint16Array(o),b.Columns[l].values.push(Array.prototype.slice.call(n)),s+=p,q=Math.min.apply(null,Array.prototype.slice.call(n)),r=Math.max.apply(null,Array.prototype.slice.call(n)),q<b.Columns[l]._minVal&&(b.Columns[l]._minVal=q),r>b.Columns[l]._maxVal&&(b.Columns[l]._maxVal=r);else{if("BYTE"!==b.Columns[l].ssffdatatype)return{status:{type:"ERROR",message:"Unsupported column type! Only DOUBLE, FLOAT, SHORT, BYTE column types are currently supported in ssffTrackName "+f}};p=1*b.Columns[l].length,o=a.subarray(s,p),n=new Uint8Array(o),b.Columns[l].values.push(Array.prototype.slice.call(n)),s+=p}return b},a.jso2ssff=function(b){var f=c+d;f+="Record_Freq "+a.round(b.sampleRate,1)+"\n",f+="Start_Time "+b.startTime+"\n",b.Columns.forEach(function(a){f+="Column "+a.name+" "+a.ssffdatatype+" "+a.length+"\n"}),f+="Original_Freq DOUBLE "+a.round(b.origFreq,1)+"\n",f+=e;var g=0,h=!1;if(b.Columns.forEach(function(a){"SHORT"===a.ssffdatatype?g+=2*a.length:h=!0}),h)return{status:{type:"ERROR",message:"Unsupported column type! Only SHORT columns supported for now!"}};var i=g*b.Columns[0].values.length,j=new ArrayBuffer(i),k=new DataView(j),l=new Uint8Array(a.stringToUint(f)),m=0;if(b.Columns[0].values.forEach(function(a,c){b.Columns.forEach(function(a){"SHORT"===a.ssffdatatype?a.values[c].forEach(function(a){k.setInt16(m,a,!0),m+=2}):h=!0})}),h)return{status:{type:"ERROR",message:"Unsupported column type! Only SHORT columns supported for now!"}};var n=new Uint8Array(k.buffer);return l=new a.Uint8Concat(l,n),{status:{type:"SUCCESS",message:""},data:l.buffer}},a.parseArr=function(b){for(var c,d=!0,e=[],f=0;f<b.length;f++){c={};var g;if(g=a.base64ToArrayBuffer(b[f].data),c=a.ssff2jso(g,b[f].ssffTrackName),void 0!==c.status)return d=!1,c;e.push(JSON.parse(JSON.stringify(c)))}return d?{status:{type:"SUCCESS",message:""},data:e}:{status:{type:"ERROR",message:"Error in parseArr() with: "+JSON.stringify(b)}}},ArrayBuffer.prototype.subarray=function(a,b){for(var c=new ArrayBuffer(b),d=new Int8Array(c),e=new Int8Array(this),f=0;b>f;f++)d[f]=e[a+f];return c},a.onmessage=function(b){if(void 0!==b.data)switch(b.data.cmd){case"parseArr":a.postMessage(a.parseArr(b.data.ssffArr));break;case"jso2ssff":a.postMessage(a.jso2ssff(JSON.parse(b.data.jso)));break;default:a.postMessage({status:{type:"ERROR",message:"Unknown command sent to ssffParserWorker"}})}else a.postMessage({status:{type:"ERROR",message:"Undefined message was sent to ssffParserWorker"}})}},getWorkerURL:function(){var a,b;try{a=new Blob([this.getWorkerScript()],{type:"application/javascript"})}catch(c){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,a=new BlobBuilder,a.append(textGridParserWorker),a=a.getBlob()}return b="object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.createObjectURL(a):URL.createObjectURL(a)},kill:function(){this.worker&&(this.worker.terminate(),this.worker=void 0),this.url&&("object"!=typeof URL&&"undefined"!=typeof webkitURL?webkitURL.revokeObjectURL(this.url):URL.revokeObjectURL(this.url),this.url=void 0)},tell:function(a){this.worker&&this.worker.postMessage(a)},says:function(a){this.worker&&this.worker.addEventListener("message",function(b){a(b.data)})}},angular.module("emuwebApp").service("mathHelperService",function(){var a={};return a.calcClosestPowerOf2Gt=function(a){for(var b=0;Math.pow(2,b)<a;)b+=1;return Math.pow(2,b)},a}),angular.module("emuwebApp").directive("modal",["$animate","modalService",function(a,b){return{restrict:"E",templateUrl:"views/modal.html",replace:!0,scope:{},link:function(a,c){a.templateUrl="",a.modal=b,a.isOpen=!1,a.force=!1,a.dataIn="",a.$watch("modal.isOpen",function(d){void 0!==d&&(a.templateUrl=b.getTemplateUrl(),a.dataIn=b.dataIn,a.force=b.force,d?c[0].classList.add("emuwebapp-modalDialog-isOpen"):c[0].classList.remove("emuwebapp-modalDialog-isOpen"))}),a.$watch("modal.templateUrl",function(c){void 0!==c&&(a.templateUrl=c,a.dataIn=b.dataIn,a.force=b.force)})}}}]),angular.module("emuwebApp").service("modalService",["$q","ArrayHelperService","viewState",function(a,b,c){var d={};return d.isOpen=!1,d.templateUrl="",d.defer=void 0,d.deferChange=void 0,d.force=!1,d.dataOut=void 0,d.dataIn=void 0,d.dataExport=void 0,d.open=function(e,f,g,h){return void 0!==f&&(d.dataIn=f,void 0!==f.y&&(d.dataIn.chartData=b.convertArrayToXYjsoArray(f.y))),void 0!==g&&(d.dataExport=g),void 0!==h&&(d.force=h),d.defer=a.defer(),d.templateUrl=e,c.setState("modalShowing"),d.isOpen=!0,d.defer.promise},d.changeModal=function(b,c,e,f){return void 0!==c&&(d.dataIn=c),void 0!==e&&(d.dataExport=e),void 0!==f&&(d.force=f),d.deferChange=a.defer(),d.templateUrl=b,d.deferChange.promise},d.error=function(a){d.dataIn=a,d.templateUrl="views/error.html",c.setState("modalShowing")},d.close=function(){c.setEditing(!1),c.setState(c.prevState),d.isOpen=!1,c.hierarchyShown&&c.toggleHierarchy(),d.defer.resolve(!1)},d.closeAndResolve=function(a){c.setEditing(!1),c.setState(c.prevState),d.isOpen=!1,d.defer.resolve(a)},d.confirm=function(){c.setEditing(!1),c.setState(c.prevState),d.isOpen=!1,d.defer.resolve(!0)},d.select=function(a){d.defer.resolve(a)},d.confirmContent=function(){c.setEditing(!1),c.setState(c.prevState),d.isOpen=!1,d.defer.resolve(d.dataOut)},d.getTemplateUrl=function(){return d.templateUrl},d}]),angular.module("emuwebApp").controller("TabbedCtrl",["$scope","viewState","ConfigProviderService","Validationservice","uuid",function(a,b,c,d){a.cps=c,a.vs=b,a.valid=d,a.levelDefinitionProperties={},a.linkDefinitionProperties={},a.spectroDefinitionProperties={},a.signalSelect=[],a.levelSelect=[],a.twoDimSelect=[],a.addSignalSelect="",a.addLevelSelect="",a.addTwoDimSelect="",a.tabs=[{title:"level definitions",url:"views/tabbed/levelDefinition.html"},{title:"link definitions",url:"views/tabbed/linkDefinition.html"},{title:"ssff track definitions",url:"views/tabbed/ssffDefinition.html"},{title:"2D definitions",url:"views/tabbed/twoDimDefinition.html"},{title:"EMU-webApp",url:"views/tabbed/emuDefinition.html"},{title:"global DB",url:"views/tabbed/globalDefinition.html"}],a.currentTab="views/tabbed/levelDefinition.html",a.setup=function(){var b=a.valid.getSchema("DBconfigFileSchema"),c=a.valid.getSchema("emuwebappConfigSchema");a.levelDefinitionProperties=b.data.properties.levelDefinitions.items.properties,a.linkDefinitionProperties=b.data.properties.linkDefinitions.items.properties,a.spectroDefinitionProperties=c.data.properties.spectrogramSettings.properties,a.resetSelections()},a.onClickTab=function(b){a.currentTab=b.url},a.resetSelections=function(){a.signalSelect=["OSCI","SPEC"],a.levelSelect=[],a.twoDimSelect=[],angular.forEach(a.cps.curDbConfig.ssffTrackDefinitions,function(b){a.signalSelect.push(b.name)}),angular.forEach(a.cps.curDbConfig.levelDefinitions,function(b){a.levelSelect.push(b.name)}),a.twoDimSelect.push("under development"),a.addSignalSelect=a.signalSelect[0],a.addLevelSelect=a.levelSelect[0],a.addTwoDimSelect=a.twoDimSelect[0]},a.isActiveTab=function(b){return b==a.currentTab?{"background-color":"#FFF",color:"#000"}:{}},a.cursorInTextField=function(){b.setEditing(!0),b.setcursorInTextField(!0)},a.cursorOutOfTextField=function(){b.setEditing(!1),b.setcursorInTextField(!1)},a.addDefinition=function(b,c,d){switch(b){case"level":a.cps.curDbConfig.levelDefinitions.push({name:"",type:"ITEM",attributeDefinitions:[{name:"",type:"STRING"}]});break;case"levelattribute":a.cps.curDbConfig.levelDefinitions[c].attributeDefinitions.push({name:"",type:"STRING",legalLabels:[]});break;case"link":a.cps.curDbConfig.linkDefinitions.push({type:"undefined",superlevelName:"undefined",sublevelName:"undefined"});break;case"ssff":a.cps.curDbConfig.ssffTrackDefinitions.push({name:"undefined",columnName:"undefined",fileExtension:"undefined"});break;case"perspective":a.cps.vals.perspectives.push({name:"",signalCanvases:{order:[],assign:[],contourLims:[],contourColors:[]},levelCanvases:{order:[]},twoDimCanvases:{order:[]}});break;case"perspectiveAssign":a.cps.vals.perspectives[c].signalCanvases.assign.push({signalCanvasName:"",ssffTrackName:""});break;case"perspectiveContourColor":a.cps.vals.perspectives[c].signalCanvases.contourColors.push({colors:["rgba(0,0,0,1)"],ssffTrackName:""});break;case"perspectiveContourColorColor":a.cps.vals.perspectives[c].signalCanvases.contourColors[d].colors.push("rgba(0,0,0,1)");break;case"perspectiveContourLims":a.cps.vals.perspectives[c].signalCanvases.contourLims.push({ssffTrackName:"",minContourIdx:0,maxContourIdx:1});break;case"perspectiveOrderSignal":a.cps.vals.perspectives[c].signalCanvases.order.push(d);break;case"perspectiveOrderLevel":a.cps.vals.perspectives[c].levelCanvases.order.push(d);break;case"perspectiveOrderTwoDim":a.cps.vals.perspectives[c].twoDimCanvases.order.push(d)}},a.deleteDefinition=function(b,c,d,e){switch(b){case"level":a.cps.curDbConfig.levelDefinitions.splice(c,1);break;case"levelattribute":a.cps.curDbConfig.levelDefinitions[c].attributeDefinitions.splice(d,1);break;case"link":a.cps.curDbConfig.linkDefinitions.splice(c,1);break;case"ssff":a.cps.curDbConfig.ssffTrackDefinitions.splice(c,1);break;case"perspective":a.cps.vals.perspectives.splice(c,1);break;case"perspectiveAssign":a.cps.vals.perspectives[c].signalCanvases.assign.splice(d,1);break;case"perspectiveContourColor":a.cps.vals.perspectives[c].signalCanvases.contourColors.splice(d,1);break;case"perspectiveContourColorColor":a.cps.vals.perspectives[c].signalCanvases.contourColors[d].colors.splice(e,1);break;case"perspectiveContourLims":a.cps.vals.perspectives[c].signalCanvases.contourLims.splice(d,1);break;case"perspectiveOrderSignal":a.cps.vals.perspectives[c].signalCanvases.order.splice(d,1);break;case"perspectiveOrderLevel":a.cps.vals.perspectives[c].levelCanvases.order.splice(d,1);break;case"perspectiveOrderTwoDim":a.cps.vals.perspectives[c].twoDimCanvases.order.splice(d,1)}},a.setup()}]);